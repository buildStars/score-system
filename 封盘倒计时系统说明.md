# ğŸ° å°ç›˜å€’è®¡æ—¶ç³»ç»Ÿè¯´æ˜

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

åŸºäº **USA28 å½©ç¥¨**ï¼ˆæ¯ 3.5 åˆ†é’Ÿä¸€æœŸï¼‰çš„å°ç›˜å€’è®¡æ—¶ç³»ç»Ÿï¼Œ**åç«¯æ§åˆ¶æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œå‰ç«¯è´Ÿè´£å±•ç¤º**ã€‚

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

### âœ… åç«¯èŒè´£ï¼ˆæƒå¨ï¼‰
1. **æ—¶é—´è®¡ç®—** - æ‰€æœ‰æ—¶é—´è®¡ç®—åœ¨æœåŠ¡å™¨ç«¯å®Œæˆ
2. **çŠ¶æ€åˆ¤å®š** - åˆ¤æ–­å¼€ç›˜/å°ç›˜/å³å°†å°ç›˜çŠ¶æ€
3. **ä¸‹æ³¨æ§åˆ¶** - å°ç›˜æœŸé—´æ‹’ç»ä¸‹æ³¨è¯·æ±‚
4. **æ•°æ®åŒæ­¥** - å®šæ—¶ä» USA28 API è·å–æœ€æ–°å¼€å¥–

### âœ… å‰ç«¯èŒè´£ï¼ˆå±•ç¤ºï¼‰
1. **å€’è®¡æ—¶æ˜¾ç¤º** - æµç•…çš„å€’è®¡æ—¶åŠ¨ç”»
2. **çŠ¶æ€å±•ç¤º** - å¯è§†åŒ–æ˜¾ç¤ºå½“å‰çŠ¶æ€
3. **ç”¨æˆ·æç¤º** - å°ç›˜/å¼€ç›˜é€šçŸ¥
4. **æœ¬åœ°ä¼˜åŒ–** - å‡å°‘æœåŠ¡å™¨è¯·æ±‚å‹åŠ›

---

## âš™ï¸ æŠ€æœ¯å‚æ•°

### æ—¶é—´é…ç½®
```typescript
å¼€å¥–é—´éš”: 210ç§’ (3åˆ†30ç§’)
å°ç›˜æ—¶é—´: å¼€å¥–å‰30ç§’
è­¦å‘Šæ—¶é—´: å°ç›˜å‰60ç§’
å¼€ç›˜æ—¶é—´: 180ç§’ (210 - 30)
```

### çŠ¶æ€å®šä¹‰
```typescript
type Status = 'open' | 'closing' | 'closed'

- open: æ­£å¸¸å¼€ç›˜ï¼Œå¯ä»¥ä¸‹æ³¨
- closing: å³å°†å°ç›˜ï¼ˆå°ç›˜å‰60ç§’ï¼‰ï¼Œä»å¯ä¸‹æ³¨ä½†éœ€æç¤º
- closed: å·²å°ç›˜ï¼Œä¸å¯ä¸‹æ³¨
```

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### åç«¯æ¶æ„

#### 1. LotteryCountdownServiceï¼ˆæ ¸å¿ƒæœåŠ¡ï¼‰

**èŒè´£ï¼š**
- ç®¡ç†å¼€å¥–æ•°æ®ç¼“å­˜
- è®¡ç®—å€’è®¡æ—¶å’ŒçŠ¶æ€
- æä¾›æŸ¥è¯¢æ¥å£

**å…³é”®æ–¹æ³•ï¼š**

```typescript
@Injectable()
export class LotteryCountdownService {
  // é…ç½®
  private readonly DRAW_INTERVAL = 210;
  private readonly CLOSE_BEFORE_DRAW = 30;
  private readonly WARNING_TIME = 60;
  
  // ç¼“å­˜
  private currentPeriod: string;
  private lastDrawTime: Date;
  
  // åˆå§‹åŒ–
  async initialize() {
    await this.fetchLatestDraw();
  }
  
  // å®šæ—¶ä»»åŠ¡ï¼šæ¯åˆ†é’ŸåŒæ­¥ä¸€æ¬¡æ•°æ®
  @Cron(CronExpression.EVERY_MINUTE)
  async syncLatestDraw() {
    await this.fetchLatestDraw();
  }
  
  // è·å–å½“å‰çŠ¶æ€
  async getLotteryStatus(): Promise<LotteryStatusDto> {
    // è®¡ç®—å€’è®¡æ—¶
    // åˆ¤æ–­çŠ¶æ€
    // è¿”å›å®Œæ•´çŠ¶æ€ä¿¡æ¯
  }
  
  // æ£€æŸ¥æ˜¯å¦å¯ä»¥ä¸‹æ³¨
  async canPlaceBet(): Promise<{canBet: boolean, reason?: string}> {
    const status = await this.getLotteryStatus();
    return { canBet: status.canBet };
  }
}
```

#### 2. BetServiceï¼ˆä¸‹æ³¨æœåŠ¡å¢å¼ºï¼‰

**å¢å¼ºç‚¹ï¼š**
```typescript
async createBet(userId: number, createBetDto: CreateBetDto) {
  // 1. éªŒè¯æ¸¸æˆæ˜¯å¦å¼€å¯
  // 2. âœ¨ æ£€æŸ¥æ˜¯å¦åœ¨å°ç›˜æœŸé—´
  const betCheck = await this.countdownService.canPlaceBet();
  if (!betCheck.canBet) {
    throw new BadRequestException(betCheck.reason);
  }
  
  // 3. âœ¨ éªŒè¯ä¸‹æ³¨æœŸå·æ˜¯å¦ä¸ºå½“å‰æœŸ
  const status = await this.countdownService.getLotteryStatus();
  if (issue !== status.currentPeriod) {
    throw new BadRequestException('ä¸‹æ³¨æœŸå·é”™è¯¯');
  }
  
  // 4. å…¶ä»–éªŒè¯...
  // 5. åˆ›å»ºä¸‹æ³¨è®°å½•
}
```

#### 3. API æ¥å£

| æ¥å£ | æ–¹æ³• | è¯´æ˜ | æƒé™ |
|------|------|------|------|
| `/lottery/status` | GET | è·å–å½©ç¥¨çŠ¶æ€ | å…¬å¼€ |
| `/lottery/can-bet` | GET | æ£€æŸ¥æ˜¯å¦å¯ä¸‹æ³¨ | å…¬å¼€ |
| `/lottery/refresh-status` | POST | æ‰‹åŠ¨åˆ·æ–°çŠ¶æ€ | ç®¡ç†å‘˜ |

---

### å‰ç«¯æ¶æ„

#### 1. LotteryCountdown ç»„ä»¶

**ä¼˜åŒ–ç­–ç•¥ï¼šæœ¬åœ°å€’è®¡æ—¶ + å®šæ—¶åŒæ­¥**

```vue
<script setup lang="ts">
// çŠ¶æ€
const lotteryStatus = ref<LotteryStatusResponse | null>(null)
const localCountdown = ref(0) // æœ¬åœ°å€’è®¡æ—¶
const serverTimeDiff = ref(0) // æ—¶é—´å·®æ ¡å‡†

// åŒæ­¥æœåŠ¡å™¨çŠ¶æ€
const fetchLotteryStatus = async () => {
  const res = await getLotteryStatus()
  
  // è®¡ç®—æœåŠ¡å™¨æ—¶é—´å·®
  const serverTime = new Date(res.data.serverTime).getTime()
  serverTimeDiff.value = serverTime - Date.now()
  
  // åˆå§‹åŒ–æœ¬åœ°å€’è®¡æ—¶
  localCountdown.value = res.data.countdown
  lotteryStatus.value = res.data
}

// æœ¬åœ°å€’è®¡æ—¶æ›´æ–°
const updateLocalCountdown = () => {
  localCountdown.value = Math.max(0, localCountdown.value - 1)
  
  // â° å€’è®¡æ—¶ç»“æŸï¼Œé‡æ–°åŒæ­¥
  if (localCountdown.value <= 0) {
    fetchLotteryStatus()
  }
  
  // ğŸ”„ æ¯60ç§’æ ¡å‡†ä¸€æ¬¡ï¼ˆé˜²æ­¢æ—¶é—´åç§»ï¼‰
  if (localCountdown.value % 60 === 0) {
    fetchLotteryStatus()
  }
}

// å¯åŠ¨
onMounted(async () => {
  await fetchLotteryStatus() // é¦–æ¬¡åŒæ­¥
  setInterval(updateLocalCountdown, 1000) // æ¯ç§’æ›´æ–°
})
</script>
```

**åŒæ­¥æ—¶æœºï¼š**
1. âœ… ç»„ä»¶æŒ‚è½½æ—¶ - ç«‹å³åŒæ­¥
2. âœ… å€’è®¡æ—¶ç»“æŸæ—¶ - è‡ªåŠ¨åŒæ­¥
3. âœ… æ¯60ç§’ - å®šæ—¶æ ¡å‡†
4. âœ… æ‰‹åŠ¨åˆ·æ–° - ç”¨æˆ·è§¦å‘

---

## ğŸ”„ å·¥ä½œæµç¨‹

### ç³»ç»Ÿå¯åŠ¨æµç¨‹

```mermaid
sequenceDiagram
    participant Backend as åç«¯æœåŠ¡
    participant USA28 as USA28 API
    participant Frontend as å‰ç«¯é¡µé¢
    participant User as ç”¨æˆ·

    Backend->>Backend: å¯åŠ¨æ—¶åˆå§‹åŒ–
    Backend->>USA28: è·å–æœ€æ–°å¼€å¥–
    USA28-->>Backend: è¿”å›æœ€æ–°æœŸå·+æ—¶é—´
    Backend->>Backend: ç¼“å­˜æ•°æ®

    User->>Frontend: æ‰“å¼€é¡µé¢
    Frontend->>Backend: GET /lottery/status
    Backend->>Backend: è®¡ç®—å€’è®¡æ—¶å’ŒçŠ¶æ€
    Backend-->>Frontend: è¿”å›å®Œæ•´çŠ¶æ€
    Frontend->>Frontend: å¼€å§‹æœ¬åœ°å€’è®¡æ—¶

    loop æ¯ç§’
        Frontend->>Frontend: localCountdown--
    end

    Frontend->>Backend: å€’è®¡æ—¶ç»“æŸï¼Œé‡æ–°åŒæ­¥
    Backend-->>Frontend: è¿”å›æ–°çŠ¶æ€
```

### ä¸‹æ³¨æµç¨‹ï¼ˆå°ç›˜æ§åˆ¶ï¼‰

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯
    participant Backend as åç«¯
    participant DB as æ•°æ®åº“

    User->>Frontend: ç‚¹å‡»ä¸‹æ³¨
    Frontend->>Frontend: æ£€æŸ¥æœ¬åœ°çŠ¶æ€
    
    alt å·²å°ç›˜ï¼ˆå‰ç«¯åˆ¤æ–­ï¼‰
        Frontend-->>User: æç¤ºï¼šæœ¬æœŸå·²å°ç›˜
    else å¼€ç›˜ä¸­
        Frontend->>Backend: POST /bet/create
        Backend->>Backend: canPlaceBet()
        
        alt å°ç›˜æœŸé—´ï¼ˆåç«¯åˆ¤æ–­ï¼‰
            Backend-->>Frontend: 400: å·²å°ç›˜
            Frontend-->>User: æç¤ºï¼šå°ç›˜æœŸé—´ä¸å¯ä¸‹æ³¨
        else å¯ä»¥ä¸‹æ³¨
            Backend->>Backend: éªŒè¯æœŸå·
            Backend->>DB: åˆ›å»ºä¸‹æ³¨è®°å½•
            Backend-->>Frontend: 200: ä¸‹æ³¨æˆåŠŸ
            Frontend-->>User: æç¤ºï¼šä¸‹æ³¨æˆåŠŸ
        end
    end
```

---

## ğŸ“Š çŠ¶æ€å“åº”ç¤ºä¾‹

### GET /lottery/status å“åº”

```json
{
  "currentPeriod": "3364685",
  "nextPeriod": "3364686",
  "status": "open",
  "canBet": true,
  "countdown": 165,
  "countdownText": "è·ç¦»å°ç›˜è¿˜æœ‰ 2 åˆ† 45 ç§’",
  "lastDrawTime": "2025-11-27 04:11:30",
  "nextDrawTime": "2025-11-27 04:15:00",
  "progressPercentage": 8.33,
  "serverTime": "2025-11-27 04:12:45"
}
```

### çŠ¶æ€å˜åŒ–ç¤ºä¾‹

| å€’è®¡æ—¶ | status | canBet | countdownText |
|--------|--------|--------|---------------|
| 180ç§’ | open | true | è·ç¦»å°ç›˜è¿˜æœ‰ 3 åˆ† 0 ç§’ |
| 60ç§’ | closing | true | âš ï¸ å³å°†å°ç›˜ï¼Œè¿˜æœ‰ 60 ç§’ |
| 30ç§’ | closed | false | è·ç¦»å¼€å¥–è¿˜æœ‰ 30 ç§’ |
| 0ç§’ | - | - | é‡æ–°è·å–çŠ¶æ€ |

---

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. åŒé‡éªŒè¯
```typescript
// å‰ç«¯ï¼šå¿«é€Ÿåé¦ˆ
if (localCountdown <= 0) {
  ElMessage.warning('æœ¬æœŸå·²å°ç›˜')
  return
}

// åç«¯ï¼šæƒå¨éªŒè¯ï¼ˆå¿…é¡»ï¼‰
const betCheck = await countdownService.canPlaceBet()
if (!betCheck.canBet) {
  throw new BadRequestException(betCheck.reason)
}
```

### 2. æœŸå·éªŒè¯
```typescript
// é˜²æ­¢ç”¨æˆ·æäº¤æ—§æœŸå·æˆ–æœªæ¥æœŸå·
if (issue !== lotteryStatus.currentPeriod) {
  throw new BadRequestException('ä¸‹æ³¨æœŸå·é”™è¯¯')
}
```

### 3. æ—¶é—´æ ¡å‡†
```typescript
// å‰ç«¯è®¡ç®—æœåŠ¡å™¨æ—¶é—´å·®
serverTimeDiff = serverTime - clientTime

// æ¯60ç§’æ ¡å‡†ä¸€æ¬¡
if (localCountdown % 60 === 0) {
  fetchLotteryStatus()
}
```

---

## ğŸ¨ UI å±•ç¤º

### çŠ¶æ€é¢œè‰²
```scss
.status-open {
  background: #f0f9ff;
  color: #67c23a;
  border: 2px solid #67c23a;
}

.status-warning {
  background: #fdf6ec;
  color: #e6a23c;
  border: 2px solid #e6a23c;
  animation: pulse 1s infinite; // é—ªçƒæç¤º
}

.status-closed {
  background: #fef0f0;
  color: #f56c6c;
  border: 2px solid #f56c6c;
}
```

### è¿›åº¦æ¡é¢œè‰²
- å¼€ç›˜ä¸­ï¼šç»¿è‰² `#67c23a`
- å³å°†å°ç›˜ï¼šæ©™è‰² `#e6a23c`
- å·²å°ç›˜ï¼šçº¢è‰² `#f56c6c`

---

## ğŸ“± ä½¿ç”¨ç¤ºä¾‹

### 1. åœ¨é¡µé¢ä¸­ä½¿ç”¨

```vue
<template>
  <LotteryCountdown 
    @close="handleClose"
    @open="handleOpen"
    @tick="handleTick"
  />
</template>

<script setup>
import LotteryCountdown from '@/components/LotteryCountdown.vue'

const handleClose = (data) => {
  console.log('å°ç›˜äº†', data)
  // ç¦ç”¨ä¸‹æ³¨æŒ‰é’®
}

const handleOpen = (data) => {
  console.log('å¼€ç›˜äº†', data)
  // å¯ç”¨ä¸‹æ³¨æŒ‰é’®
}

const handleTick = (countdown) => {
  // æ¯ç§’æ›´æ–°
}
</script>
```

### 2. ç¨‹åºåŒ–è°ƒç”¨

```typescript
import { getLotteryStatus, canPlaceBet } from '@/api/lottery'

// è·å–çŠ¶æ€
const status = await getLotteryStatus()
console.log('å½“å‰æœŸå·:', status.data.currentPeriod)
console.log('å¯å¦ä¸‹æ³¨:', status.data.canBet)

// æ£€æŸ¥æ˜¯å¦å¯ä¸‹æ³¨
const check = await canPlaceBet()
if (!check.data.canBet) {
  ElMessage.warning(check.data.reason)
}
```

---

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–

### 1. å‡å°‘ç½‘ç»œè¯·æ±‚

**ä¼˜åŒ–å‰ï¼š** æ¯ç§’è¯·æ±‚ä¸€æ¬¡åç«¯ â†’ âŒ 1800æ¬¡/æœŸ
**ä¼˜åŒ–åï¼š** å€’è®¡æ—¶ç»“æŸ+æ¯60ç§’ â†’ âœ… 4æ¬¡/æœŸ

**å‡å°‘å‹åŠ›ï¼š** 99.8% â†“

### 2. ç¼“å­˜ç­–ç•¥

```typescript
// åç«¯ç¼“å­˜æœ€æ–°å¼€å¥–æ•°æ®
private currentPeriod: string
private lastDrawTime: Date

// æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
@Cron(CronExpression.EVERY_MINUTE)
async syncLatestDraw() {
  await this.fetchLatestDraw()
}
```

### 3. å“åº”é€Ÿåº¦

| æ“ä½œ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| å€’è®¡æ—¶æ›´æ–° | ~100ms (ç½‘ç»œ) | <1ms (æœ¬åœ°) |
| çŠ¶æ€æŸ¥è¯¢ | ~100ms | ~100ms |
| ä¸‹æ³¨éªŒè¯ | ~200ms | ~200ms |

---

## ğŸ› æ•…éšœå¤„ç†

### é—®é¢˜1ï¼šå€’è®¡æ—¶ä¸å‡†ç¡®

**åŸå› ï¼š** å®¢æˆ·ç«¯æ—¶é—´ä¸æœåŠ¡å™¨æ—¶é—´ä¸ä¸€è‡´

**è§£å†³ï¼š**
```typescript
// è®¡ç®—æ—¶é—´å·®å¹¶æ ¡å‡†
const serverTime = new Date(res.data.serverTime).getTime()
serverTimeDiff.value = serverTime - Date.now()

// æ¯60ç§’æ ¡å‡†ä¸€æ¬¡
if (localCountdown.value % 60 === 0) {
  fetchLotteryStatus()
}
```

### é—®é¢˜2ï¼šå°ç›˜æœŸé—´ä»å¯ä¸‹æ³¨

**åŸå› ï¼š** åªåœ¨å‰ç«¯éªŒè¯

**è§£å†³ï¼š**
```typescript
// åç«¯å¼ºåˆ¶éªŒè¯ï¼ˆå¿…é¡»ï¼‰
const betCheck = await this.countdownService.canPlaceBet()
if (!betCheck.canBet) {
  throw new BadRequestException(betCheck.reason)
}
```

### é—®é¢˜3ï¼šå€’è®¡æ—¶å¡é¡¿

**åŸå› ï¼š** æ¯ç§’è¯·æ±‚åç«¯

**è§£å†³ï¼š**
```typescript
// æœ¬åœ°å€’è®¡æ—¶ï¼Œå®šæ—¶åŒæ­¥
setInterval(() => {
  localCountdown.value-- // æœ¬åœ°æ›´æ–°
}, 1000)
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡
1. **APIå“åº”æ—¶é—´** - `/lottery/status` < 100ms
2. **åŒæ­¥é¢‘ç‡** - æ¯æœŸ ~4æ¬¡
3. **é”™è¯¯ç‡** - < 0.1%
4. **æ—¶é—´åå·®** - < 1ç§’

### æ—¥å¿—è®°å½•
```typescript
console.log('âœ“ åŒæ­¥æœåŠ¡å™¨çŠ¶æ€:', {
  æœŸå·: newStatus.currentPeriod,
  çŠ¶æ€: newStatus.status,
  å€’è®¡æ—¶: newStatus.countdown + 'ç§’',
  æœåŠ¡å™¨æ—¶é—´å·®: (serverTimeDiff.value / 1000).toFixed(1) + 'ç§’',
})
```

---

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

### 1. æ—¶åŒºè®¾ç½®
```bash
# ç¡®ä¿æœåŠ¡å™¨æ—¶åŒºæ­£ç¡®
TZ=Asia/Shanghai
```

### 2. å®šæ—¶ä»»åŠ¡
```typescript
// NestJS éœ€è¦å¯ç”¨è°ƒåº¦æ¨¡å—
@Module({
  imports: [ScheduleModule.forRoot()],
})
```

### 3. æ•°æ®åº“ç´¢å¼•
```sql
-- ä¼˜åŒ–æœŸå·æŸ¥è¯¢
CREATE INDEX idx_issue ON lottery_result(issue);
CREATE INDEX idx_bet_issue_user ON bets(issue, user_id);
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [USA28 API æ¥å£æ–‡æ¡£](../å¼€å¥–æ•°æ®æºæ¥å£æµ‹è¯•æŠ¥å‘Š.md)
- [å¼€å¥–æ•°æ®åŒæ­¥æŒ‡å—](./å¼€å¥–æ•°æ®åŒæ­¥æŒ‡å—.md)
- [ç”¨æˆ·ä¸‹æ³¨æµç¨‹æ–‡æ¡£](./ç”¨æˆ·ä¸‹æ³¨æµç¨‹.md)

---

**æ›´æ–°æ—¶é—´ï¼š** 2025-11-27  
**ç‰ˆæœ¬ï¼š** v1.0 - åç«¯æ§åˆ¶ç‰ˆæœ¬  
**ä½œè€…ï¼š** AI Assistant





