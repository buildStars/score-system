# ✅ 余额检查规则确认

## 当前实现逻辑

代码位置：`score-system/backend/src/modules/bet/bet.service.ts` (第159-178行)

### 规则 1: 倍数下注

**公式**：`最低余额 = 倍数 × 0.8 + 手续费`

```typescript
// 第159-164行
pendingMultiple.forEach(bet => {
  const fee = Number(((bet.amount / betSettings.multipleFeeBase) * betSettings.multipleFeeRate).toFixed(2));
  const loss = bet.amount * betSettings.multipleLossRate + fee;
  pendingLoss += loss;
});
```

**示例**：
- 倍数：1000
- 手续费：(1000 / 100) × 3 = 30
- 最低余额：1000 × 0.8 + 30 = **830**

✅ **符合规则**

---

### 规则 2: 大小单双下注

**公式**：`最低余额 = 本金`

```typescript
// 第166-169行
pendingBigSmallOddEven.forEach(bet => {
  pendingLoss += bet.amount;
});
```

**示例**：
- 本金：500
- 最低余额：**500**

✅ **符合规则**

---

### 规则 3: 单组合下注

**公式**：`最低余额 = 本金 × 5 + 手续费`

```typescript
// 第171-178行（单组合和多组合使用同一逻辑）
if (pendingCombo.length > 0) {
  const maxComboAmount = Math.max(...pendingCombo.map(b => b.amount));
  const comboTotalFee = pendingCombo.reduce((sum, bet) => {
    return sum + Number(((bet.amount / betSettings.comboFeeBase) * betSettings.comboFeeRate).toFixed(2));
  }, 0);
  pendingLoss += maxComboAmount * 5 + comboTotalFee;
}
```

**示例**：
- 本金：300
- 手续费：(300 / 100) × 5 = 15
- 最低余额：300 × 5 + 15 = **1515**

✅ **符合规则**

---

### 规则 4: 多组合下注

**公式**：`最低余额 = 最大本金组合 × 5 + 所有组合手续费总和`

```typescript
// 同上（第171-178行）
const maxComboAmount = Math.max(...pendingCombo.map(b => b.amount));
const comboTotalFee = pendingCombo.reduce((sum, bet) => {
  return sum + Number(((bet.amount / betSettings.comboFeeBase) * betSettings.comboFeeRate).toFixed(2));
}, 0);
pendingLoss += maxComboAmount * 5 + comboTotalFee;
```

**示例**（大单200 + 大双300 + 小单150）：
- 最大本金：300
- 手续费总和：10 + 15 + 7 = 32
- 最低余额：300 × 5 + 32 = **1532**

✅ **符合规则**

---

## 配置参数

当前使用的参数（从 `bet_settings` 表获取，默认值）：

| 参数 | 值 | 说明 |
|------|-----|------|
| `multipleLossRate` | **0.8** | 倍数下注损失率 |
| `multipleFeeRate` | **3** | 倍数手续费率（每100倍收3） |
| `multipleFeeBase` | **100** | 倍数手续费基数 |
| `comboFeeRate` | **5** | 组合手续费率（每100本金收5） |
| `comboFeeBase` | **100** | 组合手续费基数 |

---

## 总结

✅ **所有规则都已正确实现**

- 倍数下注：倍数 × 0.8 + 手续费
- 大小单双：本金
- 单组合：本金 × 5 + 手续费
- 多组合：最大本金 × 5 + 所有手续费总和

**注意事项**：
1. 手续费使用 `Math.floor()` 向下取整
2. 组合下注判断：`['大', '小', '单', '双']` 算大小单双，`['大单', '大双', '小单', '小双']` 算组合
3. 余额检查在下注前执行，计算公式：`可用余额 = 当前积分 - 未结算占用`
4. 如果 `可用余额 < 本次需要的最低余额`，则拒绝下注

