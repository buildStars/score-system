# ğŸ“‹ æ–°è§„åˆ™é‡æ„è¯´æ˜

## ğŸ”„ æ ¸å¿ƒæµç¨‹å˜æ›´

### âŒ æ—§æµç¨‹
1. ä¸‹æ³¨æ—¶ï¼šæ‰£é™¤ `æœ¬é‡‘ + æ‰‹ç»­è´¹`
2. ç»“ç®—æ—¶ï¼šè®¡ç®—å‡€ç›ˆäºï¼Œè°ƒæ•´ç§¯åˆ†

### âœ… æ–°æµç¨‹  
1. ä¸‹æ³¨æ—¶ï¼š**ä¸æ‰£åˆ†**ï¼Œåªæ£€æŸ¥"å¯ç”¨ä½™é¢"æ˜¯å¦è¶³å¤Ÿ
2. ç»“ç®—æ—¶ï¼šæ ¹æ®"ç»“ç®—åˆ†"**ç›´æ¥å¢å‡ç§¯åˆ†**

---

## ğŸ’° å…³é”®æ¦‚å¿µ

### 1. æœ€å¤§å¯èƒ½æŸå¤±ï¼ˆç”¨äºä¸‹æ³¨å‰æ£€æŸ¥ï¼‰

| ä¸‹æ³¨ç±»å‹ | æœ€å¤§å¯èƒ½æŸå¤± |
|---------|-------------|
| å€æ•°ä¸‹æ³¨ | `å€æ•° Ã— 0.8 + æ‰‹ç»­è´¹` |
| å¤§å°å•åŒ | `æœ¬é‡‘` |
| ç»„åˆä¸‹æ³¨ | `æœ¬é‡‘ Ã— 5 + æ‰‹ç»­è´¹` |

### 2. å¯ç”¨ä½™é¢è®¡ç®—

```
å¯ç”¨ä½™é¢ = å½“å‰ç§¯åˆ† - SUM(æ‰€æœ‰æœªç»“ç®—æ³¨å•çš„æœ€å¤§å¯èƒ½æŸå¤±)
```

### 3. ç»“ç®—åˆ†ï¼ˆSettlement Amountï¼‰

ç»“ç®—åˆ†æ˜¯ç›¸å¯¹äº**ä¸‹æ³¨å‰ç§¯åˆ†**çš„å˜åŒ–é‡ã€‚

#### å€æ•°ä¸‹æ³¨
- å›æœ¬ï¼š`+å€æ•° - æ‰‹ç»­è´¹`
- ä¸å›æœ¬ï¼š`-å€æ•° Ã— 0.8 - æ‰‹ç»­è´¹`

#### å¤§å°å•åŒ  
- å‘½ä¸­ & ä¸å›æœ¬ï¼š`+æœ¬é‡‘ Ã— 1.8`
- å‘½ä¸­ & å›æœ¬ï¼š`0`
- æœªå‘½ä¸­ï¼š`-æœ¬é‡‘`

#### ç»„åˆä¸‹æ³¨
- å‘½ä¸­ & ä¸å›æœ¬ï¼š`-æœ¬é‡‘ Ã— 5 - æ‰‹ç»­è´¹`
- å‘½ä¸­ & å›æœ¬ï¼š`-æ‰‹ç»­è´¹`
- æœªå‘½ä¸­ï¼š`+æœ¬é‡‘ - æ‰‹ç»­è´¹`

---

## ğŸ”§ å®æ–½æ­¥éª¤

### Step 1: ä¿®æ”¹ä¸‹æ³¨é€»è¾‘ï¼ˆbet.service.tsï¼‰

```typescript
async createBet(userId: number, createBetDto: CreateBetDto) {
  // ... å‰ç½®æ£€æŸ¥ ...
  
  // 1. è®¡ç®—æœ¬æ¬¡ä¸‹æ³¨çš„æœ€å¤§å¯èƒ½æŸå¤±
  const { minimumBalance } = calculateMinimumBalance(
    betType,
    amount,
    betContent,
    feeRate,
    feeBase
  );
  
  // 2. è®¡ç®—æ‰€æœ‰æœªç»“ç®—æ³¨å•çš„æœ€å¤§å¯èƒ½æŸå¤±
  const pendingBets = await this.prisma.bet.findMany({
    where: { userId, status: 'pending' }
  });
  
  const pendingLoss = pendingBets.reduce((sum, bet) => {
    const { minimumBalance: loss } = calculateMinimumBalance(
      bet.betType,
      bet.amount,
      bet.betContent,
      feeRate,
      feeBase
    );
    return sum + loss;
  }, 0);
  
  // 3. æ£€æŸ¥å¯ç”¨ä½™é¢
  const availableBalance = currentPoints - pendingLoss;
  if (availableBalance < minimumBalance) {
    throw new BadRequestException(
      `å¯ç”¨ä½™é¢ä¸è¶³ã€‚å½“å‰ç§¯åˆ†: ${currentPoints}, ` +
      `æœªç»“ç®—å ç”¨: ${pendingLoss}, ` +
      `å¯ç”¨ä½™é¢: ${availableBalance}, ` +
      `æœ¬æ¬¡éœ€è¦: ${minimumBalance}`
    );
  }
  
  // 4. åˆ›å»ºä¸‹æ³¨è®°å½•ï¼ˆä¸æ‰£åˆ†ï¼‰
  const bet = await tx.bet.create({
    data: {
      userId,
      issue: currentIssue,
      betType,
      betContent,
      amount,
      fee: betType === 'combo' && !['å¤§','å°','å•','åŒ'].includes(betContent) 
        ? calculateFee(amount, feeRate, feeBase) 
        : (betType === 'multiple' ? calculateFee(amount, feeRate, feeBase) : 0),
      pointsBefore: currentPoints,  // è®°å½•ä¸‹æ³¨æ—¶çš„ç§¯åˆ†
      status: 'pending',
    },
  });
  
  // 5. ä¸è®°å½• pointRecordï¼ˆä¸‹æ³¨æ—¶ä¸æ‰£åˆ†ï¼‰
  
  return bet;
}
```

### Step 2: ä¿®æ”¹ç»“ç®—é€»è¾‘ï¼ˆlottery.service.tsï¼‰

```typescript
async settleSingleBet(betId: bigint, lotteryResult: any) {
  return await this.prisma.$transaction(async (tx) => {
    const bet = await tx.bet.findUnique({  where: { id: betId } });
    
    // 1. è§£æå¼€å¥–å·ç 
    const { number1, number2, number3, resultSum } = parseLotteryNumbers(
      lotteryResult.resultLottery
    );
    
    // 2. åˆ¤æ–­æ˜¯å¦å›æœ¬
    const { isReturn: isReturnResult } = isReturn(
      number1,
      number2,
      number3,
      resultSum
    );
    
    // 3. æ ¹æ®ä¸‹æ³¨ç±»å‹è®¡ç®—ç»“ç®—åˆ†
    let settlementAmount = 0;
    let status: 'win' | 'loss' = 'loss';
    
    if (bet.betType === 'multiple') {
      const result = calculateMultipleBetResult(
        bet.amount,
        isReturnResult,
        feeRate,
        feeBase
      );
      settlementAmount = result.settlementAmount;
      status = result.status;
    } 
    else if (['å¤§','å°','å•','åŒ'].includes(bet.betContent)) {
      // å¤§å°å•åŒ
      const result = calculateBigSmallOddEvenResult(
        bet.amount,
        bet.betContent,
        resultSum,
        isReturnResult
      );
      settlementAmount = result.settlementAmount;
      status = result.status;
    }
    else {
      // ç»„åˆä¸‹æ³¨
      const result = calculateComboBetResult(
        bet.amount,
        bet.betContent,
        resultSum,
        isReturnResult,
        feeRate,
        feeBase
      );
      settlementAmount = result.settlementAmount;
      status = result.status;
    }
    
    // 4. æ›´æ–°ç”¨æˆ·ç§¯åˆ†
    const user = await tx.user.findUnique({ where: { id: bet.userId } });
    const currentPoints = Number(user.points);
    const newPoints = Math.floor(currentPoints + settlementAmount);
    
    await tx.user.update({
      where: { id: bet.userId },
      data: { points: newPoints },
    });
    
    // 5. æ›´æ–°ä¸‹æ³¨è®°å½•
    await tx.bet.update({
      where: { id: betId },
      data: {
        status,
        resultAmount: settlementAmount,  // ç»“ç®—åˆ†
        pointsAfter: newPoints,
        settledAt: new Date(),
      },
    });
    
    // 6. è®°å½•ç§¯åˆ†å˜åŠ¨
    await tx.pointRecord.create({
      data: {
        userId: bet.userId,
        type: status === 'win' ? 'win' : 'loss',
        amount: settlementAmount,  // ç»“ç®—åˆ†
        balanceBefore: currentPoints,
        balanceAfter: newPoints,
        relatedId: bet.id,
        relatedType: 'bet',
        remark: `æœŸå·${bet.issue}ç»“ç®—-${status === 'win' ? 'èµ¢' : 'è¾“'}(${bet.betType})`,
        operatorType: 'system',
      },
    });
  });
}
```

---

## âœ… éªŒè¯ä¾‹å­

### ä¾‹å­1ï¼šç»„åˆä¸‹æ³¨-æœªå‘½ä¸­

- ç”¨æˆ·ç§¯åˆ†ï¼š1000
- ä¸‹æ³¨ï¼š100ã€Œå¤§å•ã€
- å¼€å¥–ï¼šå°å•ï¼ˆæœªå‘½ä¸­ï¼‰
- æ‰‹ç»­è´¹ï¼š5

**æµç¨‹**ï¼š
1. ä¸‹æ³¨æ—¶ï¼šç§¯åˆ†ä»ä¸º 1000ï¼ˆä¸æ‰£åˆ†ï¼‰
2. ç»“ç®—æ—¶ï¼šsettlementAmount = +100 - 5 = +95
3. æœ€ç»ˆç§¯åˆ†ï¼š1000 + 95 = **1095** âœ…

### ä¾‹å­2ï¼šç»„åˆä¸‹æ³¨-å‘½ä¸­ä¸å›æœ¬  

- ç”¨æˆ·ç§¯åˆ†ï¼š2000
- ä¸‹æ³¨ï¼š100ã€Œå¤§åŒã€
- å¼€å¥–ï¼šå¤§åŒä¸”ä¸å›æœ¬
- æ‰‹ç»­è´¹ï¼š5

**æµç¨‹**ï¼š
1. ä¸‹æ³¨æ—¶ï¼šç§¯åˆ†ä»ä¸º 2000ï¼ˆä¸æ‰£åˆ†ï¼‰
2. ç»“ç®—æ—¶ï¼šsettlementAmount = -100Ã—5 - 5 = -505
3. æœ€ç»ˆç§¯åˆ†ï¼š2000 - 505 = **1495** âœ…

### ä¾‹å­3ï¼šå€æ•°ä¸‹æ³¨-å›æœ¬

- ç”¨æˆ·ç§¯åˆ†ï¼š5000
- ä¸‹æ³¨ï¼š1000å€
- å¼€å¥–ï¼šå›æœ¬
- æ‰‹ç»­è´¹ï¼š30

**æµç¨‹**ï¼š
1. ä¸‹æ³¨æ—¶ï¼šç§¯åˆ†ä»ä¸º 5000ï¼ˆä¸æ‰£åˆ†ï¼‰
2. ç»“ç®—æ—¶ï¼šsettlementAmount = +1000 - 30 = +970
3. æœ€ç»ˆç§¯åˆ†ï¼š5000 + 970 = **5970** âœ…

---

## ğŸ¯ å…³é”®å˜æ›´æ€»ç»“

1. **Bet è¡¨å­—æ®µ**ï¼š
   - `pointsBefore`ï¼šä¸‹æ³¨æ—¶çš„ç§¯åˆ†ï¼ˆä¸å˜ï¼‰
   - `pointsAfter`ï¼šç»“ç®—åçš„ç§¯åˆ†
   - `amount`ï¼šä¸‹æ³¨æœ¬é‡‘/å€æ•°
   - `fee`ï¼šæ‰‹ç»­è´¹ï¼ˆè®¡ç®—ä½†ä¸åœ¨ä¸‹æ³¨æ—¶æ‰£é™¤ï¼‰
   - `resultAmount`ï¼šç»“ç®—åˆ†ï¼ˆSettlement Amountï¼‰

2. **PointRecord è®°å½•**ï¼š
   - ä¸‹æ³¨æ—¶ï¼š**ä¸åˆ›å»ºè®°å½•**
   - ç»“ç®—æ—¶ï¼šåˆ›å»ºä¸€æ¡è®°å½•ï¼Œ`amount` = `settlementAmount`

3. **ä½™é¢æ£€æŸ¥**ï¼š
   - ä»"æ£€æŸ¥ç§¯åˆ†æ˜¯å¦ >= æœ¬é‡‘+æ‰‹ç»­è´¹"
   - æ”¹ä¸º"æ£€æŸ¥å¯ç”¨ä½™é¢æ˜¯å¦ >= æœ€å¤§å¯èƒ½æŸå¤±"
   - å¯ç”¨ä½™é¢ = å½“å‰ç§¯åˆ† - æ‰€æœ‰æœªç»“ç®—æ³¨å•çš„æœ€å¤§å¯èƒ½æŸå¤±

---

**é‡æ„æ—¶é—´**ï¼š2025-11-29  
**é‡æ„åŸå› **ï¼šå®Œå…¨æŒ‰ç…§æ–°è§„åˆ™å®æ–½  
**å½±å“èŒƒå›´**ï¼šä¸‹æ³¨ã€ç»“ç®—ã€ä½™é¢æ£€æŸ¥

