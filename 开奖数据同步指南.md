# ğŸ° å¼€å¥–æ•°æ®åŒæ­¥æŒ‡å—

## ğŸ“‹ é—®é¢˜è¯´æ˜

å¼€å¥–å†å²é¡µé¢æ²¡æœ‰æ•°æ®ï¼Œå› ä¸ºéœ€è¦ä»ç¬¬ä¸‰æ–¹å¹³å°åŒæ­¥å¼€å¥–æ•°æ®ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ³•ä¸€ï¼šæ‰‹åŠ¨åŒæ­¥å¼€å¥–æ•°æ®ï¼ˆæ¨èï¼‰

#### 1. åœ¨ç®¡ç†åå°æ“ä½œ

1. **ç™»å½•ç®¡ç†åå°**
   - è®¿é—®ï¼šhttp://localhost:5174
   - è´¦å·ï¼š`admin`
   - å¯†ç ï¼š`admin123`

2. **è¿›å…¥å¼€å¥–å†å²é¡µé¢**
   - ç‚¹å‡»å·¦ä¾§èœå•"å¼€å¥–å†å²"

3. **ç‚¹å‡»"åŒæ­¥å¼€å¥–æ•°æ®"æŒ‰é’®**
   - ç³»ç»Ÿä¼šè‡ªåŠ¨ä»é…ç½®çš„æ•°æ®æºè·å–æœ€æ–°å¼€å¥–æ•°æ®

#### 2. ä½¿ç”¨ API ç›´æ¥è°ƒç”¨

**POST è¯·æ±‚ï¼š**
```bash
curl -X POST http://localhost:3000/lottery/sync \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**ä½¿ç”¨ Postman æˆ–æµè§ˆå™¨è®¿é—®ï¼š**
```
POST http://localhost:3000/lottery/sync
```

---

### æ–¹æ³•äºŒï¼šé…ç½®è‡ªåŠ¨åŒæ­¥ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰

åç«¯å¯ä»¥é…ç½®å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒæ­¥å¼€å¥–æ•°æ®ã€‚

#### æ­¥éª¤ï¼š

1. **ç¡®è®¤æ•°æ®æºé…ç½®**

åœ¨ `backend/.env` æ–‡ä»¶ä¸­é…ç½®ï¼š
```env
# å¼€å¥–æ•°æ®æº API åœ°å€
LOTTERY_DATA_SOURCE=http://localhost:8081/userApi/Lott

# æˆ–è€…ä½¿ç”¨å®é™…çš„ç¬¬ä¸‰æ–¹å¹³å°åœ°å€
# LOTTERY_DATA_SOURCE=https://api.lottery-platform.com/latest
```

2. **æ•°æ®æº API æ ¼å¼è¦æ±‚**

ç¬¬ä¸‰æ–¹ API åº”è¯¥è¿”å›å¦‚ä¸‹æ ¼å¼ï¼š
```json
{
  "code": 200,
  "data": {
    "issue": "3330421",
    "lott": "5+3+8",
    "time": "2024-11-27 10:00:00"
  }
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `issue`: æœŸå·
- `lott`: å¼€å¥–å·ç ï¼ˆä¸‰ä¸ªæ•°å­—ï¼Œç”¨+åˆ†éš”ï¼‰
- `time`: å¼€å¥–æ—¶é—´

---

### æ–¹æ³•ä¸‰ï¼šæ‰‹åŠ¨æ·»åŠ æµ‹è¯•æ•°æ®

å¦‚æœæš‚æ—¶æ²¡æœ‰ç¬¬ä¸‰æ–¹æ•°æ®æºï¼Œå¯ä»¥æ‰‹åŠ¨æ·»åŠ æµ‹è¯•æ•°æ®ï¼š

#### 1. ç›´æ¥åœ¨æ•°æ®åº“æ’å…¥

```sql
INSERT INTO lottery_results (
  issue, 
  number1, 
  number2, 
  number3, 
  result_sum,
  is_return,
  return_reason,
  size_result,
  odd_even_result,
  combo_result,
  draw_time,
  is_settled,
  created_at
) VALUES 
  ('3330421', 5, 3, 8, 16, 0, NULL, 'å¤§', 'åŒ', 'å¤§åŒ', '2024-11-27 10:00:00', 0, NOW()),
  ('3330420', 6, 8, 9, 23, 1, 'é¡ºå­', 'å¤§', 'å•', 'å¤§å•', '2024-11-27 09:55:00', 1, NOW()),
  ('3330419', 2, 4, 7, 13, 0, NULL, 'å°', 'å•', 'å°å•', '2024-11-27 09:50:00', 1, NOW()),
  ('3330418', 1, 3, 5, 9, 0, NULL, 'å°', 'å•', 'å°å•', '2024-11-27 09:45:00', 1, NOW()),
  ('3330417', 8, 8, 8, 24, 1, 'è±¹å­', 'å¤§', 'åŒ', 'å¤§åŒ', '2024-11-27 09:40:00', 1, NOW());
```

#### 2. ä½¿ç”¨ Prisma Studioï¼ˆå›¾å½¢åŒ–ç•Œé¢ï¼‰

```bash
cd score-system/backend
npx prisma studio
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://localhost:5555ï¼Œæ‰‹åŠ¨æ·»åŠ æ•°æ®ã€‚

---

## ğŸ”§ é…ç½®å¼€å¥–æ•°æ®æº

### 1. åœ¨ç³»ç»Ÿè®¾ç½®ä¸­é…ç½®

1. ç™»å½•ç®¡ç†åå°
2. è¿›å…¥"ç½‘ç«™è®¾ç½®"é¡µé¢
3. æ‰¾åˆ°"å¼€å¥–æ•°æ®æºURLé…ç½®"
4. è¾“å…¥ç¬¬ä¸‰æ–¹å¹³å°çš„ API åœ°å€
5. ç‚¹å‡»"ä¿å­˜è®¾ç½®"

### 2. æµ‹è¯•æ•°æ®æºè¿æ¥

**æ£€æŸ¥æ•°æ®æºæ˜¯å¦å¯è®¿é—®ï¼š**
```bash
# æµ‹è¯•æ•°æ®æºè¿æ¥
curl http://localhost:8081/userApi/Lott
```

**é¢„æœŸè¿”å›ï¼š**
```json
{
  "code": 200,
  "data": {
    "issue": "3330421",
    "lott": "5+3+8",
    "time": "2024-11-27 10:00:00"
  }
}
```

---

## ğŸ“Š å¼€å¥–è§„åˆ™è¯´æ˜

### å›æœ¬åˆ¤å®šè§„åˆ™

ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦å›æœ¬ï¼š

1. **è±¹å­**ï¼ˆä¸‰ä¸ªæ•°å­—ç›¸åŒï¼‰- å›æœ¬
   - ä¾‹ï¼š1+1+1, 2+2+2, 9+9+9

2. **é¡ºå­**ï¼ˆä¸‰ä¸ªè¿ç»­æ•°å­—ï¼‰- å›æœ¬
   - ä¾‹ï¼š1+2+3, 5+6+7, 7+8+9

3. **å¯¹å­**ï¼ˆä¸¤ä¸ªæ•°å­—ç›¸åŒï¼‰- å›æœ¬
   - ä¾‹ï¼š1+1+2, 5+5+8, 7+7+9

4. **æ€»å’Œä¸º3æˆ–27**ï¼ˆç‰¹æ®Šæ•°å­—ï¼‰- å›æœ¬
   - ä¾‹ï¼š1+1+1ï¼ˆæ€»å’Œ3ï¼‰, 9+9+9ï¼ˆæ€»å’Œ27ï¼‰

### å¤§å°å•åŒåˆ¤å®š

- **æ€»å’Œ â‰¤ 13**ï¼šå°
- **æ€»å’Œ â‰¥ 14**ï¼šå¤§
- **æ€»å’Œä¸ºå¥‡æ•°**ï¼šå•
- **æ€»å’Œä¸ºå¶æ•°**ï¼šåŒ

### ç»„åˆç»“æœ

- **å¤§å•**ï¼šæ€»å’Œ â‰¥ 14 ä¸”ä¸ºå¥‡æ•°
- **å¤§åŒ**ï¼šæ€»å’Œ â‰¥ 14 ä¸”ä¸ºå¶æ•°
- **å°å•**ï¼šæ€»å’Œ â‰¤ 13 ä¸”ä¸ºå¥‡æ•°
- **å°åŒ**ï¼šæ€»å’Œ â‰¤ 13 ä¸”ä¸ºå¶æ•°

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1ï¼šåŒæ­¥å¤±è´¥ - æœªé…ç½®å¼€å¥–æ•°æ®æº

**é”™è¯¯ä¿¡æ¯ï¼š**
```
æœªé…ç½®å¼€å¥–æ•°æ®æº
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `LOTTERY_DATA_SOURCE` é…ç½®
2. æˆ–åœ¨ç®¡ç†åå°çš„"ç½‘ç«™è®¾ç½®"ä¸­é…ç½®

### é—®é¢˜2ï¼šå¼€å¥–æ•°æ®æ ¼å¼é”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼š**
```
å¼€å¥–æ•°æ®æ ¼å¼é”™è¯¯
```

**è§£å†³æ–¹æ¡ˆï¼š**
ç¡®ä¿ç¬¬ä¸‰æ–¹ API è¿”å›æ­£ç¡®çš„æ ¼å¼ï¼ˆå‚è€ƒä¸Šé¢çš„æ ¼å¼è¦æ±‚ï¼‰

### é—®é¢˜3ï¼šæ•°æ®æºæ— æ³•è®¿é—®

**é”™è¯¯ä¿¡æ¯ï¼š**
```
connect ECONNREFUSED
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥æ•°æ®æº URL æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. ç¡®è®¤ç¬¬ä¸‰æ–¹æœåŠ¡æ˜¯å¦è¿è¡Œ

### é—®é¢˜4ï¼šè¯¥æœŸå¼€å¥–æ•°æ®å·²å­˜åœ¨

**ä¿¡æ¯ï¼š**
```
è¯¥æœŸå¼€å¥–æ•°æ®å·²å­˜åœ¨
```

**è¯´æ˜ï¼š**
è¿™ä¸æ˜¯é”™è¯¯ï¼Œè¡¨ç¤ºè¯¥æœŸå·çš„æ•°æ®å·²ç»åŒæ­¥è¿‡äº†ã€‚

---

## ğŸ¯ å¿«é€Ÿæµ‹è¯•æµç¨‹

### 1. åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®æºï¼ˆå¯é€‰ï¼‰

å¦‚æœæ²¡æœ‰å®é™…çš„ç¬¬ä¸‰æ–¹å¹³å°ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªç®€å•çš„æ¨¡æ‹ŸæœåŠ¡ï¼š

**åˆ›å»ºæ–‡ä»¶ï¼š** `mock-lottery-api.js`

```javascript
const express = require('express');
const app = express();

app.get('/userApi/Lott', (req, res) => {
  // ç”Ÿæˆéšæœºå¼€å¥–å·ç 
  const num1 = Math.floor(Math.random() * 9) + 1;
  const num2 = Math.floor(Math.random() * 9) + 1;
  const num3 = Math.floor(Math.random() * 9) + 1;
  
  // ç”ŸæˆæœŸå·ï¼ˆå½“å‰æ—¶é—´æˆ³ï¼‰
  const issue = Date.now().toString().slice(-7);
  
  res.json({
    code: 200,
    data: {
      issue: issue,
      lott: `${num1}+${num2}+${num3}`,
      time: new Date().toISOString().slice(0, 19).replace('T', ' ')
    }
  });
});

app.listen(8081, () => {
  console.log('æ¨¡æ‹Ÿå¼€å¥–APIè¿è¡Œåœ¨ http://localhost:8081');
});
```

**å¯åŠ¨æ¨¡æ‹ŸæœåŠ¡ï¼š**
```bash
node mock-lottery-api.js
```

### 2. é…ç½®æ•°æ®æº

åœ¨ `.env` ä¸­ï¼š
```env
LOTTERY_DATA_SOURCE=http://localhost:8081/userApi/Lott
```

### 3. åŒæ­¥æ•°æ®

åœ¨ç®¡ç†åå°ç‚¹å‡»"åŒæ­¥å¼€å¥–æ•°æ®"æŒ‰é’®ã€‚

### 4. æŸ¥çœ‹ç»“æœ

åˆ·æ–°å¼€å¥–å†å²é¡µé¢ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æ–°çš„å¼€å¥–æ•°æ®ã€‚

---

## ğŸ“ è‡ªåŠ¨åŒæ­¥é…ç½®ï¼ˆé«˜çº§ï¼‰

### ä½¿ç”¨ BullMQ å®šæ—¶ä»»åŠ¡

åç«¯å¯ä»¥é…ç½®å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒæ­¥ï¼š

**ä¿®æ”¹ï¼š** `backend/src/modules/lottery/lottery.module.ts`

```typescript
import { Module } from '@nestjs/common';
import { BullModule } from '@nestjs/bullmq';
import { LotteryService } from './lottery.service';
import { LotteryController } from './lottery.controller';

@Module({
  imports: [
    BullModule.registerQueue({
      name: 'lottery-sync',
    }),
  ],
  controllers: [LotteryController],
  providers: [LotteryService, LotterySyncProcessor],
  exports: [LotteryService],
})
export class LotteryModule {}
```

**åˆ›å»ºå¤„ç†å™¨ï¼š** `lottery-sync.processor.ts`

```typescript
import { Processor, WorkerHost } from '@nestjs/bullmq';
import { Job } from 'bullmq';
import { LotteryService } from './lottery.service';

@Processor('lottery-sync')
export class LotterySyncProcessor extends WorkerHost {
  constructor(private lotteryService: LotteryService) {
    super();
  }

  async process(job: Job) {
    await this.lotteryService.syncLotteryData();
  }
}
```

### é…ç½®å®šæ—¶è§„åˆ™

æ¯5åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ï¼š
```typescript
// åœ¨ LotteryService ä¸­æ·»åŠ 
@Cron('*/5 * * * *') // æ¯5åˆ†é’Ÿ
async scheduledSync() {
  await this.syncLotteryData();
}
```

---

## âœ… éªŒè¯åŒæ­¥æˆåŠŸ

åŒæ­¥æˆåŠŸåï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°ï¼š

1. âœ… å¼€å¥–å†å²é¡µé¢æ˜¾ç¤ºæ•°æ®
2. âœ… æ¯æ¡è®°å½•åŒ…å«ï¼š
   - æœŸå·
   - å¼€å¥–å·ç ï¼ˆä¸‰ä¸ªæ•°å­—ï¼‰
   - æ€»å’Œ
   - å¤§å°ã€å•åŒ
   - æ˜¯å¦å›æœ¬
   - å¼€å¥–æ—¶é—´

---

**ç°åœ¨å»ç®¡ç†åå°è¯•è¯•"åŒæ­¥å¼€å¥–æ•°æ®"æŒ‰é’®å§ï¼** ğŸ‰



