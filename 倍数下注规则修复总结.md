# 倍数下注规则修复总结 ✅

## 📋 问题发现

### 错误的理解

**之前的理解**：回本 = 不输不赢，只扣手续费

```
最终积分 = 原积分 - 手续费
例子：5000 - 30 = 4970 ❌
```

### 正确的规则

**回本 = 用户赚钱**

```
最终积分 = 原积分 + 下注金额 - 手续费
例子：5000 + 1000 - 30 = 5970 ✅
```

---

## 🔧 修复内容

### 1. 业务规则文档 ✅

**文件**：`业务规则详解文档.md`

**修改**：
- 更新回本公式：`原积分 + 下注金额 - 手续费`
- 更新例子1：5000 + 1000 - 30 = 5970
- 更新例子2：2000 + 2000 - 60 = 3940

---

### 2. 后端代码 ✅

**文件**：`score-system/backend/src/modules/lottery/utils/lottery-rules.util.ts`

**修改前**：
```typescript
if (isReturn) {
  // 回本：只扣手续费
  return {
    fee,
    loss: 0,
    resultAmount: amount - fee,  // ❌ 错误！只返还本金
  };
}
```

**修改后**：
```typescript
if (isReturn) {
  // 回本：用户赚下注金额（扣手续费）
  // 公式：原积分 + 下注金额 - 手续费
  // 因为下注时已扣除amount，所以这里返还：amount(本金) + amount(赢的) - fee
  return {
    fee,
    loss: 0,
    resultAmount: amount + amount - fee,  // ✅ 返还2倍下注金额扣手续费
  };
}
```

**不回本逻辑也修正**：
```typescript
else {
  // 不回本：损失80% + 手续费
  // 公式：原积分 - 下注金额×0.8 - 手续费
  // 因为下注时已扣除amount，所以这里返还：amount - loss - fee = amount×0.2 - fee
  const loss = amount * lossRate;
  const returnAmount = amount - loss; // 返还20%本金
  return {
    fee,
    loss,
    resultAmount: returnAmount - fee,  // ✅ 返还20%本金扣手续费
  };
}
```

---

## 📊 验证计算

### 例子1：回本（5000 → 5970）

```
原积分：5000
下注：1000
手续费：30

流程：
1. 下注时：5000 - 1000 = 4000
2. 结算返还：2×1000 - 30 = 1970
3. 最终积分：4000 + 1970 = 5970 ✅

盈亏：+970
```

### 例子2：回本（2000 → 3940）

```
原积分：2000
下注：2000
手续费：60

流程：
1. 下注时：2000 - 2000 = 0
2. 结算返还：2×2000 - 60 = 3940
3. 最终积分：0 + 3940 = 3940 ✅

盈亏：+1940
```

### 例子3：不回本（5000 → 4170）

```
原积分：5000
下注：1000
损失：800（80%）
手续费：30

流程：
1. 下注时：5000 - 1000 = 4000
2. 结算返还：1000×0.2 - 30 = 170
3. 最终积分：4000 + 170 = 4170 ✅

盈亏：-830
```

### 例子4：不回本（2000 → 340）

```
原积分：2000
下注：2000
损失：1600（80%）
手续费：60

流程：
1. 下注时：2000 - 2000 = 0
2. 结算返还：2000×0.2 - 60 = 340
3. 最终积分：0 + 340 = 340 ✅

盈亏：-1660
```

---

## 🎯 核心逻辑

### 下注流程

```
1. 下注时
   用户积分 = 原积分 - 下注金额
   
2. 开奖后
   回本：
     返还金额 = 2×下注金额 - 手续费
     用户积分 = 当前积分 + 返还金额
   
   不回本：
     返还金额 = 下注金额×0.2 - 手续费
     用户积分 = 当前积分 + 返还金额
```

### 最终公式

```
回本：
  最终积分 = 原积分 + 下注金额 - 手续费

不回本：
  最终积分 = 原积分 - 下注金额×0.8 - 手续费
```

---

## ✅ 修复清单

- [x] 更新业务规则文档
- [x] 修复后端计算逻辑（回本）
- [x] 修复后端计算逻辑（不回本）
- [x] 验证所有例子
- [ ] 重启后端服务
- [ ] 测试真实下注和结算

---

## 🚀 部署步骤

### 1. 重启后端服务

```bash
cd D:\download\yunce\yunce\score-system\backend
# 停止当前服务
taskkill /F /IM node.exe

# 等待2秒
Start-Sleep -Seconds 2

# 重新启动
pnpm start:dev
```

### 2. 测试验证

**测试场景**：
- [ ] 测试回本情况（对子/豹子/顺子/13/14）
- [ ] 测试不回本情况
- [ ] 验证手续费计算
- [ ] 验证积分变动

**预期结果**：
- 回本：用户赚下注金额（扣手续费）
- 不回本：用户输80%本金+手续费
- 手续费：每100为3

---

## 📝 前端建议

### H5下注页面

**当前状态**：
- ✅ 已有倍数下注功能
- ✅ 已有金额输入框
- ✅ 已有快捷金额按钮
- ✅ 已有手续费计算

**建议优化**：
- 保持当前的金额输入方式
- 可选：将"下注倍数"改为"下注金额"（更准确）

---

## 🎉 总结

### 核心修复

✅ **回本规则修正**：从"不输不赢"改为"用户赚钱"  
✅ **后端代码修复**：返还2倍下注金额扣手续费  
✅ **不回本逻辑修正**：返还20%本金扣手续费  
✅ **所有例子验证**：4个例子全部通过

### 修改文件

1. `业务规则详解文档.md` - 更新规则说明
2. `score-system/backend/src/modules/lottery/utils/lottery-rules.util.ts` - 修复计算逻辑

### 影响范围

- ✅ 倍数下注结算逻辑
- ✅ 用户积分计算
- ✅ 盈亏统计

**现在倍数下注规则完全正确，符合你提供的所有例子！** ✅



