# 下注时预扣手续费优化 ✅

## 📋 需求说明

**原需求**：下注1000，手续费30，积分明细还是统计的-1000，应该是-1030

**核心改动**：下注时同时扣除本金+手续费，积分明细显示总扣款金额

---

## 🔄 改动前后对比

### 改动前

#### 倍数下注流程
```
1. 下注时：
   扣除: -1000（本金）
   积分明细: -1000
   
2. 结算时（回本）：
   返还: +1970（2000 - 30手续费）
   积分明细: +1970（含手续费30）
```

**问题**：用户看不到下注时真正扣了多少钱（实际1030，显示1000）

### 改动后

#### 倍数下注流程
```
1. 下注时：
   扣除: -1030（本金1000 + 手续费30）
   积分明细: -1030（本金1000+手续费30）
   
2. 结算时（回本）：
   返还: +2000（2倍本金）
   积分明细: +2000（手续费已预扣）
```

**优势**：用户清楚看到下注时扣了1030

---

## 📐 新的计算逻辑

### 倍数下注

#### 下注阶段
```typescript
// 计算手续费
const fee = Math.floor((amount / 100) * 3);  // 1000 / 100 * 3 = 30

// 计算总扣款
const totalDeduct = amount + fee;  // 1000 + 30 = 1030

// 扣除积分
const newPoints = currentPoints - totalDeduct;  // 5000 - 1030 = 3970

// 积分明细
{
  type: 'bet',
  amount: -1030,  // ✅ 显示总扣款
  remark: '期号3364710 倍数下注（本金1000+手续费30）'
}
```

#### 结算阶段（回本）
```typescript
// 手续费已预扣，直接返还2倍本金
const resultAmount = 2 * amount;  // 2 * 1000 = 2000

// 更新积分
const finalPoints = 3970 + 2000;  // 5970 ✅

// 积分明细
{
  type: 'win',
  amount: +2000,
  remark: '期号3364710下注结算-中奖（含手续费30）'
}
```

#### 结算阶段（不回本）
```typescript
// 手续费已预扣，返还20%本金
const resultAmount = Math.floor(amount * 0.2);  // 1000 * 0.2 = 200

// 更新积分
const finalPoints = 3970 + 200;  // 4170 ✅

// 积分明细
{
  type: 'loss',
  amount: +200,
  remark: '期号3364710下注结算-未中（含手续费30）'
}
```

### 组合下注（反向逻辑）

#### 下注阶段
```typescript
// 计算手续费
const fee = Math.floor((amount / 100) * 5);  // 100 / 100 * 5 = 5

// 计算总扣款
const totalDeduct = amount + fee;  // 100 + 5 = 105

// 扣除积分
const newPoints = currentPoints - totalDeduct;  // 1000 - 105 = 895

// 积分明细
{
  type: 'bet',
  amount: -105,  // ✅ 显示总扣款
  remark: '期号3364710 组合下注（本金100+手续费5）'
}
```

#### 结算阶段（未中奖-用户赢）
```typescript
// 手续费已预扣，返还2倍本金
const resultAmount = 2 * amount;  // 2 * 100 = 200

// 更新积分
const finalPoints = 895 + 200;  // 1095 ✅

// 积分明细
{
  type: 'win',
  amount: +200,
  remark: '期号3364710下注结算-中奖（含手续费5）'
}
```

#### 结算阶段（中奖且回本）
```typescript
// 手续费已预扣，只返还本金
const resultAmount = amount;  // 100

// 更新积分
const finalPoints = 1895 + 100;  // 1995 ✅

// 积分明细
{
  type: 'loss',
  amount: +100,
  remark: '期号3364710下注结算-未中（含手续费5）'
}
```

#### 结算阶段（中奖且不回本）
```typescript
// 手续费已预扣，再扣4倍本金（总共5倍）
const resultAmount = -4 * amount;  // -4 * 100 = -400

// 更新积分
const finalPoints = 1895 - 400;  // 1495 ✅

// 积分明细
{
  type: 'loss',
  amount: -400,
  remark: '期号3364710下注结算-未中（含手续费5）'
}
```

---

## 🔧 代码修改

### 1. 下注服务（`bet.service.ts`）

#### 计算总扣款
```typescript
// 计算手续费（下注时扣除）
const feeWithDecimal = betType === 'multiple'
  ? (amount / betSettings.multipleFeeBase) * betSettings.multipleFeeRate
  : (amount / betSettings.comboFeeBase) * betSettings.comboFeeRate;
const fee = Math.floor(feeWithDecimal);  // 向下取整

// ✅ 计算总扣除金额（本金 + 手续费）
const totalDeduct = amount + fee;
```

#### 扣除积分
```typescript
// ✅ 扣除用户积分（本金 + 手续费）
const currentPoints = Number(user.points);
const newPoints = Math.floor(currentPoints - totalDeduct);

await tx.user.update({
  where: { id: userId },
  data: { points: newPoints },
});
```

#### 记录积分明细
```typescript
// ✅ 记录积分变动（显示总扣除金额）
await tx.pointRecord.create({
  data: {
    userId,
    type: 'bet',
    amount: -totalDeduct,  // 显示本金+手续费
    balanceBefore: currentPoints,
    balanceAfter: newPoints,
    relatedId: bet.id,
    relatedType: 'bet',
    remark: `期号${currentIssue} ${betType === 'multiple' ? '倍数' : '组合'}下注（本金${amount}+手续费${fee}）`,
    operatorType: 'system',
  },
});
```

### 2. 倍数下注计算（`lottery-rules.util.ts`）

```typescript
export function calculateMultipleBetResult(
  amount: number,
  isReturn: boolean,
  feeRate: number,
  feeBase: number,
  lossRate: number,
): {
  fee: number;
  loss: number;
  resultAmount: number;
} {
  const fee = Math.floor((amount / feeBase) * feeRate);
  
  if (isReturn) {
    // ✅ 回本：返还2倍本金（手续费已预扣）
    const resultAmount = Math.floor(2 * amount);
    return { fee, loss: 0, resultAmount };
  } else {
    // ✅ 不回本：返还20%本金（手续费已预扣）
    const returnAmount = Math.floor(amount * 0.2);
    return {
      fee,
      loss: Math.floor(amount * lossRate),
      resultAmount: returnAmount,
    };
  }
}
```

### 3. 组合下注计算（`lottery-rules.util.ts`）

```typescript
export function calculateComboBetResult(
  amount: number,
  betContent: string,
  comboResult: string,
  isReturn: boolean,
  feeRate: number,
  feeBase: number,
): {
  fee: number;
  resultAmount: number;
} {
  const fee = Math.floor((amount / feeBase) * feeRate);
  
  // 判断是否中奖（反向逻辑）
  const isMatched = betContent === comboResult;
  
  if (!isMatched) {
    // ✅ 未中奖：返还2倍本金
    return {
      fee,
      resultAmount: Math.floor(2 * amount),
    };
  }
  
  if (isReturn) {
    // ✅ 中奖且回本：返还本金
    return {
      fee,
      resultAmount: Math.floor(amount),
    };
  }
  
  // ✅ 中奖且不回本：扣除额外4倍本金
  return {
    fee,
    resultAmount: Math.floor(-4 * amount),
  };
}
```

### 4. 结算服务（`lottery.service.ts`）

```typescript
// ✅ 组合下注调用
const result = calculateComboBetResult(
  Number(bet.amount),
  bet.betContent,  // 用户下注的组合
  lotteryResult.comboResult,  // 开奖组合结果
  lotteryResult.isReturn === 1,  // 是否回本
  betSettings.comboFeeRate,
  betSettings.comboFeeBase,
);

resultAmount = result.resultAmount;
fee = result.fee;
// ✅ 反向逻辑：resultAmount > 0 表示赢钱
status = resultAmount > 0 ? 'win' : 'loss';
```

---

## 📊 完整示例

### 倍数下注示例

**用户积分**：5000

#### 下注（期号3364710）
```
扣除: 1000（本金）+ 30（手续费）= 1030
余额: 5000 - 1030 = 3970

积分明细：
类型: bet
金额: -1030  ✅（本金+手续费）
余额: 3970
备注: 期号3364710 倍数下注（本金1000+手续费30）
```

#### 结算（回本）
```
返还: 2000（2倍本金）
余额: 3970 + 2000 = 5970 ✅

积分明细：
类型: win
金额: +2000  ✅
余额: 5970
备注: 期号3364710下注结算-中奖（含手续费30）
```

**积分流水**：
| 时间 | 类型 | 金额 | 余额 | 备注 |
|------|------|------|------|------|
| 15:25 | 下注 | -1030 | 3970 | 期号3364710 倍数下注（本金1000+手续费30）|
| 15:28 | 中奖 | +2000 | 5970 | 期号3364710下注结算-中奖（含手续费30）|

### 组合下注示例

**用户积分**：2000

#### 下注（期号3364711）
```
扣除: 100（本金）+ 5（手续费）= 105
余额: 2000 - 105 = 1895

积分明细：
类型: bet
金额: -105  ✅（本金+手续费）
余额: 1895
备注: 期号3364711 组合下注（本金100+手续费5）
```

#### 结算（中奖且不回本）
```
扣除: 400（额外4倍本金）
余额: 1895 - 400 = 1495 ✅

积分明细：
类型: loss
金额: -400  ✅
余额: 1495
备注: 期号3364711下注结算-未中（含手续费5）
```

**积分流水**：
| 时间 | 类型 | 金额 | 余额 | 备注 |
|------|------|------|------|------|
| 15:29 | 下注 | -105 | 1895 | 期号3364711 组合下注（本金100+手续费5）|
| 15:32 | 未中 | -400 | 1495 | 期号3364711下注结算-未中（含手续费5）|

---

## ✅ 优化效果

### 1. 用户体验
- ✅ 积分明细清晰显示总扣款（本金+手续费）
- ✅ 用户能准确知道下注时实际扣了多少钱
- ✅ 结算时的金额更直观（纯输赢金额）

### 2. 逻辑一致性
- ✅ 手续费在下注时一次性扣除
- ✅ 结算时只处理输赢，逻辑更简单
- ✅ 积分流水记录更清晰

### 3. 数据准确性
- ✅ 积分明细与实际扣款一致
- ✅ 所有计算向下取整（Math.floor）
- ✅ 手续费不会重复扣除

---

## 🎉 总结

### 核心改动

1. **下注时**：扣除本金+手续费，积分明细显示-1030
2. **结算时**：只返还输赢金额，手续费已预扣

### 计算公式

#### 倍数下注
```
下注扣除 = 本金 + 手续费
回本返还 = 2 * 本金
不回本返还 = 20% * 本金
```

#### 组合下注
```
下注扣除 = 本金 + 手续费
未中奖返还 = 2 * 本金
中奖且回本返还 = 本金
中奖且不回本扣除 = 额外4倍本金
```

---

**最后更新**: 2025-11-27
**状态**: ✅ 已完成，等待重启验证



