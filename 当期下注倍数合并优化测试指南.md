# 当期下注倍数合并优化 - 测试指南

## 测试目标

验证倍数下注的合并显示和一键取消功能是否正常工作。

---

## 测试前准备

### 1. 启动服务
```bash
# 后端
cd score-system/backend
npm run start:dev

# 前端H5
cd score-system/frontend-h5
npm run dev
```

### 2. 准备测试账号
- 账号：testuser（或其他测试账号）
- 确保有足够的积分（建议 >10000分）

### 3. 确认当前游戏状态
- 确保游戏已开启
- 确保当前未封盘（可以下注）

---

## 核心测试场景

### 测试1：倍数下注合并显示 ⭐

#### 目的
验证多次倍数下注会合并为一个显示项。

#### 步骤
1. 打开H5首页 http://localhost:5173
2. 登录测试账号
3. 记录当前积分（如：10000分）
4. 进行第一次倍数下注：
   - 选择"倍数下注"标签
   - 设置：每倍100分，倍数10倍
   - 总金额：1000分
   - 点击"确认下注"
   - 确认对话框点击"确认"
5. 查看"本期下注"区域
6. 进行第二次倍数下注：
   - 设置：每倍100分，倍数5倍
   - 总金额：500分
   - 点击"确认下注"
   - 确认对话框点击"确认"
7. 查看"本期下注"区域
8. 进行第三次倍数下注：
   - 设置：每倍100分，倍数3倍
   - 总金额：300分
   - 点击"确认下注"
   - 确认对话框点击"确认"
9. 查看"本期下注"区域

#### 预期结果
- ✅ 第一次下注后，显示："倍数 1000分 ❌"
- ✅ 第二次下注后，自动更新为："倍数 1500分 ❌"
- ✅ 第三次下注后，自动更新为："倍数 1800分 ❌"
- ✅ 始终只有**一个**倍数下注项
- ✅ 金额累加正确：1000 + 500 + 300 = 1800
- ✅ 用户积分正确减少：
  - 1000 + 30(手续费) = 1030
  - 500 + 15(手续费) = 515
  - 300 + 9(手续费) = 309
  - 总计：10000 - 1854 = 8146分

---

### 测试2：倍数下注一键取消 ⭐⭐

#### 目的
验证点击倍数下注的取消按钮会取消所有倍数下注。

#### 前置条件
完成测试1，当前显示"倍数 1800分"

#### 步骤
1. 点击"倍数"右侧的红色❌图标
2. 查看确认对话框内容
3. 点击"确定取消"按钮
4. 查看成功提示
5. 查看"本期下注"区域
6. 查看用户积分

#### 预期结果
- ✅ 确认对话框显示：
  ```
  标题：确认取消
  内容：确定要取消 倍数 的下注吗？
        取消后将退回积分到您的账户。
  按钮：红色"确定取消"、灰色"我再想想"
  ```
- ✅ 成功提示显示：
  ```
  ✅ 取消成功！
  退回积分：1854
  ```
- ✅ "本期下注"区域消失（无其他下注）
- ✅ 用户积分恢复：8146 + 1854 = 10000分

#### 验证计算
退回积分 = 所有下注金额 + 所有手续费
- 下注金额：1000 + 500 + 300 = 1800
- 手续费：30 + 15 + 9 = 54
- 退回积分：1800 + 54 = 1854 ✅

---

### 测试3：混合下注（倍数+组合） ⭐

#### 目的
验证倍数下注和组合下注可以独立管理。

#### 步骤
1. 进行倍数下注：
   - 每倍100分，倍数10倍，总金额1000分
   - 确认下注
2. 查看"本期下注"区域
3. 切换到"组合下注"标签
4. 进行组合下注：
   - 选择"大"
   - 输入金额：500
   - 确认下注
5. 查看"本期下注"区域
6. 再次进行倍数下注：
   - 切换回"倍数下注"标签
   - 每倍100分，倍数5倍，总金额500分
   - 确认下注
7. 查看"本期下注"区域
8. 再次进行组合下注：
   - 选择"小双"
   - 输入金额：300
   - 确认下注
9. 查看"本期下注"区域

#### 预期结果
- ✅ 第1步后，显示："倍数 1000分 ❌"
- ✅ 第4步后，显示两项：
  - "倍数 1000分 ❌"
  - "大 500分 ❌"
- ✅ 第6步后，显示两项：
  - "倍数 1500分 ❌"（合并）
  - "大 500分 ❌"
- ✅ 第8步后，显示三项：
  - "倍数 1500分 ❌"
  - "大 500分 ❌"
  - "小双 300分 ❌"

---

### 测试4：独立取消（混合下注） ⭐⭐

#### 前置条件
完成测试3，当前显示3个下注项

#### 步骤
1. 点击"大"右侧的❌
2. 确认取消
3. 查看"本期下注"区域
4. 点击"倍数"右侧的❌
5. 确认取消
6. 查看"本期下注"区域
7. 点击"小双"右侧的❌
8. 确认取消
9. 查看"本期下注"区域

#### 预期结果
- ✅ 第2步后，只剩两项：
  - "倍数 1500分 ❌"
  - "小双 300分 ❌"
  - 提示："✅ 取消成功！退回积分：525"（500+25手续费）
- ✅ 第5步后，只剩一项：
  - "小双 300分 ❌"
  - 提示："✅ 取消成功！退回积分：1545"（1500+45手续费）
- ✅ 第8步后，区域完全消失
  - 提示："✅ 取消成功！退回积分：315"（300+15手续费）
- ✅ 所有积分正确退回

---

### 测试5：组合下注合并（不受影响） ⭐

#### 目的
验证组合下注仍然按内容分组，不受倍数下注优化影响。

#### 步骤
1. 进行组合下注：
   - 选择"大"
   - 输入金额：500
   - 确认下注
2. 查看"本期下注"区域
3. 再次进行组合下注：
   - 选择"小双"
   - 输入金额：300
   - 确认下注
4. 查看"本期下注"区域
5. 再次进行组合下注：
   - 选择"大"（与第1步相同）
   - 输入金额：200
   - 确认下注
6. 查看"本期下注"区域

#### 预期结果
- ✅ 第1步后，显示："大 500分 ❌"
- ✅ 第3步后，显示两项：
  - "大 500分 ❌"
  - "小双 300分 ❌"
- ✅ 第5步后，显示两项：
  - "大 700分 ❌"（合并）
  - "小双 300分 ❌"

---

### 测试6：封盘后无法取消 ⭐

#### 目的
验证封盘后倍数下注也无法取消。

#### 步骤
1. 进行倍数下注：1000分
2. 查看"本期下注"区域
3. 等待至封盘（倒计时标题变为"距离开奖"）
4. 刷新页面（确保状态同步）
5. 查看"本期下注"区域

#### 预期结果
- ✅ 下注后显示："倍数 1000分 ❌"
- ✅ 封盘后：
  - "❌"图标消失
  - 显示灰色"已封盘"文字
  - 无法点击取消

---

### 测试7：跨期不混淆 ⭐

#### 目的
验证不同期的倍数下注不会混淆。

#### 步骤
1. 记录当前期号（如：3364706）
2. 进行倍数下注：1000分
3. 查看"本期下注"区域
4. 等待该期开奖并切换到下一期（如：3364707）
5. 查看"本期下注"区域
6. 进行倍数下注：500分
7. 查看"本期下注"区域

#### 预期结果
- ✅ 第2步后，显示："倍数 1000分 ❌"（期号：3364706）
- ✅ 第4步后，区域消失（上一期已结算）
- ✅ 第6步后，显示："倍数 500分 ❌"（期号：3364707）
- ✅ 不同期的下注不会混淆

---

### 测试8：快速连续下注 ⭐

#### 目的
验证快速连续下注时的稳定性。

#### 步骤
1. 快速连续进行5次倍数下注：
   - 第1次：100分
   - 第2次：200分
   - 第3次：300分
   - 第4次：400分
   - 第5次：500分
   - 每次点击确认后立即进行下一次
2. 查看"本期下注"区域

#### 预期结果
- ✅ 最终显示："倍数 1500分 ❌"
- ✅ 金额正确：100+200+300+400+500 = 1500
- ✅ 无UI异常或卡顿
- ✅ 积分计算正确

---

### 测试9：取消后重新下注 ⭐

#### 目的
验证取消后可以重新下注。

#### 步骤
1. 进行倍数下注：1000分
2. 查看"本期下注"区域
3. 取消该下注
4. 再次进行倍数下注：800分
5. 查看"本期下注"区域
6. 再次进行倍数下注：200分
7. 查看"本期下注"区域

#### 预期结果
- ✅ 第1步后，显示："倍数 1000分 ❌"
- ✅ 第3步后，区域消失
- ✅ 第4步后，显示："倍数 800分 ❌"
- ✅ 第6步后，显示："倍数 1000分 ❌"（800+200合并）

---

## API测试

### 测试API 1：获取当期下注（合并后）

```bash
# 先下注两次倍数
# 然后调用API

curl -X GET http://localhost:3000/api/user/current-issue-bets \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**预期响应：**
```json
{
  "code": 200,
  "data": {
    "issue": "3364706",
    "bets": [
      {
        "betType": "multiple",
        "betContent": "multiple",  // ← 合并标识
        "totalAmount": 1500,
        "totalFee": 45,
        "betIds": [1, 2]
      }
    ],
    "canCancel": true
  }
}
```

### 测试API 2：取消倍数下注

```bash
curl -X POST http://localhost:3000/api/user/cancel-bet \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "issue": "3364706",
    "betType": "multiple",
    "betContent": "multiple"
  }'
```

**预期响应：**
```json
{
  "code": 200,
  "data": {
    "message": "取消成功",
    "refundAmount": 1545,
    "newPoints": 10000
  }
}
```

---

## 边缘情况测试

### 边缘1：下注金额为0（应失败）
- 尝试下注0分
- ✅ 预期：前端提示"请输入有效的金额"

### 边缘2：积分不足（应失败）
- 当前积分：100分
- 尝试下注：1000分
- ✅ 预期：前端提示"积分不足"

### 边缘3：网络异常（应优雅处理）
- 断开网络
- 尝试下注
- ✅ 预期：显示"网络连接失败"

### 边缘4：后端错误（应优雅处理）
- 停止后端服务
- 刷新页面
- ✅ 预期：加载失败有提示，不崩溃

---

## 性能测试

### 性能1：大量下注合并
- 连续下注20次倍数下注
- ✅ 预期：
  - 界面仍显示一个"倍数"项
  - 刷新速度正常（<500ms）
  - 无卡顿

### 性能2：混合大量下注
- 10次倍数下注
- 10次组合下注（各种类型）
- ✅ 预期：
  - 正确分组显示
  - 界面流畅

---

## 测试检查清单

### 功能测试
- [ ] 倍数下注自动合并显示
- [ ] 合并后显示"倍数"（不含具体数值）
- [ ] 显示正确的总金额
- [ ] 一键取消所有倍数下注
- [ ] 退款金额计算正确
- [ ] 组合下注不受影响
- [ ] 混合下注可独立管理
- [ ] 封盘后无法取消
- [ ] 跨期不混淆

### UI测试
- [ ] 显示文字正确："倍数"
- [ ] 金额格式化正确（千分位）
- [ ] 取消图标显示正确
- [ ] 确认对话框文案正确
- [ ] 成功提示含退款金额

### 交互测试
- [ ] 点击取消弹出确认框
- [ ] 确认后执行取消
- [ ] 取消后自动刷新
- [ ] 下注后自动刷新
- [ ] 快速操作不卡顿

### 数据准确性
- [ ] 金额累加正确
- [ ] 手续费计算正确
- [ ] 退款金额正确
- [ ] 积分变化正确
- [ ] 数据库状态正确

### 兼容性
- [ ] Chrome浏览器正常
- [ ] 移动端浏览器正常
- [ ] 不同屏幕尺寸适配

---

## 问题记录表

| 测试场景 | 发现问题 | 严重程度 | 状态 |
|---------|---------|---------|------|
| 示例 | 示例问题描述 | 高/中/低 | 待修复/已修复 |
|  |  |  |  |
|  |  |  |  |

---

## 测试总结

### 测试环境
- 测试日期：[填写]
- 测试人员：[填写]
- 后端版本：[填写]
- 前端版本：[填写]
- 浏览器：[填写]

### 测试结果
- 通过测试数：[X]/9
- 失败测试数：[X]/9
- 阻塞问题数：[X]

### 结论
- [ ] 功能正常，可以上线
- [ ] 存在问题，需要修复

### 备注
[填写其他说明]

---

## 快速验证脚本

如果需要快速验证核心功能，可以按以下最小流程测试：

1. ✅ 下注两次倍数 → 验证合并显示
2. ✅ 点击取消 → 验证一键取消
3. ✅ 下注倍数+组合 → 验证独立管理

**总计3个步骤，约2分钟完成核心验证。**

---

测试完成后，请将测试结果反馈给开发团队！🧪





