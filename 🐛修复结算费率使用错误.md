# ğŸ› ä¿®å¤ç»“ç®—æ—¶è´¹ç‡ä½¿ç”¨é”™è¯¯å¯¼è‡´ resultAmount éƒ½æ˜¯æ•´æ•°

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šæ‰€æœ‰ `resultAmount` éƒ½æ˜¯æ•´æ•° `.00` ç»“å°¾ï¼ˆ-84.00, -830.00, -276.00...ï¼‰ï¼Œæ€€ç–‘è®¡ç®—æœ‰é—®é¢˜ã€‚

### å®é™…é…ç½®ï¼ˆå¸¦å°æ•°çš„è´¹ç‡ï¼‰

```json
{
  "multiple": { "feeRate": "0.0378" },    // 3.78%
  "big_odd": { "feeRate": "0.07" },       // 7%
  "big_even": { "feeRate": "0.105" },     // 10.5%
  "small_odd": { "feeRate": "0.105" },    // 10.5%
  "small_even": { "feeRate": "0.07" }     // 7%
}
```

### é¢„æœŸç»“æœï¼ˆåº”è¯¥æœ‰å°æ•°ï¼‰

```typescript
// 100å€ Ã— 3.78% = 3.78
// ç»“ç®—åˆ† = -(100 Ã— 0.8 + 3.78) = -83.78 âœ“

// 500å°åŒ Ã— 10.5% = 52.5
// ç»“ç®—åˆ† = 500 - 52.5 = 447.5 âœ“
```

### å®é™…ç»“æœï¼ˆå…¨æ˜¯æ•´æ•°ï¼‰

```
-84.00, -830.00, -276.00, -735.00...ï¼ˆå…¨æ˜¯ .00 ç»“å°¾ï¼‰
```

## æ ¹æœ¬åŸå› 

**æ–‡ä»¶**ï¼š`score-system/backend/src/modules/lottery/lottery.service.ts`

### é—®é¢˜1ï¼šå€æ•°ä¸‹æ³¨ä½¿ç”¨äº†é€šç”¨é»˜è®¤è´¹ç‡

```typescript
// âŒ é”™è¯¯çš„ä»£ç 
const betSettings = await this.getBetSettings();  // è¿”å›å›ºå®šçš„ 3% å’Œ 5%

const result = calculateMultipleBetResult(
  Number(bet.amount),
  isReturn,
  betSettings.multipleFeeRate,  // âŒ ä½¿ç”¨é€šç”¨é»˜è®¤å€¼ 3ï¼Œè€Œä¸æ˜¯é…ç½®çš„ 3.78
  betSettings.multipleFeeBase,
);
```

**`getBetSettings()` æ–¹æ³•çš„é—®é¢˜**ï¼š
```typescript
private async getBetSettings() {
  const multipleConfig = settingsMap['multiple'] || {};
  return {
    multipleFeeRate: (multipleConfig.feeRate || 0.03) * 100,  // âŒ å¦‚æœ feeRate æ˜¯ 0.0378ï¼Œè¿™é‡Œå˜æˆ 3.78
  };
}
```

è™½ç„¶è¿™ä¸ªæ–¹æ³•è¯»å–äº†é…ç½®ï¼Œä½†åœ¨æŸäº›ç¯å¢ƒä¸­å¯èƒ½è¯»å–åˆ°æ—§çš„é»˜è®¤å€¼ `0.03`ã€‚

### é—®é¢˜2ï¼šç»„åˆä¸‹æ³¨æ‰€æœ‰ç±»å‹éƒ½ç”¨ big_odd çš„è´¹ç‡

```typescript
// âŒ é”™è¯¯çš„ä»£ç 
const comboConfig = settingsMap['big_odd'] || {};  // æ‰€æœ‰ç»„åˆéƒ½ç”¨ big_odd çš„è´¹ç‡

return {
  comboFeeRate: (comboConfig.feeRate || 0.05) * 100,  // big_odd: 7%
};

// ç»“ç®—æ—¶æ‰€æœ‰ç»„åˆéƒ½ç”¨è¿™ä¸ªè´¹ç‡
const result = calculateComboBetResult(
  Number(bet.amount),
  bet.betContent,
  lotteryResult.resultSum,
  isReturn,
  betSettings.comboFeeRate,  // âŒ å¤§å•ã€å¤§åŒã€å°å•ã€å°åŒéƒ½ç”¨ 7%
  betSettings.comboFeeBase,
);
```

**é—®é¢˜**ï¼š
- é…ç½®ä¸­ `big_even: 10.5%`, `small_odd: 10.5%`ï¼Œä½†ç»“ç®—æ—¶éƒ½ç”¨äº† `big_odd: 7%`
- `1000 Ã— 7% = 70`ï¼ˆæ•´æ•°ï¼‰ â†’ resultAmount æ˜¯æ•´æ•°

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹ `settleBets` æ–¹æ³•

åœ¨ç»“ç®—æ¯ç¬”ä¸‹æ³¨æ—¶ï¼Œ**åŠ¨æ€è·å–è¯¥ betType çš„å‡†ç¡®è´¹ç‡**ï¼š

```typescript
// âœ… ä¿®å¤åçš„ä»£ç 

// 2.1 è·å–æ‰€æœ‰ä¸‹æ³¨ç±»å‹é…ç½®ï¼ˆç”¨äºæŒ‰ç±»å‹è·å–å‡†ç¡®è´¹ç‡ï¼‰
const betTypeSettings = await this.prisma.betTypeSetting.findMany();
const betTypeSettingsMap = new Map(
  betTypeSettings.map(s => [s.betType, s])
);

// ç»“ç®—å€æ•°ä¸‹æ³¨
if (bet.betType === 'multiple') {
  const betTypeSetting = betTypeSettingsMap.get('multiple');
  const multipleFeeRate = betTypeSetting 
    ? Number(betTypeSetting.feeRate) * 100  // âœ… 0.0378 -> 3.78
    : betSettings.multipleFeeRate;
  
  const result = calculateMultipleBetResult(
    Number(bet.amount),
    isReturn,
    multipleFeeRate,  // âœ… ä½¿ç”¨é…ç½®çš„ 3.78
    betSettings.multipleFeeBase,
  );
}

// ç»“ç®—ç»„åˆä¸‹æ³¨
else {
  const betTypeSetting = betTypeSettingsMap.get(bet.betType);  // âœ… æ ¹æ®å…·ä½“ç±»å‹è·å–
  const comboFeeRate = betTypeSetting 
    ? Number(betTypeSetting.feeRate) * 100  // âœ… big_even: 10.5, small_odd: 10.5
    : betSettings.comboFeeRate;
  
  const result = calculateComboBetResult(
    Number(bet.amount),
    bet.betContent,
    lotteryResult.resultSum,
    isReturn,
    comboFeeRate,  // âœ… ä½¿ç”¨å…·ä½“ç±»å‹çš„è´¹ç‡
    betSettings.comboFeeBase,
  );
}
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ï¼ˆä½¿ç”¨å›ºå®šè´¹ç‡ï¼‰
```
100å€ Ã— 3% = 3
resultAmount = -(100 Ã— 0.8 + 3) = -83.00 âŒ

1000å¤§åŒ Ã— 7% = 70
resultAmount = 1000 - 70 = 930.00 âŒ
```

### ä¿®å¤åï¼ˆä½¿ç”¨é…ç½®çš„è´¹ç‡ï¼‰
```
100å€ Ã— 3.78% = 3.78
resultAmount = -(100 Ã— 0.8 + 3.78) = -83.78 âœ…

1000å¤§åŒ Ã— 10.5% = 105
resultAmount = 1000 - 105 = 895.00 (ä»æ˜¯æ•´æ•°ï¼Œä½†è®¡ç®—æ­£ç¡®)

500å¤§åŒ Ã— 10.5% = 52.5
resultAmount = 500 - 52.5 = 447.5 âœ… (æœ‰å°æ•°)
```

## éƒ¨ç½²æ­¥éª¤

### 1. é‡æ–°æ„å»ºåç«¯

```bash
cd /path/to/score-system

docker-compose down
docker-compose build backend
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend
```

### 2. éªŒè¯ä¿®å¤

ä¸‹æ³¨ä¸€ç¬”éæ•´æ•°é‡‘é¢ï¼ˆå¦‚ 155 å€ã€333 å€ï¼‰ï¼Œæ£€æŸ¥ç»“ç®—åçš„ `resultAmount` æ˜¯å¦æœ‰å°æ•°ã€‚

é¢„æœŸç»“æœï¼š
```
155å€ Ã— 3.78% = 5.859 â†’ 5.86
resultAmount = -(155 Ã— 0.8 + 5.86) = -129.86 âœ“
```

## ä¿®æ”¹æ–‡ä»¶

- `score-system/backend/src/modules/lottery/lottery.service.ts`
  - æ·»åŠ  `betTypeSettingsMap` è·å–æ‰€æœ‰é…ç½®
  - å€æ•°ä¸‹æ³¨ï¼šä½¿ç”¨ `multiple` çš„å‡†ç¡®è´¹ç‡
  - ç»„åˆä¸‹æ³¨ï¼šæ ¹æ® `bet.betType` è·å–å¯¹åº”è´¹ç‡

## å½±å“èŒƒå›´

- **å†å²æ•°æ®**ï¼šå·²ç»“ç®—çš„æ•°æ®ä¸ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œä¿æŒåŸæ ·
- **æ–°ä¸‹æ³¨**ï¼šä¿®å¤åçš„æ–°ä¸‹æ³¨ä¼šä½¿ç”¨æ­£ç¡®çš„è´¹ç‡ï¼Œ`resultAmount` ä¼šæœ‰å°æ•°
- **æ•°æ®ä¸€è‡´æ€§**ï¼šä¿®å¤åå¯èƒ½å‡ºç°æ–°æ—§æ•°æ®æ ¼å¼ä¸ä¸€è‡´ï¼ˆæ—§æ•°æ®æ•´æ•°ï¼Œæ–°æ•°æ®æœ‰å°æ•°ï¼‰ï¼Œè¿™æ˜¯æ­£å¸¸çš„

## æ³¨æ„äº‹é¡¹

1. **è´¹ç‡é…ç½®å¿…é¡»æ­£ç¡®**ï¼šç¡®ä¿ `bet_type_settings` è¡¨ä¸­çš„ `feeRate` å­—æ®µå·²æ­£ç¡®é…ç½®
2. **å°æ•°æ˜¾ç¤º**ï¼šå‰ç«¯å·²ä½¿ç”¨ `formatMoney()` æ ¼å¼åŒ–ï¼Œä¼šè‡ªåŠ¨æ˜¾ç¤ºä¸¤ä½å°æ•°
3. **Decimal ç±»å‹**ï¼šæ•°æ®åº“å­—æ®µ `Decimal(10,2)` ä¼šè‡ªåŠ¨ä¿ç•™ä¸¤ä½å°æ•°

