# 🚀 封盘倒计时系统 - 快速测试指南

## ✅ 前置条件

- [x] 后端已安装 `@nestjs/schedule`
- [x] 后端 `app.module.ts` 已启用 `ScheduleModule`
- [x] 前端已删除重复导入

---

## 🎯 测试步骤

### 1. 启动后端

```bash
cd score-system/backend
npm run start:dev
```

**检查日志：**
```
✓ 应该看到以下日志：
[Nest] INFO 封盘倒计时服务初始化成功
✓ 更新最新开奖数据: 期号=XXXXXXX
```

### 2. 启动前端

```bash
cd score-system/frontend-admin
npm run dev
```

### 3. 访问页面

打开浏览器：`http://localhost:5173`

登录后进入：**开奖历史**页面

---

## 👀 预期效果

### 页面顶部应显示倒计时卡片

```
┌─────────────────────────────────────┐
│ 当前期号: 3364685    [✓ 投注中]    │
│                                     │
│       02 分 45 秒                   │
│      距离封盘                        │
│ ━━━━━━━━━━━━━━━━━━ 15%            │
│                                     │
│ 下期期号: 3364686  ⏰ 04:15:00     │
└─────────────────────────────────────┘
```

### 倒计时流程

1. **开盘状态（绿色）** - 距离封盘 > 60秒
2. **即将封盘（橙色，闪烁）** - 距离封盘 < 60秒
3. **已封盘（红色）** - 最后30秒
4. **倒计时结束** - 自动刷新开奖列表

---

## 🔍 测试检查清单

### 功能测试
- [ ] 倒计时正常显示
- [ ] 每秒正常递减
- [ ] 封盘前60秒变橙色并闪烁
- [ ] 封盘时变红色
- [ ] 倒计时结束后：
  - [ ] 显示通知："第 XXX 期已开奖"
  - [ ] 2秒后自动刷新开奖列表
  - [ ] 期号自动更新

### 后端测试
- [ ] 定时任务正常运行（每分钟同步）
- [ ] API 正常响应：`GET /lottery/status`
- [ ] 封盘期间拒绝下注

---

## 🧪 API 测试

### 1. 测试状态查询

```bash
curl http://localhost:3000/api/lottery/status
```

**预期响应：**
```json
{
  "currentPeriod": "3364685",
  "nextPeriod": "3364686",
  "status": "open",
  "canBet": true,
  "countdown": 165,
  "countdownText": "距离封盘还有 2 分 45 秒",
  "lastDrawTime": "2025-11-27 04:11:30",
  "nextDrawTime": "2025-11-27 04:15:00",
  "progressPercentage": 8.33,
  "serverTime": "2025-11-27 04:12:45"
}
```

### 2. 测试下注（封盘期间）

```bash
curl -X POST http://localhost:3000/api/bet/create \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "issue": "3364685",
    "betType": "multiple",
    "betContent": "big",
    "amount": 100
  }'
```

**封盘期间预期响应：**
```json
{
  "code": 400,
  "message": "第 3364685 期已封盘，请等待开奖"
}
```

---

## 🐛 常见问题

### 问题1：倒计时不显示

**检查：**
```bash
# 后端日志
tail -f score-system/backend/logs/app.log

# 应该看到：
✓ 封盘倒计时服务初始化成功
```

**解决：**
- 确保后端正常运行
- 检查 USA28 API 是否可访问

### 问题2：倒计时不准确

**原因：** 客户端时间与服务器时间不一致

**检查：**
- 打开浏览器控制台
- 查看日志：`✓ 同步服务器状态: 服务器时间差: X秒`

### 问题3：自动刷新不工作

**检查：**
- 打开浏览器控制台
- 应该看到：`🎰 收到开奖通知:`

---

## 📊 性能检查

### 网络请求监控

打开浏览器 DevTools → Network

**预期：**
- 每60秒请求一次 `/lottery/status`
- 倒计时结束时请求一次
- **不应该**每秒都请求

### CPU 使用率

打开浏览器 DevTools → Performance

**预期：**
- CPU 使用率 < 5%
- 倒计时流畅，无卡顿

---

## ✅ 测试通过标准

### 基础功能
- [x] 倒计时正常显示
- [x] 状态正确切换
- [x] 自动刷新工作

### 性能指标
- [x] 每期请求 < 5次
- [x] CPU 使用 < 5%
- [x] 无明显卡顿

### 安全验证
- [x] 封盘期间无法下注
- [x] 期号验证生效

---

## 🎉 测试完成！

如果所有测试通过，封盘倒计时系统已成功部署！

**下一步：**
1. 在其他页面集成倒计时组件
2. 添加更多提示音效
3. 优化移动端显示

---

**更新时间：** 2025-11-27  
**版本：** v1.0  
**作者：** AI Assistant



