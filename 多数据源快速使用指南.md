# 多数据源快速使用指南 🚀

## 📝 已实现功能

✅ **3个数据源**：USA28 + JND28 + Database  
✅ **自动故障转移**：主数据源失败时自动切换  
✅ **健康监控**：实时查看各数据源状态  
✅ **零配置**：开箱即用，无需手动设置  

---

## 🎯 快速开始

### 1. 启动后端服务

```bash
cd score-system/backend
pnpm install  # 如果还没安装依赖
pnpm start:dev
```

### 2. 观察同步日志

```
[INFO] 📚 已注册 3 个数据源
  - USA28 (优先级: 1, 状态: 启用)
  - JND28 (优先级: 2, 状态: 启用)
  - Database (优先级: 99, 状态: 启用)

[INFO] 🎯 开始同步开奖数据（多数据源模式）...
[INFO] 🔍 尝试数据源: USA28 (优先级: 1)
[INFO] ✅ USA28获取成功: 2条数据 (245ms)
[INFO] ✅ 成功从 USA28 获取 2 条开奖记录 (245ms)
[INFO] ✓ 成功保存期号 3365450: 3+9+0=12 (来源: USA28)
```

---

## 🔍 验证功能

### 方法1：查看数据源健康状态

1. 登录管理后台
2. 获取管理员Token
3. 调用健康检查接口：

```bash
curl -X GET http://localhost:3000/api/lottery/data-source-health \
  -H "Authorization: Bearer <your_admin_token>"
```

**预期响应**：

```json
{
  "timestamp": "2025-11-29T02:00:00.000Z",
  "status": "healthy",
  "dataSources": [
    {
      "name": "USA28",
      "priority": 1,
      "enabled": true,
      "status": "ok",
      "responseTime": 245
    },
    {
      "name": "JND28",
      "priority": 2,
      "enabled": true,
      "status": "ok",
      "responseTime": 312
    },
    {
      "name": "Database",
      "priority": 99,
      "enabled": true,
      "status": "ok",
      "responseTime": 5
    }
  ]
}
```

### 方法2：测试故障转移

#### 测试场景1：正常情况

```bash
# 观察日志
✅ 成功从 USA28 获取 2 条数据
```

#### 测试场景2：模拟USA28失败

1. 临时修改 `usa28.data-source.ts` 的API地址（制造错误）：

```typescript
private readonly apiUrl = 'https://invalid-url.com/api';  // 错误地址
```

2. 重启服务，观察日志：

```
🔍 尝试数据源: USA28 (优先级: 1)
❌ USA28失败 (10000ms): getaddrinfo ENOTFOUND invalid-url.com
➡️ 切换到下一个数据源...
🔍 尝试数据源: JND28 (优先级: 2)
✅ JND28获取成功: 2条数据 (312ms)
✓ 成功保存期号 3365450: 3+9+0=12 (来源: JND28)  ← 自动切换成功！
```

3. 还原修改，重启服务

---

## 📊 数据源对比

### USA28 vs JND28 数据格式对比

#### USA28 API响应

```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "drawIssue": "3365450",
        "drawTime": "2025-11-29 01:55:00",
        "drawCode": "3,9,0"
      }
    ]
  }
}
```

#### JND28 API响应

```json
{
  "error": 0,
  "result_list": [
    {
      "expect": 3365450,
      "code1": 3,
      "code2": 9,
      "code3": 0,
      "he": 12,
      "datetime": "2025-11-29 01:55:07"
    }
  ]
}
```

#### 统一后的格式

```typescript
{
  issue: "3365450",
  number1: 3,
  number2: 9,
  number3: 0,
  sumValue: 12,
  drawTime: new Date("2025-11-29 01:55:00"),
  source: "USA28"  // 或 "JND28"
}
```

---

## 🔧 常见问题

### Q1: 如何查看当前使用的是哪个数据源？

**A**: 查看同步成功的日志，会显示数据来源：

```
✓ 成功保存期号 3365450: 3+9+0=12 (来源: USA28)
```

或调用API查看返回的 `dataSource` 字段：

```json
{
  "message": "成功同步 2 条开奖数据 (来源: USA28)",
  "dataSource": "USA28"
}
```

### Q2: 如果所有数据源都失败会怎样？

**A**: 系统会返回错误，但不会崩溃：

```
❌ USA28 失败: Network timeout
❌ JND28 失败: Connection refused
❌ Database 失败: No data available
🚨 所有数据源均失败
```

此时系统会：
1. 记录详细错误日志
2. 返回HTTP 500错误
3. 保持现有数据不变
4. 等待下次定时同步重试

### Q3: 如何禁用某个数据源？

**A**: 修改对应数据源类的 `enabled` 属性：

```typescript
// jnd28.data-source.ts
export class JND28DataSource implements ILotteryDataSource {
  name = 'JND28';
  priority = 2;
  enabled = false;  // 改为false即可禁用
}
```

或通过API动态禁用（如果实现了配置接口）。

### Q4: 数据源的优先级是什么意思？

**A**: 优先级数字**越小优先级越高**：

- `priority: 1` → USA28（优先使用）
- `priority: 2` → JND28（USA28失败时使用）
- `priority: 99` → Database（最后兜底）

系统按优先级从低到高依次尝试。

### Q5: JND28和USA28的数据一样吗？

**A**: 是的，都是加拿大28的开奖数据，但：
- 数据格式不同（已统一处理）
- 服务器不同（提供冗余）
- 更新时间可能有秒级差异（都在可接受范围内）

### Q6: 部署到生产环境需要注意什么？

**A**: 
1. ✅ 确保服务器可以访问两个API地址
2. ✅ 检查防火墙是否允许HTTPS出站连接
3. ✅ 设置健康检查定时任务（推荐）
4. ✅ 配置告警通知（邮件/短信）
5. ⚠️ 考虑使用HTTPS代理（如果有网络限制）

---

## 📈 监控建议

### 1. 定时健康检查

```typescript
// 建议在cron-jobs或监控系统中添加
@Cron('*/5 * * * *')  // 每5分钟检查
async monitorDataSources() {
  const health = await this.lotteryService.getDataSourceHealth();
  
  if (health.status !== 'healthy') {
    // 发送告警
    console.error('⚠️ 数据源异常:', health);
  }
}
```

### 2. 数据源性能统计

记录每个数据源的：
- 成功率
- 平均响应时间
- 最近失败时间
- 累计失败次数

### 3. 告警阈值

建议设置：
- 🟢 健康：所有数据源正常
- 🟡 警告：1个数据源失败
- 🔴 严重：2个或以上数据源失败

---

## 🎉 部署验证清单

部署到生产环境前，确保：

- [ ] USA28数据源正常工作
- [ ] JND28数据源正常工作
- [ ] 数据库备份数据存在
- [ ] 健康检查接口可访问
- [ ] 故障转移逻辑已测试
- [ ] 日志系统正常记录
- [ ] 管理员可以查看数据源状态
- [ ] 定时同步任务正常运行

---

## 📞 技术支持

如有问题，请查看：
- 📖 [多数据源自动切换方案.md](./多数据源自动切换方案.md) - 详细技术文档
- 📖 [数据源风险与备份方案.md](./数据源风险与备份方案.md) - 风险评估和解决方案
- 📝 后端日志：`backend/logs/`
- 🔍 API文档：`http://localhost:3000/api`

---

**文档版本**: v1.0  
**创建日期**: 2025-11-29  
**适用版本**: v2.0+

