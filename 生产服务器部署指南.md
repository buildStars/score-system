# 🚀 生产服务器部署指南

## 📋 服务器信息

```
IP地址: 96.44.177.240
用户名: root
密码: 35hPEY97yFAsq21Hlu
SSH端口: 22
```

---

## 🎯 部署步骤总览

1. ✅ 连接到服务器
2. ✅ 安装 Docker 和 Docker Compose
3. ✅ 上传项目文件
4. ✅ 配置环境变量
5. ✅ 启动服务
6. ✅ 配置防火墙
7. ✅ （可选）配置域名和 SSL

---

## 第一步：连接到服务器

### Windows 用户

#### 方法1：使用 PowerShell（推荐）

```powershell
# 打开 PowerShell
ssh root@96.44.177.240

# 输入密码：35hPEY97yFAsq21Hlu
```

#### 方法2：使用 PuTTY

1. 下载 PuTTY：https://www.putty.org/
2. 安装并打开 PuTTY
3. 填写信息：
   - Host Name: `96.44.177.240`
   - Port: `22`
   - Connection type: `SSH`
4. 点击 Open
5. 输入用户名：`root`
6. 输入密码：`35hPEY97yFAsq21Hlu`

---

## 第二步：安装 Docker 和 Docker Compose

连接到服务器后，执行以下命令：

```bash
# 更新系统
apt update && apt upgrade -y

# 安装必要的工具
apt install -y curl git vim

# 安装 Docker
curl -fsSL https://get.docker.com | sh

# 启动 Docker
systemctl start docker
systemctl enable docker

# 验证 Docker 安装
docker --version

# 安装 Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# 验证 Docker Compose 安装
docker-compose --version
```

---

## 第三步：上传项目文件

### 方法1：使用 Git（推荐）

如果你的项目在 Git 仓库：

```bash
# 创建项目目录
mkdir -p /opt/score-system
cd /opt/score-system

# 克隆项目（替换为你的仓库地址）
git clone <你的仓库地址> .
```

### 方法2：使用 SCP 上传

在你的 **本地电脑** 上打开命令行：

```bash
# Windows PowerShell 或 CMD
# 进入项目目录
cd D:\download\yunce\yunce\score-system

# 上传整个项目到服务器
scp -r . root@96.44.177.240:/opt/score-system/
```

### 方法3：使用 WinSCP（Windows 用户）

1. 下载 WinSCP：https://winscp.net/
2. 安装并打开 WinSCP
3. 新建连接：
   - 主机名: `96.44.177.240`
   - 用户名: `root`
   - 密码: `35hPEY97yFAsq21Hlu`
   - 端口: `22`
4. 点击登录
5. 在服务器端创建目录：`/opt/score-system`
6. 拖拽本地项目文件到服务器

---

## 第四步：配置环境变量

在服务器上执行：

```bash
# 进入项目目录
cd /opt/score-system

# 从示例文件创建环境配置
cp env.example .env

# 编辑配置文件
vim .env
# 或使用 nano（更简单）
nano .env
```

### 重要配置项（必须修改）

```bash
# MySQL 配置
MYSQL_ROOT_PASSWORD=你的超级安全的MySQL密码123!@#
MYSQL_DATABASE=score_system
MYSQL_USER=scoreuser
MYSQL_PASSWORD=你的数据库用户密码ABC!@#
MYSQL_PORT=3307

# Redis 配置
REDIS_PASSWORD=你的Redis密码XYZ!@#
REDIS_PORT=6380

# 后端配置
BACKEND_PORT=3000
JWT_SECRET=至少32位的超级安全随机字符串请务必修改这个12345678901234567890

# 前端端口
ADMIN_PORT=8080
H5_PORT=8081
```

### vim 编辑器使用方法

```bash
# 打开文件后：
# 1. 按 i 进入编辑模式
# 2. 修改内容
# 3. 按 Esc 退出编辑模式
# 4. 输入 :wq 保存并退出
# 5. 或输入 :q! 不保存退出
```

### nano 编辑器使用方法（更简单）

```bash
# 打开文件后：
# 1. 直接编辑内容
# 2. 按 Ctrl+O 保存
# 3. 按 Enter 确认
# 4. 按 Ctrl+X 退出
```

---

## 第五步：启动服务

```bash
# 确保在项目目录
cd /opt/score-system

# 停止并清理旧容器（如果有）
docker-compose down -v

# 构建并启动所有服务
docker-compose up -d --build

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 如果一切正常，按 Ctrl+C 退出日志查看
```

### 等待服务启动

首次启动需要 5-10 分钟，请耐心等待。

```bash
# 持续查看后端日志，确认启动成功
docker-compose logs -f backend

# 看到类似信息表示成功：
# "Nest application successfully started"
# "Application is running on: http://[::1]:3000"
```

---

## 第六步：配置防火墙

```bash
# 安装 UFW 防火墙（如果未安装）
apt install -y ufw

# 允许 SSH（重要！否则会断开连接）
ufw allow 22/tcp

# 允许 HTTP 和 HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# 允许应用端口
ufw allow 3000/tcp  # 后端 API
ufw allow 8080/tcp  # 管理后台
ufw allow 8081/tcp  # H5 前端

# 启用防火墙
ufw enable

# 查看防火墙状态
ufw status
```

---

## 第七步：验证部署

### 测试 API

```bash
# 在服务器上测试
curl http://localhost:3000/api-docs

# 应该返回 HTML 内容
```

### 浏览器访问

在你的电脑浏览器中访问：

- **后端 API**: http://96.44.177.240:3000
- **API 文档**: http://96.44.177.240:3000/api-docs
- **管理后台**: http://96.44.177.240:8080
- **H5 前端**: http://96.44.177.240:8081

### 默认账号

- **管理员**: `admin` / `admin123`
- **测试用户**: `user1` / `123456`

---

## 🔧 常用运维命令

### 查看服务状态

```bash
cd /opt/score-system
docker-compose ps
```

### 查看日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend
docker-compose logs -f mysql
docker-compose logs -f redis
```

### 重启服务

```bash
# 重启所有服务
docker-compose restart

# 重启特定服务
docker-compose restart backend
docker-compose restart frontend-admin
```

### 停止服务

```bash
# 停止服务
docker-compose stop

# 停止并删除容器（保留数据）
docker-compose down

# 停止并删除容器和数据（⚠️ 慎用）
docker-compose down -v
```

### 更新代码

```bash
cd /opt/score-system

# 如果使用 Git
git pull

# 重新构建并启动
docker-compose down
docker-compose up -d --build
```

### 备份数据库

```bash
# 备份数据库
docker-compose exec mysql mysqldump -u root -p score_system > backup_$(date +%Y%m%d).sql

# 输入密码（.env 中的 MYSQL_ROOT_PASSWORD）
```

### 恢复数据库

```bash
# 恢复数据库
docker-compose exec -T mysql mysql -u root -p score_system < backup_20241128.sql
```

---

## 🌐 配置域名（可选但推荐）

### 1. 购买域名

在域名注册商（如阿里云、腾讯云、GoDaddy）购买域名

### 2. 配置 DNS 解析

添加以下 A 记录：

```
类型    主机记录    记录值
A       @          96.44.177.240
A       www        96.44.177.240
A       api        96.44.177.240
A       admin      96.44.177.240
A       h5         96.44.177.240
```

### 3. 安装 Nginx

```bash
# 安装 Nginx
apt install -y nginx

# 启动 Nginx
systemctl start nginx
systemctl enable nginx
```

### 4. 配置 Nginx 反向代理

创建配置文件：

```bash
nano /etc/nginx/sites-available/score-system
```

添加以下内容（替换 `yourdomain.com` 为你的域名）：

```nginx
# API 后端
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# 管理后台
server {
    listen 80;
    server_name admin.yourdomain.com;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# H5 前端
server {
    listen 80;
    server_name h5.yourdomain.com;

    location / {
        proxy_pass http://localhost:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

启用配置：

```bash
# 创建软链接
ln -s /etc/nginx/sites-available/score-system /etc/nginx/sites-enabled/

# 测试配置
nginx -t

# 重新加载 Nginx
systemctl reload nginx
```

### 5. 安装 SSL 证书（HTTPS）

```bash
# 安装 Certbot
apt install -y certbot python3-certbot-nginx

# 自动配置 SSL（替换为你的域名和邮箱）
certbot --nginx -d api.yourdomain.com -d admin.yourdomain.com -d h5.yourdomain.com --email your@email.com --agree-tos --no-eff-email

# 自动续期
certbot renew --dry-run
```

---

## 🔒 安全加固（重要！）

### 1. 修改 SSH 端口

```bash
# 编辑 SSH 配置
nano /etc/ssh/sshd_config

# 找到 #Port 22，修改为（取消注释并改端口）：
Port 2222

# 重启 SSH 服务
systemctl restart sshd

# 更新防火墙
ufw allow 2222/tcp
ufw delete allow 22/tcp

# 下次连接使用：
# ssh -p 2222 root@96.44.177.240
```

### 2. 禁用 root 密码登录（推荐使用密钥）

```bash
# 创建新的普通用户
adduser deploy
usermod -aG sudo deploy

# 切换到新用户测试
su - deploy
```

### 3. 配置自动更新

```bash
# 安装自动更新
apt install -y unattended-upgrades

# 启用自动更新
dpkg-reconfigure -plow unattended-upgrades
```

### 4. 安装 Fail2Ban（防暴力破解）

```bash
# 安装 Fail2Ban
apt install -y fail2ban

# 启动服务
systemctl start fail2ban
systemctl enable fail2ban
```

---

## 📊 监控和日志

### 查看系统资源

```bash
# 查看 CPU 和内存使用
htop
# 或
top

# 查看磁盘使用
df -h

# 查看 Docker 资源使用
docker stats
```

### 设置日志轮转

```bash
# Docker 日志会自动轮转
# 查看日志大小
docker-compose logs --tail=100
```

---

## 🆘 故障排查

### 服务无法启动

```bash
# 查看详细日志
docker-compose logs -f

# 检查端口占用
netstat -tlnp | grep 3000

# 检查容器状态
docker ps -a
```

### 数据库连接失败

```bash
# 进入 MySQL 容器
docker-compose exec mysql bash

# 连接数据库
mysql -u root -p

# 查看用户权限
SHOW GRANTS FOR 'scoreuser'@'%';
```

### 内存不足

```bash
# 查看内存使用
free -h

# 清理 Docker 资源
docker system prune -a --volumes
```

---

## 📚 快速命令参考

```bash
# 连接服务器
ssh root@96.44.177.240

# 进入项目目录
cd /opt/score-system

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 重启服务
docker-compose restart

# 更新并重启
git pull && docker-compose up -d --build

# 备份数据
docker-compose exec mysql mysqldump -u root -p score_system > backup.sql
```

---

## ✅ 部署检查清单

- [ ] 已连接到服务器
- [ ] 已安装 Docker 和 Docker Compose
- [ ] 已上传项目文件
- [ ] 已配置 .env 文件（修改所有默认密码）
- [ ] 已启动所有服务
- [ ] 已配置防火墙
- [ ] 可以通过浏览器访问
- [ ] （可选）已配置域名
- [ ] （可选）已安装 SSL 证书
- [ ] 已备份数据库

---

## 🎉 恭喜！

如果一切顺利，你的应用现在应该已经在生产环境运行了！

**访问地址**：
- 后端 API: http://96.44.177.240:3000
- 管理后台: http://96.44.177.240:8080
- H5 前端: http://96.44.177.240:8081

**下一步**：
1. 修改所有默认密码
2. 配置域名和 SSL
3. 设置定时备份
4. 监控服务运行状态

有任何问题，请查看故障排查部分或查看日志！

