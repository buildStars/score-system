# âœ… æ‰‹ç»­è´¹é…ç½®å®Œæ•´æ£€æŸ¥æŠ¥å‘Š

## 1. é—®é¢˜æè¿°
ç”¨æˆ·åé¦ˆï¼š`http://localhost:5174/bet-settings` é¡µé¢å¯ä»¥è®¾ç½®æ‰‹ç»­è´¹ç‡ï¼Œä½†æ‰‹ç»­è´¹è®¡ç®—ä¼¼ä¹ä½¿ç”¨äº†ç¡¬ç¼–ç çš„å€¼ã€‚

## 2. æ£€æŸ¥ç»“æœ

### âœ… æ•°æ®åº“é…ç½®ï¼ˆæ­£å¸¸ï¼‰
```sql
SELECT * FROM bet_setting WHERE setting_key LIKE '%fee%';
```

å½“å‰é…ç½®ï¼š
- `multiple_fee_rate`: 3 (æ¯100ä¸º3)
- `multiple_fee_base`: 100 (åŸºæ•°ä¸º100)
- `combo_fee_rate`: 5 (æ¯100ä¸º5)
- `combo_fee_base`: 100 (åŸºæ•°ä¸º100)
- `multiple_loss_rate`: 0.8 (å€æ•°ä¸å›æœ¬æŸå¤±ç‡)

### âœ… åç«¯æœåŠ¡ï¼ˆæ­£å¸¸ä½¿ç”¨é…ç½®ï¼‰

#### `bet.service.ts`
```typescript
// âœ… æ­£ç¡®ä»æ•°æ®åº“è¯»å–é…ç½®
const betSettings = await this.getBetSettings();

// âœ… ä¼ é€’ç»™è®¡ç®—å‡½æ•°
calculateMinimumBalance(
  betType === 'multiple' ? 'multiple' : 'combo',
  amount,
  betContent,
  betType === 'multiple' ? betSettings.multipleFeeRate : betSettings.comboFeeRate,
  betType === 'multiple' ? betSettings.multipleFeeBase : betSettings.comboFeeBase,
  betSettings.multipleLossRate, // ğŸ”§ æ–°å¢ï¼šä½¿ç”¨é…ç½®çš„æŸå¤±ç‡
)
```

#### `lottery.service.ts`
```typescript
// âœ… æ­£ç¡®ä»æ•°æ®åº“è¯»å–é…ç½®
const betSettings = await this.getBetSettings();

// âœ… å€æ•°ä¸‹æ³¨ç»“ç®—
calculateMultipleBetResult(
  Number(bet.amount),
  isReturn,
  betSettings.multipleFeeRate,  // âœ… ä½¿ç”¨é…ç½®
  betSettings.multipleFeeBase,  // âœ… ä½¿ç”¨é…ç½®
)

// âœ… ç»„åˆä¸‹æ³¨ç»“ç®—
calculateComboBetResult(
  Number(bet.amount),
  bet.betContent,
  lotteryResult.resultSum,
  isReturn,
  betSettings.comboFeeRate,  // âœ… ä½¿ç”¨é…ç½®
  betSettings.comboFeeBase,  // âœ… ä½¿ç”¨é…ç½®
)
```

### âš ï¸ å·¥å…·å‡½æ•°é»˜è®¤å€¼ï¼ˆåå¤‡å€¼ï¼Œéé—®é¢˜ï¼‰

`lottery-rules.util.ts` ä¸­çš„é»˜è®¤å‚æ•°åªæ˜¯åå¤‡å€¼ï¼Œæ­£å¸¸æµç¨‹ä¸‹ä¸ä¼šä½¿ç”¨ï¼š

```typescript
// è¿™äº›é»˜è®¤å€¼åªåœ¨æœªä¼ é€’å‚æ•°æ—¶ä½¿ç”¨ï¼ˆä¸ä¼šå‘ç”Ÿï¼‰
export function calculateMultipleBetResult(
  multiplier: number,
  isReturn: boolean,
  feeRate: number = 3,      // âš ï¸ é»˜è®¤å€¼ï¼ˆåå¤‡ï¼‰
  feeBase: number = 100,    // âš ï¸ é»˜è®¤å€¼ï¼ˆåå¤‡ï¼‰
)

export function calculateComboBetResult(
  amount: number,
  betContent: string,
  resultSum: number,
  isReturn: boolean,
  feeRate: number = 5,      // âš ï¸ é»˜è®¤å€¼ï¼ˆåå¤‡ï¼‰
  feeBase: number = 100,    // âš ï¸ é»˜è®¤å€¼ï¼ˆåå¤‡ï¼‰
)
```

## 3. æœ¬æ¬¡ä¼˜åŒ–

### ğŸ”§ ä¿®å¤ç‚¹1ï¼šå ç”¨ç§¯åˆ†è®¡ç®—é”™è¯¯
**é—®é¢˜**ï¼šå¤šç»„åˆä¸‹æ³¨æ—¶ï¼Œæ¯ä¸ªç»„åˆéƒ½æŒ‰ `æœ¬é‡‘ Ã— 5 + æ‰‹ç»­è´¹` è®¡ç®—ï¼Œå¯¼è‡´å ç”¨ç§¯åˆ†è¿‡é«˜ã€‚

**ä¿®å¤**ï¼š
```typescript
// âŒ æ—§é€»è¾‘ï¼ˆé”™è¯¯ï¼‰
pendingBets.forEach(bet => {
  if (ç»„åˆä¸‹æ³¨) {
    å ç”¨ç§¯åˆ† += æœ¬é‡‘ Ã— 5 + æ‰‹ç»­è´¹  // æ¯ä¸ªç»„åˆéƒ½ Ã—5
  }
})
// ç¤ºä¾‹ï¼š3ä¸ª500çš„ç»„åˆ = (500Ã—5+25) Ã— 3 = 7575

// âœ… æ–°é€»è¾‘ï¼ˆæ­£ç¡®ï¼‰
const maxComboAmount = Math.max(...ç»„åˆä¸‹æ³¨.map(b => b.amount))
const comboTotalFee = ç»„åˆä¸‹æ³¨.reduce((sum, bet) => sum + betæ‰‹ç»­è´¹, 0)
å ç”¨ç§¯åˆ† += maxComboAmount Ã— 5 + comboTotalFee
// ç¤ºä¾‹ï¼š3ä¸ª500çš„ç»„åˆ = 500Ã—5 + (25Ã—3) = 2575
```

**èŠ‚çœç§¯åˆ†**ï¼š5000ï¼ˆè§ `test-pending-loss.ts`ï¼‰

### ğŸ”§ ä¿®å¤ç‚¹2ï¼šä½¿ç”¨é…ç½®çš„æŸå¤±ç‡
**é—®é¢˜**ï¼š`bet.service.ts` ä¸­è®¡ç®—å€æ•°ä¸‹æ³¨å ç”¨æ—¶ï¼Œç¡¬ç¼–ç äº† `0.8`ã€‚

**ä¿®å¤**ï¼š
```typescript
// âŒ æ—§ä»£ç 
const loss = bet.amount * 0.8 + fee;  // ç¡¬ç¼–ç  0.8

// âœ… æ–°ä»£ç 
const loss = bet.amount * betSettings.multipleLossRate + fee;  // ä½¿ç”¨é…ç½®
```

### ğŸ”§ ä¿®å¤ç‚¹3ï¼š`calculateMinimumBalance` å‡½æ•°æ”¯æŒæŸå¤±ç‡å‚æ•°
**é—®é¢˜**ï¼šå‡½æ•°å†…éƒ¨ç¡¬ç¼–ç äº† `0.8`ã€‚

**ä¿®å¤**ï¼š
```typescript
// âŒ æ—§ç­¾å
export function calculateMinimumBalance(
  betType: 'multiple' | 'combo',
  amount: number,
  betContent?: string,
  feeRate?: number,
  feeBase?: number,
)

// âœ… æ–°ç­¾å
export function calculateMinimumBalance(
  betType: 'multiple' | 'combo',
  amount: number,
  betContent?: string,
  feeRate?: number,
  feeBase?: number,
  multipleLossRate: number = 0.8,  // æ–°å¢å‚æ•°
)
```

## 4. ç»“è®º

### âœ… æ‰‹ç»­è´¹é…ç½®å®Œå…¨æ­£å¸¸
1. **æ•°æ®åº“**ï¼šæœ‰å®Œæ•´çš„é…ç½®è®°å½•
2. **åç«¯æœåŠ¡**ï¼šæ‰€æœ‰åœ°æ–¹éƒ½æ­£ç¡®è¯»å–å¹¶ä½¿ç”¨æ•°æ®åº“é…ç½®
3. **ç®¡ç†åå°**ï¼šå¯ä»¥é€šè¿‡ `/admin/bet-settings` ä¿®æ”¹é…ç½®
4. **é»˜è®¤å€¼**ï¼šä»…ä½œä¸ºåå¤‡ï¼Œå®é™…è¿è¡Œä¸­å§‹ç»ˆä½¿ç”¨æ•°æ®åº“é…ç½®

### âœ… æ–°å¢ä¼˜åŒ–
1. **å¤šç»„åˆå ç”¨è®¡ç®—**ï¼šä¿®å¤äº†è¿‡åº¦å ç”¨ç§¯åˆ†çš„é—®é¢˜ï¼ˆèŠ‚çœ5000ç§¯åˆ†/ä¾‹ï¼‰
2. **æŸå¤±ç‡é…ç½®åŒ–**ï¼šæ‰€æœ‰å€æ•°ä¸‹æ³¨æŸå¤±ç‡è®¡ç®—ç°åœ¨éƒ½ä½¿ç”¨é…ç½®å€¼

## 5. æµ‹è¯•å»ºè®®

### æµ‹è¯•1ï¼šä¿®æ”¹æ‰‹ç»­è´¹é…ç½®
1. è®¿é—® `http://localhost:5174/bet-settings`
2. ä¿®æ”¹ `å€æ•°æ‰‹ç»­è´¹ç‡` ä» 3 æ”¹ä¸º 5
3. ä¸‹æ³¨å€æ•°ï¼ˆå¦‚1000ï¼‰
4. æ£€æŸ¥æ‰‹ç»­è´¹ï¼šåº”ä¸º `1000 Ã· 100 Ã— 5 = 50`ï¼ˆè€Œé 30ï¼‰

### æµ‹è¯•2ï¼šå¤šç»„åˆå ç”¨
1. ç”¨æˆ·ä½™é¢ï¼š10000
2. Pendingä¸‹æ³¨ï¼š
   - 500å¤§å•ï¼ˆç»„åˆï¼‰
   - 500å¤§åŒï¼ˆç»„åˆï¼‰
   - 500å°å•ï¼ˆç»„åˆï¼‰
3. æ—§å ç”¨ï¼š`7575`ï¼ˆä¸å…è®¸å†ä¸‹æ³¨ï¼‰
4. æ–°å ç”¨ï¼š`2575`ï¼ˆå¯ä»¥ç»§ç»­ä¸‹æ³¨ï¼‰

### æµ‹è¯•3ï¼šæŸå¤±ç‡é…ç½®
1. ä¿®æ”¹ `å€æ•°ä¸å›æœ¬æŸå¤±ç‡` ä» 0.8 æ”¹ä¸º 0.9
2. ä¸‹æ³¨1000å€
3. ä¸å›æœ¬ç»“ç®—ï¼šåº”ä¸º `-1000 Ã— 0.9 - æ‰‹ç»­è´¹`ï¼ˆè€Œé `-1000 Ã— 0.8 - æ‰‹ç»­è´¹`ï¼‰

## 6. ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨
- âœ… `backend/src/modules/bet/bet.service.ts`
  - ä¿®å¤å¤šç»„åˆå ç”¨è®¡ç®—é€»è¾‘
  - ä½¿ç”¨é…ç½®çš„ `multipleLossRate`
- âœ… `backend/src/modules/lottery/utils/lottery-rules.util.ts`
  - `calculateMinimumBalance` å‡½æ•°æ–°å¢ `multipleLossRate` å‚æ•°

## 7. éƒ¨ç½²å»ºè®®
1. é‡å¯åç«¯æœåŠ¡
2. æ¸…ç†æµè§ˆå™¨ç¼“å­˜
3. æµ‹è¯•å ç”¨ç§¯åˆ†è®¡ç®—
4. æµ‹è¯•æ‰‹ç»­è´¹é…ç½®ä¿®æ”¹

