# 🧪 新规则测试指南

## ✅ 数据已清空

- ✅ 删除了 21 条下注记录
- ✅ 删除了 32 条积分记录
- ✅ 删除了 51 条开奖记录
- ✅ 重置了 2 个用户的积分为 10000

---

## 🎯 测试场景

### 场景 1：倍数下注

#### 测试1：倍数回本
```
下注：100倍
开奖：对子/豹子/顺子/和值13-14（回本）
预期结算分：+100 - 3 = +97
预期最终积分：10000 + 97 = 10097
```

#### 测试2：倍数不回本
```
下注：100倍
开奖：普通号码（不回本）
预期结算分：-100×0.8 - 3 = -83
预期最终积分：10000 - 83 = 9917
```

---

### 场景 2：大小单双

#### 测试3：命中且不回本
```
下注：1000「大」
开奖：大（和值15-27，非回本）
预期结算分：+1000×1.8 = +1800
预期最终积分：10000 + 1800 = 11800
```

#### 测试4：命中且回本
```
下注：1000「大」
开奖：大（和值14，回本）
预期结算分：0
预期最终积分：10000 + 0 = 10000
```

#### 测试5：未命中
```
下注：1000「大」
开奖：小（和值0-13）
预期结算分：-1000
预期最终积分：10000 - 1000 = 9000
```

---

### 场景 3：组合下注

#### 测试6：未命中
```
下注：100「大单」
开奖：小单（未命中）
预期结算分：+100 - 5 = +95
预期最终积分：10000 + 95 = 10095
```

#### 测试7：命中且不回本
```
下注：100「大双」
开奖：大双（和值16，不回本）
预期结算分：-100×5 - 5 = -505
预期最终积分：10000 - 505 = 9495
```

#### 测试8：命中且回本
```
下注：100「大双」
开奖：大双（和值14，回本）
预期结算分：-5
预期最终积分：10000 - 5 = 9995
```

---

## ✅ 验证清单

### 1. 下注时验证

检查返回数据：
```json
{
  "betId": "...",
  "issue": "...",
  "amount": 100,
  "fee": 3,
  "pointsBefore": 10000,  // ← 应该是下注前的积分（未扣除）
  "availableBalance": 9917,  // ← 可用余额（扣除锁定）
  "lockedAmount": 83  // ← 最大可能损失
}
```

**关键点**：
- ✅ `pointsBefore` = 下注前的真实积分（不扣分）
- ✅ 不创建 PointRecord（下注时）

### 2. 结算时验证

查看数据库记录：
```sql
SELECT 
  id, issue, betType, betContent, amount, fee,
  status, resultAmount, pointsBefore, pointsAfter
FROM bets 
WHERE status != 'pending'
ORDER BY id DESC 
LIMIT 5;
```

**关键验证**：
```
✅ pointsAfter = pointsBefore + resultAmount
✅ resultAmount 应该符合新规则计算
✅ PointRecord 的 amount = resultAmount
```

### 3. 积分变化验证

```sql
SELECT 
  type, amount, balanceBefore, balanceAfter, remark
FROM point_records
ORDER BY id DESC
LIMIT 10;
```

**关键点**：
- ✅ 只有结算记录，没有下注记录
- ✅ `amount` = `resultAmount`（结算分）
- ✅ `balanceAfter - balanceBefore` = `amount`

---

## 🧪 测试步骤

### Step 1: 启动服务

```bash
# 启动后端（如果未启动）
cd score-system/backend
npm run start:dev

# 启动 H5 前端
cd ../frontend-h5
npm run dev

# 启动管理后台
cd ../frontend-admin
npm run dev
```

### Step 2: 登录测试账号

- **用户账号**：登录 H5 前端
- **管理员**：登录管理后台查看数据

### Step 3: 等待开奖数据同步

系统会自动同步开奖数据（每210秒），或者手动触发：
```bash
# 在管理后台点击"同步开奖数据"按钮
```

### Step 4: 下注测试

1. **查看当前积分**：10000
2. **选择下注类型**（倍数/大小单双/组合）
3. **输入金额**
4. **提交下注**
5. **检查返回数据**：
   - `pointsBefore` 应该还是 10000
   - `availableBalance` 应该减少了

### Step 5: 等待开奖

等待系统自动结算（开奖后约10秒内）

### Step 6: 验证结算

1. **查看积分变化**：
   ```
   新积分 = 10000 + resultAmount
   ```

2. **查看积分记录**：
   - 应该只有一条结算记录
   - 金额 = resultAmount

3. **查看下注记录**：
   ```
   pointsAfter = pointsBefore + resultAmount
   ```

---

## 📊 测试记录表

| 测试 | 下注类型 | 金额 | 开奖结果 | 预期结算分 | 实际结算分 | 预期积分 | 实际积分 | 状态 |
|------|---------|------|---------|-----------|-----------|---------|---------|------|
| 1 | 倍数100 | 100 | 回本 | +97 | ? | 10097 | ? | ⬜ |
| 2 | 倍数100 | 100 | 不回本 | -83 | ? | 9917 | ? | ⬜ |
| 3 | 大 | 1000 | 大不回本 | +1800 | ? | 11800 | ? | ⬜ |
| 4 | 大 | 1000 | 大回本 | 0 | ? | 10000 | ? | ⬜ |
| 5 | 大 | 1000 | 小 | -1000 | ? | 9000 | ? | ⬜ |
| 6 | 大单 | 100 | 小单 | +95 | ? | 10095 | ? | ⬜ |
| 7 | 大双 | 100 | 大双不回本 | -505 | ? | 9495 | ? | ⬜ |
| 8 | 大双 | 100 | 大双回本 | -5 | ? | 9995 | ? | ⬜ |

---

## 🐛 常见问题

### Q1: 下注时积分被扣除了？
**A**: 说明后端还在使用旧代码，需要重新启动或重新部署。

### Q2: resultAmount 和实际积分变化不一致？
**A**: 这是旧数据的特征，清空数据后重新测试。

### Q3: 大小单双没有手续费，为什么积分还是不对？
**A**: 检查是否命中且回本（结算分应该是0）。

### Q4: 组合下注，命中了但还赢钱？
**A**: 检查是否回本：
- 命中 & 回本 = -手续费（小亏）
- 命中 & 不回本 = -5倍-手续费（大亏）

---

## ✅ 测试完成后

如果所有测试都通过，说明新规则已正确实施！

可以部署到生产环境了：
```bash
cd /path/to/score-system
git add .
git commit -m "重构结算规则 - 完全符合新需求"
git push

# 在服务器上
./rebuild-backend.sh
```

---

**祝测试顺利！🚀**

