# 封盘时间配置说明 ⚙️

## 📋 功能概述

封盘时间现已支持**后台动态配置**，管理员可以在网站设置中灵活调整封盘策略，无需修改代码。

---

## 🎯 可配置项

### 1. 开奖间隔时间 (`draw_interval`)

**说明**：两次开奖之间的时间间隔（秒）

- **默认值**：`210` 秒（3.5分钟）
- **取值范围**：60-600秒（1-10分钟）
- **用途**：确定开奖周期

**示例**：
- `180` = 3分钟一期
- `210` = 3.5分钟一期（默认）
- `300` = 5分钟一期

---

### 2. 封盘时间 (`close_before_draw`)

**说明**：开奖前多少秒停止接受下注

- **默认值**：`30` 秒
- **取值范围**：5-120秒
- **用途**：给系统留出结算时间，避免开奖瞬间的下注

**示例**：
- `15` = 开奖前15秒封盘
- `30` = 开奖前30秒封盘（默认）
- `60` = 开奖前1分钟封盘

**封盘期间**：
- ❌ 用户无法下注
- ⏱️ 显示倒计时："距离开奖还有 X 秒"
- 🔒 所有下注按钮禁用

---

### 3. 封盘预警时间 (`warning_time`)

**说明**：封盘前多少秒开始显示预警提示

- **默认值**：`60` 秒
- **取值范围**：10-180秒
- **用途**：提醒用户即将封盘，抓紧下注

**示例**：
- `30` = 封盘前30秒开始预警
- `60` = 封盘前60秒开始预警（默认）
- `90` = 封盘前1.5分钟开始预警

**预警期间**：
- ⚠️ 显示警告文字："⚠️ 即将封盘，还有 X 秒"
- ✅ 仍可以下注
- 🎨 界面变为黄色警告色

---

## 🎮 配置方式

### 方式一：管理后台配置（推荐）

#### 1. 登录管理后台

```
访问：http://localhost:5174
账号：admin
密码：admin123
```

#### 2. 进入网站设置

导航：**系统管理** → **网站设置**

#### 3. 修改配置

```yaml
开奖间隔时间：210 秒     # 开奖周期
封盘时间：30 秒          # 开奖前30秒封盘
封盘预警时间：60 秒      # 封盘前60秒预警
```

#### 4. 保存设置

点击"保存设置"按钮，系统会：
- ✅ 保存到数据库
- 🔄 自动刷新倒计时服务配置
- ⚡ 立即生效（最多延迟5分钟）

---

### 方式二：API 调用

#### 接口信息

```http
PUT /api/system/settings
Authorization: Bearer {admin_token}
Content-Type: application/json
```

#### 请求示例

```json
{
  "drawInterval": 210,
  "closeBeforeDraw": 30,
  "warningTime": 60
}
```

#### 响应示例

```json
{
  "code": 200,
  "message": "系统设置更新成功",
  "data": {}
}
```

---

### 方式三：直接修改数据库

```sql
-- 修改开奖间隔
UPDATE system_settings 
SET setting_value = '210' 
WHERE setting_key = 'draw_interval';

-- 修改封盘时间
UPDATE system_settings 
SET setting_value = '30' 
WHERE setting_key = 'close_before_draw';

-- 修改预警时间
UPDATE system_settings 
SET setting_value = '60' 
WHERE setting_key = 'warning_time';
```

**注意**：修改数据库后，配置会在**5分钟内**自动刷新（定时任务）。

---

## 📊 时间轴示例

### 默认配置（210秒周期，30秒封盘，60秒预警）

```
0秒                           150秒               180秒    210秒
|------------------------------|-------------------|--------|
     正常下注期                    预警期           封盘期   开奖

✅ 0-150秒：正常下注，显示绿色
⚠️ 150-180秒：预警状态，黄色提示"即将封盘"
❌ 180-210秒：封盘期，红色提示"已封盘"
🎲 210秒：开奖，进入下一期
```

### 配置示例1：快速游戏（180秒周期，15秒封盘）

```
0秒                    165秒  180秒
|----------------------|------|
      正常下注            封盘   开奖

更快的游戏节奏，适合活跃玩家
```

### 配置示例2：保守策略（210秒周期，60秒封盘）

```
0秒              150秒      210秒
|----------------|----------|
    正常下注        长封盘     开奖

更长的封盘时间，避免抢开奖
```

---

## 🔄 配置生效时间

| 方式 | 生效时间 | 说明 |
|-----|---------|------|
| 管理后台修改 | **立即生效** | 保存时主动刷新配置 |
| API 调用 | **立即生效** | 更新时主动刷新配置 |
| 数据库直接修改 | **5分钟内** | 定时任务自动刷新 |
| 手动刷新 | **立即** | 调用刷新接口 |

### 手动刷新配置

```http
POST /api/lottery/refresh-status
Authorization: Bearer {admin_token}
```

---

## 💡 配置建议

### 1. 平衡游戏节奏

| 游戏类型 | 开奖间隔 | 封盘时间 | 预警时间 |
|---------|---------|---------|---------|
| 快速游戏 | 180秒 | 15秒 | 30秒 |
| 标准游戏 | 210秒 | 30秒 | 60秒 |
| 慢速游戏 | 300秒 | 45秒 | 90秒 |

### 2. 封盘时间设置原则

**过短的封盘时间**：
- ❌ 用户可能在开奖瞬间下注
- ❌ 结算压力大
- ✅ 下注时间长，用户体验好

**过长的封盘时间**：
- ✅ 系统有充足时间处理
- ✅ 避免争议
- ❌ 下注时间短，用户可能错过

**推荐**：
- 封盘时间 = 开奖间隔的 10-20%
- 例如：210秒周期 → 20-40秒封盘

### 3. 预警时间设置原则

- 预警时间 ≥ 封盘时间 × 2
- 给用户足够的反应时间
- 推荐：60秒预警 + 30秒封盘

---

## 🛠️ 技术实现

### 架构

```
数据库 (system_settings)
    ↓ 读取配置
倒计时服务 (LotteryCountdownService)
    ↓ 实时计算
前端界面
    ↓ 显示状态
用户
```

### 配置加载流程

1. **启动时加载**：应用启动后立即从数据库读取
2. **定时刷新**：每5分钟自动重新加载
3. **手动刷新**：管理员修改后立即刷新
4. **降级策略**：数据库读取失败时使用默认值

### 关键代码

```typescript
// lottery-countdown.service.ts

// 从数据库加载配置
private async loadSettings() {
  const drawInterval = await this.prisma.systemSetting.findUnique({
    where: { settingKey: 'draw_interval' },
  });
  this.DRAW_INTERVAL = parseInt(drawInterval.settingValue) || 210;
  
  // ... 其他配置
}

// 定时刷新（每5分钟）
@Cron('*/5 * * * *')
async reloadSettings() {
  await this.loadSettings();
}
```

---

## 📚 相关文档

- [开奖数据定时同步方案.md](./开奖数据定时同步方案.md)
- [API接口文档.md](../API接口文档.md)
- [启动指南.md](./启动指南.md)

---

## ❓ 常见问题

### Q1: 修改配置后多久生效？

**A**: 
- 通过管理后台或API修改：**立即生效**
- 直接修改数据库：**5分钟内自动生效**
- 手动调用刷新接口：**立即生效**

### Q2: 封盘时间可以设为0吗？

**A**: 不建议。最小值是5秒，给系统留出最基本的处理时间。

### Q3: 如果设置不合理会怎样？

**A**: 系统有验证：
- 开奖间隔：60-600秒
- 封盘时间：5-120秒
- 预警时间：10-180秒
- 超出范围会提示错误

### Q4: 配置会影响已经开始的这期吗？

**A**: 会。配置立即生效，影响当前周期的剩余时间计算。

### Q5: 如何验证配置是否生效？

**A**: 
1. 查看前端倒计时显示
2. 尝试在封盘期下注（应该被拒绝）
3. 查看后端日志：`配置加载成功: 开奖间隔=xxx秒`

---

## 🎉 总结

封盘时间配置功能让系统更加灵活：

✅ **灵活调整**：管理员可根据实际情况调整  
✅ **即时生效**：修改后立即生效  
✅ **安全可靠**：有合理的取值范围限制  
✅ **用户友好**：清晰的状态提示  
✅ **易于维护**：无需修改代码

**现在您可以在管理后台自由调整封盘策略了！** 🚀



