# æ•°æ®æºé…ç½®è¿ç§»è¯´æ˜ ğŸ”§

## ä¿®æ”¹æ¦‚è¿°

å°†"å¼€å¥–æ•°æ®æº"é…ç½®ä»å‰ç«¯ç®¡ç†ç•Œé¢ç§»é™¤ï¼Œæ”¹ä¸ºç”±åç«¯ç»Ÿä¸€ç®¡ç†ã€‚è¿™æ ·å¯ä»¥ï¼š
- âœ… æé«˜å®‰å…¨æ€§ï¼ˆé¿å…è¯¯ä¿®æ”¹æ•°æ®æºï¼‰
- âœ… ç®€åŒ–å‰ç«¯ç•Œé¢
- âœ… é›†ä¸­ç®¡ç†é…ç½®

## ä¿®æ”¹è¯¦æƒ…

### 1. å‰ç«¯ä¿®æ”¹

**æ–‡ä»¶ï¼š** `frontend-admin/src/views/SystemSettings.vue`

#### 1.1 åˆ é™¤ UI éƒ¨åˆ†
åˆ é™¤äº†"æ•°æ®æºè®¾ç½®"æ•´ä¸ªåŒºå—ï¼š

```vue
<!-- å·²åˆ é™¤ -->
<el-divider content-position="left">æ•°æ®æºè®¾ç½®</el-divider>

<el-form-item label="å¼€å¥–æ•°æ®æº" prop="lotteryDataSource">
  <el-input
    v-model="form.lotteryDataSource"
    placeholder="è¯·è¾“å…¥å¼€å¥–æ•°æ®æºURL"
  />
  <span class="form-tip">å¼€å¥–æ•°æ®è·å–æ¥å£åœ°å€</span>
</el-form-item>
```

#### 1.2 åˆ é™¤éªŒè¯è§„åˆ™
```typescript
// å·²åˆ é™¤
lotteryDataSource: [
  { required: true, message: 'è¯·è¾“å…¥å¼€å¥–æ•°æ®æºURL', trigger: 'blur' },
  { type: 'url' as const, message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„URL', trigger: 'blur' },
],
```

#### 1.3 æäº¤æ—¶è¿‡æ»¤å­—æ®µ
```typescript
// æäº¤è®¾ç½®
const handleSubmit = async () => {
  if (!formRef.value) return

  try {
    await formRef.value.validate()
    submitLoading.value = true
    
    // ç§»é™¤ lotteryDataSourceï¼Œç”±åç«¯é…ç½®æ–‡ä»¶ç®¡ç†
    const { lotteryDataSource, ...settingsToUpdate } = form
    await updateSystemSettings(settingsToUpdate)
    
    ElMessage.success('ä¿å­˜æˆåŠŸ')
  } catch (error) {
    console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error)
  } finally {
    submitLoading.value = false
  }
}
```

### 2. åç«¯ä¿®æ”¹

**æ–‡ä»¶ï¼š** `backend/src/modules/system/dto/update-system-settings.dto.ts`

æ ‡è®° `lotteryDataSource` ä¸ºå·²åºŸå¼ƒï¼š

```typescript
@ApiProperty({ description: 'å¼€å¥–æ•°æ®æºï¼ˆå·²åºŸå¼ƒï¼Œç”±åç«¯é…ç½®æ–‡ä»¶ç®¡ç†ï¼‰', required: false })
@IsOptional()
@IsString()
lotteryDataSource?: string;
```

**æ–‡ä»¶ï¼š** `backend/src/modules/system/system.service.ts`

å°† `lotteryDataSource` åŠ å…¥åºŸå¼ƒå­—æ®µåˆ—è¡¨ï¼š

```typescript
// è¿‡æ»¤æ‰å·²åºŸå¼ƒçš„å­—æ®µï¼ˆç”±åç«¯é…ç½®æ–‡ä»¶æˆ–å…¶ä»–æ–¹å¼ç®¡ç†ï¼‰
const deprecatedFields = ['warningTime', 'lotteryDataSource'];

for (const [key, value] of Object.entries(updateDto)) {
  if (value !== undefined && !deprecatedFields.includes(key)) {
    // åªä¿å­˜éåºŸå¼ƒå­—æ®µ
  }
}
```

### 3. åç«¯é…ç½®ç®¡ç†

æ•°æ®æºç°åœ¨ç”±åç«¯é…ç½®æ–‡ä»¶ç®¡ç†ï¼Œåœ¨ä»¥ä¸‹ä½ç½®é…ç½®ï¼š

**æ–‡ä»¶ï¼š** `backend/.env`

```env
# USA28 API æ•°æ®æº
LOTTERY_DATA_SOURCE=https://api.365kaik.com/api/v1/trend/getHistoryList
```

æˆ–è€…åœ¨æ•°æ®åº“çš„ `system_settings` è¡¨ä¸­æ‰‹åŠ¨ç»´æŠ¤ï¼š

```sql
-- æŸ¥çœ‹å½“å‰æ•°æ®æºé…ç½®
SELECT * FROM system_settings WHERE setting_key = 'lottery_data_source';

-- æ›´æ–°æ•°æ®æºï¼ˆå¦‚éœ€è¦ï¼‰
UPDATE system_settings 
SET setting_value = 'https://api.365kaik.com/api/v1/trend/getHistoryList' 
WHERE setting_key = 'lottery_data_source';
```

## é…ç½®ä¼˜å…ˆçº§

åç«¯è·å–æ•°æ®æºçš„ä¼˜å…ˆçº§ï¼š
1. **ç¯å¢ƒå˜é‡** `.env` æ–‡ä»¶ä¸­çš„ `LOTTERY_DATA_SOURCE`
2. **æ•°æ®åº“é…ç½®** `system_settings` è¡¨ä¸­çš„ `lottery_data_source`
3. **é»˜è®¤å€¼** ç¡¬ç¼–ç çš„é»˜è®¤å€¼

## å‰ç«¯ç•Œé¢å˜åŒ–

### ä¿®æ”¹å‰
```
ç³»ç»Ÿè®¾ç½®
â”œâ”€â”€ æ¸¸æˆæ§åˆ¶
â”‚   â”œâ”€â”€ æ¸¸æˆå¼€å…³
â”‚   â”œâ”€â”€ ç»´æŠ¤æ¨¡å¼
â”‚   â””â”€â”€ è‡ªåŠ¨ç»“ç®—
â”œâ”€â”€ å°ç›˜æ—¶é—´è®¾ç½®
â”‚   â”œâ”€â”€ å¼€å¥–é—´éš”æ—¶é—´
â”‚   â””â”€â”€ å°ç›˜æ—¶é—´
â”œâ”€â”€ ç³»ç»Ÿå…¬å‘Š
â”‚   â””â”€â”€ ç³»ç»Ÿå…¬å‘Šå†…å®¹
â””â”€â”€ æ•°æ®æºè®¾ç½® âŒ å·²åˆ é™¤
    â””â”€â”€ å¼€å¥–æ•°æ®æº
```

### ä¿®æ”¹å
```
ç³»ç»Ÿè®¾ç½®
â”œâ”€â”€ æ¸¸æˆæ§åˆ¶
â”‚   â”œâ”€â”€ æ¸¸æˆå¼€å…³
â”‚   â”œâ”€â”€ ç»´æŠ¤æ¨¡å¼
â”‚   â””â”€â”€ è‡ªåŠ¨ç»“ç®—
â”œâ”€â”€ å°ç›˜æ—¶é—´è®¾ç½®
â”‚   â”œâ”€â”€ å¼€å¥–é—´éš”æ—¶é—´
â”‚   â””â”€â”€ å°ç›˜æ—¶é—´
â””â”€â”€ ç³»ç»Ÿå…¬å‘Š
    â””â”€â”€ ç³»ç»Ÿå…¬å‘Šå†…å®¹
```

## æµ‹è¯•éªŒè¯

1. **å‰ç«¯é¡µé¢**
   - âœ… è®¿é—® `http://localhost:5174/system-settings`
   - âœ… ç¡®è®¤ä¸å†æ˜¾ç¤º"æ•°æ®æºè®¾ç½®"åŒºå—
   - âœ… å…¶ä»–é…ç½®å¯ä»¥æ­£å¸¸ä¿å­˜

2. **åç«¯æ•°æ®åŒæ­¥**
   - âœ… æ£€æŸ¥å¼€å¥–æ•°æ®åŒæ­¥æ˜¯å¦æ­£å¸¸å·¥ä½œ
   - âœ… æ•°æ®æºåº”ä» `.env` æˆ–æ•°æ®åº“è¯»å–
   - âœ… ä¸å—å‰ç«¯è®¾ç½®é¡µé¢å½±å“

3. **ä¿®æ”¹æ•°æ®æº**ï¼ˆå¦‚éœ€è¦ï¼‰
   ```bash
   # æ–¹å¼1: ä¿®æ”¹ .env æ–‡ä»¶
   cd score-system/backend
   vim .env
   # æ·»åŠ æˆ–ä¿®æ”¹: LOTTERY_DATA_SOURCE=https://api.xxx.com/...
   
   # æ–¹å¼2: ç›´æ¥ä¿®æ”¹æ•°æ®åº“
   mysql -u root -p score_system
   UPDATE system_settings 
   SET setting_value = 'https://new-api.com/...' 
   WHERE setting_key = 'lottery_data_source';
   ```

## å…¼å®¹æ€§è¯´æ˜

- âœ… æ•°æ®åº“ä¸­çš„ `lottery_data_source` è®°å½•ä¿ç•™
- âœ… åç«¯ä»ä¼šè¯»å–è¿™ä¸ªé…ç½®
- âœ… åªæ˜¯å‰ç«¯ä¸å†æä¾›ç¼–è¾‘ç•Œé¢
- âœ… å¦‚æœå‰ç«¯è¯¯å‘é€ï¼Œåç«¯ä¼šè‡ªåŠ¨è¿‡æ»¤

## å®ŒæˆçŠ¶æ€

- âœ… å‰ç«¯é¡µé¢åˆ é™¤"æ•°æ®æºè®¾ç½®"
- âœ… å‰ç«¯æäº¤æ—¶è¿‡æ»¤ `lotteryDataSource`
- âœ… åç«¯ DTO æ ‡è®°å­—æ®µä¸ºåºŸå¼ƒ
- âœ… åç«¯ Service è¿‡æ»¤åºŸå¼ƒå­—æ®µ
- âœ… ä»£ç  Linter æ£€æŸ¥é€šè¿‡

## å›æ»šæ–¹æ¡ˆ

å¦‚æœéœ€è¦æ¢å¤å‰ç«¯é…ç½®ç•Œé¢ï¼š

1. æ¢å¤ `SystemSettings.vue` ä¸­çš„"æ•°æ®æºè®¾ç½®"åŒºå—
2. æ¢å¤éªŒè¯è§„åˆ™
3. ä¿®æ”¹æäº¤é€»è¾‘ï¼Œä¸å†è¿‡æ»¤ `lotteryDataSource`
4. ä»åç«¯ `deprecatedFields` ä¸­ç§»é™¤ `lotteryDataSource`

---

**æ›´æ–°æ—¶é—´ï¼š** 2025-11-27
**ç›¸å…³æ–‡æ¡£ï¼š**
- warningTimeå­—æ®µç§»é™¤è¯´æ˜.md
- åˆ é™¤é€€æ°´åŠŸèƒ½è¯´æ˜.md



