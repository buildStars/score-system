# å¼€å¥–æ•°æ®å®šæ—¶åŒæ­¥æ–¹æ¡ˆ ğŸ”„

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

é‡‡ç”¨**åå°å®šæ—¶ä»»åŠ¡ä¸»åŠ¨åŒæ­¥**çš„æ¶æ„ï¼Œæ›¿ä»£åŸæ¥çš„"å‰ç«¯è¯·æ±‚æ—¶è¢«åŠ¨è·å–"æ–¹æ¡ˆã€‚

### æ ¸å¿ƒæ€æƒ³

> **æ•°æ®åº“ä½œä¸ºå”¯ä¸€æ•°æ®æºï¼Œå®šæ—¶ä»»åŠ¡è´Ÿè´£ä¿æŒæ•°æ®åº“ä¸ç¬¬ä¸‰æ–¹APIåŒæ­¥**

```
ç¬¬ä¸‰æ–¹API (USA28) 
    â†“ 
å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒæ­¥ (æ¯3åˆ†é’Ÿ)
    â†“
æ•°æ®åº“ (MySQL)
    â†“
å‰ç«¯è¯·æ±‚ (ç›´æ¥æŸ¥æ•°æ®åº“ï¼Œé€Ÿåº¦å¿«)
```

---

## ğŸ¯ æ–¹æ¡ˆä¼˜åŠ¿

### âœ… 1. æ€§èƒ½ä¼˜åŒ–
- **å‰ç«¯æŸ¥è¯¢é€Ÿåº¦å¿«**ï¼šç›´æ¥æŸ¥æ•°æ®åº“ï¼Œæ— éœ€ç­‰å¾…ç¬¬ä¸‰æ–¹APIå“åº”
- **å“åº”æ—¶é—´ç¨³å®š**ï¼šä¸å—ç¬¬ä¸‰æ–¹APIç½‘ç»œæ³¢åŠ¨å½±å“
- **é™ä½å»¶è¿Ÿ**ï¼šæ•°æ®åº“æœ¬åœ°æŸ¥è¯¢ < 50msï¼ŒAPIè¯·æ±‚é€šå¸¸ > 500ms

### âœ… 2. ç”¨æˆ·ä½“éªŒæå‡
- **æ— æ„ŸçŸ¥åŠ è½½**ï¼šç”¨æˆ·çœ‹åˆ°çš„æ•°æ®ç«‹å³æ˜¾ç¤ºï¼Œæ— åŠ è½½ç­‰å¾…
- **ç•Œé¢æµç•…**ï¼šä¸ä¼šå› ä¸ºAPIæ…¢å¯¼è‡´é¡µé¢å¡é¡¿
- **æ•°æ®ä¸€è‡´æ€§**ï¼šæ‰€æœ‰ç”¨æˆ·çœ‹åˆ°çš„æ•°æ®ä¿æŒä¸€è‡´

### âœ… 3. å¯é æ€§å¢å¼º
- **å®¹é”™èƒ½åŠ›å¼º**ï¼šå³ä½¿æŸæ¬¡APIè°ƒç”¨å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·æŸ¥è¯¢
- **æ•°æ®æŒä¹…åŒ–**ï¼šæ‰€æœ‰å†å²æ•°æ®æ°¸ä¹…ä¿å­˜åœ¨æ•°æ®åº“
- **æ•…éšœæ¢å¤**ï¼šAPIæ¢å¤åï¼Œå®šæ—¶ä»»åŠ¡ä¼šè‡ªåŠ¨è¡¥é½ç¼ºå¤±æ•°æ®

### âœ… 4. é™ä½APIå‹åŠ›
- **å‡å°‘è°ƒç”¨é¢‘ç‡**ï¼šæ¯3åˆ†é’ŸåŒæ­¥1æ¬¡ï¼Œè€Œä¸æ˜¯æ¯æ¬¡è¯·æ±‚éƒ½è°ƒç”¨
- **é¿å…é‡å¤è¯·æ±‚**ï¼šå¤šç”¨æˆ·å¹¶å‘æŸ¥è¯¢ä¸ä¼šå¯¼è‡´é‡å¤APIè°ƒç”¨
- **ç¬¦åˆAPIæœ€ä½³å®è·µ**ï¼šé¿å…è¢«ç¬¬ä¸‰æ–¹é™æµæˆ–å°ç¦

### âœ… 5. ç»´æŠ¤æ€§æå‡
- **é€»è¾‘é›†ä¸­**ï¼šæ•°æ®åŒæ­¥é€»è¾‘é›†ä¸­åœ¨åç«¯å®šæ—¶ä»»åŠ¡
- **æ˜“äºè°ƒè¯•**ï¼šæ¸…æ™°çš„æ—¥å¿—è®°å½•æ¯æ¬¡åŒæ­¥ç»“æœ
- **çµæ´»æ§åˆ¶**ï¼šå¯ä»¥éšæ—¶è°ƒæ•´åŒæ­¥é¢‘ç‡å’Œç­–ç•¥

---

## ğŸ”§ æŠ€æœ¯å®ç°

### æ ¸å¿ƒç»„ä»¶

#### 1. **å®šæ—¶åŒæ­¥æœåŠ¡** (`lottery-sync.service.ts`)

```typescript
@Injectable()
export class LotterySyncService {
  // æ¯3åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  @Cron('*/3 * * * *')
  async handleScheduledSync() {
    await this.syncLotteryData();
  }

  // æ¯30ç§’æ£€æŸ¥æ˜¯å¦æœ‰æ–°æœŸ
  @Cron('*/30 * * * * *')
  async checkNewIssue() {
    // æ£€æµ‹åˆ°æ–°æœŸç«‹å³åŒæ­¥
  }
}
```

**åŠŸèƒ½**ï¼š
- â° æ¯3åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡
- ğŸ² æ£€æµ‹åˆ°æ–°æœŸå¼€å¥–ç«‹å³åŒæ­¥
- ğŸš€ åº”ç”¨å¯åŠ¨å5ç§’é¦–æ¬¡åŒæ­¥
- ğŸ”’ é˜²å¹¶å‘æ§åˆ¶ï¼ˆåŒæ—¶åªè¿è¡Œä¸€ä¸ªåŒæ­¥ä»»åŠ¡ï¼‰

#### 2. **å¼€å¥–æœåŠ¡** (`lottery.service.ts`)

```typescript
// ç›´æ¥ä»æ•°æ®åº“æŸ¥è¯¢
async getLotteryHistory(query: QueryLotteryDto) {
  return this.prisma.lotteryResult.findMany({
    where,
    orderBy: { drawTime: 'desc' },
  });
}

// åŒæ­¥æ•°æ®åˆ°æ•°æ®åº“
async syncLotteryData() {
  // è°ƒç”¨USA28 API
  // è§£ææ•°æ®
  // ä¿å­˜åˆ°æ•°æ®åº“
}
```

**èŒè´£**ï¼š
- ğŸ“¡ è°ƒç”¨ç¬¬ä¸‰æ–¹APIè·å–æ•°æ®
- ğŸ’¾ ä¿å­˜/æ›´æ–°æ•°æ®åº“
- ğŸ” æä¾›æŸ¥è¯¢æ¥å£

#### 3. **å€’è®¡æ—¶æœåŠ¡** (`lottery-countdown.service.ts`)

```typescript
@Injectable()
export class LotteryCountdownService {
  // è·å–å½“å‰æœŸå·
  async getLotteryStatus() { }
  
  // åˆ¤æ–­æ˜¯å¦å¯ä»¥ä¸‹æ³¨ï¼ˆå°ç›˜æ£€æµ‹ï¼‰
  async canPlaceBet() { }
}
```

**èŒè´£**ï¼š
- â±ï¸ è®¡ç®—å¼€å¥–å€’è®¡æ—¶
- ğŸ” åˆ¤æ–­æ˜¯å¦åœ¨å°ç›˜æœŸ
- ğŸ¯ æä¾›å½“å‰æœŸå·ä¿¡æ¯

---

## ğŸ“Š åŒæ­¥ç­–ç•¥

### å®šæ—¶ä»»åŠ¡æ—¶é—´è¡¨

| å®šæ—¶ä»»åŠ¡ | æ‰§è¡Œé¢‘ç‡ | Cronè¡¨è¾¾å¼ | è¯´æ˜ |
|---------|---------|-----------|------|
| å¸¸è§„åŒæ­¥ | æ¯3åˆ†é’Ÿ | `*/3 * * * *` | ä¸å¼€å¥–å‘¨æœŸä¸€è‡´ |
| æ–°æœŸæ£€æµ‹ | æ¯30ç§’ | `*/30 * * * * *` | å¿«é€Ÿå“åº”æ–°æœŸ |
| åº”ç”¨å¯åŠ¨ | å¯åŠ¨å5ç§’ | - | ç¡®ä¿åˆå§‹æ•°æ® |

### æ•°æ®æµç¨‹

```mermaid
sequenceDiagram
    participant Timer as å®šæ—¶ä»»åŠ¡
    participant Sync as åŒæ­¥æœåŠ¡
    participant API as USA28 API
    participant DB as æ•°æ®åº“
    participant User as ç”¨æˆ·

    Timer->>Sync: è§¦å‘åŒæ­¥ï¼ˆæ¯3åˆ†é’Ÿï¼‰
    Sync->>API: è¯·æ±‚æœ€æ–°å¼€å¥–æ•°æ®
    API-->>Sync: è¿”å›æ•°æ®
    Sync->>DB: ä¿å­˜/æ›´æ–°æ•°æ®
    
    User->>DB: æŸ¥è¯¢å¼€å¥–å†å²
    DB-->>User: ç«‹å³è¿”å›ï¼ˆå¿«é€Ÿï¼‰
```

---

## ğŸ›¡ï¸ å®¹é”™æœºåˆ¶

### 1. APIå¤±è´¥å¤„ç†

```typescript
try {
  const result = await this.lotteryService.syncLotteryData();
  this.logger.log(`âœ… åŒæ­¥æˆåŠŸ: ${result.syncedCount} æ¡`);
} catch (error) {
  this.logger.error(`âŒ åŒæ­¥å¤±è´¥: ${error.message}`);
  // ä¸æŠ›å‡ºé”™è¯¯ï¼Œä¸‹æ¬¡ç»§ç»­å°è¯•
}
```

**ç­–ç•¥**ï¼š
- âŒ å•æ¬¡å¤±è´¥ä¸å½±å“ç³»ç»Ÿè¿è¡Œ
- ğŸ”„ ä¸‹æ¬¡å®šæ—¶ä»»åŠ¡ä¼šè‡ªåŠ¨é‡è¯•
- ğŸ“ è®°å½•é”™è¯¯æ—¥å¿—ä¾›æ’æŸ¥

### 2. æ•°æ®å»é‡

```typescript
await this.prisma.lotteryResult.upsert({
  where: { issue: drawIssue },
  update: lotteryData,
  create: lotteryData,
});
```

**ç­–ç•¥**ï¼š
- ğŸ”‘ ä½¿ç”¨æœŸå·ä½œä¸ºå”¯ä¸€æ ‡è¯†
- ğŸ”„ é‡å¤æ•°æ®è‡ªåŠ¨æ›´æ–°
- âœ… é¿å…æ•°æ®é‡å¤

### 3. å¹¶å‘æ§åˆ¶

```typescript
private isSyncing: boolean = false;

private async syncLotteryData() {
  if (this.isSyncing) {
    return; // è·³è¿‡æœ¬æ¬¡
  }
  this.isSyncing = true;
  try {
    // æ‰§è¡ŒåŒæ­¥
  } finally {
    this.isSyncing = false;
  }
}
```

**ç­–ç•¥**ï¼š
- ğŸ”’ åŒæ—¶åªè¿è¡Œä¸€ä¸ªåŒæ­¥ä»»åŠ¡
- â­ï¸ å¹¶å‘è¯·æ±‚è‡ªåŠ¨è·³è¿‡
- âœ… é¿å…èµ„æºæµªè´¹

---

## ğŸ“¡ APIæ¥å£

### ç”¨æˆ·æ¥å£

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|-----|------|-----|------|
| å¼€å¥–å†å² | GET | `/api/lottery/history` | æŸ¥è¯¢æ•°æ®åº“ |
| å½“å‰æœŸå· | GET | `/api/lottery/current` | æŸ¥è¯¢æ•°æ®åº“ |
| å€’è®¡æ—¶çŠ¶æ€ | GET | `/api/lottery/status` | å®æ—¶è®¡ç®— |

### ç®¡ç†å‘˜æ¥å£

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|-----|------|-----|------|
| æ‰‹åŠ¨åŒæ­¥ | POST | `/api/lottery/sync` | ç«‹å³è§¦å‘åŒæ­¥ |
| åŒæ­¥çŠ¶æ€ | GET | `/api/lottery/sync-status` | æŸ¥çœ‹åŒæ­¥çŠ¶æ€ |
| æµ‹è¯•API | GET | `/api/lottery/test-api` | æµ‹è¯•ç¬¬ä¸‰æ–¹API |

---

## ğŸ® ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯æŸ¥è¯¢å¼€å¥–å†å²

```typescript
// ç®€å•ã€å¿«é€Ÿ
const { data } = await axios.get('/api/lottery/history', {
  params: { page: 1, limit: 20 }
});

// å“åº”é€Ÿåº¦ï¼š< 50ms
// æ•°æ®æ¥æºï¼šæ•°æ®åº“
```

### ç®¡ç†å‘˜æ‰‹åŠ¨åŒæ­¥

```typescript
// ç®¡ç†åå°è§¦å‘
const { data } = await axios.post('/api/lottery/sync');

// å“åº”ï¼š{ message: 'åŒæ­¥ä»»åŠ¡å·²è§¦å‘' }
```

### æŸ¥çœ‹åŒæ­¥çŠ¶æ€

```typescript
const { data } = await axios.get('/api/lottery/sync-status');

// å“åº”ï¼š
// {
//   isSyncing: false,
//   lastSyncedIssue: '3330421'
// }
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### æ—§æ–¹æ¡ˆï¼ˆè¢«åŠ¨åŒæ­¥ï¼‰

```
ç”¨æˆ·è¯·æ±‚ â†’ æ£€æŸ¥æ•°æ®åº“ â†’ è°ƒç”¨API â†’ è§£ææ•°æ® â†’ ä¿å­˜æ•°æ®åº“ â†’ è¿”å›
å“åº”æ—¶é—´ï¼š500ms - 3000msï¼ˆå–å†³äºAPIé€Ÿåº¦ï¼‰
```

### æ–°æ–¹æ¡ˆï¼ˆå®šæ—¶åŒæ­¥ï¼‰

```
ç”¨æˆ·è¯·æ±‚ â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ è¿”å›
å“åº”æ—¶é—´ï¼š20ms - 50msï¼ˆç¨³å®šï¼‰
```

**æ€§èƒ½æå‡**ï¼š**10å€ - 100å€** ğŸš€

---

## ğŸ” ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—ç¤ºä¾‹

```
[LotterySyncService] ğŸš€ å¼€å¥–æ•°æ®å®šæ—¶åŒæ­¥æœåŠ¡å·²å¯åŠ¨
[LotterySyncService] â° å®šæ—¶ä»»åŠ¡è§¦å‘ï¼šå¼€å§‹åŒæ­¥å¼€å¥–æ•°æ®
[LotterySyncService] ğŸ“¡ å¼€å§‹åŒæ­¥å¼€å¥–æ•°æ®...
[LotteryService] è¯·æ±‚USA28 API: https://api.365kaik.com/...
[LotteryService] âœ“ æˆåŠŸä¿å­˜æœŸå· 3330421: 1+2+3=6
[LotterySyncService] âœ… åŒæ­¥æˆåŠŸï¼æ–°å¢ 10 æ¡æ•°æ®ï¼Œæœ€æ–°æœŸå·: 3330421
[LotterySyncService] ğŸ² æ£€æµ‹åˆ°æ–°æœŸå¼€å¥–ï¼æœŸå·: 3330422
```

### ç›‘æ§æŒ‡æ ‡

- âœ… åŒæ­¥æˆåŠŸç‡
- â±ï¸ åŒæ­¥è€—æ—¶
- ğŸ“Š æ•°æ®é‡ç»Ÿè®¡
- âŒ å¤±è´¥æ¬¡æ•°å’ŒåŸå› 

---

## âš™ï¸ é…ç½®è°ƒæ•´

### ä¿®æ”¹åŒæ­¥é¢‘ç‡

```typescript
// lottery-sync.service.ts

// æ”¹ä¸ºæ¯åˆ†é’ŸåŒæ­¥
@Cron('* * * * *')

// æ”¹ä¸ºæ¯5åˆ†é’ŸåŒæ­¥
@Cron('*/5 * * * *')

// æ”¹ä¸ºæ¯å°æ—¶åŒæ­¥
@Cron('0 * * * *')
```

### ç¦ç”¨å®šæ—¶ä»»åŠ¡

```typescript
// app.module.ts
// æ³¨é‡Šæ‰ ScheduleModule å³å¯
// ScheduleModule.forRoot(),
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä»·å€¼

1. **ç”¨æˆ·ä½“éªŒ** â†’ æŸ¥è¯¢é€Ÿåº¦æå‡ 10å€ä»¥ä¸Š
2. **ç³»ç»Ÿç¨³å®šæ€§** â†’ APIæ•…éšœä¸å½±å“ç”¨æˆ·
3. **æ•°æ®å¯é æ€§** â†’ æ‰€æœ‰æ•°æ®æ°¸ä¹…ä¿å­˜
4. **ç»´æŠ¤æ€§** â†’ é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºè°ƒè¯•
5. **æ‰©å±•æ€§** â†’ æ–¹ä¾¿æ·»åŠ æ–°çš„æ•°æ®æº

### é€‚ç”¨åœºæ™¯

âœ… éœ€è¦å±•ç¤ºå†å²æ•°æ®  
âœ… ç¬¬ä¸‰æ–¹APIå“åº”æ…¢  
âœ… å¤šç”¨æˆ·å¹¶å‘è®¿é—®  
âœ… å¯¹æ•°æ®ä¸€è‡´æ€§æœ‰è¦æ±‚  
âœ… éœ€è¦ç¦»çº¿æŸ¥è¯¢èƒ½åŠ›

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¼€å¥–æ•°æ®æºæ¥å£æµ‹è¯•æŠ¥å‘Š.md](../å¼€å¥–æ•°æ®æºæ¥å£æµ‹è¯•æŠ¥å‘Š.md)
- [å¼€å¥–æ•°æ®é‡‡é›†ç®—æ³•è¯¦è§£.md](../å¼€å¥–æ•°æ®é‡‡é›†ç®—æ³•è¯¦è§£.md)
- [å¼€å¥–æ•°æ®åŒæ­¥æŒ‡å—.md](./å¼€å¥–æ•°æ®åŒæ­¥æŒ‡å—.md)
- [å¯åŠ¨æŒ‡å—.md](./å¯åŠ¨æŒ‡å—.md)

---

**ğŸ‰ å®šæ—¶åŒæ­¥æ–¹æ¡ˆå·²å®Œæˆå¹¶å¯ç”¨ï¼**

**ä¸‹æ¬¡å¯åŠ¨åç«¯æœåŠ¡æ—¶ï¼Œå®šæ—¶ä»»åŠ¡ä¼šè‡ªåŠ¨è¿è¡Œï¼Œæ¯3åˆ†é’ŸåŒæ­¥ä¸€æ¬¡å¼€å¥–æ•°æ®ã€‚**



