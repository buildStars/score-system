# ğŸ° å®æ—¶å¼€å¥–æ•°æ®è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç³»ç»Ÿå·²å‡çº§ä¸º**å®æ—¶å¼€å¥–æ•°æ®æ¨¡å¼**ï¼Œå¼€å¥–å†å²é¡µé¢å°†ç›´æ¥ä» USA28 API è·å–æœ€æ–°æ•°æ®ï¼Œæ— éœ€æ‰‹åŠ¨åŒæ­¥ã€‚

---

## âœ¨ ä¸»è¦ç‰¹æ€§

### 1ï¸âƒ£ å®æ—¶æ•°æ®å±•ç¤º
- âœ… é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æœ€æ–°å¼€å¥–æ•°æ®
- âœ… æ•°æ®ç›´æ¥æ¥è‡ª USA28 å®˜æ–¹ API
- âœ… æ— éœ€ç­‰å¾…æ•°æ®åŒæ­¥ï¼Œå³æ—¶å¯è§

### 2ï¸âƒ£ æ™ºèƒ½é™çº§ç­–ç•¥
```
USA28 API (é¦–é€‰)
    â†“ å¦‚æœå¤±è´¥
æ•°æ®åº“æ•°æ® (å¤‡ç”¨)
```

### 3ï¸âƒ£ æ“ä½œæ›´ç®€å•
- ğŸš« **ç§»é™¤**ï¼šåŒæ­¥å¼€å¥–æ•°æ®æŒ‰é’®
- âœ… **æ–°å¢**ï¼šå®æ—¶æ•°æ®æ ‡è¯†
- âœ… **ä¿ç•™**ï¼šåˆ·æ–°æ•°æ®æŒ‰é’®

---

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯æ”¹è¿›

#### 1. ä¿®æ”¹ `getLotteryHistory` æ–¹æ³•

**åŸæ¥ï¼š** ä»æ•°æ®åº“è¯»å–æ•°æ®
```typescript
async getLotteryHistory(query: QueryLotteryDto) {
  // ä»æ•°æ®åº“æŸ¥è¯¢...
  return await this.prisma.lotteryResult.findMany({...});
}
```

**ç°åœ¨ï¼š** ç›´æ¥è°ƒç”¨ USA28 API
```typescript
async getLotteryHistory(query: QueryLotteryDto) {
  try {
    // 1. è°ƒç”¨ USA28 API
    const response = await axios.get('https://api.365kaik.com/api/v1/trend/getHistoryList', {
      params: { lotCode: '10029', pageSize, pageNum, t: Date.now() },
      httpsAgent: new https.Agent({ rejectUnauthorized: false }),
    });
    
    // 2. è½¬æ¢æ•°æ®æ ¼å¼
    const list = response.data.data.list.map(item => ({
      issue: item.drawIssue,
      number1: parseInt(item.drawCode.split(',')[0]),
      number2: parseInt(item.drawCode.split(',')[1]),
      number3: parseInt(item.drawCode.split(',')[2]),
      // ... è®¡ç®—ç»“æœ
    }));
    
    return { list, total, page, limit };
    
  } catch (error) {
    // 3. é™çº§åˆ°æ•°æ®åº“æŸ¥è¯¢
    return this.getLotteryHistoryFromDB(query);
  }
}
```

#### 2. SSL è¯ä¹¦å¤„ç†
```typescript
import * as https from 'https';

const httpsAgent = new https.Agent({
  rejectUnauthorized: false, // å¿½ç•¥è¯ä¹¦éªŒè¯
});
```

### å‰ç«¯æ”¹è¿›

#### 1. ç§»é™¤åŒæ­¥æŒ‰é’®
```vue
<!-- åŸæ¥ -->
<el-button type="primary" @click="handleSync">
  åŒæ­¥å¼€å¥–æ•°æ®
</el-button>

<!-- ç°åœ¨ -->
<el-tag type="success" effect="dark">
  <el-icon><CircleCheck /></el-icon>
  å®æ—¶æ•°æ®
</el-tag>
<el-button type="primary" @click="handleRefresh">
  åˆ·æ–°æ•°æ®
</el-button>
```

#### 2. ç®€åŒ–é€»è¾‘
```typescript
// åˆ é™¤ syncLottery API è°ƒç”¨
// åˆ é™¤ handleSync æ–¹æ³•

// åˆ·æ–°æ•°æ®ï¼ˆç›´æ¥é‡æ–°è·å–ï¼‰
const handleRefresh = () => {
  ElMessage.info('æ­£åœ¨è·å–æœ€æ–°å¼€å¥–æ•°æ®...')
  fetchLotteryHistory()
}
```

---

## ğŸ“Š API æ•°æ®æ ¼å¼

### USA28 API è¿”å›æ ¼å¼
```json
{
  "code": 0,
  "data": {
    "pageNum": 0,
    "totalCount": 132,
    "pageSize": 20,
    "list": [
      {
        "drawTime": "2025-11-27 04:11:30",
        "drawIssue": "3364685",
        "drawCode": "5,2,1",
        "groupCode": "pc28",
        "result": {
          "pc28_total": "8",
          "pc28_totalBigSmall": "2",
          "pc28_totalOddEven": "2",
          ...
        }
      }
    ]
  },
  "msg": "ok"
}
```

### ç³»ç»Ÿè½¬æ¢åæ ¼å¼
```json
{
  "list": [
    {
      "id": 3364685,
      "issue": "3364685",
      "number1": 5,
      "number2": 2,
      "number3": 1,
      "resultSum": 8,
      "sizeResult": "å°",
      "oddEvenResult": "åŒ",
      "comboResult": "å°åŒ",
      "isReturn": 0,
      "returnReason": null,
      "drawTime": "2025-11-27T04:11:30.000Z"
    }
  ],
  "total": 132,
  "page": 1,
  "limit": 20
}
```

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### æŸ¥çœ‹å¼€å¥–å†å²

1. **æ‰“å¼€é¡µé¢**
   - å·¦ä¾§èœå•ï¼šç‚¹å‡»"å¼€å¥–å†å²"
   - ç³»ç»Ÿè‡ªåŠ¨è·å–æœ€æ–°æ•°æ®

2. **åˆ·æ–°æ•°æ®**
   - ç‚¹å‡»"åˆ·æ–°æ•°æ®"æŒ‰é’®
   - æˆ–è€…åˆ‡æ¢é¡µé¢åè¿”å›

3. **æœç´¢æœŸå·**
   - è¾“å…¥æœŸå·ï¼ˆå¦‚ï¼š3364685ï¼‰
   - ç‚¹å‡»"æœç´¢"
   - æ”¯æŒæ¨¡ç³Šæœç´¢

### æ•°æ®ç‰¹ç‚¹

âœ… **å®æ—¶æ€§**
- æ•°æ®ç›´æ¥æ¥è‡ª USA28 å®˜æ–¹
- æ— å»¶è¿Ÿï¼Œå³æ—¶æ›´æ–°

âœ… **å‡†ç¡®æ€§**
- å®˜æ–¹æ•°æ®æºï¼Œæƒå¨å¯é 
- è‡ªåŠ¨è®¡ç®—å¤§å°ã€å•åŒã€ç»„åˆã€å›æœ¬

âœ… **å¯é æ€§**
- API å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°æ•°æ®åº“
- ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§

---

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦é…ç½® USA28 APIï¼Œå¯ä»¥åœ¨ `.env` ä¸­è®¾ç½®ï¼š

```env
# USA28 APIé…ç½®
USA28_API_URL=https://api.365kaik.com/api/v1/trend/getHistoryList
USA28_LOT_CODE=10029
USA28_API_TIMEOUT=30000
```

### æ•°æ®åº“ä½œç”¨

è™½ç„¶å¼€å¥–å†å²ä¸å†å­˜å‚¨ï¼Œä½†æ•°æ®åº“ä»ç”¨äºï¼š
- âœ… ç”¨æˆ·ä¸‹æ³¨è®°å½•
- âœ… ç§¯åˆ†å˜åŠ¨è®°å½•
- âœ… ç»“ç®—å†å²
- âœ… API å¤±è´¥æ—¶çš„é™çº§æ•°æ®æº

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæ˜¾ç¤º"æš‚æ— æ•°æ®"

**å¯èƒ½åŸå› ï¼š**
1. USA28 API æ— å“åº”
2. ç½‘ç»œè¿æ¥é—®é¢˜
3. SSL è¯ä¹¦éªŒè¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
cd score-system/backend
npm run start:dev

# æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
```

### é—®é¢˜2ï¼šæ•°æ®æ˜¾ç¤ºå»¶è¿Ÿ

**è¯´æ˜ï¼š**
- USA28 API å“åº”æ—¶é—´ï¼š1-3ç§’
- ç½‘ç»œè¾ƒæ…¢æ—¶å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´

**ä¼˜åŒ–å»ºè®®ï¼š**
- æ·»åŠ åŠ è½½åŠ¨ç”»ï¼ˆå·²å®ç°ï¼‰
- å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤30ç§’ï¼‰

### é—®é¢˜3ï¼šSSLè¯ä¹¦é”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼š**
```
UNABLE_TO_GET_ISSUER_CERT_LOCALLY
```

**è§£å†³æ–¹æ¡ˆï¼š**
å·²åœ¨ä»£ç ä¸­å¤„ç†ï¼š
```typescript
const httpsAgent = new https.Agent({
  rejectUnauthorized: false, // å¿½ç•¥è¯ä¹¦éªŒè¯
});
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### æ—§æ–¹æ¡ˆï¼ˆæ•°æ®åº“æ¨¡å¼ï¼‰
```
ç”¨æˆ·è®¿é—® â†’ æ•°æ®åº“æŸ¥è¯¢ â†’ è¿”å›æ•°æ®
ä¼˜ç‚¹ï¼šé€Ÿåº¦å¿«ï¼ˆæœ¬åœ°æŸ¥è¯¢ï¼‰
ç¼ºç‚¹ï¼šéœ€è¦æ‰‹åŠ¨åŒæ­¥ï¼Œæ•°æ®å¯èƒ½ä¸æ˜¯æœ€æ–°
```

### æ–°æ–¹æ¡ˆï¼ˆå®æ—¶APIæ¨¡å¼ï¼‰
```
ç”¨æˆ·è®¿é—® â†’ USA28 API â†’ è½¬æ¢æ•°æ® â†’ è¿”å›æ•°æ®
ä¼˜ç‚¹ï¼šæ•°æ®æ°¸è¿œæœ€æ–°ï¼Œæ— éœ€åŒæ­¥
ç¼ºç‚¹ï¼šä¾èµ–å¤–éƒ¨APIï¼Œé€Ÿåº¦ç¨æ…¢ï¼ˆ1-3ç§’ï¼‰
```

### æ™ºèƒ½é™çº§
```
USA28 API (ä¼˜å…ˆ) â†’ æ•°æ®åº“ (å¤‡ç”¨)
å…¼é¡¾å®æ—¶æ€§å’Œå¯é æ€§
```

---

## ğŸš€ æœªæ¥ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥
```typescript
// æ·»åŠ çŸ­æœŸç¼“å­˜ï¼ˆå¦‚ï¼š30ç§’ï¼‰
const cache = new Map();

async getLotteryHistory(query) {
  const cacheKey = JSON.stringify(query);
  const cached = cache.get(cacheKey);
  
  if (cached && Date.now() - cached.time < 30000) {
    return cached.data; // è¿”å›ç¼“å­˜
  }
  
  const data = await fetchFromUSA28();
  cache.set(cacheKey, { data, time: Date.now() });
  return data;
}
```

### 2. WebSocket æ¨é€
```typescript
// å®æ—¶æ¨é€æœ€æ–°å¼€å¥–
@WebSocketGateway()
export class LotteryGateway {
  @SubscribeMessage('subscribe-lottery')
  handleSubscribe(client: Socket) {
    // å®šæ—¶æ¨é€æœ€æ–°å¼€å¥–
    setInterval(() => {
      const latest = await getLatestLottery();
      client.emit('lottery-update', latest);
    }, 60000); // æ¯åˆ†é’Ÿæ¨é€
  }
}
```

### 3. æ•°æ®é¢„åŠ è½½
```typescript
// åå°å®šæ—¶ç¼“å­˜æ•°æ®
@Cron('0 */5 * * * *') // æ¯5åˆ†é’Ÿ
async cacheLatestData() {
  const data = await fetchFromUSA28();
  await redis.set('lottery:cache', JSON.stringify(data), 'EX', 300);
}
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. åç«¯æ—¥å¿—ï¼ˆ`score-system/backend`ï¼‰
2. æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12 â†’ Consoleï¼‰
3. ç½‘ç»œè¿æ¥ï¼ˆç¡®ä¿å¯è®¿é—® api.365kaik.comï¼‰

---

**æ›´æ–°æ—¶é—´ï¼š** 2025-11-27  
**ç‰ˆæœ¬ï¼š** v2.0 - å®æ—¶æ•°æ®æ¨¡å¼  
**ä½œè€…ï¼š** AI Assistant



