# ✅ 取消下注逻辑更新

## 📝 背景

在新规则下：
- **下注时不扣分**：只检查可用余额
- **结算时才计分**：根据结算分直接增减积分

因此，取消下注时不应该退还积分（因为从未扣除过）。

---

## ❌ 旧逻辑

### 下注流程
```
1. 用户下注 100 倍
2. 扣除积分：100 + 3 = 103
3. 用户积分：10000 → 9897
```

### 取消下注
```
1. 用户取消下注
2. 退还积分：100 + 3 = 103
3. 用户积分：9897 → 10000 ✅
4. 创建 PointRecord（类型：refund）
```

**问题**：逻辑复杂，且与新规则不符。

---

## ✅ 新逻辑

### 下注流程
```
1. 用户下注 100 倍
2. 不扣除积分，只锁定可用余额：83（最大可能损失）
3. 用户积分：10000（不变）
4. 可用余额：10000 - 83 = 9917
```

### 取消下注
```
1. 用户取消下注
2. 更新状态为 cancelled
3. 释放锁定的可用余额（自动）
4. 用户积分：10000（不变）✅
5. 不创建 PointRecord
```

**优点**：
- ✅ 逻辑简单清晰
- ✅ 符合新规则
- ✅ 减少数据库操作
- ✅ 避免积分变动记录混乱

---

## 🔧 修改内容

### 1. 后端：`bet.service.ts` - `cancelBet()` 方法

#### ❌ 旧代码
```typescript
// 计算需要退回的总积分（下注金额 + 手续费）
const totalRefund = bets.reduce((sum, bet) => sum + Number(bet.amount) + Number(bet.fee), 0);

// 更新用户积分
await tx.user.update({
  where: { id: userId },
  data: { points: newPoints },  // newPoints = currentPoints + totalRefund
});

// 创建积分记录
await tx.pointRecord.create({
  data: {
    type: 'refund',
    amount: totalRefund,
    remark: `取消下注退款：...`,
  },
});

return {
  message: '取消成功',
  refundAmount: totalRefund,  // ← 返回退款金额
  newPoints,
};
```

#### ✅ 新代码
```typescript
// 新规则：下注时没有扣分，取消下注只需要更新状态
// 不需要退还积分，只需要释放"锁定"的可用余额（系统会自动处理）

const currentPoints = Number(user.points);

// 仅更新下注状态为 cancelled
await tx.bet.updateMany({
  where: {
    id: { in: bets.map(b => b.id) },
  },
  data: {
    status: 'cancelled',
    pointsAfter: currentPoints,  // 记录取消时的积分（不变）
    settledAt: new Date(),
  },
});

// 注意：新规则下，不需要退还积分，因为下注时没有扣除
// 不需要更新 user.points
// 不需要创建 PointRecord

return {
  message: '取消成功',
  cancelledCount: bets.length,  // ← 返回取消的笔数
  currentPoints,
};
```

### 2. 前端：`Home.vue` - 取消成功提示

#### ❌ 旧代码
```typescript
showToast({
  message: `✅ 取消成功！\n退回积分：${formatMoney(res.data.refundAmount)}`,
  type: 'success',
});
```

#### ✅ 新代码
```typescript
showToast({
  message: `✅ 取消成功！\n已取消 ${res.data.cancelledCount} 笔下注`,
  type: 'success',
});
```

---

## 📊 对比示例

### 场景：用户下注后立即取消

#### 旧规则
```
初始积分：10000

下注 100 倍：
  ↓ 扣除 103
  积分：9897

取消下注：
  ↓ 退还 103
  积分：10000

积分记录：
  1. -103（下注）
  2. +103（退款）
```

#### 新规则
```
初始积分：10000

下注 100 倍：
  ↓ 不扣分
  积分：10000
  可用余额：9917（锁定 83）

取消下注：
  ↓ 释放锁定
  积分：10000
  可用余额：10000

积分记录：
  无记录 ✅
```

---

## ✅ 验证清单

### 功能验证

- [x] 取消下注后积分不变
- [x] 取消下注不创建 PointRecord
- [x] 状态正确更新为 cancelled
- [x] 前端提示信息正确
- [x] 可用余额正确释放

### 测试步骤

1. **下注**
   ```
   下注：100 倍
   当前积分：10000（不变）
   可用余额：10000 - 83 = 9917
   ```

2. **取消下注**
   ```
   操作：取消下注
   当前积分：10000（不变）✅
   可用余额：10000（恢复）✅
   提示：已取消 1 笔下注 ✅
   ```

3. **检查数据库**
   ```sql
   -- 下注记录状态应为 cancelled
   SELECT status, pointsBefore, pointsAfter 
   FROM bets 
   WHERE id = ?;
   -- pointsBefore = 10000
   -- pointsAfter = 10000
   -- status = 'cancelled'
   
   -- 不应该有 refund 类型的积分记录
   SELECT * 
   FROM point_records 
   WHERE type = 'refund' 
   AND userId = ?;
   -- 应该返回空 ✅
   ```

---

## 🎯 优点总结

### 1. 逻辑一致性
- ✅ 下注不扣分 → 取消不退分
- ✅ 结算才计分 → 积分记录干净

### 2. 数据简洁性
- ✅ 减少积分变动记录
- ✅ 避免退款记录混乱
- ✅ 数据库操作更少

### 3. 用户体验
- ✅ 积分显示稳定（不会频繁变动）
- ✅ 提示信息更清晰
- ✅ 操作更快速

---

## 📝 注意事项

### 1. 旧数据兼容性

如果数据库中有旧规则下的取消记录（type='refund'的 PointRecord），不影响新功能。

### 2. 可用余额计算

取消下注后，系统会自动重新计算可用余额：
```
可用余额 = 当前积分 - SUM(所有未结算注单的最大可能损失)
```

取消后，该笔下注不再计入"未结算"，所以可用余额自动增加。

### 3. 多笔下注取消

如果一次性取消多笔下注（例如取消所有倍数下注），返回的 `cancelledCount` 会显示具体数量。

---

**更新时间**：2025-11-29  
**影响范围**：取消下注功能  
**向下兼容**：✅ 是（不影响已有数据）  
**状态**：✅ 已完成

