# ç§¯åˆ†æ•´æ•°åŒ–å’Œç»Ÿè®¡å­—æ®µç§»é™¤ âœ…

## ğŸ“‹ éœ€æ±‚è¯´æ˜

### 1. å»æ‰ç»Ÿè®¡å­—æ®µ
- ä» `User` è¡¨ä¸­åˆ é™¤ `totalBet`ï¼ˆç´¯è®¡ä¸‹æ³¨ï¼‰
- ä» `User` è¡¨ä¸­åˆ é™¤ `totalWin`ï¼ˆç´¯è®¡èµ¢ï¼‰
- ä» `User` è¡¨ä¸­åˆ é™¤ `totalLoss`ï¼ˆç´¯è®¡äºæŸï¼‰

### 2. ç§¯åˆ†å»æ‰å°æ•°
- **ç”¨æˆ·ä½™é¢**ï¼ˆ`User.points`ï¼‰ï¼šåªæ˜¾ç¤ºæ•´æ•°ï¼ˆå‘ä¸‹å–æ•´ï¼‰
- **ç§¯åˆ†è´¦å•**ï¼ˆ`PointRecord`ï¼‰ï¼šæ˜¾ç¤ºå°æ•°ç‚¹åä¸¤ä½ï¼ˆè®°å½•è¯¦ç»†å˜åŠ¨ï¼‰

## ğŸ“ è®¡ç®—è§„åˆ™

### ç¤ºä¾‹1ï¼šåŠ åˆ†
```
åŸä½™é¢ï¼š2000
åŠ åˆ†ï¼š+1500.52
è®¡ç®—ï¼š2000 + 1500.52 = 3500.52
æœ€ç»ˆä½™é¢ï¼š3500ï¼ˆå‘ä¸‹å–æ•´ï¼‰

ç§¯åˆ†è´¦å•æ˜¾ç¤ºï¼š
- å˜åŠ¨é‡‘é¢ï¼š+1500.52
- å˜åŠ¨å‰ï¼š2000.00
- å˜åŠ¨åï¼š3500.00
```

### ç¤ºä¾‹2ï¼šå‡åˆ†
```
åŸä½™é¢ï¼š2000
å‡åˆ†ï¼š-1500.52
è®¡ç®—ï¼š2000 - 1500.52 = 499.48
æœ€ç»ˆä½™é¢ï¼š499ï¼ˆå‘ä¸‹å–æ•´ï¼‰

ç§¯åˆ†è´¦å•æ˜¾ç¤ºï¼š
- å˜åŠ¨é‡‘é¢ï¼š-1500.52
- å˜åŠ¨å‰ï¼š2000.00
- å˜åŠ¨åï¼š499.00
```

## ğŸ”§ å®ç°å†…å®¹

### 1. æ•°æ®åº“Schemaä¿®æ”¹ï¼ˆ`schema.prisma`ï¼‰

#### Userè¡¨
```prisma
model User {
  id           Int           @id @default(autoincrement())
  username     String        @unique
  password     String
  nickname     String?
  points       Int           @default(0) @db.Int  // âœ… æ”¹ä¸ºInt
  // âŒ åˆ é™¤ totalBet, totalWin, totalLoss
  status       Int           @default(1)
  // ... å…¶ä»–å­—æ®µ
}
```

#### PointRecordè¡¨ï¼ˆä¿ç•™Decimalï¼‰
```prisma
model PointRecord {
  id            BigInt   @id @default(autoincrement())
  userId        Int
  type          String
  amount        Decimal  @db.Decimal(10, 2)  // âœ… ä¿ç•™å°æ•°
  balanceBefore Decimal  @db.Decimal(10, 2)  // âœ… ä¿ç•™å°æ•°
  balanceAfter  Decimal  @db.Decimal(10, 2)  // âœ… ä¿ç•™å°æ•°
  // ... å…¶ä»–å­—æ®µ
}
```

#### Betè¡¨
```prisma
model Bet {
  id           BigInt    @id @default(autoincrement())
  amount       Int       @db.Int  // âœ… æ”¹ä¸ºInt
  fee          Int       @default(0) @db.Int  // âœ… æ”¹ä¸ºInt
  resultAmount Int?      @db.Int  // âœ… æ”¹ä¸ºInt
  pointsBefore Int       @db.Int  // âœ… æ”¹ä¸ºInt
  pointsAfter  Int?      @db.Int  // âœ… æ”¹ä¸ºInt
  // ... å…¶ä»–å­—æ®µ
}
```

### 2. åç«¯é€»è¾‘ä¿®æ”¹

#### è®¡ç®—è§„åˆ™å·¥å…·ï¼ˆ`lottery-rules.util.ts`ï¼‰

```typescript
// âœ… å€æ•°ä¸‹æ³¨è®¡ç®— - å‘ä¸‹å–æ•´
export function calculateMultipleBetResult(...) {
  const fee = Math.floor((amount / feeBase) * feeRate);  // æ‰‹ç»­è´¹å–æ•´
  
  if (isReturn) {
    const resultAmount = Math.floor(amount + amount - fee);  // ç»“æœå–æ•´
    return { fee, loss: 0, resultAmount };
  } else {
    const loss = Math.floor(amount * lossRate);  // æŸå¤±å–æ•´
    const returnAmount = amount - loss;
    const resultAmount = Math.floor(returnAmount - fee);  // ç»“æœå–æ•´
    return { fee, loss, resultAmount };
  }
}

// âœ… ç»„åˆä¸‹æ³¨è®¡ç®— - å‘ä¸‹å–æ•´
export function calculateComboBetResult(...) {
  const fee = Math.floor((amount / feeBase) * feeRate);  // æ‰‹ç»­è´¹å–æ•´
  const resultAmount = isWin 
    ? Math.floor(amount - fee)  // ä¸­å¥–ç»“æœå–æ•´
    : Math.floor(-amount * 5 - fee);  // æœªä¸­ç»“æœå–æ•´
  return { fee, resultAmount };
}
```

#### ä¸‹æ³¨æœåŠ¡ï¼ˆ`bet.service.ts`ï¼‰

```typescript
// âœ… åˆ›å»ºä¸‹æ³¨ - æ‰£é™¤ç§¯åˆ†å‘ä¸‹å–æ•´
async createBet(...) {
  const currentPoints = Number(user.points);
  const feeWithDecimal = betType === 'multiple' ? ... : ...;
  const fee = Math.floor(feeWithDecimal);  // æ‰‹ç»­è´¹å–æ•´
  const newPoints = Math.floor(currentPoints - amount);  // ä½™é¢å–æ•´
  
  await tx.user.update({
    where: { id: userId },
    data: { points: newPoints },  // âŒ åˆ é™¤ totalBet å¢é‡
  });
  
  // âœ… ç§¯åˆ†è´¦å•ä¿ç•™å°æ•°
  await tx.pointRecord.create({
    data: {
      amount: -amount,  // å°æ•°
      balanceBefore: currentPoints,  // å°æ•°
      balanceAfter: newPoints,  // æ•´æ•°
      // ...
    },
  });
}
```

#### ç»“ç®—æœåŠ¡ï¼ˆ`lottery.service.ts`ï¼‰

```typescript
// âœ… ç»“ç®—ä¸‹æ³¨ - ç§¯åˆ†å‘ä¸‹å–æ•´
private async settleSingleBet(...) {
  const currentPoints = Number(bet.user.points);
  const finalPointsWithDecimal = currentPoints + resultAmount;
  const finalPoints = Math.floor(finalPointsWithDecimal);  // ä½™é¢å–æ•´
  
  await tx.user.update({
    where: { id: bet.userId },
    data: { points: finalPoints },  // âŒ åˆ é™¤ totalWin/totalLoss å¢é‡
  });
  
  // âœ… ç§¯åˆ†è´¦å•ä¿ç•™å°æ•°
  await tx.pointRecord.create({
    data: {
      amount: resultAmount,  // å°æ•°
      balanceBefore: currentPoints,  // å°æ•°
      balanceAfter: finalPoints,  // æ•´æ•°
      // ...
    },
  });
}
```

#### ç§¯åˆ†è°ƒæ•´æœåŠ¡ï¼ˆ`user.service.ts`ï¼‰

```typescript
// âœ… ç®¡ç†å‘˜è°ƒæ•´ç§¯åˆ† - å‘ä¸‹å–æ•´
async adjustUserPoints(...) {
  const currentPoints = Number(user.points);
  const newPointsWithDecimal = currentPoints + amount;  // å¯èƒ½æœ‰å°æ•°
  const newPoints = Math.floor(newPointsWithDecimal);  // ä½™é¢å–æ•´
  
  await tx.user.update({
    where: { id: userId },
    data: { points: newPoints },
  });
  
  // âœ… ç§¯åˆ†è´¦å•ä¿ç•™å°æ•°
  await tx.pointRecord.create({
    data: {
      amount,  // å°æ•°
      balanceBefore: currentPoints,  // å°æ•°
      balanceAfter: newPoints,  // æ•´æ•°
      // ...
    },
  });
}
```

### 3. å‰ç«¯ç±»å‹å®šä¹‰ä¿®æ”¹

#### ç®¡ç†åå°ï¼ˆ`frontend-admin/src/types/index.ts`ï¼‰

```typescript
export interface User {
  id: number
  username: string
  nickname: string
  points: number  // âœ… æ•´æ•°
  status: number
  // âŒ åˆ é™¤ totalBet, totalWin, totalLoss
  lastLoginAt?: string
  createdAt: string
}
```

#### H5å‰ç«¯ï¼ˆ`frontend-h5/src/types/user.ts`ï¼‰

```typescript
export interface UserInfo {
  id: number
  username: string
  nickname: string
  points: number  // âœ… æ•´æ•°
  status: number
  // âŒ åˆ é™¤ totalBet, totalWin, totalLoss
  createdAt?: string
  lastLoginAt?: string
}
```

## ğŸ¯ æ ¸å¿ƒæ”¹åŠ¨ç‚¹

### æ•°æ®åº“å±‚é¢
1. âœ… `User.points` ä» `Decimal(10,2)` æ”¹ä¸º `Int`
2. âœ… `Bet.amount/fee/resultAmount/pointsBefore/pointsAfter` ä» `Decimal(10,2)` æ”¹ä¸º `Int`
3. âœ… `PointRecord.amount/balanceBefore/balanceAfter` ä¿æŒ `Decimal(10,2)`
4. âŒ åˆ é™¤ `User.totalBet`ã€`User.totalWin`ã€`User.totalLoss`

### ä¸šåŠ¡é€»è¾‘å±‚é¢
1. âœ… æ‰€æœ‰ç§¯åˆ†è®¡ç®—æœ€ç»ˆä½¿ç”¨ `Math.floor()` å‘ä¸‹å–æ•´
2. âœ… æ‰‹ç»­è´¹è®¡ç®—ä½¿ç”¨ `Math.floor()` å‘ä¸‹å–æ•´
3. âœ… æŸå¤±è®¡ç®—ä½¿ç”¨ `Math.floor()` å‘ä¸‹å–æ•´
4. âœ… `PointRecord` è®°å½•å°æ•°å˜åŠ¨ï¼ˆç”¨äºæ˜¾ç¤ºè¯¦ç»†è´¦å•ï¼‰
5. âœ… `User.points` åªä¿å­˜æ•´æ•°ï¼ˆç”¨äºæ˜¾ç¤ºç”¨æˆ·ä½™é¢ï¼‰
6. âŒ åˆ é™¤æ‰€æœ‰ `totalBet/totalWin/totalLoss` çš„å¢é‡æ›´æ–°é€»è¾‘

### å‰ç«¯å±‚é¢
1. âœ… `User` æ¥å£åˆ é™¤ `totalBet`ã€`totalWin`ã€`totalLoss` å­—æ®µ
2. âœ… `points` æ˜¾ç¤ºä¸ºæ•´æ•°ï¼ˆä¸éœ€è¦ä¿®æ”¹ï¼Œåç«¯å·²è¿”å›æ•´æ•°ï¼‰
3. âœ… ç§¯åˆ†è´¦å•æ˜¾ç¤ºå°æ•°åä¸¤ä½ï¼ˆ`PointRecord` ä¿ç•™Decimalï¼‰

## ğŸ“Š æ•°æ®è¿ç§»

æ‰§è¡Œå‘½ä»¤ï¼š
```bash
cd score-system/backend
npx prisma db push --accept-data-loss
npx prisma generate
```

**è­¦å‘Š**ï¼šæ­¤æ“ä½œä¼šï¼š
- å°†ç°æœ‰ `Decimal` å­—æ®µè½¬æ¢ä¸º `Int`ï¼ˆä¼šä¸¢å¤±å°æ•°éƒ¨åˆ†ï¼‰
- åˆ é™¤ `totalBet`ã€`totalWin`ã€`totalLoss` åˆ—åŠå…¶æ•°æ®

## âœ… æµ‹è¯•éªŒè¯

### 1. åŠ åˆ†æµ‹è¯•
```
ç”¨æˆ·ç§¯åˆ†ï¼š5000
ç®¡ç†å‘˜åŠ åˆ†ï¼š1500.52
é¢„æœŸç»“æœï¼š
- ç”¨æˆ·ä½™é¢ï¼š6500ï¼ˆ5000 + 1500.52 å‘ä¸‹å–æ•´ï¼‰
- ç§¯åˆ†è´¦å•ï¼š+1500.52
```

### 2. å‡åˆ†æµ‹è¯•
```
ç”¨æˆ·ç§¯åˆ†ï¼š2000
ç®¡ç†å‘˜å‡åˆ†ï¼š1500.52
é¢„æœŸç»“æœï¼š
- ç”¨æˆ·ä½™é¢ï¼š499ï¼ˆ2000 - 1500.52 å‘ä¸‹å–æ•´ï¼‰
- ç§¯åˆ†è´¦å•ï¼š-1500.52
```

### 3. ä¸‹æ³¨æµ‹è¯•
```
ç”¨æˆ·ç§¯åˆ†ï¼š5000
ä¸‹æ³¨é‡‘é¢ï¼š1000
æ‰‹ç»­è´¹ï¼š30
é¢„æœŸç»“æœï¼š
- ä¸‹æ³¨æ—¶ä½™é¢ï¼š4000ï¼ˆ5000 - 1000ï¼‰
- ç§¯åˆ†è´¦å•ï¼š-1000.00
```

### 4. ç»“ç®—æµ‹è¯•ï¼ˆå›æœ¬ï¼‰
```
ç”¨æˆ·ç§¯åˆ†ï¼š4000ï¼ˆä¸‹æ³¨åï¼‰
ç»“ç®—é‡‘é¢ï¼š1970ï¼ˆ2000 - 30ï¼‰
é¢„æœŸç»“æœï¼š
- ç»“ç®—åä½™é¢ï¼š5970ï¼ˆ4000 + 1970ï¼‰
- ç§¯åˆ†è´¦å•ï¼š+1970.00
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å‘ä¸‹å–æ•´è§„åˆ™**ï¼šæ‰€æœ‰ç§¯åˆ†è®¡ç®—éƒ½ä½¿ç”¨ `Math.floor()` å‘ä¸‹å–æ•´
2. **å°æ•°ä¿ç•™**ï¼š`PointRecord` ä¿ç•™å°æ•°ç”¨äºè¯¦ç»†è´¦å•æ˜¾ç¤º
3. **æ•´æ•°å­˜å‚¨**ï¼š`User.points` åªå­˜å‚¨æ•´æ•°
4. **ç»Ÿè®¡å­—æ®µ**ï¼š`totalBet/totalWin/totalLoss` å·²å®Œå…¨åˆ é™¤ï¼Œå¦‚éœ€ç»Ÿè®¡æ•°æ®è¯·é€šè¿‡èšåˆæŸ¥è¯¢å®ç°
5. **æ•°æ®ä¸¢å¤±**ï¼šDecimalè½¬Intä¼šä¸¢å¤±å°æ•°éƒ¨åˆ†ï¼Œå»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯

## ğŸ‰ å®ŒæˆçŠ¶æ€

- âœ… æ•°æ®åº“Schemaä¿®æ”¹
- âœ… åç«¯è®¡ç®—é€»è¾‘å‘ä¸‹å–æ•´
- âœ… ç§¯åˆ†è´¦å•ä¿ç•™å°æ•°æ˜¾ç¤º
- âœ… ç»Ÿè®¡å­—æ®µå®Œå…¨åˆ é™¤
- âœ… å‰ç«¯ç±»å‹å®šä¹‰æ›´æ–°
- âœ… æ•°æ®åº“è¿ç§»å®Œæˆ
- â³ ç­‰å¾…åç«¯é‡å¯éªŒè¯

---

**æœ€åæ›´æ–°**: 2025-11-27
**çŠ¶æ€**: å·²å®Œæˆï¼Œç­‰å¾…é‡å¯éªŒè¯



