#!/bin/bash

###############################################
# åç«¯æœåŠ¡å¿«é€Ÿé‡å»ºè„šæœ¬
# ä¿®å¤ crypto.randomUUID é—®é¢˜
###############################################

echo "ğŸ”§ å¿«é€Ÿé‡å»ºåç«¯æœåŠ¡ï¼ˆä¿®å¤ crypto é—®é¢˜ï¼‰..."

# è¿›å…¥é¡¹ç›®ç›®å½•
cd "$(dirname "$0")"

# 1. åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨
echo ""
echo "ğŸ“¦ æ­¥éª¤ 1/4: åœæ­¢æ—§å®¹å™¨..."
docker-compose stop backend
docker-compose rm -f backend

# 2. åˆ é™¤æ—§é•œåƒï¼ˆå¼ºåˆ¶é‡æ–°æ„å»ºï¼‰
echo ""
echo "ğŸ—‘ï¸  æ­¥éª¤ 2/4: æ¸…ç†æ—§é•œåƒ..."
docker rmi score-system-backend:latest 2>/dev/null || true

# 3. é‡æ–°æ„å»ºé•œåƒ
echo ""
echo "ğŸ—ï¸  æ­¥éª¤ 3/4: é‡æ–°æ„å»ºé•œåƒï¼ˆä½¿ç”¨ Node.js 20 + crypto ä¿®å¤ï¼‰..."
docker-compose build --no-cache backend

# 4. å¯åŠ¨æœåŠ¡
echo ""
echo "ğŸš€ æ­¥éª¤ 4/4: å¯åŠ¨åç«¯æœåŠ¡..."
docker-compose up -d backend

# 5. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
echo ""
echo "ğŸ“‹ æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼ˆæŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—æŸ¥çœ‹ï¼‰..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
sleep 2
docker-compose logs -f backend

