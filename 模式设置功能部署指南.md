# 🚀 模式设置功能 - 部署指南

## 📋 功能说明

**模式设置** = **下注类型配置管理**

管理员可以为每种下注类型（单、双、大、小、大单、大双、小单、小双等）配置：
- ✅ 赔率
- ✅ 最小投注额
- ✅ 最大投注额  
- ✅ 手续费比例
- ✅ 退水比例（返水/佣金）
- ✅ 启用/禁用状态

---

## 🎯 部署步骤

### 第1步：创建数据库表 ⏰

#### 方案 A：使用 Navicat 或其他数据库工具（推荐）

打开 `score-system/backend/prisma/migrations/add_bet_type_settings.sql`

复制SQL内容，在Navicat中执行：

```sql
-- 1. 创建表
CREATE TABLE IF NOT EXISTS `bet_type_settings` (...);

-- 2. 插入默认数据
INSERT INTO `bet_type_settings` (...) VALUES (...);
```

#### 方案 B：使用命令行

```bash
# 如果有 mysql 命令
mysql -u edp_user -p yunce_score_system < score-system/backend/prisma/migrations/add_bet_type_settings.sql

# 输入密码：123456
```

#### 方案 C：手动在数据库中执行

1. 打开数据库管理工具
2. 选择数据库：`yunce_score_system`
3. 执行 SQL 文件内容

---

### 第2步：重启后端服务 ⏰

```bash
cd score-system/backend
# 按 Ctrl+C 停止当前服务
npm run start:dev
```

**检查日志：**
```
[Nest] INFO Nest application successfully started
```

如果没报错，说明新表已被识别。

---

### 第3步：测试API ⏰

打开浏览器或Postman测试：

```bash
GET http://localhost:3000/api/admin/bet-type-settings
Authorization: Bearer YOUR_TOKEN
```

**预期响应：**
```json
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "betType": "single",
      "name": "单",
      "odds": 1.95,
      "minBet": 1.00,
      "maxBet": 4999.00,
      "feeRate": 0.0000,
      "rebateRate": 0.0000,
      "isEnabled": true,
      "sortOrder": 1,
      "description": "结果为单数"
    }
  ]
}
```

---

### 第4步：前端访问页面 ⏰

1. 刷新浏览器
2. 登录后台
3. 点击左侧菜单：**模式设置**

**预期效果：**
```
┌─────────────────────────────────────────────────────────────────┐
│  下注类型配置 - 模式设置                      [保存配置]         │
├─────────────────────────────────────────────────────────────────┤
│ 模式 │ 赔率  │ 专线 │ 最小 │ 最大   │ 手续费% │ 退水% │ 启用 │  │
├─────────────────────────────────────────────────────────────────┤
│ 单   │ 1.95  │ 1.00 │ 1.00 │ 4999   │ 0.00    │ 0.00  │  ✓   │  │
│ 双   │ 1.95  │ 1.00 │ 1.00 │ 4999   │ 0.00    │ 0.00  │  ✓   │  │
│ 大   │ 1.95  │ 1.00 │ 1.00 │ 4999   │ 0.00    │ 0.00  │  ✓   │  │
│ 小   │ 1.95  │ 1.00 │ 1.00 │ 4999   │ 0.00    │ 0.00  │  ✓   │  │
│ 大单 │ 3.80  │ 7.00 │ 7.00 │ 1000   │ 0.00    │ 0.00  │  ✓   │  │
│ 大双 │ 3.80  │19.50 │19.50 │ 1000   │ 0.00    │ 0.00  │  ✓   │  │
│ 小单 │ 3.80  │ 7.00 │ 7.00 │ 1000   │ 0.00    │ 0.00  │  ✓   │  │
│ 小双 │ 3.80  │ 0.00 │ 0.00 │ 1000   │ 0.00    │ 0.00  │  ✓   │  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📁 已创建的文件

### 后端文件 ✅
```
backend/
├── prisma/
│   ├── schema.prisma (已更新 - 添加 BetTypeSetting 模型)
│   └── migrations/
│       └── add_bet_type_settings.sql (SQL 迁移文件)
├── src/modules/system/
│   ├── dto/
│   │   └── bet-type-setting.dto.ts (DTO 定义)
│   ├── system.controller.ts (已更新 - 添加 API 接口)
│   └── system.service.ts (已更新 - 添加服务方法)
```

### 前端文件 ✅
```
frontend-admin/
├── src/
│   ├── views/
│   │   └── BetTypeSettings.vue (模式设置页面)
│   ├── api/
│   │   └── settings.ts (API 客户端)
│   └── router/
│       └── index.ts (已更新 - 指向新页面)
```

### 文档文件 ✅
```
score-system/
├── 下注类型配置系统实施计划.md
└── 模式设置功能部署指南.md (本文档)
```

---

## 🎯 使用场景

### 场景1：调整赔率
```
需求：降低"大单"的风险，降低赔率
操作：
1. 进入模式设置页面
2. 找到"大单"行
3. 修改赔率：3.80 → 3.50
4. 点击"保存配置"
5. 立即生效 ✅
```

### 场景2：限制投注额
```
需求：限制"小双"的最大投注额
操作：
1. 进入模式设置页面
2. 找到"小双"行
3. 修改最大投注：1000 → 500
4. 保存配置
5. 用户下注超过500会被拒绝 ✅
```

### 场景3：设置手续费
```
需求：为倍数玩法增加3%手续费
操作：
1. 进入模式设置页面
2. 找到"倍数"相关行
3. 修改手续费：0.00 → 3.00
4. 保存配置
5. 下注时自动扣除3%手续费 ✅
```

### 场景4：设置退水
```
需求：给高倍率玩法返2%退水
操作：
1. 进入模式设置页面
2. 找到"大单/大双"等行
3. 修改退水：0.00 → 2.00
4. 保存配置
5. 结算时返还2%给用户 ✅
```

### 场景5：临时关闭玩法
```
需求：维护期间关闭某个玩法
操作：
1. 进入模式设置页面
2. 找到对应行
3. 关闭启用开关
4. 保存配置
5. 用户无法选择此玩法 ✅
```

---

## 🔍 验证方法

### 1. 验证最小/最大投注额

**测试：**
```typescript
// 前端下注
amount = 0.50 // 小于最小值1.00

// 预期结果
ElMessage.error('下注金额不能少于1.00')
```

### 2. 验证手续费计算

**测试：**
```typescript
// 配置：feeRate = 3%
// 下注：100元

// 预期结果
实际扣除 = 100 + 3 = 103元
手续费 = 3元
```

### 3. 验证启用状态

**测试：**
```typescript
// 关闭"大单"
isEnabled = false

// 前端选择"大单"下注

// 预期结果
ElMessage.error('该下注类型暂不可用')
```

---

## 🐛 常见问题

### 问题1：表创建失败

**错误：** `Table 'bet_type_settings' already exists`

**解决：**
```sql
-- 删除旧表
DROP TABLE IF EXISTS bet_type_settings;

-- 重新执行创建脚本
```

### 问题2：API 404

**错误：** `Cannot GET /api/admin/bet-type-settings`

**解决：**
1. 确认后端已重启
2. 检查 `system.controller.ts` 是否有新接口
3. 查看后端日志是否有错误

### 问题3：前端页面空白

**错误：** 页面无数据显示

**解决：**
1. 打开浏览器控制台
2. 查看是否有API请求错误
3. 确认数据库表是否有数据

### 问题4：保存失败

**错误：** `Prisma.betTypeSetting is undefined`

**解决：**
```bash
# 重新生成 Prisma Client
cd score-system/backend
npx prisma generate
# 重启服务
npm run start:dev
```

---

## 📝 SQL 脚本位置

**文件：** `score-system/backend/prisma/migrations/add_bet_type_settings.sql`

**内容包括：**
1. CREATE TABLE - 创建表结构
2. INSERT INTO - 插入12条默认配置数据

---

## 🎊 完成标志

当以下内容全部正常时，功能即部署成功：

- ✅ 数据库表创建成功
- ✅ 后端API正常返回
- ✅ 前端页面可以打开
- ✅ 可以编辑配置
- ✅ 保存后立即生效
- ✅ 下注验证正常工作

---

## 📞 下一步

1. **执行数据库迁移** - 创建 `bet_type_settings` 表
2. **重启后端服务** - 让新代码生效
3. **访问前端页面** - 测试模式设置功能
4. **配置参数** - 调整赔率、限额、手续费
5. **测试下注** - 验证配置是否生效

---

**准备好了吗？从第1步开始执行吧！** 🚀

**更新时间：** 2025-11-27  
**版本：** v1.0  
**作者：** AI Assistant




