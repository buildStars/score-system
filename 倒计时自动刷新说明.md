# ğŸ”„ å€’è®¡æ—¶è‡ªåŠ¨åˆ·æ–°å¼€å¥–ç»“æœ

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

å½“å°ç›˜å€’è®¡æ—¶ç»“æŸï¼ˆå³å¼€å¥–æ—¶åˆ»ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ·æ–°å¼€å¥–å†å²ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°ã€‚

---

## âš™ï¸ å®ç°åŸç†

### 1. åç«¯å®šæ—¶åŒæ­¥

```typescript
// lottery-countdown.service.ts
@Cron(CronExpression.EVERY_MINUTE)
async syncLatestDraw() {
  await this.fetchLatestDraw(); // æ¯åˆ†é’Ÿä» USA28 è·å–æœ€æ–°å¼€å¥–
}
```

### 2. å‰ç«¯æ£€æµ‹å¼€å¥–

```typescript
// LotteryCountdown.vue
const handleDrawComplete = async () => {
  const oldPeriod = lotteryStatus.value?.currentPeriod
  
  // é‡æ–°åŒæ­¥æœåŠ¡å™¨çŠ¶æ€
  await fetchLotteryStatus()
  
  const newPeriod = lotteryStatus.value?.currentPeriod
  
  // å¦‚æœæœŸå·å˜åŒ–ï¼Œè¯´æ˜å·²ç»å¼€å¥–
  if (newPeriod && oldPeriod !== newPeriod) {
    console.log('ğŸ° å¼€å¥–å®Œæˆï¼')
    
    // è§¦å‘å¼€å¥–äº‹ä»¶
    emits('draw', {
      period: oldPeriod,
      nextPeriod: newPeriod,
    })
  }
}
```

### 3. é¡µé¢è‡ªåŠ¨åˆ·æ–°

```vue
<template>
  <LotteryCountdown @draw="handleDraw" />
</template>

<script setup>
const handleDraw = (data) => {
  ElMessage.success(`ç¬¬ ${data.period} æœŸå·²å¼€å¥–`)
  
  // å»¶è¿Ÿ2ç§’åˆ·æ–°ï¼ˆç¡®ä¿åç«¯æ•°æ®å·²æ›´æ–°ï¼‰
  setTimeout(() => {
    fetchLotteryHistory()
  }, 2000)
}
</script>
```

---

## ğŸ”„ å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant Timer as å‰ç«¯å€’è®¡æ—¶
    participant Backend as åç«¯æœåŠ¡
    participant USA28 as USA28 API
    participant UI as é¡µé¢UI

    Timer->>Timer: å€’è®¡æ—¶: 3...2...1...0
    Timer->>Backend: GET /lottery/status
    Backend->>USA28: è·å–æœ€æ–°å¼€å¥–
    USA28-->>Backend: è¿”å›æ–°æœŸå·
    Backend-->>Timer: currentPeriod=3364686
    
    Timer->>Timer: æ£€æµ‹æœŸå·å˜åŒ–
    Timer->>UI: emit('draw', {period, nextPeriod})
    
    UI->>UI: æ˜¾ç¤ºé€šçŸ¥ï¼šå·²å¼€å¥–
    UI->>UI: å»¶è¿Ÿ2ç§’
    UI->>Backend: GET /lottery/history
    Backend-->>UI: è¿”å›æœ€æ–°å¼€å¥–å†å²
    UI->>UI: æ›´æ–°åˆ—è¡¨
```

---

## ğŸ“Š äº‹ä»¶è¯´æ˜

### draw äº‹ä»¶ï¼ˆå¼€å¥–å®Œæˆï¼‰

**è§¦å‘æ—¶æœºï¼š** å€’è®¡æ—¶ç»“æŸä¸”æ£€æµ‹åˆ°æœŸå·å˜åŒ–

**å‚æ•°ï¼š**
```typescript
{
  period: string      // å·²å¼€å¥–çš„æœŸå·
  nextPeriod: string  // ä¸‹ä¸€æœŸæœŸå·
}
```

**ç”¨é€”ï¼š**
- æ˜¾ç¤ºå¼€å¥–é€šçŸ¥
- è‡ªåŠ¨åˆ·æ–°å¼€å¥–å†å²
- æ›´æ–°ç»Ÿè®¡æ•°æ®
- ç»“ç®—ç”¨æˆ·ä¸‹æ³¨

---

### close äº‹ä»¶ï¼ˆå°ç›˜ï¼‰

**è§¦å‘æ—¶æœºï¼š** ä»å¼€ç›˜çŠ¶æ€åˆ‡æ¢åˆ°å°ç›˜çŠ¶æ€

**å‚æ•°ï¼š**
```typescript
{
  period: string      // å½“å‰æœŸå·
  nextPeriod: string  // ä¸‹æœŸæœŸå·
}
```

**ç”¨é€”ï¼š**
- ç¦ç”¨ä¸‹æ³¨æŒ‰é’®
- æ˜¾ç¤ºå°ç›˜æç¤º
- æ’­æ”¾æç¤ºéŸ³

---

### open äº‹ä»¶ï¼ˆå¼€ç›˜ï¼‰

**è§¦å‘æ—¶æœºï¼š** ä»å°ç›˜çŠ¶æ€åˆ‡æ¢åˆ°å¼€ç›˜çŠ¶æ€

**å‚æ•°ï¼š**
```typescript
{
  period: string      // å½“å‰æœŸå·
  nextPeriod: string  // ä¸‹æœŸæœŸå·
}
```

**ç”¨é€”ï¼š**
- å¯ç”¨ä¸‹æ³¨æŒ‰é’®
- æ˜¾ç¤ºå¼€ç›˜æç¤º
- æ’­æ”¾æç¤ºéŸ³

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå¼€å¥–å†å²é¡µé¢

```vue
<template>
  <div class="lottery-history">
    <!-- å€’è®¡æ—¶ç»„ä»¶ -->
    <LotteryCountdown 
      @draw="handleDraw"
      @close="handleClose"
      @open="handleOpen"
    />

    <!-- å¼€å¥–åˆ—è¡¨ -->
    <el-table :data="lotteryList" />
  </div>
</template>

<script setup lang="ts">
import LotteryCountdown from '@/components/LotteryCountdown.vue'
import { getLotteryHistory } from '@/api/lottery'

const lotteryList = ref([])

const fetchLotteryHistory = async () => {
  const res = await getLotteryHistory({ page: 1, limit: 20 })
  lotteryList.value = res.data.list
}

// å¼€å¥–è‡ªåŠ¨åˆ·æ–°
const handleDraw = (data) => {
  ElMessage.success(`ç¬¬ ${data.period} æœŸå·²å¼€å¥–`)
  setTimeout(() => fetchLotteryHistory(), 2000)
}

// å°ç›˜å¤„ç†
const handleClose = (data) => {
  console.log('å°ç›˜äº†ï¼Œç¦ç”¨ä¸‹æ³¨')
}

// å¼€ç›˜å¤„ç†
const handleOpen = (data) => {
  console.log('å¼€ç›˜äº†ï¼Œå¯ç”¨ä¸‹æ³¨')
}

onMounted(() => {
  fetchLotteryHistory()
})
</script>
```

---

### ç¤ºä¾‹2ï¼šä¸‹æ³¨é¡µé¢

```vue
<template>
  <div class="bet-page">
    <!-- å€’è®¡æ—¶ç»„ä»¶ -->
    <LotteryCountdown 
      @draw="handleDraw"
      @close="handleClose"
      @open="handleOpen"
    />

    <!-- ä¸‹æ³¨è¡¨å• -->
    <el-form>
      <el-button 
        type="primary" 
        :disabled="isClosed"
        @click="submitBet"
      >
        {{ isClosed ? 'å·²å°ç›˜' : 'ç¡®è®¤ä¸‹æ³¨' }}
      </el-button>
    </el-form>
  </div>
</template>

<script setup lang="ts">
const isClosed = ref(false)

const handleDraw = (data) => {
  // å¼€å¥–åæ¸…ç©ºä¸‹æ³¨è¡¨å•
  resetBetForm()
  // åˆ·æ–°æˆ‘çš„ä¸‹æ³¨è®°å½•
  fetchMyBets()
}

const handleClose = (data) => {
  isClosed.value = true
  ElMessage.warning('æœ¬æœŸå·²å°ç›˜')
}

const handleOpen = (data) => {
  isClosed.value = false
  ElMessage.success('å¼€å§‹ä¸‹æ³¨')
}
</script>
```

---

## ğŸ¯ ä¼˜åŒ–ç»†èŠ‚

### 1. å»¶è¿Ÿåˆ·æ–°

```typescript
// âŒ ç«‹å³åˆ·æ–°å¯èƒ½è·å–ä¸åˆ°æœ€æ–°æ•°æ®
const handleDraw = (data) => {
  fetchLotteryHistory() // åç«¯å¯èƒ½è¿˜æ²¡åŒæ­¥
}

// âœ… å»¶è¿Ÿ2ç§’åˆ·æ–°
const handleDraw = (data) => {
  setTimeout(() => {
    fetchLotteryHistory()
  }, 2000) // ç»™åç«¯2ç§’åŒæ­¥æ—¶é—´
}
```

### 2. é˜²æ­¢é‡å¤åˆ·æ–°

```typescript
const isRefreshing = ref(false)

const handleDraw = async (data) => {
  if (isRefreshing.value) return
  
  isRefreshing.value = true
  ElMessage.success('è‡ªåŠ¨åˆ·æ–°ä¸­...')
  
  setTimeout(async () => {
    await fetchLotteryHistory()
    isRefreshing.value = false
  }, 2000)
}
```

### 3. é”™è¯¯å¤„ç†

```typescript
const handleDraw = async (data) => {
  try {
    setTimeout(async () => {
      await fetchLotteryHistory()
      ElMessage.success('æ•°æ®å·²æ›´æ–°')
    }, 2000)
  } catch (error) {
    ElMessage.error('åˆ·æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°')
    console.error('è‡ªåŠ¨åˆ·æ–°å¤±è´¥:', error)
  }
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. åªåˆ·æ–°éœ€è¦çš„æ•°æ®

```typescript
const handleDraw = (data) => {
  // âœ… åªåˆ·æ–°ç¬¬ä¸€é¡µ
  if (pagination.page === 1) {
    fetchLotteryHistory()
  } else {
    // âŒ ä¸åœ¨ç¬¬ä¸€é¡µï¼Œæ˜¾ç¤ºæç¤º
    ElMessage.info('æœ‰æ–°å¼€å¥–ï¼Œç‚¹å‡»åˆ·æ–°æŸ¥çœ‹')
  }
}
```

### 2. å±€éƒ¨æ›´æ–°

```typescript
const handleDraw = async (data) => {
  // åªè·å–æœ€æ–°ä¸€æ¡
  const res = await getLotteryHistory({ 
    page: 1, 
    limit: 1 
  })
  
  // æ’å…¥åˆ°åˆ—è¡¨é¡¶éƒ¨
  if (res.data.list[0]) {
    lotteryList.value.unshift(res.data.list[0])
    // ç§»é™¤æœ€åä¸€æ¡ï¼Œä¿æŒåˆ—è¡¨é•¿åº¦
    if (lotteryList.value.length > 20) {
      lotteryList.value.pop()
    }
  }
}
```

---

## ğŸ”” é€šçŸ¥æç¤º

### æ¡Œé¢é€šçŸ¥

```typescript
const handleDraw = (data) => {
  // è¯·æ±‚é€šçŸ¥æƒé™
  if (Notification.permission === 'granted') {
    new Notification('å¼€å¥–é€šçŸ¥', {
      body: `ç¬¬ ${data.period} æœŸå·²å¼€å¥–`,
      icon: '/logo.png',
    })
  }
  
  // åˆ·æ–°æ•°æ®
  setTimeout(() => fetchLotteryHistory(), 2000)
}
```

### Element Plus é€šçŸ¥

```typescript
import { ElNotification } from 'element-plus'

const handleDraw = (data) => {
  ElNotification({
    title: 'å¼€å¥–é€šçŸ¥',
    message: `ç¬¬ ${data.period} æœŸå·²å¼€å¥–ï¼Œè‡ªåŠ¨åˆ·æ–°ä¸­...`,
    type: 'success',
    duration: 3000,
    position: 'top-right',
  })
  
  setTimeout(() => fetchLotteryHistory(), 2000)
}
```

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1ï¼šåˆ·æ–°åæ²¡æœ‰æ–°æ•°æ®

**åŸå› ï¼š** åç«¯è¿˜æ²¡åŒæ­¥åˆ°æœ€æ–°æ•°æ®

**è§£å†³ï¼š**
```typescript
// å¢åŠ å»¶è¿Ÿæ—¶é—´
setTimeout(() => fetchLotteryHistory(), 3000) // 3ç§’

// æˆ–è€…é‡è¯•æœºåˆ¶
const retryFetch = async (maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    await fetchLotteryHistory()
    if (lotteryList.value[0]?.issue === data.period) {
      break // æ‰¾åˆ°äº†æ–°æ•°æ®
    }
    await new Promise(resolve => setTimeout(resolve, 2000))
  }
}
```

### é—®é¢˜2ï¼šå¤šæ¬¡è§¦å‘åˆ·æ–°

**åŸå› ï¼š** äº‹ä»¶é‡å¤è§¦å‘

**è§£å†³ï¼š**
```typescript
let drawTimer: any = null

const handleDraw = (data) => {
  if (drawTimer) {
    clearTimeout(drawTimer)
  }
  
  drawTimer = setTimeout(() => {
    fetchLotteryHistory()
    drawTimer = null
  }, 2000)
}
```

---

## ğŸ“Š ç›‘æ§æ•°æ®

### å…³é”®æŒ‡æ ‡

```typescript
const stats = {
  autoRefreshCount: 0,     // è‡ªåŠ¨åˆ·æ–°æ¬¡æ•°
  autoRefreshSuccess: 0,   // æˆåŠŸæ¬¡æ•°
  autoRefreshFailed: 0,    // å¤±è´¥æ¬¡æ•°
  avgRefreshTime: 0,       // å¹³å‡åˆ·æ–°æ—¶é—´
}

const handleDraw = async (data) => {
  stats.autoRefreshCount++
  const startTime = Date.now()
  
  try {
    await new Promise(resolve => setTimeout(resolve, 2000))
    await fetchLotteryHistory()
    stats.autoRefreshSuccess++
  } catch (error) {
    stats.autoRefreshFailed++
  } finally {
    const duration = Date.now() - startTime
    stats.avgRefreshTime = (stats.avgRefreshTime + duration) / 2
  }
}
```

---

## ğŸš€ æœªæ¥ä¼˜åŒ–

### 1. WebSocket æ¨é€

```typescript
// æ›¿ä»£å®šæ—¶è½®è¯¢ï¼Œå®æ—¶æ¨é€å¼€å¥–ç»“æœ
socket.on('lottery-draw', (data) => {
  ElMessage.success(`ç¬¬ ${data.period} æœŸå·²å¼€å¥–`)
  // ç›´æ¥æ›´æ–°åˆ—è¡¨ï¼Œæ— éœ€å»¶è¿Ÿ
  lotteryList.value.unshift(data)
})
```

### 2. Service Worker

```typescript
// åå°è‡ªåŠ¨åˆ·æ–°ï¼Œå³ä½¿é¡µé¢ä¸åœ¨å‰å°
navigator.serviceWorker.addEventListener('message', (event) => {
  if (event.data.type === 'lottery-draw') {
    fetchLotteryHistory()
  }
})
```

---

**æ›´æ–°æ—¶é—´ï¼š** 2025-11-27  
**ç‰ˆæœ¬ï¼š** v1.0  
**ä½œè€…ï¼š** AI Assistant





