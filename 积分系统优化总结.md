# ç§¯åˆ†ç³»ç»Ÿä¼˜åŒ–æ€»ç»“ âœ…

## ğŸ“‹ æœ¬æ¬¡ä¼˜åŒ–å†…å®¹

### 1. å»æ‰ç»Ÿè®¡å­—æ®µ âŒ
ä» `User` è¡¨ä¸­åˆ é™¤ï¼š
- `totalBet`ï¼ˆç´¯è®¡ä¸‹æ³¨ï¼‰
- `totalWin`ï¼ˆç´¯è®¡èµ¢ï¼‰
- `totalLoss`ï¼ˆç´¯è®¡äºæŸï¼‰

**ç†ç”±**ï¼šè¿™äº›ç»Ÿè®¡å­—æ®µå¯ä»¥é€šè¿‡èšåˆæŸ¥è¯¢å®æ—¶è®¡ç®—ï¼Œä¸éœ€è¦å­˜å‚¨

### 2. ç§¯åˆ†æ•´æ•°åŒ– ğŸ”¢
- **ç”¨æˆ·ä½™é¢**ï¼ˆ`User.points`ï¼‰ï¼šåªå­˜å‚¨æ•´æ•°ï¼Œä½¿ç”¨ `Int` ç±»å‹
- **ç§¯åˆ†è´¦å•**ï¼ˆ`PointRecord`ï¼‰ï¼šä¿ç•™å°æ•°ç‚¹åä¸¤ä½ï¼Œä½¿ç”¨ `Decimal(10,2)` ç±»å‹
- **ä¸‹æ³¨ç›¸å…³**ï¼ˆ`Bet` è¡¨ï¼‰ï¼šé‡‘é¢ã€æ‰‹ç»­è´¹ã€ç»“æœéƒ½æ”¹ä¸º `Int` ç±»å‹
- **è®¡ç®—è§„åˆ™**ï¼šæ‰€æœ‰ç§¯åˆ†è®¡ç®—ä½¿ç”¨ `Math.floor()` å‘ä¸‹å–æ•´

**ç¤ºä¾‹**ï¼š
```
åŸä½™é¢ï¼š2000
åŠ åˆ†ï¼š+1500.52
è®¡ç®—ï¼š2000 + 1500.52 = 3500.52
æœ€ç»ˆä½™é¢ï¼š3500ï¼ˆå‘ä¸‹å–æ•´ï¼‰

ç§¯åˆ†è´¦å•æ˜¾ç¤ºï¼š
- å˜åŠ¨é‡‘é¢ï¼š+1500.52
- å˜åŠ¨å‰ï¼š2000.00
- å˜åŠ¨åï¼š3500.00
```

### 3. æ‰‹ç»­è´¹åˆå¹¶ ğŸ«
ä¸å†å•ç‹¬åˆ›å»ºæ‰‹ç»­è´¹è®°å½•ï¼Œæ‰‹ç»­è´¹åˆå¹¶åˆ°ç»“ç®—è®°å½•ä¸­ï¼š

**æ”¹åŠ¨å‰**ï¼š
- ä¸‹æ³¨æ—¶ï¼š1æ¡è®°å½•ï¼ˆæ‰£æœ¬é‡‘ï¼‰
- ç»“ç®—æ—¶ï¼š2æ¡è®°å½•ï¼ˆæ‰‹ç»­è´¹ + ç»“ç®—ï¼‰
- **æ€»è®¡ï¼š3æ¡è®°å½•**

**æ”¹åŠ¨å**ï¼š
- ä¸‹æ³¨æ—¶ï¼š1æ¡è®°å½•ï¼ˆæ‰£æœ¬é‡‘ï¼‰
- ç»“ç®—æ—¶ï¼š1æ¡è®°å½•ï¼ˆç»“ç®—ï¼Œå«æ‰‹ç»­è´¹ï¼‰
- **æ€»è®¡ï¼š2æ¡è®°å½•**

**ç¤ºä¾‹**ï¼š
```
ä¸‹æ³¨è®°å½•ï¼š
ç±»å‹: bet
é‡‘é¢: -1000
å¤‡æ³¨: æœŸå·3364710 å€æ•°ä¸‹æ³¨

ç»“ç®—è®°å½•ï¼š
ç±»å‹: win
é‡‘é¢: +1970  ï¼ˆåŸæœ¬é‡‘2000 - æ‰‹ç»­è´¹30ï¼‰
å¤‡æ³¨: æœŸå·3364710ä¸‹æ³¨ç»“ç®—-ä¸­å¥–ï¼ˆå«æ‰‹ç»­è´¹30ï¼‰
```

## ğŸ”§ æ•°æ®åº“Schemaå˜æ›´

### User è¡¨
```sql
-- ä¿®æ”¹å‰
points       DECIMAL(10,2) DEFAULT 0.00
total_bet    DECIMAL(15,2) DEFAULT 0.00
total_win    DECIMAL(15,2) DEFAULT 0.00
total_loss   DECIMAL(15,2) DEFAULT 0.00

-- ä¿®æ”¹å
points       INT DEFAULT 0  -- âœ… æ”¹ä¸ºæ•´æ•°
-- âŒ åˆ é™¤ total_bet, total_win, total_loss
```

### Bet è¡¨
```sql
-- ä¿®æ”¹å‰
amount         DECIMAL(10,2)
fee            DECIMAL(10,2) DEFAULT 0.00
result_amount  DECIMAL(10,2)
points_before  DECIMAL(10,2)
points_after   DECIMAL(10,2)

-- ä¿®æ”¹å
amount         INT  -- âœ… æ”¹ä¸ºæ•´æ•°
fee            INT DEFAULT 0  -- âœ… æ”¹ä¸ºæ•´æ•°
result_amount  INT  -- âœ… æ”¹ä¸ºæ•´æ•°
points_before  INT  -- âœ… æ”¹ä¸ºæ•´æ•°
points_after   INT  -- âœ… æ”¹ä¸ºæ•´æ•°
```

### PointRecord è¡¨
```sql
-- ä¿æŒä¸å˜
amount          DECIMAL(10,2)  -- âœ… ä¿ç•™å°æ•°
balance_before  DECIMAL(10,2)  -- âœ… ä¿ç•™å°æ•°
balance_after   DECIMAL(10,2)  -- âœ… ä¿ç•™å°æ•°
```

## ğŸ“ ä»£ç ä¿®æ”¹æ¸…å•

### 1. åç«¯ Schemaï¼ˆ`schema.prisma`ï¼‰
- âœ… `User.points` ä» `Decimal(10,2)` æ”¹ä¸º `Int`
- âœ… åˆ é™¤ `User.totalBet/totalWin/totalLoss`
- âœ… `Bet` è¡¨æ‰€æœ‰é‡‘é¢å­—æ®µä» `Decimal(10,2)` æ”¹ä¸º `Int`
- âœ… `PointRecord` ä¿æŒ `Decimal(10,2)`

### 2. è®¡ç®—å·¥å…·ï¼ˆ`lottery-rules.util.ts`ï¼‰
```typescript
// âœ… å€æ•°ä¸‹æ³¨
export function calculateMultipleBetResult(...) {
  const fee = Math.floor((amount / feeBase) * feeRate);
  const resultAmount = Math.floor(...);  // å‘ä¸‹å–æ•´
  return { fee, loss, resultAmount };
}

// âœ… ç»„åˆä¸‹æ³¨
export function calculateComboBetResult(...) {
  const fee = Math.floor((amount / feeBase) * feeRate);
  const resultAmount = Math.floor(...);  // å‘ä¸‹å–æ•´
  return { fee, resultAmount };
}
```

### 3. ä¸‹æ³¨æœåŠ¡ï¼ˆ`bet.service.ts`ï¼‰
```typescript
// âœ… åˆ›å»ºä¸‹æ³¨
async createBet(...) {
  const fee = Math.floor(feeWithDecimal);  // æ‰‹ç»­è´¹å–æ•´
  const newPoints = Math.floor(currentPoints - amount);  // ä½™é¢å–æ•´
  
  // âŒ åˆ é™¤ totalBet å¢é‡æ›´æ–°
  await tx.user.update({
    data: { points: newPoints },  // åªæ›´æ–°ç§¯åˆ†
  });
}
```

### 4. ç»“ç®—æœåŠ¡ï¼ˆ`lottery.service.ts`ï¼‰
```typescript
// âœ… ç»“ç®—å•ä¸ªä¸‹æ³¨
private async settleSingleBet(...) {
  const finalPoints = Math.floor(finalPointsWithDecimal);  // ä½™é¢å–æ•´
  
  // âŒ åˆ é™¤ totalWin/totalLoss å¢é‡æ›´æ–°
  await tx.user.update({
    data: { points: finalPoints },  // åªæ›´æ–°ç§¯åˆ†
  });
  
  // âœ… åªåˆ›å»ºä¸€æ¡ç»“ç®—è®°å½•ï¼ˆå«æ‰‹ç»­è´¹ï¼‰
  await tx.pointRecord.create({
    data: {
      type: status === 'win' ? 'win' : 'loss',
      amount: resultAmount,  // å·²åŒ…å«æ‰‹ç»­è´¹
      remark: `æœŸå·${bet.issue}ä¸‹æ³¨ç»“ç®—-${status}ï¼ˆå«æ‰‹ç»­è´¹${fee}ï¼‰`,
    },
  });
  
  // âŒ åˆ é™¤å•ç‹¬çš„æ‰‹ç»­è´¹è®°å½•
}
```

### 5. ç”¨æˆ·æœåŠ¡ï¼ˆ`user.service.ts`ï¼‰
```typescript
// âœ… è°ƒæ•´ç§¯åˆ†
async adjustUserPoints(...) {
  const newPoints = Math.floor(newPointsWithDecimal);  // ä½™é¢å–æ•´
  
  await tx.user.update({
    data: { points: newPoints },
  });
  
  // âœ… ç§¯åˆ†è´¦å•ä¿ç•™å°æ•°
  await tx.pointRecord.create({
    data: {
      amount,  // ä¿ç•™å°æ•°
      balanceBefore: currentPoints,
      balanceAfter: newPoints,
    },
  });
}
```

### 6. å‰ç«¯ç±»å‹å®šä¹‰
```typescript
// frontend-admin/src/types/index.ts
export interface User {
  id: number
  username: string
  nickname: string
  points: number  // âœ… æ•´æ•°
  status: number
  // âŒ åˆ é™¤ totalBet, totalWin, totalLoss
}

// frontend-h5/src/types/user.ts
export interface UserInfo {
  id: number
  username: string
  points: number  // âœ… æ•´æ•°
  // âŒ åˆ é™¤ totalBet, totalWin, totalLoss
}
```

## ğŸ“Š ç§¯åˆ†æµæ°´å¯¹æ¯”

### æ”¹åŠ¨å‰ï¼ˆ3æ¡è®°å½•ï¼‰
```
1. [ä¸‹æ³¨] -1000.00  ä½™é¢: 4000
2. [æ‰‹ç»­è´¹] -30.00  ä½™é¢: 3970
3. [ä¸­å¥–] +2000.00  ä½™é¢: 5970
```

### æ”¹åŠ¨åï¼ˆ2æ¡è®°å½•ï¼‰
```
1. [ä¸‹æ³¨] -1000.00  ä½™é¢: 4000
2. [ä¸­å¥–] +1970.00  ä½™é¢: 5970  å¤‡æ³¨: å«æ‰‹ç»­è´¹30
```

## âœ… ä¼˜åŒ–æ•ˆæœ

### 1. æ•°æ®åº“å±‚é¢
- âœ… å‡å°‘3ä¸ªå­—æ®µï¼ˆtotalBet/totalWin/totalLossï¼‰
- âœ… Int ç±»å‹æ¯” Decimal èŠ‚çœå­˜å‚¨ç©ºé—´
- âœ… æ¯æ¬¡ç»“ç®—å‡å°‘1-2æ¡ PointRecord è®°å½•

### 2. æ€§èƒ½å±‚é¢
- âœ… å‡å°‘æ•°æ®åº“å†™æ“ä½œ
- âœ… å‡å°‘äº‹åŠ¡å¤„ç†æ—¶é—´
- âœ… ç®€åŒ–æŸ¥è¯¢é€»è¾‘

### 3. ç”¨æˆ·ä½“éªŒå±‚é¢
- âœ… ç§¯åˆ†æµæ°´æ›´ç®€æ´æ¸…æ™°
- âœ… æ‰‹ç»­è´¹ä¿¡æ¯é€æ˜åŒ–
- âœ… ä½™é¢æ˜¾ç¤ºæ•´æ•°ï¼Œæ›´ç›´è§‚

### 4. ç»´æŠ¤å±‚é¢
- âœ… ä»£ç é€»è¾‘æ›´ç®€å•
- âœ… å‡å°‘æ•°æ®ä¸€è‡´æ€§é—®é¢˜
- âœ… ç»Ÿè®¡æ•°æ®é€šè¿‡èšåˆæŸ¥è¯¢ï¼Œæ›´å‡†ç¡®

## ğŸ¯ æµ‹è¯•éªŒè¯

### 1. ç§¯åˆ†è®¡ç®—æµ‹è¯•
```bash
# åŠ åˆ†æµ‹è¯•
åŸä½™é¢: 5000
åŠ åˆ†: 1500.52
é¢„æœŸä½™é¢: 6500  âœ…

# å‡åˆ†æµ‹è¯•
åŸä½™é¢: 2000
å‡åˆ†: 1500.52
é¢„æœŸä½™é¢: 499  âœ…
```

### 2. ä¸‹æ³¨æµ‹è¯•
```bash
# å€æ•°ä¸‹æ³¨ - å›æœ¬
ä¸‹æ³¨: 1000, æ‰‹ç»­è´¹: 30
ç§¯åˆ†æµæ°´: 2æ¡ï¼ˆä¸‹æ³¨ + ç»“ç®—ï¼‰âœ…
æœ€ç»ˆä½™é¢: å‘ä¸‹å–æ•´ âœ…
```

### 3. ç§¯åˆ†æµæ°´æµ‹è¯•
```bash
# æ£€æŸ¥ç§¯åˆ†è´¦å•
PointRecord æ˜¾ç¤ºå°æ•°: âœ…
User ä½™é¢æ˜¾ç¤ºæ•´æ•°: âœ…
æµæ°´è®°å½•æ•°: å‡å°‘ 33%-50% âœ…
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

```bash
# 1. åœæ­¢åç«¯æœåŠ¡
taskkill /F /IM node.exe

# 2. æ¨é€æ•°æ®åº“å˜æ›´ï¼ˆä¼šä¸¢å¤±å°æ•°éƒ¨åˆ†ï¼‰
cd score-system/backend
npx prisma db push --accept-data-loss

# 3. ç”Ÿæˆ Prisma Client
npx prisma generate

# 4. é‡å¯åç«¯æœåŠ¡
pnpm start:dev
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®ä¸¢å¤±è­¦å‘Š**ï¼š
   - Decimal è½¬ Int ä¼šä¸¢å¤±å°æ•°éƒ¨åˆ†
   - `totalBet/totalWin/totalLoss` æ•°æ®ä¼šè¢«åˆ é™¤
   - å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯

2. **è®¡ç®—è§„åˆ™**ï¼š
   - æ‰€æœ‰ç§¯åˆ†è®¡ç®—éƒ½å‘ä¸‹å–æ•´ï¼ˆMath.floorï¼‰
   - æ‰‹ç»­è´¹è®¡ç®—ä¹Ÿå‘ä¸‹å–æ•´
   - ä¸ä¼šå››èˆäº”å…¥

3. **ç§¯åˆ†è´¦å•**ï¼š
   - PointRecord ä¿ç•™å°æ•°æ˜¾ç¤ºè¯¦ç»†å˜åŠ¨
   - User.points åªå­˜å‚¨æ•´æ•°æ˜¾ç¤ºä½™é¢
   - ä¸¤è€…å¯èƒ½æœ‰å¾®å°å·®å¼‚ï¼ˆå°æ•°éƒ¨åˆ†ä¸¢å¤±ï¼‰

4. **ç»Ÿè®¡æ•°æ®**ï¼š
   - å¦‚éœ€æ€»ä¸‹æ³¨/æ€»ç›ˆäºç­‰ç»Ÿè®¡ï¼Œä½¿ç”¨èšåˆæŸ¥è¯¢
   - ä¸å†ä¾èµ– User è¡¨çš„ç»Ÿè®¡å­—æ®µ
   - å¯åœ¨ Admin Service ä¸­å®ç°ç»Ÿè®¡æ¥å£

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç§¯åˆ†æ•´æ•°åŒ–å’Œç»Ÿè®¡å­—æ®µç§»é™¤.md](./ç§¯åˆ†æ•´æ•°åŒ–å’Œç»Ÿè®¡å­—æ®µç§»é™¤.md)
- [æ‰‹ç»­è´¹åˆå¹¶åˆ°æ³¨å•è®°å½•.md](./æ‰‹ç»­è´¹åˆå¹¶åˆ°æ³¨å•è®°å½•.md)
- [ä¸šåŠ¡è§„åˆ™è¯¦è§£æ–‡æ¡£.md](../ä¸šåŠ¡è§„åˆ™è¯¦è§£æ–‡æ¡£.md)

---

**æœ€åæ›´æ–°**: 2025-11-27 17:10
**çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œç­‰å¾…é‡å¯éªŒè¯
**å½±å“èŒƒå›´**: 
- æ•°æ®åº“ Schema
- åç«¯è®¡ç®—é€»è¾‘
- å‰ç«¯ç±»å‹å®šä¹‰
- ç§¯åˆ†æµæ°´è®°å½•



