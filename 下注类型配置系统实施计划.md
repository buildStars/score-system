# ğŸ¯ ä¸‹æ³¨ç±»å‹é…ç½®ç³»ç»Ÿå®æ–½è®¡åˆ’

## ğŸ“‹ éœ€æ±‚æè¿°

æ ¹æ®å›¾ç‰‡æ˜¾ç¤ºï¼Œéœ€è¦ä¸ºæ¯ç§ä¸‹æ³¨ç±»å‹é…ç½®ä»¥ä¸‹å‚æ•°ï¼š

### ä¸‹æ³¨ç±»å‹åˆ—è¡¨
1. **å•** - ç»“æœä¸ºå•æ•°
2. **åŒ** - ç»“æœä¸ºåŒæ•°  
3. **å¤§** - ç»“æœ â‰¥ 14
4. **å°** - ç»“æœ < 14
5. **å¤§å•** - ç»“æœ â‰¥ 14 ä¸”ä¸ºå•æ•°
6. **å¤§åŒ** - ç»“æœ â‰¥ 14 ä¸”ä¸ºåŒæ•°
7. **å°å•** - ç»“æœ < 14 ä¸”ä¸ºå•æ•°
8. **å°åŒ** - ç»“æœ < 14 ä¸”ä¸ºåŒæ•°
9. **å€æ•°** - æŒ‰å€æ•°ä¸‹æ³¨ï¼ˆ2å€ã€3å€ã€5å€ç­‰ï¼‰

### æ¯ç§ç±»å‹éœ€è¦é…ç½®çš„å‚æ•°
- **èµ”ç‡** - ä¸­å¥–èµ”ç‡ï¼ˆå¦‚1.95å€ã€3.80å€ï¼‰
- **æœ€å°æŠ•æ³¨é¢** - å•æ¬¡æœ€å°ä¸‹æ³¨é‡‘é¢
- **æœ€å¤§æŠ•æ³¨é¢** - å•æ¬¡æœ€å¤§ä¸‹æ³¨é‡‘é¢
- **æ‰‹ç»­è´¹æ¯”ä¾‹** - æ‰£é™¤çš„æ‰‹ç»­è´¹ç™¾åˆ†æ¯”
- **é€€æ°´æ¯”ä¾‹** - è¿”è¿˜ç»™ç”¨æˆ·çš„æ¯”ä¾‹ï¼ˆç±»ä¼¼ä½£é‡‘ï¼‰
- **æ˜¯å¦å¯ç”¨** - å¼€å…³æ­¤ç©æ³•

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è®¾è®¡ âœ…

**åˆ›å»ºäº†æ–°è¡¨ `bet_type_settings`ï¼š**
```sql
CREATE TABLE `bet_type_settings` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `bet_type` VARCHAR(50) UNIQUE NOT NULL,     -- ç±»å‹æ ‡è¯†
  `name` VARCHAR(100) NOT NULL,                -- æ˜¾ç¤ºåç§°
  `odds` DECIMAL(10, 2) DEFAULT 0.00,         -- èµ”ç‡
  `min_bet` DECIMAL(10, 2) DEFAULT 1.00,      -- æœ€å°æŠ•æ³¨
  `max_bet` DECIMAL(10, 2) DEFAULT 10000.00,  -- æœ€å¤§æŠ•æ³¨
  `fee_rate` DECIMAL(10, 4) DEFAULT 0.0000,   -- æ‰‹ç»­è´¹æ¯”ä¾‹
  `rebate_rate` DECIMAL(10, 4) DEFAULT 0.0000, -- é€€æ°´æ¯”ä¾‹
  `is_enabled` TINYINT(1) DEFAULT 1,           -- æ˜¯å¦å¯ç”¨
  `sort_order` INT DEFAULT 0,                  -- æ’åº
  `description` VARCHAR(500),                   -- è¯´æ˜
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**é»˜è®¤æ•°æ®ï¼ˆæ ¹æ®å›¾ç‰‡ï¼‰ï¼š**
```sql
INSERT INTO `bet_type_settings` VALUES
('single', 'å•', 1.95, 1.00, 4999.00, 0.00, 0.00, 1, 1, 'ç»“æœä¸ºå•æ•°'),
('double', 'åŒ', 1.95, 1.00, 4999.00, 0.00, 0.00, 1, 2, 'ç»“æœä¸ºåŒæ•°'),
('big', 'å¤§', 1.95, 1.00, 4999.00, 0.00, 0.00, 1, 3, 'ç»“æœ>=14'),
('small', 'å°', 1.95, 1.00, 4999.00, 0.00, 0.00, 1, 4, 'ç»“æœ<14'),
('big_single', 'å¤§å•', 3.80, 7.00, 1000.00, 0.00, 0.00, 1, 5, '>=14ä¸”å•'),
('big_double', 'å¤§åŒ', 3.80, 19.50, 1000.00, 0.00, 0.00, 1, 6, '>=14ä¸”åŒ'),
('small_single', 'å°å•', 3.80, 7.00, 1000.00, 0.00, 0.00, 1, 7, '<14ä¸”å•'),
('small_double', 'å°åŒ', 3.80, 0.00, 1000.00, 0.00, 0.00, 1, 8, '<14ä¸”åŒ');
```

### 2. Prisma Schema æ›´æ–° âœ…

```prisma
model BetTypeSetting {
  id            Int      @id @default(autoincrement())
  betType       String   @unique @map("bet_type")
  name          String
  odds          Decimal  @default(0) @db.Decimal(10, 2)
  minBet        Decimal  @map("min_bet") @default(1)
  maxBet        Decimal  @map("max_bet") @default(10000)
  feeRate       Decimal  @map("fee_rate") @default(0)
  rebateRate    Decimal  @map("rebate_rate") @default(0)
  isEnabled     Boolean  @default(true) @map("is_enabled")
  sortOrder     Int      @default(0) @map("sort_order")
  description   String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@map("bet_type_settings")
}
```

### 3. DTO å®šä¹‰ âœ…

**æ–‡ä»¶ï¼š** `backend/src/modules/system/dto/bet-type-setting.dto.ts`

```typescript
export class UpdateBetTypeSettingDto {
  name?: string;           // æ˜¾ç¤ºåç§°
  odds?: number;           // èµ”ç‡
  minBet?: number;         // æœ€å°æŠ•æ³¨
  maxBet?: number;         // æœ€å¤§æŠ•æ³¨
  feeRate?: number;        // æ‰‹ç»­è´¹æ¯”ä¾‹
  rebateRate?: number;     // é€€æ°´æ¯”ä¾‹
  isEnabled?: boolean;     // æ˜¯å¦å¯ç”¨
  sortOrder?: number;      // æ’åº
  description?: string;    // è¯´æ˜
}

export class BatchUpdateBetTypeSettingsDto {
  settings: Array<{betType: string} & UpdateBetTypeSettingDto>;
}
```

### 4. API æ¥å£ âœ…

**æ–‡ä»¶ï¼š** `backend/src/modules/system/system.controller.ts`

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/admin/bet-type-settings` | GET | è·å–æ‰€æœ‰ä¸‹æ³¨ç±»å‹é…ç½® |
| `/admin/bet-type-settings/:betType` | GET | è·å–æŒ‡å®šç±»å‹é…ç½® |
| `/admin/bet-type-settings/:betType` | PUT | æ›´æ–°æŒ‡å®šç±»å‹é…ç½® |
| `/admin/bet-type-settings/batch` | POST | æ‰¹é‡æ›´æ–°é…ç½® |

---

## ğŸš§ å¾…å®Œæˆçš„å·¥ä½œ

### 1. æœåŠ¡å±‚å®ç° â°

**æ–‡ä»¶ï¼š** `backend/src/modules/system/system.service.ts`

éœ€è¦æ·»åŠ ä»¥ä¸‹æ–¹æ³•ï¼š

```typescript
export class SystemService {
  // è·å–æ‰€æœ‰ä¸‹æ³¨ç±»å‹é…ç½®
  async getBetTypeSettings() {
    return await this.prisma.betTypeSetting.findMany({
      orderBy: { sortOrder: 'asc' }
    });
  }

  // è·å–æŒ‡å®šä¸‹æ³¨ç±»å‹é…ç½®
  async getBetTypeSetting(betType: string) {
    return await this.prisma.betTypeSetting.findUnique({
      where: { betType }
    });
  }

  // æ›´æ–°æŒ‡å®šä¸‹æ³¨ç±»å‹é…ç½®
  async updateBetTypeSetting(
    betType: string,
    updateDto: UpdateBetTypeSettingDto,
    adminId: number,
    adminUsername: string
  ) {
    // 1. æ›´æ–°é…ç½®
    const updated = await this.prisma.betTypeSetting.update({
      where: { betType },
      data: updateDto
    });

    // 2. è®°å½•æ—¥å¿—
    await this.logAction(
      adminId,
      adminUsername,
      'update_bet_type_setting',
      'bet_type_setting',
      betType,
      `æ›´æ–°ä¸‹æ³¨ç±»å‹é…ç½®: ${betType}`,
      updateDto
    );

    return updated;
  }

  // æ‰¹é‡æ›´æ–°
  async batchUpdateBetTypeSettings(
    batchUpdateDto: BatchUpdateBetTypeSettingsDto,
    adminId: number,
    adminUsername: string
  ) {
    const results = [];
    
    for (const item of batchUpdateDto.settings) {
      const { betType, ...updateData } = item;
      const updated = await this.updateBetTypeSetting(
        betType,
        updateData,
        adminId,
        adminUsername
      );
      results.push(updated);
    }

    return results;
  }
}
```

### 2. æ•°æ®åº“è¿ç§» â°

```bash
# æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ Prisma è¿ç§»
cd score-system/backend
npx prisma migrate dev --name add_bet_type_settings

# æ–¹æ¡ˆ 2ï¼šæ‰‹åŠ¨æ‰§è¡Œ SQL
mysql -u root -p yunce_score_system < prisma/migrations/add_bet_type_settings.sql
```

### 3. å‰ç«¯é¡µé¢å¼€å‘ â°

**æ–‡ä»¶ï¼š** `frontend-admin/src/views/BetTypeSettings.vue`

**é¡µé¢åŠŸèƒ½ï¼š**
- åˆ—è¡¨å±•ç¤ºæ‰€æœ‰ä¸‹æ³¨ç±»å‹é…ç½®
- å¯ç¼–è¾‘æ¯é¡¹é…ç½®
- æ”¯æŒæ‰¹é‡ä¿å­˜
- æ˜¾ç¤ºèµ”ç‡ã€æœ€å°/æœ€å¤§æŠ•æ³¨é¢ã€æ‰‹ç»­è´¹ã€é€€æ°´æ¯”ä¾‹
- å¯å¯ç”¨/ç¦ç”¨æŸä¸ªç©æ³•

**é¡µé¢å¸ƒå±€ï¼š**
```vue
<template>
  <div class="bet-type-settings">
    <el-card>
      <template #header>
        <div class="card-header">
          <span>ä¸‹æ³¨ç±»å‹é…ç½®</span>
          <el-button type="primary" @click="handleSave">ä¿å­˜é…ç½®</el-button>
        </div>
      </template>

      <el-table :data="settingsList" border>
        <el-table-column prop="name" label="ç±»å‹åç§°" width="100" />
        <el-table-column label="èµ”ç‡" width="120">
          <template #default="{ row }">
            <el-input-number
              v-model="row.odds"
              :min="0"
              :precision="2"
              size="small"
            />
          </template>
        </el-table-column>
        <el-table-column label="æœ€å°æŠ•æ³¨" width="150">
          <template #default="{ row }">
            <el-input-number
              v-model="row.minBet"
              :min="0"
              :precision="2"
              size="small"
            />
          </template>
        </el-table-column>
        <el-table-column label="æœ€å¤§æŠ•æ³¨" width="150">
          <template #default="{ row }">
            <el-input-number
              v-model="row.maxBet"
              :min="0"
              :precision="2"
              size="small"
            />
          </template>
        </el-table-column>
        <el-table-column label="æ‰‹ç»­è´¹%" width="120">
          <template #default="{ row }">
            <el-input-number
              v-model="row.feeRate"
              :min="0"
              :max="100"
              :precision="2"
              size="small"
            />
          </template>
        </el-table-column>
        <el-table-column label="é€€æ°´%" width="120">
          <template #default="{ row }">
            <el-input-number
              v-model="row.rebateRate"
              :min="0"
              :max="100"
              :precision="2"
              size="small"
            />
          </template>
        </el-table-column>
        <el-table-column label="å¯ç”¨çŠ¶æ€" width="100">
          <template #default="{ row }">
            <el-switch v-model="row.isEnabled" />
          </template>
        </el-table-column>
        <el-table-column prop="description" label="è¯´æ˜" />
      </el-table>
    </el-card>
  </div>
</template>
```

### 4. API å®¢æˆ·ç«¯ â°

**æ–‡ä»¶ï¼š** `frontend-admin/src/api/settings.ts`

```typescript
// è·å–æ‰€æœ‰ä¸‹æ³¨ç±»å‹é…ç½®
export function getBetTypeSettings() {
  return request.get('/admin/bet-type-settings')
}

// æ›´æ–°æŒ‡å®šä¸‹æ³¨ç±»å‹é…ç½®
export function updateBetTypeSetting(betType: string, data: any) {
  return request.put(`/admin/bet-type-settings/${betType}`, data)
}

// æ‰¹é‡æ›´æ–°ä¸‹æ³¨ç±»å‹é…ç½®
export function batchUpdateBetTypeSettings(settings: any[]) {
  return request.post('/admin/bet-type-settings/batch', { settings })
}
```

### 5. è·¯ç”±é…ç½® â°

**æ–‡ä»¶ï¼š** `frontend-admin/src/router/index.ts`

```typescript
{
  path: '/bet-type-settings',
  name: 'BetTypeSettings',
  component: () => import('@/views/BetTypeSettings.vue'),
  meta: { title: 'æ¨¡å¼è®¾ç½®', requiresAuth: true, role: 'admin' }
}
```

### 6. ä¸‹æ³¨éªŒè¯é›†æˆ â°

**æ–‡ä»¶ï¼š** `backend/src/modules/bet/bet.service.ts`

åœ¨åˆ›å»ºä¸‹æ³¨æ—¶ï¼Œéœ€è¦éªŒè¯ï¼š

```typescript
async createBet(userId: number, createBetDto: CreateBetDto) {
  // è·å–è¯¥ä¸‹æ³¨ç±»å‹çš„é…ç½®
  const typeSetting = await this.prisma.betTypeSetting.findUnique({
    where: { betType: createBetDto.betContent }
  });

  // éªŒè¯æ˜¯å¦å¯ç”¨
  if (!typeSetting || !typeSetting.isEnabled) {
    throw new BadRequestException('è¯¥ä¸‹æ³¨ç±»å‹æš‚ä¸å¯ç”¨');
  }

  // éªŒè¯é‡‘é¢èŒƒå›´
  if (amount < typeSetting.minBet) {
    throw new BadRequestException(
      `ä¸‹æ³¨é‡‘é¢ä¸èƒ½å°‘äº${typeSetting.minBet}`
    );
  }
  if (amount > typeSetting.maxBet) {
    throw new BadRequestException(
      `ä¸‹æ³¨é‡‘é¢ä¸èƒ½è¶…è¿‡${typeSetting.maxBet}`
    );
  }

  // è®¡ç®—æ‰‹ç»­è´¹ï¼ˆä½¿ç”¨é…ç½®çš„è´¹ç‡ï¼‰
  const fee = amount * typeSetting.feeRate;

  // ç»§ç»­ä¸‹æ³¨æµç¨‹...
}
```

---

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```mermaid
graph TD
    A[ç®¡ç†å‘˜] --> B[å‰ç«¯é…ç½®é¡µé¢]
    B --> C{ä¿®æ”¹é…ç½®}
    C --> D[æ‰¹é‡æ›´æ–°API]
    D --> E[SystemService]
    E --> F[æ•°æ®åº“æ›´æ–°]
    F --> G[è®°å½•æ—¥å¿—]
    
    H[ç”¨æˆ·ä¸‹æ³¨] --> I[BetService]
    I --> J[æŸ¥è¯¢é…ç½®]
    J --> K{éªŒè¯}
    K -->|é‡‘é¢èŒƒå›´| L[æ£€æŸ¥æœ€å°/æœ€å¤§]
    K -->|å¯ç”¨çŠ¶æ€| M[æ£€æŸ¥isEnabled]
    K -->|è®¡ç®—è´¹ç”¨| N[ä½¿ç”¨feeRate]
    L & M & N --> O[åˆ›å»ºä¸‹æ³¨è®°å½•]
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬1æ­¥ï¼šæ•°æ®åº“è¿ç§»
```bash
cd score-system/backend
npx prisma migrate dev --name add_bet_type_settings
# æˆ–æ‰‹åŠ¨æ‰§è¡Œ SQL
```

### ç¬¬2æ­¥ï¼šé‡å¯åç«¯
```bash
npm run start:dev
```

### ç¬¬3æ­¥ï¼šéªŒè¯API
```bash
# æµ‹è¯•è·å–é…ç½®
curl http://localhost:3000/api/admin/bet-type-settings \
  -H "Authorization: Bearer YOUR_TOKEN"

# æµ‹è¯•æ›´æ–°é…ç½®
curl -X PUT http://localhost:3000/api/admin/bet-type-settings/single \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"minBet": 2.00, "maxBet": 5000.00}'
```

### ç¬¬4æ­¥ï¼šå‰ç«¯å¼€å‘
1. åˆ›å»º `BetTypeSettings.vue` é¡µé¢
2. æ·»åŠ è·¯ç”±é…ç½®
3. æ·»åŠ èœå•é¡¹

### ç¬¬5æ­¥ï¼šæµ‹è¯•
1. é…ç½®å„é¡¹å‚æ•°
2. å‰ç«¯ä¸‹æ³¨éªŒè¯
3. æ‰‹ç»­è´¹è®¡ç®—éªŒè¯

---

## ğŸ“ é…ç½®ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå•/åŒé…ç½®
```json
{
  "betType": "single",
  "name": "å•",
  "odds": 1.95,
  "minBet": 1.00,
  "maxBet": 4999.00,
  "feeRate": 0.00,
  "rebateRate": 0.00,
  "isEnabled": true
}
```

### ç¤ºä¾‹2ï¼šå¤§å•é…ç½®ï¼ˆé«˜èµ”ç‡ï¼‰
```json
{
  "betType": "big_single",
  "name": "å¤§å•",
  "odds": 3.80,
  "minBet": 7.00,
  "maxBet": 1000.00,
  "feeRate": 0.00,
  "rebateRate": 0.00,
  "isEnabled": true
}
```

### ç¤ºä¾‹3ï¼šå€æ•°é…ç½®ï¼ˆæœ‰æ‰‹ç»­è´¹ï¼‰
```json
{
  "betType": "multiple_2",
  "name": "å€æ•° 2å€",
  "odds": 2.00,
  "minBet": 1.00,
  "maxBet": 4999.00,
  "feeRate": 0.03,    // 3%æ‰‹ç»­è´¹
  "rebateRate": 0.00,
  "isEnabled": true
}
```

---

## âœ… éªŒæ”¶æ ‡å‡†

- [ ] æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ
- [ ] API æ¥å£æ­£å¸¸è¿”å›
- [ ] å‰ç«¯é¡µé¢å¯ä»¥æŸ¥çœ‹é…ç½®
- [ ] å‰ç«¯é¡µé¢å¯ä»¥ç¼–è¾‘é…ç½®
- [ ] ä¿å­˜åç«‹å³ç”Ÿæ•ˆ
- [ ] ä¸‹æ³¨æ—¶éªŒè¯æœ€å°/æœ€å¤§é‡‘é¢
- [ ] ä¸‹æ³¨æ—¶æ­£ç¡®è®¡ç®—æ‰‹ç»­è´¹
- [ ] å¯ä»¥å¯ç”¨/ç¦ç”¨æŸä¸ªç©æ³•
- [ ] æ“ä½œæœ‰æ—¥å¿—è®°å½•

---

**å½“å‰è¿›åº¦ï¼š** 40% å®Œæˆ

**ä¸‹ä¸€æ­¥ï¼š** å®æ–½æœåŠ¡å±‚ä»£ç å¹¶æ‰§è¡Œæ•°æ®åº“è¿ç§»

**æ›´æ–°æ—¶é—´ï¼š** 2025-11-27  
**ç‰ˆæœ¬ï¼š** v1.0  
**ä½œè€…ï¼š** AI Assistant



