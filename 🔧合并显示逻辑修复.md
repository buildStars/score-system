# ğŸ”§ åˆå¹¶æ˜¾ç¤ºé€»è¾‘ä¿®å¤

## ğŸ“ é—®é¢˜æè¿°

**å‘ç°æ—¶é—´**ï¼š2025-11-29  
**é—®é¢˜**ï¼šåˆå¹¶æ˜¾ç¤ºæ—¶åŒ…å«äº† cancelled è®°å½•ï¼Œå¯¼è‡´ `pointsBefore`ã€`pointsAfter` å’Œ `resultAmount` ä¸ä¸€è‡´

---

## âŒ æ—§é€»è¾‘çš„é—®é¢˜

### åœºæ™¯é‡ç°

ç”¨æˆ·åœ¨åŒä¸€æœŸä¸‹äº†5ç¬”æ³¨ï¼Œç„¶åå–æ¶ˆäº†4ç¬”ï¼Œåªæœ‰1ç¬”çœŸæ­£ç»“ç®—ï¼š

```
è®°å½•1 (ID 31): cancelled, pointsBefore=10177, pointsAfter=10387
è®°å½•2 (ID 32): cancelled, pointsBefore=10177, pointsAfter=10592
è®°å½•3 (ID 33): cancelled, pointsBefore=10177, pointsAfter=10387
è®°å½•4 (ID 34): cancelled, pointsBefore=10387, pointsAfter=10487
è®°å½•5 (ID 35): win,       pointsBefore=10592, pointsAfter=10689, resultAmount=97
```

### åˆå¹¶æ˜¾ç¤ºçš„ç»“æœï¼ˆæ—§é€»è¾‘ï¼‰

```json
{
  "pointsBefore": 10177,      // â† ç¬¬1æ¡è®°å½•çš„å€¼
  "pointsAfter": 10689,       // â† ç¬¬5æ¡è®°å½•çš„å€¼
  "resultAmount": 97,         // â† åªæœ‰ç¬¬5æ¡æœ‰å€¼
  "betCount": 5               // â† åŒ…å«äº†æ‰€æœ‰è®°å½•
}
```

### è®¡ç®—éªŒè¯

```
pointsAfter - pointsBefore = 10689 - 10177 = 512
resultAmount = 97

512 â‰  97  âŒ ä¸ä¸€è‡´ï¼
```

**é—®é¢˜æ ¹æº**ï¼š
- `resultAmount` åªç»Ÿè®¡äº†å·²ç»“ç®—çš„è®°å½•ï¼ˆ97ï¼‰
- ä½† `pointsBefore` å’Œ `pointsAfter` åŒ…å«äº†æ‰€æœ‰è®°å½•ï¼ˆå« cancelledï¼‰
- å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

---

## âœ… æ–°é€»è¾‘ï¼ˆå·²ä¿®å¤ï¼‰

### ä¿®å¤ç­–ç•¥

**åªåˆå¹¶å·²ç»“ç®—çš„è®°å½•ï¼ˆwin/lossï¼‰ï¼Œæ’é™¤ cancelled å’Œ pending**

### ä¿®å¤åçš„é€»è¾‘

```typescript
// ğŸ”§ ä¿®å¤ï¼šåªåˆå¹¶å·²ç»“ç®—çš„è®°å½•ï¼Œæ’é™¤ cancelled
const settledBets = bets.filter(b => b.status === 'win' || b.status === 'loss');

// å¦‚æœæ²¡æœ‰å·²ç»“ç®—çš„è®°å½•
if (settledBets.length === 0) {
  // è¿”å›ç¬¬ä¸€æ¡è®°å½•ï¼ˆå¯èƒ½æ˜¯ pending æˆ– cancelledï¼‰
  return bets[0];
}

// åªç»Ÿè®¡å·²ç»“ç®—çš„è®°å½•
const totalAmount = settledBets.reduce(...);
const totalFee = settledBets.reduce(...);
const totalResultAmount = settledBets.reduce(...);

// ä½¿ç”¨å·²ç»“ç®—è®°å½•çš„ pointsBefore å’Œ pointsAfter
const firstPointsBefore = earliestBet.pointsBefore;
const lastPointsAfter = latestSettled.pointsAfter;

return {
  pointsBefore: firstPointsBefore,
  pointsAfter: lastPointsAfter,
  resultAmount: totalResultAmount.toString(),
  betCount: settledBets.length,  // â† åªç»Ÿè®¡å·²ç»“ç®—çš„
  ...
};
```

### ä¿®å¤åçš„ç»“æœ

```json
{
  "pointsBefore": 10592,      // â† ç¬¬5æ¡ï¼ˆå”¯ä¸€å·²ç»“ç®—ï¼‰çš„å€¼
  "pointsAfter": 10689,       // â† ç¬¬5æ¡çš„å€¼
  "resultAmount": 97,         // â† ç¬¬5æ¡çš„å€¼
  "betCount": 1               // â† åªæœ‰1æ¡å·²ç»“ç®—
}
```

### è®¡ç®—éªŒè¯

```
pointsAfter - pointsBefore = 10689 - 10592 = 97
resultAmount = 97

97 = 97  âœ… ä¸€è‡´ï¼
```

---

## ğŸ”§ ä¿®æ”¹å†…å®¹

### æ–‡ä»¶ï¼š`bet.service.ts` - `mergeBetsByIssue()` æ–¹æ³•

#### 1. è¿‡æ»¤åªä¿ç•™å·²ç»“ç®—çš„è®°å½•

```typescript
// âŒ æ—§ä»£ç 
private mergeBetsByIssue(bets: any[]): any {
  if (bets.length === 0) return null;
  if (bets.length === 1) return bets[0];

  const multipleBets = bets.filter(b => b.betType === 'multiple');
  const comboBets = bets.filter(b => b.betType === 'combo');
  // ... ç›´æ¥ä½¿ç”¨æ‰€æœ‰ bets

// âœ… æ–°ä»£ç 
private mergeBetsByIssue(bets: any[]): any {
  if (bets.length === 0) return null;
  
  // ğŸ”§ ä¿®å¤ï¼šåªåˆå¹¶å·²ç»“ç®—çš„è®°å½•ï¼Œæ’é™¤ cancelled
  const settledBets = bets.filter(b => b.status === 'win' || b.status === 'loss');
  
  if (settledBets.length === 0) {
    return bets[0];  // æ²¡æœ‰å·²ç»“ç®—çš„ï¼Œè¿”å›ç¬¬ä¸€æ¡
  }
  
  if (settledBets.length === 1) return settledBets[0];

  const multipleBets = settledBets.filter(b => b.betType === 'multiple');
  const comboBets = settledBets.filter(b => b.betType === 'combo');
  // ... åªä½¿ç”¨ settledBets
```

#### 2. ä½¿ç”¨å·²ç»“ç®—è®°å½•ç»Ÿè®¡

```typescript
// âŒ æ—§ä»£ç 
const totalAmount = bets.reduce((sum, bet) => sum + Number(bet.amount), 0);
const totalFee = bets.reduce((sum, bet) => sum + Number(bet.fee), 0);

// âœ… æ–°ä»£ç 
const totalAmount = settledBets.reduce((sum, bet) => sum + Number(bet.amount), 0);
const totalFee = settledBets.reduce((sum, bet) => sum + Number(bet.fee), 0);
```

#### 3. ä½¿ç”¨å·²ç»“ç®—è®°å½•çš„ç§¯åˆ†

```typescript
// âŒ æ—§ä»£ç 
const earliestBet = bets.reduce(...);
return {
  pointsBefore: earliestBet.pointsBefore,
  pointsAfter: bets[bets.length - 1].pointsAfter,
  betCount: bets.length,
};

// âœ… æ–°ä»£ç 
const earliestBet = settledBets.reduce(...);
const latestSettled = settledBets.reduce(...);
return {
  pointsBefore: earliestBet.pointsBefore,
  pointsAfter: latestSettled.pointsAfter,
  betCount: settledBets.length,  // åªç»Ÿè®¡å·²ç»“ç®—çš„
};
```

---

## ğŸ“Š ä¸åŒåœºæ™¯çš„å¤„ç†

### åœºæ™¯1ï¼šå…¨éƒ¨å·²ç»“ç®—ï¼ˆwin/lossï¼‰

```
è®°å½•1: win,  resultAmount=50
è®°å½•2: loss, resultAmount=-30
è®°å½•3: win,  resultAmount=20

åˆå¹¶ç»“æœï¼š
- resultAmount: 40 (50 - 30 + 20)
- betCount: 3
```

### åœºæ™¯2ï¼šéƒ¨åˆ†å–æ¶ˆ

```
è®°å½•1: win,       resultAmount=50
è®°å½•2: cancelled, resultAmount=null
è®°å½•3: win,       resultAmount=20

åˆå¹¶ç»“æœï¼š
- resultAmount: 70 (50 + 20)
- betCount: 2  â† åªç»Ÿè®¡å·²ç»“ç®—çš„
```

### åœºæ™¯3ï¼šå…¨éƒ¨å–æ¶ˆ

```
è®°å½•1: cancelled, resultAmount=null
è®°å½•2: cancelled, resultAmount=null

åˆå¹¶ç»“æœï¼š
- ç›´æ¥è¿”å›ç¬¬ä¸€æ¡è®°å½•
- betCount: ä¸è¿”å›ï¼ˆè¿”å›åŸå§‹è®°å½•ï¼‰
```

### åœºæ™¯4ï¼šå…¨éƒ¨pending

```
è®°å½•1: pending, resultAmount=null
è®°å½•2: pending, resultAmount=null

åˆå¹¶ç»“æœï¼š
- ç›´æ¥è¿”å›ç¬¬ä¸€æ¡è®°å½•
- betCount: ä¸è¿”å›ï¼ˆè¿”å›åŸå§‹è®°å½•ï¼‰
```

---

## âœ… éªŒè¯æ¸…å•

### æ•°æ®ä¸€è‡´æ€§

- [x] `pointsAfter - pointsBefore = resultAmount`
- [x] `betCount` åªç»Ÿè®¡å·²ç»“ç®—çš„è®°å½•
- [x] cancelled è®°å½•ä¸å½±å“ç»Ÿè®¡
- [x] pending è®°å½•ä¸å½±å“ç»Ÿè®¡

### è¾¹ç•Œæƒ…å†µ

- [x] å…¨éƒ¨å·²ç»“ç®—ï¼šæ­£å¸¸åˆå¹¶
- [x] éƒ¨åˆ†å–æ¶ˆï¼šåªåˆå¹¶å·²ç»“ç®—çš„
- [x] å…¨éƒ¨å–æ¶ˆï¼šè¿”å›ç¬¬ä¸€æ¡
- [x] å…¨éƒ¨pendingï¼šè¿”å›ç¬¬ä¸€æ¡
- [x] å•æ¡è®°å½•ï¼šç›´æ¥è¿”å›

---

## ğŸ¯ ä¼˜ç‚¹æ€»ç»“

### 1. æ•°æ®ä¸€è‡´æ€§

- âœ… `pointsBefore + resultAmount = pointsAfter`
- âœ… æ‰€æœ‰ç»Ÿè®¡æ•°æ®åŸºäºç›¸åŒçš„è®°å½•é›†
- âœ… é¿å…æ··æ·†

### 2. é€»è¾‘æ¸…æ™°

- âœ… å·²ç»“ç®—çš„è®°å½•æ‰å‚ä¸åˆå¹¶
- âœ… cancelled/pending ä¸å½±å“ç»Ÿè®¡
- âœ… å®¹æ˜“ç†è§£å’Œç»´æŠ¤

### 3. ç”¨æˆ·ä½“éªŒ

- âœ… æ˜¾ç¤ºçš„æ•°æ®å‡†ç¡®
- âœ… ç§¯åˆ†å˜åŒ–æ¸…æ™°å¯æŸ¥
- âœ… ä¸ä¼šå‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µ

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. betCount çš„å«ä¹‰å˜åŒ–

**æ—§å«ä¹‰**ï¼šæ‰€æœ‰è®°å½•æ•°ï¼ˆåŒ…æ‹¬ cancelled/pendingï¼‰
**æ–°å«ä¹‰**ï¼šå·²ç»“ç®—çš„è®°å½•æ•°ï¼ˆåªå« win/lossï¼‰

è¿™æ˜¯ä¸€ä¸ªæ”¹è¿›ï¼Œå› ä¸ºç”¨æˆ·å…³å¿ƒçš„æ˜¯"æœ‰å¤šå°‘ç¬”çœŸæ­£ç»“ç®—äº†"ï¼Œè€Œä¸æ˜¯"æ€»å…±ä¸‹äº†å¤šå°‘ç¬”"ã€‚

### 2. å‰ç«¯æ˜¾ç¤º

å‰ç«¯ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æ•°æ®å³å¯ï¼Œæ–°é€»è¾‘ç¡®ä¿ï¼š
```
ç»“æœåˆ—æ˜¾ç¤º: resultAmount âœ…
å‰©ä½™åˆ—æ˜¾ç¤º: pointsAfter âœ…
```

éƒ½æ˜¯å‡†ç¡®çš„ã€‚

### 3. å†å²æ•°æ®

æ—§æ•°æ®å¯èƒ½ä»ç„¶å­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µï¼ˆå¦‚æœåŒ…å« cancelled è®°å½•ï¼‰ï¼Œä½†æ–°çš„æŸ¥è¯¢ä¼šè‡ªåŠ¨è¿‡æ»¤ï¼Œä¸å½±å“æ˜¾ç¤ºã€‚

---

**ä¿®å¤æ—¶é—´**ï¼š2025-11-29  
**å½±å“èŒƒå›´**ï¼šä¸‹æ³¨å†å²åˆå¹¶æ˜¾ç¤º  
**å‘ä¸‹å…¼å®¹**ï¼šâœ… æ˜¯  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

