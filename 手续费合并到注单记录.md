# 手续费合并到注单记录 ✅

## 📋 需求说明

**原需求**：下注手续费不要单独拎出来，合并到注单里面

**改动前**：
- 下注时：创建一条积分记录（扣除本金）
- 结算时：创建一条手续费记录 + 一条结算记录（分开显示）

**改动后**：
- 下注时：创建一条积分记录（扣除本金）
- 结算时：创建一条结算记录（手续费已包含在resultAmount中）

## 🔧 实现内容

### 1. 修改结算逻辑（`lottery.service.ts`）

#### 原代码（删除）
```typescript
// ❌ 记录手续费变动（单独一条）
if (fee > 0) {
  await tx.pointRecord.create({
    data: {
      userId: bet.userId,
      type: 'fee',
      amount: -fee,
      balanceBefore: currentPoints,
      balanceAfter: currentPoints - fee,
      relatedId: bet.id,
      relatedType: 'bet',
      remark: '下注手续费',
      operatorType: 'system',
    },
  });
}

// ❌ 记录结算积分变动（单独一条）
const settleAmount = resultAmount + (fee > 0 ? fee : 0);
await tx.pointRecord.create({
  data: {
    userId: bet.userId,
    type: status === 'win' ? 'win' : 'loss',
    amount: settleAmount,
    // ...
  },
});
```

#### 新代码（合并）
```typescript
// ✅ 记录结算积分变动（手续费已包含在resultAmount中）
await tx.pointRecord.create({
  data: {
    userId: bet.userId,
    type: status === 'win' ? 'win' : 'loss',
    amount: resultAmount,  // 已包含手续费扣除
    balanceBefore: currentPointsBefore,  // 下注前的积分
    balanceAfter: finalPoints,  // 向下取整后的最终积分
    relatedId: bet.id,
    relatedType: 'bet',
    remark: `期号${bet.issue}下注结算-${status === 'win' ? '中奖' : '未中'}（含手续费${fee}）`,
    operatorType: 'system',
  },
});
```

### 2. 积分记录流程

#### 下注阶段（`bet.service.ts`）
```typescript
// 1️⃣ 扣除本金
const newPoints = Math.floor(currentPoints - amount);

await tx.user.update({
  where: { id: userId },
  data: { points: newPoints },
});

// 2️⃣ 创建下注记录（只记录本金扣除）
await tx.pointRecord.create({
  data: {
    userId,
    type: 'bet',
    amount: -amount,  // 负数表示扣除
    balanceBefore: currentPoints,
    balanceAfter: newPoints,
    relatedId: bet.id,
    relatedType: 'bet',
    remark: `期号${currentIssue} ${betType === 'multiple' ? '倍数' : '组合'}下注`,
    operatorType: 'system',
  },
});
```

#### 结算阶段（`lottery.service.ts`）
```typescript
// 1️⃣ 计算结果金额（手续费已在计算中扣除）
const result = calculateMultipleBetResult(...);
const resultAmount = result.resultAmount;  // 已包含手续费扣除
const fee = result.fee;  // 手续费（仅用于显示）

// 2️⃣ 更新用户积分
const finalPoints = Math.floor(currentPoints + resultAmount);
await tx.user.update({
  where: { id: bet.userId },
  data: { points: finalPoints },
});

// 3️⃣ 创建结算记录（一条记录，手续费已包含）
await tx.pointRecord.create({
  data: {
    userId: bet.userId,
    type: status === 'win' ? 'win' : 'loss',
    amount: resultAmount,  // ✅ 已包含手续费
    balanceBefore: currentPointsBefore,
    balanceAfter: finalPoints,
    relatedId: bet.id,
    relatedType: 'bet',
    remark: `期号${bet.issue}下注结算-${status === 'win' ? '中奖' : '未中'}（含手续费${fee}）`,
    operatorType: 'system',
  },
});
```

## 📊 积分流水示例

### 示例1：倍数下注 - 回本

**用户积分**：5000

#### 下注时（期号3364710）
```
类型: bet
金额: -1000
变动前: 5000
变动后: 4000
备注: 期号3364710 倍数下注
```

#### 结算时（回本）
```
手续费计算: 1000 / 100 * 3 = 30
结算金额: 2000 - 30 = 1970
最终积分: 4000 + 1970 = 5970

类型: win
金额: +1970  ✅（已包含手续费-30）
变动前: 5000  （下注前的积分）
变动后: 5970  （最终积分）
备注: 期号3364710下注结算-中奖（含手续费30）
```

**积分流水显示**：
| 时间 | 类型 | 金额 | 余额 | 备注 |
|------|------|------|------|------|
| 15:25 | 下注 | -1000.00 | 4000 | 期号3364710 倍数下注 |
| 15:28 | 中奖 | +1970.00 | 5970 | 期号3364710下注结算-中奖（含手续费30） |

### 示例2：倍数下注 - 不回本

**用户积分**：5000

#### 下注时（期号3364711）
```
类型: bet
金额: -1000
变动前: 5000
变动后: 4000
备注: 期号3364711 倍数下注
```

#### 结算时（不回本）
```
手续费计算: 1000 / 100 * 3 = 30
损失计算: 1000 * 0.8 = 800
返还本金: 1000 - 800 = 200
结算金额: 200 - 30 = 170
最终积分: 4000 + 170 = 4170

类型: loss
金额: +170  ✅（已包含手续费-30）
变动前: 5000  （下注前的积分）
变动后: 4170  （最终积分）
备注: 期号3364711下注结算-未中（含手续费30）
```

**积分流水显示**：
| 时间 | 类型 | 金额 | 余额 | 备注 |
|------|------|------|------|------|
| 15:29 | 下注 | -1000.00 | 4000 | 期号3364711 倍数下注 |
| 15:32 | 未中 | +170.00 | 4170 | 期号3364711下注结算-未中（含手续费30） |

### 示例3：组合下注 - 中奖（回本）

**用户积分**：2000

#### 下注时（期号3364712）
```
类型: bet
金额: -100
变动前: 2000
变动后: 1900
备注: 期号3364712 组合下注
```

#### 结算时（中奖且回本）
```
手续费计算: 100 / 100 * 5 = 5
结算金额: 0 - 5 = -5（只扣手续费）
最终积分: 1900 + (-5) = 1895

类型: loss
金额: -5  ✅（只扣手续费）
变动前: 2000  （下注前的积分）
变动后: 1895  （最终积分）
备注: 期号3364712下注结算-未中（含手续费5）
```

**积分流水显示**：
| 时间 | 类型 | 金额 | 余额 | 备注 |
|------|------|------|------|------|
| 15:33 | 下注 | -100.00 | 1900 | 期号3364712 组合下注 |
| 15:36 | 未中 | -5.00 | 1895 | 期号3364712下注结算-未中（含手续费5） |

### 示例4：组合下注 - 未中奖

**用户积分**：1000

#### 下注时（期号3364713）
```
类型: bet
金额: -100
变动前: 1000
变动后: 900
备注: 期号3364713 组合下注
```

#### 结算时（未中奖）
```
手续费计算: 100 / 100 * 5 = 5
结算金额: 100 - 5 = 95（赢）
最终积分: 900 + 95 = 995

类型: win
金额: +95  ✅（已包含手续费-5）
变动前: 1000  （下注前的积分）
变动后: 995  （最终积分）
备注: 期号3364713下注结算-中奖（含手续费5）
```

**积分流水显示**：
| 时间 | 类型 | 金额 | 余额 | 备注 |
|------|------|------|------|------|
| 15:37 | 下注 | -100.00 | 900 | 期号3364713 组合下注 |
| 15:40 | 中奖 | +95.00 | 995 | 期号3364713下注结算-中奖（含手续费5） |

## 🎯 核心改动点

### 删除内容
1. ❌ 删除单独的手续费 `PointRecord` 创建逻辑
2. ❌ 删除 `type: 'fee'` 积分记录类型
3. ❌ 删除重复的结算记录创建

### 保留内容
1. ✅ 下注时创建一条 `type: 'bet'` 记录（扣除本金）
2. ✅ 结算时创建一条 `type: 'win'` 或 `'loss'` 记录（包含手续费）
3. ✅ 在备注中显示手续费金额（透明化）

### 优化内容
1. ✅ 简化积分流水记录
2. ✅ 减少数据库操作（每次结算从2-3条记录减少到1条）
3. ✅ 备注中明确显示手续费金额

## 📝 数据库影响

- **PointRecord 表**：每次下注结算只创建1条记录（原来2-3条）
- **记录类型**：只有 `bet`、`win`、`loss`、`admin_add`、`admin_deduct`
- **手续费信息**：在 `remark` 字段中显示

## 🎉 完成状态

- ✅ 删除单独的手续费记录逻辑
- ✅ 删除重复的结算记录创建
- ✅ 手续费合并到结算记录中
- ✅ 在备注中显示手续费金额
- ✅ 简化积分流水结构
- ⏳ 等待重启验证

## 📋 测试清单

### 1. 倍数下注测试
- [ ] 回本情况：积分流水只有2条（下注+结算）
- [ ] 不回本情况：积分流水只有2条（下注+结算）
- [ ] 备注显示手续费金额

### 2. 组合下注测试
- [ ] 中奖且回本：积分流水只有2条
- [ ] 中奖且不回本：积分流水只有2条
- [ ] 未中奖：积分流水只有2条
- [ ] 备注显示手续费金额

### 3. 积分余额验证
- [ ] 最终余额正确（向下取整）
- [ ] 积分流水金额正确（保留小数）
- [ ] 手续费正确扣除

---

**最后更新**: 2025-11-27
**状态**: 已完成，等待重启验证



