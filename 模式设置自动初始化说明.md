# 模式设置自动初始化说明

## ✅ 功能说明

系统已添加**自动初始化**功能，在后端启动时会自动检查并初始化下注类型设置数据。

---

## 🔄 工作原理

### 自动初始化服务

**文件位置**: `backend/src/modules/system/system-init.service.ts`

**触发时机**: 后端应用启动时（`OnModuleInit`）

**初始化逻辑**:
```typescript
1. 检查 bet_type_settings 表是否有数据
2. 如果已有数据 → 跳过初始化，输出日志
3. 如果无数据 → 自动创建 9 个默认配置
```

---

## 📦 默认配置项

启动时会自动创建以下 9 个配置：

| 模式 | 名称 | 赔率 | 最小 | 最大 | 手续费 | 说明 |
|------|------|------|------|------|--------|------|
| multiple | 倍数 | 1.95 | 100 | 100000 | 3% | 中奖获得下注金额的1.95倍 |
| big | 大 | 1.95 | 100 | 100000 | 3% | 总和≥14 |
| small | 小 | 1.95 | 100 | 100000 | 3% | 总和≤13 |
| odd | 单 | 1.95 | 100 | 100000 | 3% | 总和为单数 |
| even | 双 | 1.95 | 100 | 100000 | 3% | 总和为双数 |
| big_odd | 大单 | 1.95 | 100 | 100000 | 3% | 总和≥14且为单数 |
| big_even | 大双 | 1.95 | 100 | 100000 | 3% | 总和≥14且为双数 |
| small_odd | 小单 | 1.95 | 100 | 100000 | 3% | 总和≤13且为单数 |
| small_even | 小双 | 1.95 | 100 | 100000 | 3% | 总和≤13且为双数 |

---

## 🚀 部署流程

### 1️⃣ 首次部署（全新服务器）

```bash
# 1. 克隆代码
git clone <repository>
cd score-system

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 文件，配置数据库等

# 3. 安装依赖
cd backend
npm install

# 4. 运行数据库迁移
npx prisma migrate deploy

# 5. 启动应用（会自动初始化模式设置）
npm run start:prod
```

**启动日志示例**:
```
🔧 开始初始化下注类型设置...
✅ 下注类型设置初始化完成 (9 条)
🚀 应用启动成功！
```

---

### 2️⃣ 已有数据的服务器

如果服务器已有模式设置数据，启动时会跳过初始化：

**启动日志示例**:
```
✓ 下注类型设置已存在 (9 条)
🚀 应用启动成功！
```

---

### 3️⃣ Docker 部署

使用 Docker Compose 部署时，同样会自动初始化：

```bash
# 1. 构建并启动
docker-compose up -d

# 2. 查看日志确认初始化
docker-compose logs backend
```

---

## 🔧 手动初始化（备用方案）

如果需要手动重新初始化（比如清空数据后），可以使用以下方法：

### 方法一：重启后端服务

删除数据后重启，会自动初始化：

```bash
# 1. 连接数据库
mysql -u root -p

# 2. 清空表
TRUNCATE TABLE bet_type_settings;

# 3. 退出数据库
exit

# 4. 重启后端（会自动初始化）
pm2 restart backend
# 或
docker-compose restart backend
```

### 方法二：使用 Prisma Studio

```bash
cd backend
npx prisma studio

# 在浏览器中打开 http://localhost:5555
# 手动删除 bet_type_settings 表的所有数据
# 然后重启后端服务
```

### 方法三：临时初始化脚本

创建临时文件 `init-settings.js`:

```javascript
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

async function init() {
  await prisma.betTypeSetting.deleteMany({});
  // ... 插入默认数据（见 system-init.service.ts）
  await prisma.$disconnect();
}

init();
```

运行：
```bash
node init-settings.js
```

---

## 📊 验证初始化

### 检查数据库

```sql
-- 查看记录数
SELECT COUNT(*) FROM bet_type_settings;
-- 应该返回 9

-- 查看所有配置
SELECT bet_type, name, odds, is_enabled FROM bet_type_settings ORDER BY sort_order;
```

### 检查 API

```bash
curl http://localhost:3000/api/admin/bet-type-settings
```

应该返回 9 个配置项。

---

## ⚠️ 注意事项

1. **不会覆盖现有数据**
   - 初始化服务只在表为空时才创建数据
   - 不会修改或删除已有配置

2. **自动运行**
   - 每次后端启动都会检查
   - 无需手动干预

3. **日志记录**
   - 初始化过程会在控制台输出日志
   - 可通过日志确认是否成功

4. **生产环境**
   - Docker、PM2、Railway 等环境均支持
   - 启动时自动初始化，无需额外配置

---

## 🎯 常见问题

### Q: 首次部署后没有模式设置数据？

A: 检查后端启动日志，确认是否有初始化日志。如果没有，尝试重启后端服务。

### Q: 想修改默认配置怎么办？

A: 
1. 修改 `backend/src/modules/system/system-init.service.ts` 中的 `defaultSettings`
2. 删除数据库中的现有数据
3. 重启服务，会使用新的默认配置初始化

### Q: 部署后模式设置为空？

A: 
1. 检查数据库迁移是否成功：`npx prisma migrate status`
2. 查看后端日志确认初始化是否执行
3. 手动重启后端服务触发初始化

---

## 📝 更新日志

- **2025-11-29**: 添加自动初始化功能
- 服务器部署时无需手动初始化模式设置数据
- 系统启动时自动检查并创建默认配置

---

## 🎉 总结

✅ **自动化**: 服务器启动时自动初始化  
✅ **智能检测**: 已有数据时跳过  
✅ **零配置**: 无需手动操作  
✅ **日志友好**: 清晰的初始化日志  
✅ **环境兼容**: 支持所有部署环境  

现在部署到服务器时，模式设置会自动初始化，无需担心数据丢失！🚀


