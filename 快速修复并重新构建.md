# ğŸ”§ å¿«é€Ÿä¿®å¤å¹¶é‡æ–°æ„å»º

## é—®é¢˜æ€»ç»“

1. âœ… **å‰ç«¯ä¾èµ–å†²çª** - å·²ä¿®å¤ï¼ˆpiniaç‰ˆæœ¬é™çº§ï¼‰
2. âœ… **ç¼ºå°‘é”æ–‡ä»¶** - å·²ä¿®å¤ï¼ˆç§»é™¤frozen-lockfileè¦æ±‚ï¼‰
3. â³ **Dockeré•œåƒæ‹‰å–æ…¢** - éœ€è¦é…ç½®åŠ é€Ÿ

---

## âœ… æ‰€æœ‰é—®é¢˜å·²ä¿®å¤

### ä¿®å¤å†…å®¹ï¼š

1. **frontend-admin/package.json** - é™çº§pinia-plugin-persistedstate
   ```json
   "pinia-plugin-persistedstate": "^3.2.1"
   ```

2. **backend/Dockerfile** - ç§»é™¤frozen-lockfileé™åˆ¶
   ```dockerfile
   RUN pnpm install --no-frozen-lockfile
   ```

3. **frontend-h5/Dockerfile** - æ·»åŠ å¤‡ç”¨æ–¹æ¡ˆ
   ```dockerfile
   RUN pnpm install --no-frozen-lockfile || npm install --legacy-peer-deps
   ```

4. **frontend-admin/Dockerfile** - ä½¿ç”¨legacy-peer-deps
   ```dockerfile
   RUN npm install --legacy-peer-deps
   ```

---

## ğŸš€ ç°åœ¨é‡æ–°æ„å»º

### æ–¹æ³•1ï¼šä¸€é”®é‡æ–°æ„å»ºï¼ˆæ¨èï¼‰

```bash
# æ¸…ç†æ—§çš„
docker-compose down

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose build --no-cache
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### æ–¹æ³•2ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬

```bash
# åœæ­¢æœåŠ¡
docker-compose down

# é‡æ–°å¯åŠ¨ï¼ˆè‡ªåŠ¨æ„å»ºï¼‰
./docker-start.sh
```

---

## ğŸ“Š æ„å»ºè¿›åº¦æŸ¥çœ‹

æ„å»ºè¿‡ç¨‹ä¸­ä½ ä¼šçœ‹åˆ°ï¼š

```
[+] Building 120.5s (45/45) FINISHED
 => [mysql internal] load metadata for docker.io/library/mysql:8.0
 => [redis internal] load metadata for docker.io/library/redis:7-alpine
 => [backend internal] load metadata for docker.io/library/node:18-alpine
 => [frontend-h5 builder 1/7] FROM docker.io/library/node:18-alpine
 => [frontend-admin builder 1/6] FROM docker.io/library/node:18-alpine
 => [backend builder 5/8] RUN pnpm install --no-frozen-lockfile
 => [frontend-admin builder 4/6] RUN npm install --legacy-peer-deps
 => [frontend-h5 builder 4/7] RUN pnpm install --no-frozen-lockfile
```

---

## âš¡ å¦‚æœDockeré•œåƒæ‹‰å–å¤ªæ…¢

### ä¸´æ—¶è§£å†³ï¼šè·³è¿‡å‰ç«¯æ„å»º

åˆ›å»º `docker-compose.backend-only.yml`ï¼š

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: score-system-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-score_root_2024}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-yunce_score_system}
      MYSQL_USER: ${MYSQL_USER:-score_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-score_pass_2024}
    ports:
      - "3307:3306"
    volumes:
      - score-mysql-data:/var/lib/mysql
    networks:
      - score-network

  redis:
    image: redis:7-alpine
    container_name: score-system-redis
    restart: always
    ports:
      - "6380:6379"
    volumes:
      - score-redis-data:/data
    networks:
      - score-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: score-system-backend
    restart: always
    environment:
      DATABASE_URL: mysql://${MYSQL_USER:-score_user}:${MYSQL_PASSWORD:-score_pass_2024}@mysql:3306/${MYSQL_DATABASE:-yunce_score_system}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: 7d
      JWT_ADMIN_EXPIRES_IN: 12h
      PORT: 3000
      NODE_ENV: production
    ports:
      - "3000:3000"
    volumes:
      - ./backend:/app
      - /app/node_modules
    networks:
      - score-network
    depends_on:
      - mysql
      - redis

volumes:
  score-mysql-data:
  score-redis-data:

networks:
  score-network:
```

ä½¿ç”¨ï¼š
```bash
docker-compose -f docker-compose.backend-only.yml up -d

# æœ¬åœ°è¿è¡Œå‰ç«¯
cd frontend-h5
npm install
npm run dev

cd ../frontend-admin
npm install
npm run dev
```

---

## ğŸ¯ é¢„æœŸç»“æœ

æ„å»ºæˆåŠŸåï¼Œä½ ä¼šçœ‹åˆ°ï¼š

```bash
docker-compose ps

# è¾“å‡ºï¼š
NAME                   STATUS              PORTS
score-system-mysql     Up 2 minutes       0.0.0.0:3307->3306/tcp
score-system-redis     Up 2 minutes       0.0.0.0:6380->6379/tcp
score-system-backend   Up 2 minutes       0.0.0.0:3000->3000/tcp
score-system-h5        Up 2 minutes       0.0.0.0:5173->80/tcp
score-system-admin     Up 2 minutes       0.0.0.0:5174->80/tcp
```

è®¿é—®ï¼š
- âœ… http://localhost:3000/api-docs - APIæ–‡æ¡£
- âœ… http://localhost:5173 - H5å‰ç«¯
- âœ… http://localhost:5174 - ç®¡ç†åå°

---

## ğŸ” å¦‚æœè¿˜æ˜¯å¤±è´¥

### æŸ¥çœ‹å…·ä½“é”™è¯¯

```bash
# æŸ¥çœ‹æ„å»ºæ—¥å¿—
docker-compose build 2>&1 | tee build.log

# æŸ¥çœ‹å…·ä½“æœåŠ¡çš„æ„å»º
docker-compose build backend --progress=plain
docker-compose build frontend-h5 --progress=plain
docker-compose build frontend-admin --progress=plain
```

### é€ä¸ªæœåŠ¡æ„å»º

```bash
# å…ˆæ„å»ºæ•°æ®åº“ï¼ˆæœ€ç®€å•ï¼‰
docker-compose up -d mysql redis

# ç­‰å¾…å¯åŠ¨
sleep 10

# æ„å»ºåç«¯
docker-compose build backend
docker-compose up -d backend

# æŸ¥çœ‹åç«¯æ—¥å¿—
docker-compose logs -f backend

# å¦‚æœåç«¯æˆåŠŸï¼Œå†æ„å»ºå‰ç«¯
docker-compose build frontend-h5 frontend-admin
docker-compose up -d frontend-h5 frontend-admin
```

---

## ğŸŒŸ æ¨èæ–¹æ¡ˆï¼šæ··åˆéƒ¨ç½²

**Dockerè¿è¡Œæ•°æ®åº“ï¼Œæœ¬åœ°è¿è¡Œä»£ç ï¼ˆæœ€å¿«é€Ÿï¼‰**

### 1. å¯åŠ¨æ•°æ®åº“

```bash
docker-compose up -d mysql redis
```

### 2. æœ¬åœ°è¿è¡Œåç«¯

```bash
cd backend

# é…ç½®æœ¬åœ°.env
cat > .env << 'EOF'
DATABASE_URL="mysql://score_user:score_pass_2024@localhost:3307/yunce_score_system"
REDIS_HOST="localhost"
REDIS_PORT=6380
JWT_SECRET="your-jwt-secret-here"
JWT_EXPIRES_IN="7d"
JWT_ADMIN_EXPIRES_IN="12h"
PORT=3000
NODE_ENV="development"
EOF

# å®‰è£…å¹¶å¯åŠ¨
pnpm install
npx prisma generate
npx prisma migrate dev
npx prisma db seed
pnpm start:dev
```

### 3. æœ¬åœ°è¿è¡Œå‰ç«¯

```bash
# H5å‰ç«¯
cd frontend-h5
npm install
npm run dev
# è®¿é—® http://localhost:5173

# ç®¡ç†åå°
cd frontend-admin  
npm install
npm run dev
# è®¿é—® http://localhost:5174
```

---

## âœ… éªŒè¯æ„å»ºæˆåŠŸ

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker-compose ps

# æ£€æŸ¥æ—¥å¿—ï¼ˆæ— é”™è¯¯ï¼‰
docker-compose logs --tail=50

# æµ‹è¯•åç«¯API
curl http://localhost:3000/api-docs

# æµ‹è¯•MySQLè¿æ¥
docker exec -it score-system-mysql mysql -uscore_user -p -e "SHOW DATABASES;"
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°å…¶ä»–é—®é¢˜ï¼š

1. æŸ¥çœ‹å®Œæ•´æ—¥å¿—ï¼š`docker-compose logs -f > full.log`
2. æ£€æŸ¥Dockerç‰ˆæœ¬ï¼š`docker --version`
3. æ£€æŸ¥DockerçŠ¶æ€ï¼š`docker info`
4. æ¸…ç†å¹¶é‡è¯•ï¼š`docker system prune -a && docker-compose build --no-cache`

---

**ğŸ‰ ä¿®å¤å®Œæˆï¼ç°åœ¨æ‰§è¡Œï¼š**

```bash
docker-compose build --no-cache
docker-compose up -d
```

**æˆ–è€…ä½¿ç”¨æ··åˆéƒ¨ç½²æ–¹æ¡ˆæ›´å¿«ï¼**

---

**æ›´æ–°æ—¥æœŸ**ï¼š2024å¹´11æœˆ26æ—¥  
**çŠ¶æ€**ï¼šâœ… æ‰€æœ‰æ„å»ºé”™è¯¯å·²ä¿®å¤



