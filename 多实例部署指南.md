# 🚀 多实例部署指南

在同一台服务器上部署多套独立的云策28计分系统实例。

---

## 📋 目录

- [应用场景](#应用场景)
- [架构说明](#架构说明)
- [快速部署](#快速部署)
- [手动部署](#手动部署)
- [管理实例](#管理实例)
- [常见问题](#常见问题)

---

## 应用场景

### 为什么需要多实例？

1. **多租户系统**: 为不同的客户部署独立的系统实例
2. **测试环境**: 生产环境 + 测试环境，互不影响
3. **版本隔离**: 同时运行新旧版本，灰度发布
4. **业务隔离**: 不同业务线使用独立实例

### 实例间隔离

✅ **完全隔离**:
- 独立的数据库
- 独立的Redis
- 独立的Docker网络
- 独立的数据卷
- 不同的端口

---

## 架构说明

### 单服务器多实例架构

```
服务器 (IP: xxx.xxx.xxx.xxx)
│
├── 实例1 (默认)
│   ├── MySQL:     3307
│   ├── Redis:     6380  
│   ├── Backend:   3000
│   ├── H5:        5173
│   └── Admin:     5174
│
├── 实例2 (客户A)
│   ├── MySQL:     3308
│   ├── Redis:     6381
│   ├── Backend:   3001
│   ├── H5:        5175
│   └── Admin:     5176
│
└── 实例3 (测试环境)
    ├── MySQL:     3309
    ├── Redis:     6382
    ├── Backend:   3002
    ├── H5:        5177
    └── Admin:     5178
```

### 端口分配规则

| 实例 | MySQL | Redis | Backend | H5 | Admin |
|------|-------|-------|---------|-----|-------|
| 默认 | 3307 | 6380 | 3000 | 5173 | 5174 |
| 实例2 | 3308 | 6381 | 3001 | 5175 | 5176 |
| 实例3 | 3309 | 6382 | 3002 | 5177 | 5178 |
| 实例N | 3307+N | 6380+N | 3000+N | 5173+(N-1)*2 | 5174+(N-1)*2 |

---

## 快速部署

### 方式一：使用自动化脚本（推荐）

#### 1. 创建新实例

```bash
# 在项目根目录下
cd /root/score-system

# 创建实例2（客户A）
./create-instance.sh instance2 "客户A系统"

# 创建实例3（测试环境）
./create-instance.sh instance3 "测试环境"
```

脚本会自动：
- ✅ 复制项目代码到新目录
- ✅ 生成独立的配置文件
- ✅ 分配端口号
- ✅ 启动Docker容器
- ✅ 初始化数据库

#### 2. 访问新实例

```bash
# 查看实例信息
./create-instance.sh instance2 info

# 输出示例：
# 
# 实例：instance2 (客户A系统)
# 位置：/root/score-system-instance2
# 
# 访问地址：
# - H5用户端: http://your-server:5175
# - 管理后台: http://your-server:5176
# - API文档:  http://your-server:3001/api-docs
# 
# 数据库：
# - MySQL: localhost:3308
# - Redis: localhost:6381
```

---

## 手动部署

### 步骤1: 复制项目代码

```bash
# 假设原项目在 /root/score-system
cd /root

# 复制项目到新目录（实例2）
cp -r score-system score-system-instance2
cd score-system-instance2
```

### 步骤2: 修改配置文件

#### 创建 `.env` 文件

```bash
cat > .env << 'EOF'
# ============================================
# 实例2配置 - 客户A系统
# ============================================

# ===== 实例标识 =====
INSTANCE_NAME=instance2
INSTANCE_LABEL=客户A系统

# ===== 端口配置 =====
MYSQL_PORT=3308
REDIS_PORT=6381
BACKEND_PORT=3001
H5_PORT=5175
ADMIN_PORT=5176

# ===== 数据库配置 =====
MYSQL_ROOT_PASSWORD=strong_password_instance2_2024
MYSQL_DATABASE=score_system_instance2
MYSQL_USER=score_user_2
MYSQL_PASSWORD=strong_db_pass_instance2_2024

# ===== Redis配置 =====
REDIS_PASSWORD=

# ===== JWT配置 =====
JWT_SECRET=random-secret-key-instance2-change-this-32chars
JWT_EXPIRES_IN=7d
JWT_ADMIN_EXPIRES_IN=12h

# ===== 应用配置 =====
NODE_ENV=production
TZ=Asia/Shanghai

# ===== 容器名称前缀 =====
COMPOSE_PROJECT_NAME=score-instance2
EOF
```

#### 修改 `docker-compose.yml`

编辑 `docker-compose.yml`，修改容器名和数据卷名：

```yaml
services:
  mysql:
    container_name: score-instance2-mysql  # 修改
    volumes:
      - score-instance2-mysql-data:/var/lib/mysql  # 修改
    networks:
      - score-instance2-network  # 修改

  redis:
    container_name: score-instance2-redis  # 修改
    volumes:
      - score-instance2-redis-data:/data  # 修改
    networks:
      - score-instance2-network  # 修改

  backend:
    container_name: score-instance2-backend  # 修改
    volumes:
      - instance2-backend-logs:/app/logs  # 修改
    networks:
      - score-instance2-network  # 修改

  frontend-h5:
    container_name: score-instance2-h5  # 修改
    networks:
      - score-instance2-network  # 修改

  frontend-admin:
    container_name: score-instance2-admin  # 修改
    networks:
      - score-instance2-network  # 修改

volumes:
  score-instance2-mysql-data:
    name: score-instance2-mysql-data
  score-instance2-redis-data:
    name: score-instance2-redis-data
  instance2-backend-logs:
    name: score-instance2-backend-logs

networks:
  score-instance2-network:
    name: score-instance2-network
    driver: bridge
```

### 步骤3: 启动新实例

```bash
# 构建并启动
docker-compose up -d

# 查看状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 步骤4: 初始化数据库

```bash
# 进入后端容器
docker exec -it score-instance2-backend sh

# 运行数据库迁移
npx prisma migrate deploy

# 初始化种子数据
npx prisma db seed

# 修复Decimal字段
mysql -h mysql -u score_user_2 -p score_system_instance2 << 'SQL'
ALTER TABLE bets MODIFY COLUMN fee DECIMAL(10,2) NOT NULL DEFAULT 0.00;
ALTER TABLE bets MODIFY COLUMN result_amount DECIMAL(10,2) NULL DEFAULT NULL;
SQL

# 退出容器
exit
```

### 步骤5: 验证部署

```bash
# 测试API
curl http://localhost:3001/api-docs

# 测试H5
curl http://localhost:5175

# 测试管理端
curl http://localhost:5176
```

---

## 管理实例

### 查看所有实例

```bash
# 列出所有Docker Compose项目
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep score

# 输出示例：
# score-system-backend    Up 2 hours   0.0.0.0:3000->3000/tcp
# score-system-h5         Up 2 hours   0.0.0.0:5173->80/tcp
# score-instance2-backend Up 1 hour    0.0.0.0:3001->3000/tcp
# score-instance2-h5      Up 1 hour    0.0.0.0:5175->80/tcp
```

### 操作特定实例

```bash
# 进入实例目录
cd /root/score-system-instance2

# 查看日志
docker-compose logs -f backend

# 重启服务
docker-compose restart backend

# 停止实例
docker-compose down

# 启动实例
docker-compose up -d

# 更新代码并重新部署
git pull  # 如果使用Git
docker-compose down
docker-compose build
docker-compose up -d
```

### 备份实例数据

```bash
# 备份MySQL数据
docker exec score-instance2-mysql mysqldump \
  -u root -p'password' \
  score_system_instance2 \
  > backup_instance2_$(date +%Y%m%d).sql

# 备份Redis数据
docker exec score-instance2-redis redis-cli SAVE
docker cp score-instance2-redis:/data/dump.rdb backup_redis_instance2.rdb
```

### 删除实例

```bash
cd /root/score-system-instance2

# ⚠️ 警告：这会删除所有数据！
docker-compose down -v

# 删除项目目录
cd /root
rm -rf score-system-instance2
```

---

## Nginx统一代理（可选）

### 为什么需要Nginx？

- 使用域名访问，而不是端口
- SSL/HTTPS支持
- 统一入口管理

### 配置示例

```nginx
# /etc/nginx/sites-available/score-instances

# 实例1 - 默认
server {
    listen 80;
    server_name score.example.com;

    # H5前端
    location / {
        proxy_pass http://localhost:5173;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # API
    location /api {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 管理后台
server {
    listen 80;
    server_name admin.score.example.com;

    location / {
        proxy_pass http://localhost:5174;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 实例2 - 客户A
server {
    listen 80;
    server_name clienta.score.example.com;

    location / {
        proxy_pass http://localhost:5175;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

server {
    listen 80;
    server_name admin.clienta.score.example.com;

    location / {
        proxy_pass http://localhost:5176;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

启用配置：

```bash
ln -s /etc/nginx/sites-available/score-instances /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx
```

---

## 资源监控

### 查看资源占用

```bash
# 查看所有容器资源占用
docker stats

# 查看特定实例
docker stats score-instance2-backend score-instance2-mysql

# 查看磁盘占用
docker system df -v
```

### 资源限制

如果服务器资源有限，可以限制每个实例的资源：

```yaml
# docker-compose.yml
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
```

---

## 常见问题

### Q: 端口冲突怎么办？

**A**: 检查端口占用并修改配置

```bash
# 查看端口占用
netstat -tlnp | grep :3001
lsof -i :3001

# 修改 .env 中的端口配置
BACKEND_PORT=3002  # 改为其他端口
```

### Q: 不同实例数据库能否共用？

**A**: 不推荐！虽然技术上可行（使用不同的数据库名），但：
- ❌ 数据隔离性差
- ❌ 互相影响性能
- ❌ 备份恢复困难

建议每个实例独立的MySQL容器。

### Q: 如何在实例间迁移数据？

**A**: 使用数据库导入导出

```bash
# 从实例1导出
docker exec score-system-mysql mysqldump \
  -u root -p'password' \
  score_system > data.sql

# 导入到实例2
docker exec -i score-instance2-mysql mysql \
  -u root -p'password' \
  score_system_instance2 < data.sql
```

### Q: 如何批量更新所有实例？

**A**: 创建批量更新脚本

```bash
#!/bin/bash
# update-all-instances.sh

INSTANCES=(
    "/root/score-system"
    "/root/score-system-instance2"
    "/root/score-system-instance3"
)

for instance in "${INSTANCES[@]}"; do
    echo "更新 $instance ..."
    cd "$instance"
    
    # 拉取代码（如果使用Git）
    git pull
    
    # 重新构建
    docker-compose build
    
    # 重启服务
    docker-compose down
    docker-compose up -d
    
    echo "✅ $instance 更新完成"
done
```

### Q: 内存不足怎么办？

**A**: 优化资源配置

1. **限制容器资源**（见上面的资源限制）
2. **使用外部数据库**：多个实例共用一个MySQL服务器（不同数据库）
3. **增加Swap空间**：
```bash
# 创建4GB swap
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

---

## 性能优化建议

### 1. 数据库优化

```ini
# 在 docker-compose.yml 中添加MySQL配置
command: >
  --default-authentication-plugin=mysql_native_password
  --character-set-server=utf8mb4
  --collation-server=utf8mb4_unicode_ci
  --max-connections=200
  --innodb-buffer-pool-size=512M
  --innodb-log-file-size=128M
```

### 2. Redis持久化

```yaml
# docker-compose.yml
redis:
  command: >
    redis-server
    --appendonly yes
    --maxmemory 256mb
    --maxmemory-policy allkeys-lru
```

### 3. 日志管理

```yaml
# docker-compose.yml
services:
  backend:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

---

## 安全建议

1. **修改默认密码**: 每个实例使用不同的强密码
2. **防火墙配置**: 只开放必要的端口
3. **定期备份**: 每天自动备份数据库
4. **监控告警**: 使用监控工具（Prometheus + Grafana）
5. **日志审计**: 记录所有管理操作

---

## 总结

### 部署清单

- [ ] 复制项目代码到新目录
- [ ] 创建独立的 .env 配置文件
- [ ] 修改 docker-compose.yml（容器名、数据卷、网络）
- [ ] 分配不同的端口号
- [ ] 启动Docker容器
- [ ] 初始化数据库
- [ ] 修复Decimal字段
- [ ] 测试访问
- [ ] 配置Nginx（可选）
- [ ] 设置监控和备份

### 推荐配置

- **小型服务器** (2核4G): 最多2-3个实例
- **中型服务器** (4核8G): 最多4-6个实例
- **大型服务器** (8核16G): 6个以上实例

---

**最后更新**: 2025-11-30





