# 倍数下注规则修正和实现 ✅

## 📋 正确的业务规则

### 回本 = 用户赚钱 💰

```
最终积分 = 原积分 + 下注金额 - 手续费
```

**意思**：回本时，用户**赚**下注金额（扣手续费后净赚）

**例子**：
```
原积分：5000
下注：1000
手续费：30（1000/100×3）

开奖回本：5000 + 1000 - 30 = 5970
盈亏：+970（赚下注金额扣手续费）
```

---

### 不回本 = 用户输钱 💸

```
最终积分 = 原积分 - 下注金额×0.8 - 手续费
```

**意思**：不回本时，用户**输**80%本金+手续费

**例子**：
```
原积分：5000
下注：1000
损失：800（1000×0.8）
手续费：30

开奖不回本：5000 - 800 - 30 = 4170
盈亏：-830（输80%本金+手续费）
```

---

## 🎲 回本判定规则

### 四种回本情况

1. **对子**：三个号码中有两个相同
   - 例子：`3+3+7`, `5+8+5`, `9+2+9`

2. **豹子**：三个号码完全相同
   - 例子：`8+8+8`, `3+3+3`, `0+0+0`

3. **顺子**：三个号码连续（任意排列）
   - 例子：`6+8+9`, `0+8+9`, `0+1+9`
   - **特别**：`089`, `019` 也算顺子（任意排列）

4. **总和13或14**：三个号码相加=13或14
   - 例子：`3+3+7=13`, `3+3+8=14`

### 判定代码

```typescript
function isReturn(n1: number, n2: number, n3: number, sum: number): boolean {
  // 1. 检查对子或豹子
  if (n1 === n2 || n1 === n3 || n2 === n3) {
    return true;
  }
  
  // 2. 检查顺子（任意排列）
  const sorted = [n1, n2, n3].sort((a, b) => a - b);
  if (sorted[1] === sorted[0] + 1 && sorted[2] === sorted[1] + 1) {
    return true; // 连续
  }
  if (sorted[0] === 0 && sorted[1] === 1 && sorted[2] === 9) {
    return true; // 089特殊顺子
  }
  if (sorted[0] === 0 && sorted[1] === 8 && sorted[2] === 9) {
    return true; // 089特殊顺子
  }
  
  // 3. 检查总和13或14
  if (sum === 13 || sum === 14) {
    return true;
  }
  
  return false;
}
```

---

## 🔢 完整例子

### 例子1：回本（5000分 → 5970分）

```
用户账户：5000分
下注倍数：1000
开奖结果：3+3+7 = 13

判定：对子 + 总和13 → 回本 ✅

计算：
公式：5000 + 1000 - 30 = 5970

详细过程：
1. 下注时扣除：5000 - 1000 = 4000
2. 手续费：1000 / 100 × 3 = 30
3. 开奖回本：返还2倍
   4000 + 1000（本金）+ 1000（赢的）= 6000
4. 扣手续费：6000 - 30 = 5970

最终积分：5970
盈亏：+970
```

---

### 例子2：回本（2000分 → 3940分）

```
用户账户：2000分
下注倍数：2000
开奖结果：6+8+9 = 23

判定：顺子 → 回本 ✅

计算：
公式：2000 + 2000 - 60 = 3940

详细过程：
1. 下注时扣除：2000 - 2000 = 0
2. 手续费：2000 / 100 × 3 = 60
3. 开奖回本：返还2倍
   0 + 2000（本金）+ 2000（赢的）= 4000
4. 扣手续费：4000 - 60 = 3940

最终积分：3940
盈亏：+1940
```

---

### 例子3：不回本（5000分 → 4170分）

```
用户账户：5000分
下注倍数：1000
开奖结果：5+3+8 = 16

判定：不回本 ❌
- 无对子/豹子
- 不是顺子
- 总和16≠13且≠14

计算：
公式：5000 - 1000×0.8 - 30 = 4170

详细过程：
1. 下注时扣除：5000 - 1000 = 4000
2. 损失金额：1000 × 0.8 = 800
3. 手续费：1000 / 100 × 3 = 30
4. 返还剩余：4000 + 200（20%本金）= 4200
5. 扣手续费：4200 - 30 = 4170

最终积分：4170
盈亏：-830
```

---

### 例子4：不回本（2000分 → 340分）

```
用户账户：2000分
下注倍数：2000
开奖结果：1+2+5 = 8

判定：不回本 ❌

计算：
公式：2000 - 2000×0.8 - 60 = 340

详细过程：
1. 下注时扣除：2000 - 2000 = 0
2. 损失金额：2000 × 0.8 = 1600
3. 手续费：2000 / 100 × 3 = 60
4. 返还剩余：0 + 400（20%本金）= 400
5. 扣手续费：400 - 60 = 340

最终积分：340
盈亏：-1660
```

---

## 💻 前端H5改进建议

### 当前问题

前端H5只有简单的金额输入框，没有真正的"倍数选择"功能。

### 改进方案1：保持当前（推荐）

**说明**：保持当前的金额输入方式，只改文案

```vue
<van-field
  v-model="multipleBet.amount"
  type="digit"
  label="下注金额"  <!-- 改为"下注金额"而不是"下注倍数" -->
  placeholder="请输入下注金额"
  :disabled="!lotteryStore.gameEnabled"
/>
```

**优点**：
- 简单直接
- 用户可以输入任意金额
- 不需要额外配置

---

### 改进方案2：真正的倍数选择

**说明**：添加倍数选择器，每倍对应固定金额

```vue
<!-- 倍数选择器 -->
<div class="multiplier-selector">
  <van-stepper
    v-model="multipleBet.multiplier"
    :min="1"
    :max="100"
    :disabled="!lotteryStore.gameEnabled"
  />
  <span class="multiplier-label">倍</span>
</div>

<!-- 显示总金额 -->
<div class="amount-display">
  <span class="label">下注金额：</span>
  <span class="value">{{ calculateAmount() }}</span>
</div>
```

```typescript
// 配置
const AMOUNT_PER_MULTIPLIER = 100; // 每倍100分

// 计算总金额
const calculateAmount = () => {
  return multipleBet.multiplier * AMOUNT_PER_MULTIPLIER;
};
```

**优点**：
- 更符合"倍数"的概念
- 可以限制最小/最大倍数
- 便于设置标准化金额

**缺点**：
- 需要额外配置每倍金额
- 不够灵活

---

### 改进方案3：倍数+金额混合

**说明**：既可以选倍数，也可以直接输入金额

```vue
<van-tabs v-model="multipleBet.inputType">
  <!-- 方式1：选择倍数 -->
  <van-tab title="选择倍数" name="multiplier">
    <van-stepper v-model="multipleBet.multiplier" />
    <div class="amount-hint">
      金额：{{ multipleBet.multiplier * 100 }}
    </div>
  </van-tab>
  
  <!-- 方式2：直接输入金额 -->
  <van-tab title="输入金额" name="amount">
    <van-field
      v-model="multipleBet.amount"
      type="digit"
      placeholder="请输入金额"
    />
  </van-tab>
</van-tabs>
```

**优点**：
- 灵活，满足不同用户需求
- 既有标准化倍数，也有自定义金额

**缺点**：
- UI复杂
- 可能让用户困惑

---

## 📊 后端代码检查

### 需要确认的逻辑

1. ✅ 回本判定是否正确
2. ✅ 回本时的积分计算：`+本金 - 手续费`
3. ✅ 不回本时的积分计算：`-本金×0.8 - 手续费`

### 结算代码示例

```typescript
// 倍数下注结算
function settleMultipleBet(
  userId: number,
  betAmount: number,
  isReturn: boolean
): {
  finalPoints: number;
  pointChange: number;
  fee: number;
} {
  // 获取用户当前积分
  const currentPoints = await getUserPoints(userId);
  
  // 计算手续费
  const fee = (betAmount / 100) * 3;
  
  let pointChange: number;
  let finalPoints: number;
  
  if (isReturn) {
    // 回本：用户赚下注金额（扣手续费）
    pointChange = betAmount - fee;
    finalPoints = currentPoints + betAmount - fee;
  } else {
    // 不回本：用户输80%本金+手续费
    const loss = betAmount * 0.8;
    pointChange = -(loss + fee);
    finalPoints = currentPoints - loss - fee;
  }
  
  return {
    finalPoints,
    pointChange,
    fee
  };
}
```

---

## ✅ 实施步骤

### 1. 更新业务规则文档

- [x] 修正倍数下注的回本规则
- [x] 更新所有例子

### 2. 检查后端代码

- [ ] 检查 `bet.service.ts` 的结算逻辑
- [ ] 确认回本判定函数
- [ ] 确认积分计算公式

### 3. 更新前端H5

- [ ] 选择UI方案（推荐方案1：保持当前）
- [ ] 更新文案（"下注倍数" → "下注金额"）
- [ ] 测试下注流程

### 4. 测试验证

- [ ] 测试回本情况
- [ ] 测试不回本情况
- [ ] 验证手续费计算
- [ ] 验证积分变动

---

## 🎉 总结

### 核心规则（已确认）

✅ **回本**：用户赚下注金额（扣手续费）  
✅ **不回本**：用户输80%本金+手续费  
✅ **手续费**：每100为3，必扣

### 回本判定（已确认）

✅ 对子/豹子  
✅ 顺子（含089、019）  
✅ 总和13或14

### 前端建议（待确认）

**推荐**：保持当前的金额输入方式，只改文案

**原因**：
- 简单直接
- 用户可输入任意金额
- 无需额外配置

---

**规则已修正，现在符合你提供的所有例子！** ✅



