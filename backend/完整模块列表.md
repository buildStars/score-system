# ğŸ¯ åç«¯å®Œæ•´æ¨¡å—å®ç°åˆ—è¡¨

## âœ… å·²å®Œæˆçš„æ¨¡å—

### 1. åŸºç¡€è®¾æ–½
- [x] Prismaæ•°æ®åº“æ¨¡å—
- [x] å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
- [x] å“åº”æ‹¦æˆªå™¨
- [x] JWTè®¤è¯å®ˆå«
- [x] è§’è‰²å®ˆå«
- [x] å…¬å…±è£…é¥°å™¨ï¼ˆ@CurrentUser, @Roles, @Publicï¼‰

### 2. è®¤è¯æ¨¡å— (Auth Module)
- [x] JWTç­–ç•¥
- [x] ç”¨æˆ·ç™»å½•
- [x] ç®¡ç†å‘˜ç™»å½•
- [x] Tokenç”Ÿæˆä¸éªŒè¯

### 3. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- [x] å¼€å¥–è§„åˆ™å·¥å…·ç±» (lottery-rules.util.ts)
  - å›æœ¬åˆ¤å®šé€»è¾‘
  - é¡ºå­åˆ¤å®šé€»è¾‘
  - å¤§å°å•åŒè®¡ç®—
  - å€æ•°ä¸‹æ³¨ç»“ç®—
  - ç»„åˆä¸‹æ³¨ç»“ç®—

## ğŸ“ éœ€è¦åˆ›å»ºçš„æ¨¡å—

ç”±äºé¡¹ç›®è§„æ¨¡è¾ƒå¤§ï¼Œä»¥ä¸‹æ¨¡å—ä»£ç é‡å¾ˆå¤§ã€‚æˆ‘å·²ç»åˆ›å»ºäº†æ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘å·¥å…·ç±»ã€‚

å‰©ä½™æ¨¡å—å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºåˆ›å»ºï¼š

### 1. ç”¨æˆ·æ¨¡å— (User Module)
**æ–‡ä»¶**ï¼š
- `src/modules/user/user.module.ts`
- `src/modules/user/user.controller.ts`
- `src/modules/user/user.service.ts`
- `src/modules/user/dto/change-password.dto.ts`
- `src/modules/user/dto/create-user.dto.ts`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```typescript
// user.service.ts æ ¸å¿ƒæ–¹æ³•
class UserService {
  // è·å–ç”¨æˆ·ä¿¡æ¯
  async getUserInfo(userId: number): Promise<UserInfo>
  
  // ä¿®æ”¹å¯†ç 
  async changePassword(userId: number, oldPassword: string, newPassword: string)
  
  // åˆ›å»ºç”¨æˆ·ï¼ˆç®¡ç†å‘˜ï¼‰
  async createUser(createUserDto: CreateUserDto)
  
  // è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰
  async getUserList(page: number, limit: number, filters: any)
  
  // è°ƒæ•´ç”¨æˆ·ç§¯åˆ†ï¼ˆç®¡ç†å‘˜ï¼‰
  async adjustUserPoints(userId: number, amount: number, adminId: number, remark: string)
  
  // é‡ç½®ç”¨æˆ·å¯†ç ï¼ˆç®¡ç†å‘˜ï¼‰
  async resetUserPassword(userId: number, newPassword: string)
  
  // ç¦ç”¨/å¯ç”¨ç”¨æˆ·ï¼ˆç®¡ç†å‘˜ï¼‰
  async updateUserStatus(userId: number, status: number)
}
```

### 2. ä¸‹æ³¨æ¨¡å— (Bet Module)
**æ–‡ä»¶**ï¼š
- `src/modules/bet/bet.module.ts`
- `src/modules/bet/bet.controller.ts`
- `src/modules/bet/bet.service.ts`
- `src/modules/bet/dto/create-bet.dto.ts`
- `src/modules/bet/dto/query-bet.dto.ts`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```typescript
// bet.service.ts æ ¸å¿ƒæ–¹æ³•
class BetService {
  // æäº¤ä¸‹æ³¨
  async createBet(userId: number, createBetDto: CreateBetDto): Promise<Bet> {
    // 1. éªŒè¯æ¸¸æˆæ˜¯å¦å¼€å¯
    // 2. éªŒè¯ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
    // 3. éªŒè¯ä¸‹æ³¨é‡‘é¢èŒƒå›´
    // 4. éªŒè¯å•æœŸä¸‹æ³¨æ¬¡æ•°
    // 5. è·å–æ‰‹ç»­è´¹è®¾ç½®
    // 6. è®¡ç®—æ‰‹ç»­è´¹
    // 7. æ‰£é™¤ç§¯åˆ†
    // 8. åˆ›å»ºä¸‹æ³¨è®°å½•
    // 9. è®°å½•ç§¯åˆ†å˜åŠ¨
  }
  
  // è·å–ç”¨æˆ·ä¸‹æ³¨å†å²
  async getUserBetHistory(userId: number, query: QueryBetDto)
  
  // è·å–æ‰€æœ‰ä¸‹æ³¨è®°å½•ï¼ˆç®¡ç†å‘˜ï¼‰
  async getAllBets(query: QueryBetDto)
  
  // ç»“ç®—ä¸‹æ³¨ï¼ˆå†…éƒ¨æ–¹æ³•ï¼‰
  async settleBet(betId: bigint, lotteryResult: LotteryResult)
}
```

### 3. å¼€å¥–æ¨¡å— (Lottery Module)
**æ–‡ä»¶**ï¼š
- `src/modules/lottery/lottery.module.ts`
- `src/modules/lottery/lottery.controller.ts`
- `src/modules/lottery/lottery.service.ts`
- `src/modules/lottery/lottery.processor.ts` (BullMQé˜Ÿåˆ—)

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```typescript
// lottery.service.ts æ ¸å¿ƒæ–¹æ³•
class LotteryService {
  // åŒæ­¥å¼€å¥–æ•°æ®ï¼ˆä»æ—§ç³»ç»Ÿï¼‰
  async syncLotteryData(): Promise<LotteryResult> {
    // 1. ä»æ—§ç³»ç»ŸAPIè·å–æœ€æ–°å¼€å¥–
    // 2. è§£æå¼€å¥–å·ç 
    // 3. è®¡ç®—æ€»å’Œ
    // 4. åˆ¤å®šæ˜¯å¦å›æœ¬
    // 5. è®¡ç®—å¤§å°å•åŒ
    // 6. ä¿å­˜åˆ°æ•°æ®åº“
    // 7. è§¦å‘è‡ªåŠ¨ç»“ç®—
  }
  
  // è·å–å½“å‰æœŸå·ä¿¡æ¯
  async getCurrentIssue()
  
  // è·å–å¼€å¥–å†å²
  async getLotteryHistory(page: number, limit: number)
  
  // è‡ªåŠ¨ç»“ç®—æŒ‡å®šæœŸå·
  async autoSettle(issue: string) {
    // 1. è·å–å¼€å¥–ç»“æœ
    // 2. æŸ¥è¯¢è¯¥æœŸæ‰€æœ‰å¾…ç»“ç®—çš„ä¸‹æ³¨
    // 3. é€æ¡ç»“ç®—
    // 4. æ›´æ–°ç”¨æˆ·ç§¯åˆ†
    // 5. è®°å½•ç§¯åˆ†å˜åŠ¨
  }
}
```

### 4. ç§¯åˆ†æ¨¡å— (Point Module)
**æ–‡ä»¶**ï¼š
- `src/modules/point/point.module.ts`
- `src/modules/point/point.controller.ts`
- `src/modules/point/point.service.ts`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```typescript
// point.service.ts æ ¸å¿ƒæ–¹æ³•
class PointService {
  // è·å–ç”¨æˆ·ç§¯åˆ†è®°å½•
  async getUserPointRecords(userId: number, query: QueryDto)
  
  // è·å–æ‰€æœ‰ç§¯åˆ†è®°å½•ï¼ˆç®¡ç†å‘˜ï¼‰
  async getAllPointRecords(query: QueryDto)
  
  // åˆ›å»ºç§¯åˆ†è®°å½•ï¼ˆå†…éƒ¨æ–¹æ³•ï¼‰
  async createPointRecord(data: CreatePointRecordDto)
}
```

### 5. ç³»ç»Ÿæ¨¡å— (System Module)
**æ–‡ä»¶**ï¼š
- `src/modules/system/system.module.ts`
- `src/modules/system/system.controller.ts`
- `src/modules/system/system.service.ts`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```typescript
// system.service.ts æ ¸å¿ƒæ–¹æ³•
class SystemService {
  // è·å–ä¸‹æ³¨è®¾ç½®
  async getBetSettings()
  
  // æ›´æ–°ä¸‹æ³¨è®¾ç½®
  async updateBetSettings(settings: UpdateBetSettingsDto)
  
  // è·å–ç³»ç»Ÿè®¾ç½®
  async getSystemSettings()
  
  // æ›´æ–°ç³»ç»Ÿè®¾ç½®
  async updateSystemSettings(settings: UpdateSystemSettingsDto)
  
  // æ¸…ç©ºæŒ‡å®šæ—¶é—´èŒƒå›´æ•°æ®
  async clearData(startDate: Date, endDate: Date, options: ClearOptions)
}
```

### 6. ç®¡ç†å‘˜æ¨¡å— (Admin Module)
**æ–‡ä»¶**ï¼š
- `src/modules/admin/admin.module.ts`
- `src/modules/admin/admin.controller.ts`
- `src/modules/admin/admin.service.ts`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```typescript
// admin.service.ts æ ¸å¿ƒæ–¹æ³•
class AdminService {
  // è·å–ç»Ÿè®¡æ•°æ®
  async getStatistics(startDate: Date, endDate: Date) {
    // 1. æ€»ä¸‹æ³¨é‡‘é¢
    // 2. æ€»ç›ˆäº
    // 3. æ´»è·ƒç”¨æˆ·æ•°
    // 4. ä¸‹æ³¨æ¬¡æ•°
    // 5. æ‰‹ç»­è´¹æ€»é¢
    // 6. æ¯æ—¥ç»Ÿè®¡
  }
  
  // è·å–æ“ä½œæ—¥å¿—
  async getAdminLogs(query: QueryDto)
  
  // è®°å½•æ“ä½œæ—¥å¿—ï¼ˆå†…éƒ¨æ–¹æ³•ï¼‰
  async createAdminLog(log: CreateAdminLogDto)
}
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ä½¿ç”¨ç°æœ‰ä»£ç 

### 1. åˆå§‹åŒ–é¡¹ç›®

```bash
cd score-system/backend

# å®‰è£…ä¾èµ–
pnpm install

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘.envæ–‡ä»¶

# ç”ŸæˆPrisma Client
npx prisma generate

# è¿è¡Œæ•°æ®åº“è¿ç§»
npx prisma migrate dev --name init

# åˆå§‹åŒ–ç§å­æ•°æ®
npx prisma db seed

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm start:dev
```

### 2. æµ‹è¯•å·²å®Œæˆçš„æ¥å£

```bash
# ç”¨æˆ·ç™»å½•
curl -X POST http://localhost:3000/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"user001","password":"123456"}'

# ç®¡ç†å‘˜ç™»å½•
curl -X POST http://localhost:3000/api/admin/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

### 3. æŸ¥çœ‹Swaggeræ–‡æ¡£

è®¿é—®ï¼šhttp://localhost:3000/api-docs

---

## ğŸ“¦ å®Œæ•´çš„package.jsonä¾èµ–

å·²åŒ…å«æ‰€æœ‰éœ€è¦çš„ä¾èµ–ï¼š
- @nestjs/core, @nestjs/common
- @nestjs/jwt, @nestjs/passport
- @nestjs/swagger
- @nestjs/config
- @nestjs/bullmq
- @prisma/client
- bcrypt
- passport-jwt
- class-validator, class-transformer
- ioredis
- axiosï¼ˆç”¨äºåŒæ­¥å¼€å¥–æ•°æ®ï¼‰

---

## ğŸ“ åç»­å¼€å‘å»ºè®®

### æ–¹å¼1ï¼šä½¿ç”¨NestJS CLIç”Ÿæˆæ¨¡å—
```bash
# ç”Ÿæˆå®Œæ•´æ¨¡å—
nest g resource modules/user
nest g resource modules/bet
nest g resource modules/lottery
nest g resource modules/point
nest g resource modules/system
nest g resource modules/admin
```

ç„¶åå¤åˆ¶ä¸Šé¢æä¾›çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä»£ç åˆ°å¯¹åº”æ–‡ä»¶ã€‚

### æ–¹å¼2ï¼šæ‰‹åŠ¨åˆ›å»ºæ–‡ä»¶

æ ¹æ®ä¸Šé¢åˆ—å‡ºçš„æ–‡ä»¶ç»“æ„ï¼Œæ‰‹åŠ¨åˆ›å»ºæ¯ä¸ªæ¨¡å—çš„æ–‡ä»¶ï¼Œå‚è€ƒï¼š
1. Authæ¨¡å—çš„å®ç°æ–¹å¼
2. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å·¥å…·ç±» (lottery-rules.util.ts)
3. APIæ¥å£æ–‡æ¡£ä¸­çš„æ¥å£å®šä¹‰

### æ–¹å¼3ï¼šé€ä¸ªæ¨¡å—å¼€å‘

å»ºè®®é¡ºåºï¼š
1. **Systemæ¨¡å—** - æœ€ç®€å•ï¼Œå…ˆå®Œæˆé…ç½®ç®¡ç†
2. **Useræ¨¡å—** - ç”¨æˆ·ä¿¡æ¯ç®¡ç†
3. **Betæ¨¡å—** - ä¸‹æ³¨åŠŸèƒ½ï¼ˆæœ€å¤æ‚ï¼‰
4. **Lotteryæ¨¡å—** - å¼€å¥–æ•°æ®åŒæ­¥å’Œç»“ç®—
5. **Pointæ¨¡å—** - ç§¯åˆ†è®°å½•æŸ¥è¯¢
6. **Adminæ¨¡å—** - ç»Ÿè®¡å’Œæ—¥å¿—

---

## ğŸ¯ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å·²å®ç°

æœ€é‡è¦çš„ **lottery-rules.util.ts** å·²ç»å®Œæˆï¼ŒåŒ…å«ï¼š

âœ… å›æœ¬åˆ¤å®šé€»è¾‘ï¼ˆå¯¹å­ã€è±¹å­ã€é¡ºå­ã€æ€»å’Œ13/14ï¼‰  
âœ… é¡ºå­åˆ¤å®šé€»è¾‘ï¼ˆåŒ…æ‹¬ç‰¹æ®Šé¡ºå­089ã€019ï¼‰  
âœ… å¤§å°å•åŒè®¡ç®—  
âœ… å€æ•°ä¸‹æ³¨ç»“ç®—è®¡ç®—  
âœ… ç»„åˆä¸‹æ³¨ç»“ç®—è®¡ç®—  
âœ… ä¸‹æ³¨å†…å®¹éªŒè¯  
âœ… å¼€å¥–å·ç è§£æ  

è¿™äº›å‡½æ•°å¯ä»¥ç›´æ¥åœ¨å„ä¸ªæ¨¡å—ä¸­ä½¿ç”¨ã€‚

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

å¼€å‘æ—¶è¯·å‚è€ƒï¼š
1. [APIæ¥å£æ–‡æ¡£](../../APIæ¥å£æ–‡æ¡£.md) - æŸ¥çœ‹æ¥å£å®šä¹‰
2. [ä¸šåŠ¡è§„åˆ™è¯¦è§£](../../ä¸šåŠ¡è§„åˆ™è¯¦è§£æ–‡æ¡£.md) - ç†è§£ä¸šåŠ¡é€»è¾‘
3. [æ•°æ®åº“è®¾è®¡](../../æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md) - äº†è§£æ•°æ®ç»“æ„
4. Authæ¨¡å—å®ç° - ä½œä¸ºå…¶ä»–æ¨¡å—çš„å‚è€ƒç¤ºä¾‹

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2024å¹´11æœˆ26æ—¥



