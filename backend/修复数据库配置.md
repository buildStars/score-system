# 🔧 修复数据库配置错误

## ❌ 当前问题

你的 `.env` 文件连接到了**旧项目的数据库**：
```
Datasource "db": MySQL database "edp_db" at "localhost:3306"
User `edp_user` was denied access
```

**这是错误的！** 新项目需要使用**独立的数据库**。

---

## ✅ 正确的配置步骤

### 第1步：创建独立数据库（如果还没创建）

```bash
# 连接MySQL
mysql -u root -p

# 创建独立的数据库
CREATE DATABASE yunce_score_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 查看数据库列表（确认创建成功）
SHOW DATABASES;

# 应该看到：
# - edp_db           <- 旧项目的数据库
# - yunce_score_system  <- 新项目的数据库（独立）

# 退出
EXIT;
```

### 第2步：修改 backend/.env 文件

打开 `backend/.env` 文件，找到 `DATABASE_URL` 这行，修改为：

```env
# ❌ 错误的配置（旧项目）
DATABASE_URL="mysql://edp_user:password@localhost:3306/edp_db"

# ✅ 正确的配置（新项目）
DATABASE_URL="mysql://root:你的MySQL密码@localhost:3306/yunce_score_system"
```

**完整的正确配置**：

```env
# 数据库配置
DATABASE_URL="mysql://root:你的MySQL密码@localhost:3306/yunce_score_system"

# JWT配置
JWT_SECRET="yunce-score-system-secret-2024"
JWT_EXPIRES_IN="7d"
JWT_ADMIN_EXPIRES_IN="12h"

# 应用配置
PORT=3000
NODE_ENV="development"

# CORS配置
CORS_ORIGIN="http://localhost:5173,http://localhost:5174"
```

### 第3步：重新运行迁移

```bash
cd backend

# 1. 生成Prisma Client
npx prisma generate

# 2. 运行数据库迁移
npx prisma migrate dev --name init

# 3. 初始化种子数据
npx prisma db seed

# 4. 启动服务
pnpm start:dev
```

---

## 🎯 完整的配置示例

### 场景1：使用本地MySQL（推荐）

```env
DATABASE_URL="mysql://root:YourMySQLPassword@localhost:3306/yunce_score_system"
```

### 场景2：使用Docker MySQL

如果你用 `docker-compose up -d mysql` 启动了MySQL：

```env
DATABASE_URL="mysql://score_user:score_pass_2024@localhost:3307/yunce_score_system"
```

注意端口是 `3307`（Docker映射的端口）

### 场景3：使用专用数据库用户

如果你创建了专用用户：

```sql
CREATE USER 'score_user'@'localhost' IDENTIFIED BY 'ScorePass2024!';
GRANT ALL PRIVILEGES ON yunce_score_system.* TO 'score_user'@'localhost';
FLUSH PRIVILEGES;
```

然后配置：
```env
DATABASE_URL="mysql://score_user:ScorePass2024!@localhost:3306/yunce_score_system"
```

---

## 🔍 验证配置是否正确

### 1. 检查数据库连接

```bash
cd backend
npx prisma db execute --stdin <<< "SELECT 1"
```

如果成功，会输出：
```
✔ Query executed successfully
```

如果失败，会提示连接错误。

### 2. 查看连接的数据库

```bash
npx prisma db execute --stdin <<< "SELECT DATABASE()"
```

应该输出：`yunce_score_system`

### 3. 查看Prisma配置

```bash
npx prisma version
```

会显示当前配置的数据库。

---

## ⚠️ 常见错误

### 错误1：Shadow数据库权限不足

**错误信息**：
```
P3014: Prisma Migrate could not create the shadow database
```

**原因**：
- 使用的数据库用户没有创建数据库的权限
- 或者连接到了受限的数据库

**解决方法1**：使用root用户
```env
DATABASE_URL="mysql://root:password@localhost:3306/yunce_score_system"
```

**解决方法2**：禁用shadow数据库（不推荐）
```bash
npx prisma migrate dev --create-only
npx prisma db push
```

**解决方法3**：给用户授权
```sql
GRANT ALL PRIVILEGES ON `yunce_score_system\_%`.* TO 'score_user'@'localhost';
FLUSH PRIVILEGES;
```

### 错误2：数据库不存在

**错误信息**：
```
P1003: Database yunce_score_system does not exist
```

**解决**：
```bash
mysql -u root -p -e "CREATE DATABASE yunce_score_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
```

### 错误3：连接被拒绝

**错误信息**：
```
P1001: Can't reach database server at localhost:3306
```

**检查**：
```bash
# 检查MySQL是否运行
# Windows
netstat -ano | findstr "3306"

# Linux/Mac
lsof -i :3306

# 或者
mysql -u root -p -e "SELECT 1"
```

---

## 🎯 快速修复命令

复制粘贴运行：

```bash
# 1. 进入后端目录
cd D:\download\yunce\yunce\score-system\backend

# 2. 备份旧配置
copy .env .env.old

# 3. 复制正确的配置
copy .env.correct .env

# 4. 用记事本打开.env，修改MySQL密码
notepad .env

# 5. 创建数据库（如果还没创建）
mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS yunce_score_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 6. 重新运行迁移
npx prisma generate
npx prisma migrate dev --name init
npx prisma db seed

# 7. 启动
pnpm start:dev
```

---

## 📊 配置对比

| 配置项 | ❌ 错误（旧项目） | ✅ 正确（新项目） |
|--------|------------------|------------------|
| **数据库名** | edp_db | yunce_score_system |
| **用户名** | edp_user | root 或 score_user |
| **端口** | 3306 | 3306（本地）或3307（Docker） |
| **用途** | 旧项目 | 新项目（独立） |

---

## ✅ 验证成功

当你看到以下输出，说明配置正确：

```bash
npx prisma migrate dev

Environment variables loaded from .env
Prisma schema loaded from prisma\schema.prisma
Datasource "db": MySQL database "yunce_score_system" at "localhost:3306"

✔ Applied migration 0_init
✔ Generated Prisma Client

Database synchronized successfully!
```

---

## 🎉 总结

**关键点**：
1. ✅ 使用独立数据库：`yunce_score_system`
2. ✅ 不要使用旧项目的配置：`edp_db`
3. ✅ 确保数据库已创建
4. ✅ 使用有足够权限的用户（推荐root）

**配置模板**：
```env
DATABASE_URL="mysql://root:你的密码@localhost:3306/yunce_score_system"
```

**按照上面的步骤操作，问题就解决了！** 🚀

---

**创建日期**：2024年11月26日  
**问题**：连接到了旧项目数据库  
**解决**：配置独立数据库



