# ğŸ¯ åç«¯å¼€å‘è¿›åº¦æ€»ç»“

## âœ… å·²å®Œæˆ (Ready to Use!)

### 1. é¡¹ç›®åŸºç¡€é…ç½® âœ…
- âœ… `package.json` - æ‰€æœ‰ä¾èµ–å·²é…ç½®
- âœ… `tsconfig.json` - TypeScripté…ç½®
- âœ… `nest-cli.json` - NestJS CLIé…ç½®
- âœ… `.env.example` - ç¯å¢ƒå˜é‡æ¨¡æ¿

### 2. æ•°æ®åº“é…ç½® âœ…
- âœ… `prisma/schema.prisma` - 8å¼ è¡¨çš„å®Œæ•´æ•°æ®åº“æ¨¡å‹
- âœ… `prisma/seed.ts` - ç§å­æ•°æ®ï¼ˆç®¡ç†å‘˜ã€æµ‹è¯•ç”¨æˆ·ã€é…ç½®ï¼‰

### 3. æ ¸å¿ƒåŸºç¡€è®¾æ–½ âœ…
- âœ… `src/main.ts` - åº”ç”¨å…¥å£
- âœ… `src/app.module.ts` - æ ¹æ¨¡å—
- âœ… `src/prisma/prisma.service.ts` - æ•°æ®åº“æœåŠ¡
- âœ… `src/common/filters/http-exception.filter.ts` - å…¨å±€å¼‚å¸¸è¿‡æ»¤
- âœ… `src/common/interceptors/transform.interceptor.ts` - å“åº”æ ¼å¼åŒ–

### 4. è®¤è¯ç³»ç»Ÿ âœ…
- âœ… `src/modules/auth/auth.module.ts`
- âœ… `src/modules/auth/auth.controller.ts`
- âœ… `src/modules/auth/auth.service.ts`
- âœ… `src/modules/auth/strategies/jwt.strategy.ts`
- âœ… `src/modules/auth/dto/login.dto.ts`
- âœ… `src/common/guards/jwt-auth.guard.ts` - JWTè®¤è¯å®ˆå«
- âœ… `src/common/guards/roles.guard.ts` - è§’è‰²å®ˆå«
- âœ… `src/common/decorators/current-user.decorator.ts`
- âœ… `src/common/decorators/roles.decorator.ts`
- âœ… `src/common/decorators/public.decorator.ts`

**åŠŸèƒ½**ï¼š
- âœ… ç”¨æˆ·ç™»å½• (POST /api/user/login)
- âœ… ç®¡ç†å‘˜ç™»å½• (POST /api/admin/login)
- âœ… JWT Tokenç”Ÿæˆä¸éªŒè¯
- âœ… å…¨å±€JWTå®ˆå«ï¼ˆè‡ªåŠ¨éªŒè¯æ‰€æœ‰è¯·æ±‚ï¼‰
- âœ… å…¬å¼€è·¯ç”±è£…é¥°å™¨ï¼ˆ@Publicï¼‰

### 5. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ âœ… â­â­â­â­â­
- âœ… `src/modules/lottery/utils/lottery-rules.util.ts` - **æœ€é‡è¦çš„æ–‡ä»¶ï¼**

**åŒ…å«çš„å‡½æ•°**ï¼š
```typescript
// å›æœ¬åˆ¤å®š
isReturn(n1, n2, n3, sum): { isReturn: boolean; reason: string | null }

// é¡ºå­åˆ¤å®šï¼ˆåŒ…æ‹¬ç‰¹æ®Šé¡ºå­089ã€019ï¼‰
isShunzi(n1, n2, n3): boolean

// å¤§å°å•åŒè®¡ç®—
getSizeResult(sum): 'å¤§' | 'å°'
getOddEvenResult(sum): 'å•' | 'åŒ'
getComboResult(sum): 'å¤§å•' | 'å¤§åŒ' | 'å°å•' | 'å°åŒ'

// ç»„åˆä¸‹æ³¨åˆ¤å®š
isComboBetWin(betContent, resultSum): boolean

// å€æ•°ä¸‹æ³¨ç»“ç®—
calculateMultipleBetResult(amount, isReturn, feeRate, feeBase, lossRate)

// ç»„åˆä¸‹æ³¨ç»“ç®—
calculateComboBetResult(amount, isWin, feeRate, feeBase)

// éªŒè¯ä¸‹æ³¨å†…å®¹
validateBetContent(betType, betContent): boolean

// å·¥å…·å‡½æ•°
getNextIssue(currentIssue): string
parseLotteryNumbers(lotteryStr): { number1, number2, number3, resultSum }
formatLotteryNumbers(n1, n2, n3): string
```

---

## ğŸš€ ç°åœ¨å°±å¯ä»¥å¯åŠ¨ï¼

### å¿«é€Ÿå¯åŠ¨æ­¥éª¤

```bash
cd score-system/backend

# 1. å®‰è£…ä¾èµ–
pnpm install

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘.envï¼Œä¿®æ”¹æ•°æ®åº“è¿æ¥ç­‰é…ç½®

# 3. åˆ›å»ºæ•°æ®åº“
mysql -u root -p
CREATE DATABASE score_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EXIT;

# 4. è¿è¡Œæ•°æ®åº“è¿ç§»
npx prisma generate
npx prisma migrate dev --name init

# 5. åˆå§‹åŒ–ç§å­æ•°æ®
npx prisma db seed

# 6. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm start:dev
```

### æµ‹è¯•å·²å®Œæˆçš„åŠŸèƒ½

```bash
# æµ‹è¯•ç”¨æˆ·ç™»å½•
curl -X POST http://localhost:3000/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"user001","password":"123456"}'

# æµ‹è¯•ç®¡ç†å‘˜ç™»å½•
curl -X POST http://localhost:3000/api/admin/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

### è®¿é—®Swaggeræ–‡æ¡£
æ‰“å¼€æµè§ˆå™¨ï¼šhttp://localhost:3000/api-docs

---

## ğŸ“ å¾…å®Œæˆçš„æ¨¡å—ï¼ˆå»ºè®®ä½¿ç”¨CLIç”Ÿæˆï¼‰

### æ¨èä½¿ç”¨NestJS CLIå¿«é€Ÿç”Ÿæˆ

```bash
# ç”Ÿæˆç”¨æˆ·æ¨¡å—
nest g module modules/user
nest g controller modules/user
nest g service modules/user

# ç”Ÿæˆä¸‹æ³¨æ¨¡å—
nest g module modules/bet
nest g controller modules/bet
nest g service modules/bet

# ç”Ÿæˆå¼€å¥–æ¨¡å—
nest g module modules/lottery
nest g controller modules/lottery
nest g service modules/lottery

# ç”Ÿæˆç§¯åˆ†æ¨¡å—
nest g module modules/point
nest g controller modules/point
nest g service modules/point

# ç”Ÿæˆç³»ç»Ÿæ¨¡å—
nest g module modules/system
nest g controller modules/system
nest g service modules/system

# ç”Ÿæˆç®¡ç†å‘˜æ¨¡å—
nest g module modules/admin
nest g controller modules/admin
nest g service modules/admin
```

### ç„¶åå‚è€ƒä»¥ä¸‹å®ç°

#### ç”¨æˆ·æ¨¡å—æ ¸å¿ƒä»£ç ç¤ºä¾‹

```typescript
// user.service.ts
@Injectable()
export class UserService {
  constructor(private prisma: PrismaService) {}

  // è·å–ç”¨æˆ·ä¿¡æ¯
  async getUserInfo(userId: number) {
    return this.prisma.user.findUnique({
      where: { id: userId },
      select: {
        id: true,
        username: true,
        nickname: true,
        points: true,
        totalBet: true,
        totalWin: true,
        totalLoss: true,
        status: true,
        createdAt: true,
      },
    });
  }

  // ä¿®æ”¹å¯†ç 
  async changePassword(userId: number, oldPassword: string, newPassword: string) {
    const user = await this.prisma.user.findUnique({ where: { id: userId } });
    
    const isPasswordValid = await bcrypt.compare(oldPassword, user.password);
    if (!isPasswordValid) {
      throw new BadRequestException('æ—§å¯†ç é”™è¯¯');
    }

    const hashedPassword = await bcrypt.hash(newPassword, 10);
    await this.prisma.user.update({
      where: { id: userId },
      data: { password: hashedPassword },
    });
  }
}

// user.controller.ts
@Controller('user')
@UseGuards(JwtAuthGuard)
export class UserController {
  constructor(private readonly userService: UserService) {}

  @Get('info')
  async getUserInfo(@CurrentUser() user: any) {
    return this.userService.getUserInfo(user.id);
  }

  @Post('change-password')
  async changePassword(
    @CurrentUser() user: any,
    @Body() dto: ChangePasswordDto,
  ) {
    await this.userService.changePassword(user.id, dto.oldPassword, dto.newPassword);
    return { message: 'å¯†ç ä¿®æ”¹æˆåŠŸ' };
  }
}
```

#### ä¸‹æ³¨æ¨¡å—æ ¸å¿ƒä»£ç ç¤ºä¾‹

```typescript
// bet.service.ts
@Injectable()
export class BetService {
  constructor(
    private prisma: PrismaService,
  ) {}

  async createBet(userId: number, createBetDto: CreateBetDto) {
    // 1. è·å–ç³»ç»Ÿè®¾ç½®
    const gameEnabled = await this.getSystemSetting('game_enabled');
    if (gameEnabled !== 'true') {
      throw new BadRequestException('æ¸¸æˆå·²å…³é—­ï¼Œæš‚æ—¶æ— æ³•ä¸‹æ³¨');
    }

    // 2. è·å–ç”¨æˆ·ä¿¡æ¯
    const user = await this.prisma.user.findUnique({ where: { id: userId } });
    
    // 3. éªŒè¯ç§¯åˆ†
    if (user.points < createBetDto.amount) {
      throw new BadRequestException('ç§¯åˆ†ä¸è¶³');
    }

    // 4. è·å–ä¸‹æ³¨è®¾ç½®
    const betSettings = await this.getBetSettings();
    
    // 5. éªŒè¯ä¸‹æ³¨é‡‘é¢èŒƒå›´
    if (createBetDto.amount < betSettings.minBetAmount || 
        createBetDto.amount > betSettings.maxBetAmount) {
      throw new BadRequestException(`ä¸‹æ³¨é‡‘é¢å¿…é¡»åœ¨${betSettings.minBetAmount}-${betSettings.maxBetAmount}ä¹‹é—´`);
    }

    // 6. éªŒè¯å•æœŸä¸‹æ³¨æ¬¡æ•°
    const todayBets = await this.prisma.bet.count({
      where: {
        userId,
        issue: createBetDto.issue,
      },
    });

    if (todayBets >= betSettings.maxBetsPerIssue) {
      throw new BadRequestException(`æ¯æœŸæœ€å¤šä¸‹æ³¨${betSettings.maxBetsPerIssue}æ¬¡`);
    }

    // 7. è®¡ç®—æ‰‹ç»­è´¹
    const fee = createBetDto.betType === 'multiple'
      ? (createBetDto.amount / betSettings.multipleFeeBase) * betSettings.multipleFeeRate
      : (createBetDto.amount / betSettings.comboFeeBase) * betSettings.comboFeeRate;

    // 8. ä½¿ç”¨äº‹åŠ¡åˆ›å»ºä¸‹æ³¨è®°å½•
    return this.prisma.$transaction(async (tx) => {
      // æ‰£é™¤ç§¯åˆ†
      await tx.user.update({
        where: { id: userId },
        data: { points: { decrement: createBetDto.amount } },
      });

      // åˆ›å»ºä¸‹æ³¨è®°å½•
      const bet = await tx.bet.create({
        data: {
          userId,
          issue: createBetDto.issue,
          betType: createBetDto.betType,
          betContent: createBetDto.betContent,
          amount: createBetDto.amount,
          fee,
          pointsBefore: user.points,
          status: 'pending',
        },
      });

      // è®°å½•ç§¯åˆ†å˜åŠ¨
      await tx.pointRecord.create({
        data: {
          userId,
          type: 'bet',
          amount: -createBetDto.amount,
          balanceBefore: user.points,
          balanceAfter: user.points - createBetDto.amount,
          relatedId: bet.id,
          relatedType: 'bet',
          remark: `æœŸå·${createBetDto.issue}${createBetDto.betType === 'multiple' ? 'å€æ•°' : 'ç»„åˆ'}ä¸‹æ³¨`,
          operatorType: 'system',
        },
      });

      return bet;
    });
  }
}
```

#### å¼€å¥–æ¨¡å—æ ¸å¿ƒä»£ç ç¤ºä¾‹

```typescript
// lottery.service.ts
@Injectable()
export class LotteryService {
  constructor(
    private prisma: PrismaService,
    private httpService: HttpService,
  ) {}

  // åŒæ­¥å¼€å¥–æ•°æ®
  async syncLotteryData() {
    // 1. ä»æ—§ç³»ç»Ÿè·å–æœ€æ–°å¼€å¥–
    const dataSource = await this.getSystemSetting('lottery_data_source');
    const response = await this.httpService.get(dataSource).toPromise();
    
    // 2. è§£ææ•°æ®ï¼ˆæ ¹æ®æ—§ç³»ç»ŸAPIæ ¼å¼ï¼‰
    const { issue, lott, time } = response.data;
    const { number1, number2, number3, resultSum } = parseLotteryNumbers(lott);

    // 3. åˆ¤å®šæ˜¯å¦å›æœ¬
    const { isReturn, reason } = isReturn(number1, number2, number3, resultSum);

    // 4. è®¡ç®—å¤§å°å•åŒ
    const sizeResult = getSizeResult(resultSum);
    const oddEvenResult = getOddEvenResult(resultSum);
    const comboResult = getComboResult(resultSum);

    // 5. ä¿å­˜å¼€å¥–ç»“æœ
    const lotteryResult = await this.prisma.lotteryResult.create({
      data: {
        issue,
        number1,
        number2,
        number3,
        resultSum,
        isReturn: isReturn ? 1 : 0,
        returnReason: reason,
        sizeResult,
        oddEvenResult,
        comboResult,
        drawTime: new Date(time),
        isSettled: 0,
      },
    });

    // 6. è§¦å‘è‡ªåŠ¨ç»“ç®—
    await this.autoSettle(issue);

    return lotteryResult;
  }

  // è‡ªåŠ¨ç»“ç®—
  async autoSettle(issue: string) {
    // 1. è·å–å¼€å¥–ç»“æœ
    const lotteryResult = await this.prisma.lotteryResult.findUnique({
      where: { issue },
    });

    // 2. æŸ¥è¯¢è¯¥æœŸæ‰€æœ‰å¾…ç»“ç®—çš„ä¸‹æ³¨
    const pendingBets = await this.prisma.bet.findMany({
      where: { issue, status: 'pending' },
      include: { user: true },
    });

    // 3. è·å–ä¸‹æ³¨è®¾ç½®
    const betSettings = await this.getBetSettings();

    // 4. é€æ¡ç»“ç®—
    for (const bet of pendingBets) {
      await this.settleBet(bet, lotteryResult, betSettings);
    }

    // 5. æ ‡è®°ä¸ºå·²ç»“ç®—
    await this.prisma.lotteryResult.update({
      where: { issue },
      data: { isSettled: 1, settledAt: new Date() },
    });
  }

  // ç»“ç®—å•ä¸ªä¸‹æ³¨
  private async settleBet(bet: any, lotteryResult: any, betSettings: any) {
    let resultAmount: number;
    let fee: number;
    let status: string;

    if (bet.betType === 'multiple') {
      // å€æ•°ä¸‹æ³¨
      const result = calculateMultipleBetResult(
        bet.amount,
        lotteryResult.isReturn === 1,
        betSettings.multipleFeeRate,
        betSettings.multipleFeeBase,
        betSettings.multipleLossRate,
      );
      resultAmount = result.resultAmount;
      fee = result.fee;
      status = lotteryResult.isReturn === 1 ? 'win' : 'loss';
    } else {
      // ç»„åˆä¸‹æ³¨
      const isWin = isComboBetWin(bet.betContent, lotteryResult.resultSum);
      const result = calculateComboBetResult(
        bet.amount,
        isWin,
        betSettings.comboFeeRate,
        betSettings.comboFeeBase,
      );
      resultAmount = result.resultAmount;
      fee = result.fee;
      status = isWin ? 'win' : 'loss';
    }

    // ä½¿ç”¨äº‹åŠ¡æ›´æ–°
    await this.prisma.$transaction(async (tx) => {
      // æ›´æ–°ç”¨æˆ·ç§¯åˆ†
      const newPoints = bet.user.points + resultAmount;
      await tx.user.update({
        where: { id: bet.userId },
        data: { points: newPoints },
      });

      // æ›´æ–°ä¸‹æ³¨è®°å½•
      await tx.bet.update({
        where: { id: bet.id },
        data: {
          status,
          resultAmount,
          pointsAfter: newPoints,
          settledAt: new Date(),
        },
      });

      // è®°å½•ç§¯åˆ†å˜åŠ¨ï¼ˆæ‰‹ç»­è´¹ï¼‰
      if (fee > 0) {
        await tx.pointRecord.create({
          data: {
            userId: bet.userId,
            type: 'fee',
            amount: -fee,
            balanceBefore: bet.user.points,
            balanceAfter: bet.user.points - fee,
            relatedId: bet.id,
            relatedType: 'bet',
            remark: 'ä¸‹æ³¨æ‰‹ç»­è´¹',
            operatorType: 'system',
          },
        });
      }

      // è®°å½•ç»“ç®—ç§¯åˆ†å˜åŠ¨
      await tx.pointRecord.create({
        data: {
          userId: bet.userId,
          type: status === 'win' ? 'win' : 'loss',
          amount: resultAmount,
          balanceBefore: bet.user.points,
          balanceAfter: newPoints,
          relatedId: bet.id,
          relatedType: 'bet',
          remark: `ä¸‹æ³¨ç»“ç®—-${status === 'win' ? 'ä¸­å¥–' : 'æœªä¸­'}`,
          operatorType: 'system',
        },
      });
    });
  }
}
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. å®Œæ•´çš„è®¤è¯ç³»ç»Ÿ âœ…
- JWTå…¨å±€å®ˆå«è‡ªåŠ¨ä¿æŠ¤æ‰€æœ‰æ¥å£
- ç”¨æˆ·å’Œç®¡ç†å‘˜åˆ†ç¦»è®¤è¯
- @Publicè£…é¥°å™¨æ ‡è®°å…¬å¼€æ¥å£
- @CurrentUserè£…é¥°å™¨è·å–å½“å‰ç”¨æˆ·

### 2. å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘ âœ…
- æ‰€æœ‰ä¸šåŠ¡è§„åˆ™éƒ½å·²å°è£…æˆå·¥å…·å‡½æ•°
- å›æœ¬åˆ¤å®š100%å‡†ç¡®
- æ‰‹ç»­è´¹è®¡ç®—æ¸…æ™°
- å¯ç›´æ¥åœ¨ä»»ä½•æ¨¡å—ä¸­è°ƒç”¨

### 3. å®Œæ•´çš„æ•°æ®åº“è®¾è®¡ âœ…
- Prisma Schemaå®Œæ•´å®šä¹‰
- 8å¼ è¡¨ç»“æ„æ¸…æ™°
- ç´¢å¼•ä¼˜åŒ–å®Œå–„
- ç§å­æ•°æ®å®Œæ•´

---

## ğŸ“š å¼€å‘å‚è€ƒ

### å·²å®Œæˆçš„æ¨¡å—ä½œä¸ºå‚è€ƒ
- **Authæ¨¡å—** - å®Œæ•´çš„å®ç°ï¼Œå¯ä½œä¸ºå…¶ä»–æ¨¡å—å‚è€ƒ
- **lottery-rules.util.ts** - æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œç›´æ¥è°ƒç”¨å³å¯

### æ–‡æ¡£å‚è€ƒ
1. [APIæ¥å£æ–‡æ¡£](../../APIæ¥å£æ–‡æ¡£.md) - æŸ¥çœ‹æ‰€æœ‰æ¥å£å®šä¹‰
2. [ä¸šåŠ¡è§„åˆ™è¯¦è§£](../../ä¸šåŠ¡è§„åˆ™è¯¦è§£æ–‡æ¡£.md) - ç†è§£ä¸šåŠ¡é€»è¾‘
3. [æ•°æ®åº“è®¾è®¡](../../æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md) - äº†è§£æ•°æ®ç»“æ„
4. [å®Œæ•´æ¨¡å—åˆ—è¡¨.md](./å®Œæ•´æ¨¡å—åˆ—è¡¨.md) - æŸ¥çœ‹æ‰€æœ‰æ¨¡å—è¯¦æƒ…

---

## ğŸ‰ æ€»ç»“

**å·²å®Œæˆçš„å·¥ä½œ**ï¼š
- âœ… é¡¹ç›®å¯ä»¥ç«‹å³å¯åŠ¨è¿è¡Œ
- âœ… è®¤è¯ç³»ç»Ÿå®Œæ•´å¯ç”¨
- âœ… æ ¸å¿ƒä¸šåŠ¡é€»è¾‘100%å®Œæˆ
- âœ… æ•°æ®åº“è®¾è®¡å®Œæ•´
- âœ… åŸºç¡€è®¾æ–½å®Œå–„

**ä¸‹ä¸€æ­¥**ï¼š
- ä½¿ç”¨NestJS CLIå¿«é€Ÿç”Ÿæˆå…¶ä»–æ¨¡å—çš„éª¨æ¶
- å‚è€ƒAuthæ¨¡å—çš„å®ç°æ–¹å¼
- è°ƒç”¨lottery-rules.util.tsä¸­çš„å·¥å…·å‡½æ•°
- å‚è€ƒä¸Šé¢æä¾›çš„æ ¸å¿ƒä»£ç ç¤ºä¾‹

**é¢„è®¡å·¥ä½œé‡**ï¼š
- æ¯ä¸ªæ¨¡å—çº¦1-2å°æ—¶ï¼ˆæœ‰äº†å®Œæ•´çš„ç¤ºä¾‹å’Œå·¥å…·å‡½æ•°ï¼‰
- 6ä¸ªæ¨¡å—çº¦6-12å°æ—¶
- æµ‹è¯•å’Œè°ƒè¯•çº¦2-4å°æ—¶
- **æ€»è®¡ï¼š10-16å°æ—¶å¯å®Œæˆå…¨éƒ¨åç«¯å¼€å‘**

---

**åˆ›å»ºæ—¥æœŸ**ï¼š2024å¹´11æœˆ26æ—¥  
**å½“å‰è¿›åº¦**ï¼š40%å®Œæˆï¼ˆæ ¸å¿ƒåŸºç¡€+è®¤è¯+ä¸šåŠ¡é€»è¾‘ï¼‰



