# 🧪 同一期多次下注合并功能测试指南

## 📋 测试准备

### 环境要求
- ✅ 后端服务运行正常
- ✅ 前端 H5 服务运行正常
- ✅ 数据库已清空或准备好测试数据
- ✅ 用户已登录且有足够积分

### 测试账号
- 用户名：test
- 密码：test123
- 初始积分：100000

---

## 🎯 测试场景

### 场景1：纯倍数合并（基础）

#### 操作步骤
1. 登录 H5 前端
2. 在同一期内进行以下操作：
   - 第一次：下注 500 倍
   - 第二次：加注 100 倍
3. 打开"投注历史"页面

#### 预期结果

**投注历史显示**：
```
期号    开奖号码   下注    结果
364918   - - -     600    未结算
```

**验证点**：
- ✅ 只显示 1 条记录（不是 2 条）
- ✅ 下注内容显示：600
- ✅ 状态显示：未结算（因为未开奖）

---

### 场景2：纯倍数合并（已结算）

#### 操作步骤
1. 在某一期内下注：
   - 第一次：下注 500 倍
   - 第二次：加注 100 倍
2. 等待该期开奖
3. 打开"投注历史"页面

#### 预期结果

**投注历史显示**：
```
期号    开奖号码   下注    结果
364918   ②⓪⑨     600   +102.00
```

**验证点**：
- ✅ 只显示 1 条记录
- ✅ 下注内容：600
- ✅ 开奖号码：显示 3 个圆圈
- ✅ 结果：显示总盈亏（绿色或红色）
- ✅ 状态：win 或 loss

**数据验证**：
```
下注总额：600
手续费：(500/100*3) + (100/100*3) = 15 + 3 = 18
实际扣除：600 + 18 = 618

如果中奖（假设赔率 1.95）：
单笔：500 * 1.95 = 975，100 * 1.95 = 195
总中奖：975 + 195 = 1170
净盈利：1170 - 618 = +552（需要减去本金和手续费）

如果未中奖：
净亏损：-618
```

---

### 场景3：纯组合合并

#### 操作步骤
1. 在同一期内下注：
   - 第一次：100 大单
   - 第二次：200 小双
2. 打开"投注历史"页面

#### 预期结果

**投注历史显示**：
```
期号    开奖号码     下注          结果
364918   - - -     100大单 200小双  未结算
```

**验证点**：
- ✅ 只显示 1 条记录
- ✅ 下注内容：100大单 200小双
- ✅ 两个组合都显示

---

### 场景4：相同组合多次下注

#### 操作步骤
1. 在同一期内下注：
   - 第一次：100 大单
   - 第二次：200 大单
   - 第三次：50 大单
2. 打开"投注历史"页面

#### 预期结果

**投注历史显示**：
```
期号    开奖号码   下注      结果
364918   - - -    350大单   未结算
```

**验证点**：
- ✅ 只显示 1 条记录
- ✅ 下注内容：350大单（自动累加）
- ✅ 金额：100 + 200 + 50 = 350

---

### 场景5：混合下注（倍数+组合）

#### 操作步骤
1. 在同一期内下注：
   - 第一次：500 倍
   - 第二次：100 倍
   - 第三次：100 小单
   - 第四次：50 小单
2. 打开"投注历史"页面

#### 预期结果

**投注历史显示**：
```
期号    开奖号码     下注         结果
364918   - - -     600 150小单   未结算
```

**验证点**：
- ✅ 只显示 1 条记录
- ✅ 倍数合并：500 + 100 = 600
- ✅ 组合合并：100 + 50 = 150小单
- ✅ 显示格式：倍数在前，组合在后，空格分隔

---

### 场景6：多期多次下注

#### 操作步骤
1. 第一期（364918）：
   - 下注 500 倍
   - 加注 100 倍
2. 第二期（364919）：
   - 下注 1000 倍
   - 加注 200 小
3. 第三期（364920）：
   - 下注 100 大单
4. 打开"投注历史"页面

#### 预期结果

**投注历史显示**：
```
期号    开奖号码   下注       结果
364920   - - -    100大单    未结算
364919   - - -    1000 200小  未结算
364918   - - -    600        未结算
```

**验证点**：
- ✅ 显示 3 条记录（3个不同期号）
- ✅ 每期的下注都已合并
- ✅ 按期号倒序排列（新的在上）

---

### 场景7：部分结算

#### 操作步骤
1. 在第一期内：
   - 下注 500 倍
   - 加注 100 倍
2. 等待第一期开奖
3. 在第二期内：
   - 下注 1000 倍
4. 打开"投注历史"页面

#### 预期结果

**投注历史显示**：
```
期号    开奖号码   下注    结果
364919   - - -    1000   未结算
364918   ②⓪⑨    600    +102.00
```

**验证点**：
- ✅ 两条记录
- ✅ 第一期已结算，显示结果
- ✅ 第二期未结算，显示"未结算"

---

## 🔍 详细验证

### 验证1：金额计算

**公式**：
```
总下注金额 = Σ(每笔下注金额)
总手续费 = Σ(每笔手续费)
总实际扣除 = 总下注金额 + 总手续费
```

**测试**：
```
下注1：500倍，手续费 15
下注2：100倍，手续费 3

合并后：
总金额：600
总手续费：18
总扣除：618
```

---

### 验证2：结果计算

**公式**：
```
总结果金额 = Σ(每笔结果金额)
```

**测试（假设倍数100赔率1.95）**：
```
下注1：500倍
  - 中奖：500 * 1.95 = 975
  - 结果：975 - 500 - 15 = +460

下注2：100倍
  - 中奖：100 * 1.95 = 195
  - 结果：195 - 100 - 3 = +92

合并后：
  总结果：+460 + 92 = +552
```

---

### 验证3：状态判断

#### 场景1：全部中奖
```
下注1：win, +460
下注2：win, +92

合并状态：win
合并结果：+552
```

#### 场景2：一中一不中
```
下注1：win, +460
下注2：loss, -103

合并状态：win (总盈利>0)
合并结果：+357
```

#### 场景3：全部不中
```
下注1：loss, -515
下注2：loss, -103

合并状态：loss
合并结果：-618
```

#### 场景4：有未结算
```
下注1：pending, null
下注2：win, +460

合并状态：pending
合并结果：未结算
```

---

## 🎨 UI 显示测试

### 测试1：下注内容长度

**短内容**：
```
600
```

**中等长度**：
```
600 100小单
```

**较长内容**：
```
600 100大单 200小双
```

**预期**：
- ✅ 内容完整显示
- ✅ 不换行（如果太长可能需要滚动或省略）
- ✅ 布局不错乱

---

### 测试2：结果金额显示

**正数（盈利）**：
```
+152.00  （绿色）
```

**负数（亏损）**：
```
-618.00  （红色）
```

**未结算**：
```
未结算  （灰色）
```

---

## 📊 边界情况测试

### 边界1：单次下注

**操作**：
- 某期只下注 1 次

**预期**：
- ✅ 显示该笔下注
- ✅ 不受合并逻辑影响

---

### 边界2：大量加注

**操作**：
- 某期下注 10 次以上

**预期**：
- ✅ 所有下注都能正确合并
- ✅ 金额计算准确
- ✅ 显示内容完整

---

### 边界3：空期号

**操作**：
- 查询某个不存在的期号

**预期**：
- ✅ 显示"暂无投注记录"
- ✅ 不报错

---

### 边界4：筛选条件

**操作**：
- 按状态筛选（pending/settled）

**预期**：
- ✅ 只显示符合条件的合并记录
- ✅ 合并逻辑正常工作

---

## 🐛 可能的问题和解决

### 问题1：内容显示不全

**原因**：下注内容太长，超出显示区域

**解决方案**：
```scss
.bet-content {
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
```

---

### 问题2：金额计算不准

**原因**：数值类型转换问题

**检查**：
- 确保所有金额字段都正确转换为 Number
- 确保使用 `toString()` 转换回字符串

---

### 问题3：状态判断错误

**原因**：合并后状态判断逻辑有误

**检查**：
- 如果有任何一笔是 pending，整体状态应为 pending
- 全部结算后，根据总盈亏判断 win/loss

---

## 📱 完整测试流程

### Step 1：准备测试数据

```bash
# 重启后端服务
cd backend
npm run start:dev

# 重启前端服务
cd frontend-h5
npm run dev
```

---

### Step 2：登录并充值

1. 打开 H5 前端：`http://localhost:5173`
2. 登录账号
3. 确认积分充足（建议 10000+）

---

### Step 3：执行测试场景

按照上面的 6 个测试场景依次执行，验证每个场景的预期结果。

---

### Step 4：开奖后验证

1. 等待开奖
2. 刷新投注历史
3. 验证：
   - ✅ 状态变为已结算
   - ✅ 显示开奖号码
   - ✅ 显示结果金额
   - ✅ 金额颜色正确

---

### Step 5：跨期验证

1. 在多个期号内下注
2. 验证不同期号的记录不会合并
3. 验证同期号的记录正确合并

---

## 📊 测试数据记录表

### 测试记录模板

| 期号 | 下注次数 | 下注明细 | 预期合并结果 | 实际显示 | 通过? |
|------|---------|---------|-------------|---------|-------|
| 364918 | 2次 | 500倍, 100倍 | 600 | _______ | ☐ |
| 364919 | 3次 | 500倍, 100倍, 100小单 | 600 100小单 | _______ | ☐ |
| 364920 | 2次 | 100大单, 200大单 | 300大单 | _______ | ☐ |
| 364921 | 2次 | 100大单, 200小双 | 100大单 200小双 | _______ | ☐ |

---

## 🔧 调试工具

### 1. 后端日志查看

打开后端控制台，查看合并逻辑的日志：

```typescript
// 在 mergeBetsByIssue 方法中添加日志
console.log('合并下注记录:', {
  期号: bets[0].issue,
  记录数: bets.length,
  合并后内容: mergedContent,
  总金额: totalAmount,
  总结果: totalResultAmount,
});
```

---

### 2. 前端 Network 检查

打开浏览器开发者工具 → Network：

1. 查看 `/api/user/bet-history` 请求
2. 检查响应数据：
   ```json
   {
     "code": 200,
     "data": {
       "list": [
         {
           "issue": "364918",
           "betContent": "600",
           "amount": "600",
           "betCount": 2
         }
       ]
     }
   }
   ```

---

### 3. 数据库直接查询

```sql
-- 查看某期的所有下注记录
SELECT 
  id,
  issue,
  betType,
  betContent,
  amount,
  fee,
  status,
  resultAmount
FROM bet
WHERE userId = 3 AND issue = '364918'
ORDER BY createdAt DESC;
```

**预期**：
- 应该有多条记录（原始下注）
- API 返回时应该合并为 1 条

---

## ⚠️ 注意事项

### 1. 数据库记录保持独立

- ✅ 数据库中仍然保存每次下注的独立记录
- ✅ 合并只在查询时进行
- ✅ 管理后台可以查看每笔明细

**验证方法**：
```sql
-- 应该能看到多条记录
SELECT * FROM bet WHERE issue = '364918';
```

---

### 2. 分页计算

- ✅ 分页基于合并后的记录数
- ✅ 每页显示的是合并后的期号数量
- ✅ 不是原始下注记录数量

**示例**：
```
原始记录：100条（20期，每期5次下注）
合并后：20条（每期1条）
每页10条：显示10个期号
```

---

### 3. 性能影响

对于下注记录非常多的用户：

**当前方案**：
- 查询所有记录
- 在内存中合并
- 再分页

**潜在问题**：
- 如果有 10000+ 条记录，全部加载到内存可能较慢

**优化方案**（如需要）：
- 先按期号去重，获取期号列表
- 对期号列表分页
- 只查询当前页需要的期号的下注记录
- 再合并

---

## 📋 测试清单

### 功能测试
- [ ] 场景1：纯倍数合并
- [ ] 场景2：纯倍数已结算
- [ ] 场景3：纯组合合并
- [ ] 场景4：相同组合累加
- [ ] 场景5：混合下注合并
- [ ] 场景6：多期互不影响

### 数据验证
- [ ] 金额计算准确
- [ ] 手续费计算准确
- [ ] 结果金额准确
- [ ] 状态判断正确
- [ ] 时间显示正确

### UI 显示
- [ ] 表格布局正常
- [ ] 内容完整显示
- [ ] 颜色显示正确
- [ ] 分页功能正常
- [ ] 刷新功能正常

### 边界情况
- [ ] 单次下注正常
- [ ] 大量加注正常
- [ ] 空数据正常
- [ ] 筛选功能正常

---

## 🎉 测试通过标准

### 必须满足的条件

1. ✅ **合并正确**
   - 同一期的所有下注合并为 1 条
   - 不同期的下注不会合并
   
2. ✅ **计算准确**
   - 倍数正确累加
   - 组合正确累加
   - 金额和结果准确

3. ✅ **显示清晰**
   - 内容格式正确
   - 颜色标识准确
   - 布局不错乱

4. ✅ **功能完整**
   - 分页正常
   - 刷新正常
   - 筛选正常

---

## 🚀 测试完成后

### 1. 记录测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 纯倍数合并 | ✅ | 正常 |
| 纯组合合并 | ✅ | 正常 |
| 混合合并 | ✅ | 正常 |
| 金额计算 | ✅ | 准确 |
| 状态判断 | ✅ | 正确 |

---

### 2. 反馈问题

如果发现问题，请提供：
- 期号
- 下注明细（每次下注的内容和金额）
- 预期结果
- 实际结果
- 错误截图或日志

---

### 3. 性能测试

如果用户下注记录很多（1000+条），测试：
- 加载速度是否可接受
- 是否需要优化查询逻辑

---

**测试指南完成！按照本指南进行全面测试，确保功能正常运行！** ✅🎉

---

**编写时间**：2024年11月27日  
**编写人**：AI Assistant  
**文档类型**：测试指南  
**状态**：✅ 已完成



