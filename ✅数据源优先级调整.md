# ✅ 数据源优先级调整

## 📝 调整原因

USA28 API 持续出现 `ECONNRESET` 错误：
```
❌ USA28失败 (175ms): read ECONNRESET
   错误代码: ECONNRESET
   错误编号: -4077
   系统调用: read
```

**根本原因**：TLS握手失败，服务器主动断开连接
- `_secureEstablished: false` - TLS未建立
- `secureConnecting: true` - 还在连接中就被断开
- `_hadError: true` - 发生错误

---

## ✅ 调整方案

### 原优先级
```
1. USA28 (优先级: 1) - ❌ 持续失败
2. JND28 (优先级: 2) - ✅ 稳定可用
3. Database (优先级: 99) - ✅ 本地备份
```

### 新优先级
```
1. JND28 (优先级: 1) - ✅ 主数据源
2. USA28 (优先级: 2) - ⚠️ 备用数据源
3. Database (优先级: 99) - ✅ 本地备份
```

---

## 🔧 修改内容

### 1. JND28DataSource
```typescript
// ❌ 旧代码
priority = 2;

// ✅ 新代码
priority = 1;  // 主数据源
```

### 2. USA28DataSource
```typescript
// ❌ 旧代码
priority = 1;

// ✅ 新代码
priority = 2;  // 备用数据源
```

---

## 📊 预期效果

### 同步流程（新）
```
1️⃣ 尝试 JND28
   ✅ 成功 → 返回数据
   ❌ 失败 → 继续

2️⃣ 尝试 USA28
   ✅ 成功 → 返回数据
   ❌ 失败 → 继续

3️⃣ 尝试 Database
   ✅ 返回本地数据（可能陈旧）
```

### 日志示例
```
🎯 开始获取开奖数据（多数据源）
🔍 尝试数据源: JND28 (优先级: 1)
🔄 请求JND28 API: https://c2api.canada28.vip/...
✅ JND28获取成功: 2条数据 (1244ms)
✅ 成功从 JND28 获取 2 条数据
```

如果 JND28 失败：
```
🔍 尝试数据源: JND28 (优先级: 1)
❌ JND28失败 (timeout)
➡️ 切换到下一个数据源...
🔍 尝试数据源: USA28 (优先级: 2)
```

---

## 🎯 优势

### 1. 提高成功率
- ✅ JND28 目前稳定可用
- ✅ 避免持续 ECONNRESET 错误
- ✅ 减少重试和切换时间

### 2. 保留 USA28
- ✅ USA28 仍作为备用数据源
- ✅ 如果 JND28 故障，自动切换到 USA28
- ✅ 双重保障

### 3. 灵活调整
```typescript
// 如果将来 USA28 恢复稳定，只需修改优先级：
USA28: priority = 1  // 改回主数据源
JND28: priority = 2  // 改回备用
```

---

## ⚠️ 注意事项

### 1. 数据一致性
- ✅ JND28 和 USA28 数据源相同（加拿大28）
- ✅ 期号格式一致，无需转换
- ✅ 结果可互相验证

### 2. 监控建议
```
- 定期检查 USA28 连接状态
- 记录各数据源成功/失败率
- 关注 ECONNRESET 是否恢复
```

### 3. 临时 vs 永久
**当前**: 临时调整（应对 USA28 故障）

**如果**：
- USA28 持续1周以上不可用 → 考虑永久切换
- USA28 恢复稳定 → 可切换回原优先级
- JND28 也出现问题 → 考虑添加第三方数据源

---

## 📝 回滚方案

如果需要切换回 USA28：

```typescript
// usa28.data-source.ts
priority = 1;  // 改回主数据源

// jnd28.data-source.ts
priority = 2;  // 改回备用
```

重启后端即可生效。

---

## 🔧 修改文件

- ✅ `backend/src/modules/lottery/data-sources/jnd28.data-source.ts`
- ✅ `backend/src/modules/lottery/data-sources/usa28.data-source.ts`

---

**调整时间**：2025-11-29  
**原因**：USA28 持续 ECONNRESET 错误  
**状态**：✅ 已完成  
**类型**：临时调整（可根据实际情况恢复）

