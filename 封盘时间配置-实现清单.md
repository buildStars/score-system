# å°ç›˜æ—¶é—´é…ç½®åŠŸèƒ½ - å®ç°æ¸…å• âœ…

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²å®Œæˆå°ç›˜æ—¶é—´çš„åå°åŠ¨æ€é…ç½®åŠŸèƒ½ï¼Œç®¡ç†å‘˜å¯åœ¨ç®¡ç†åå°ç•Œé¢ä¸­çµæ´»è°ƒæ•´å°ç›˜ç­–ç•¥ã€‚

---

## ğŸ¯ å·²ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯æ–‡ä»¶ï¼ˆBackendï¼‰

#### 1. **æ•°æ®åº“ Seed æ–‡ä»¶** âœ…
**æ–‡ä»¶**: `score-system/backend/prisma/seed.ts`

**ä¿®æ”¹å†…å®¹**:
```typescript
// æ·»åŠ äº†3ä¸ªæ–°çš„ç³»ç»Ÿè®¾ç½®é¡¹
{
  settingKey: 'draw_interval',
  settingValue: '210',
  settingName: 'å¼€å¥–é—´éš”æ—¶é—´',
  description: 'ä¸¤æ¬¡å¼€å¥–ä¹‹é—´çš„é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤210ç§’ï¼ˆ3.5åˆ†é’Ÿï¼‰',
  valueType: 'number',
},
{
  settingKey: 'close_before_draw',
  settingValue: '30',
  settingName: 'å°ç›˜æ—¶é—´',
  description: 'å¼€å¥–å‰å¤šå°‘ç§’å°ç›˜ï¼ˆç¦æ­¢ä¸‹æ³¨ï¼‰ï¼Œé»˜è®¤30ç§’',
  valueType: 'number',
},
{
  settingKey: 'warning_time',
  settingValue: '60',
  settingName: 'å°ç›˜é¢„è­¦æ—¶é—´',
  description: 'å°ç›˜å‰å¤šå°‘ç§’æ˜¾ç¤ºé¢„è­¦æç¤ºï¼Œé»˜è®¤60ç§’',
  valueType: 'number',
}
```

**ä½œç”¨**: åœ¨æ•°æ®åº“ä¸­æ·»åŠ å°ç›˜é…ç½®é¡¹

---

#### 2. **å€’è®¡æ—¶æœåŠ¡** âœ…
**æ–‡ä»¶**: `score-system/backend/src/modules/lottery/lottery-countdown.service.ts`

**ä¿®æ”¹å†…å®¹**:
1. æ³¨å…¥ `PrismaService`
2. å°†ç¡¬ç¼–ç çš„å¸¸é‡æ”¹ä¸ºå¯å˜å±æ€§
3. æ·»åŠ  `loadSettings()` æ–¹æ³•ä»æ•°æ®åº“è¯»å–é…ç½®
4. æ·»åŠ  `refreshSettings()` æ–¹æ³•æ‰‹åŠ¨åˆ·æ–°é…ç½®
5. æ·»åŠ å®šæ—¶ä»»åŠ¡æ¯5åˆ†é’Ÿè‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®

```typescript
// æ„é€ å‡½æ•°æ³¨å…¥ Prisma
constructor(private prisma: PrismaService) { }

// ä»æ•°æ®åº“åŠ è½½é…ç½®
private async loadSettings() {
  const drawInterval = await this.prisma.systemSetting.findUnique({
    where: { settingKey: 'draw_interval' },
  });
  this.DRAW_INTERVAL = parseInt(drawInterval.settingValue) || 210;
  // ... å…¶ä»–é…ç½®
}

// å®šæ—¶åˆ·æ–°ï¼ˆæ¯5åˆ†é’Ÿï¼‰
@Cron('*/5 * * * *')
async reloadSettings() {
  await this.loadSettings();
}
```

**ä½œç”¨**: ä»æ•°æ®åº“è¯»å–å°ç›˜é…ç½®ï¼Œæ”¯æŒåŠ¨æ€åˆ·æ–°

---

#### 3. **ç³»ç»Ÿè®¾ç½®æœåŠ¡** âœ…
**æ–‡ä»¶**: `score-system/backend/src/modules/system/system.service.ts`

**ä¿®æ”¹å†…å®¹**:
1. æ³¨å…¥ `LotteryCountdownService`
2. åœ¨ `updateSystemSettings` æ–¹æ³•ä¸­æ£€æµ‹å°ç›˜é…ç½®ä¿®æ”¹
3. è‡ªåŠ¨åˆ·æ–°å€’è®¡æ—¶æœåŠ¡é…ç½®

```typescript
// æ£€æŸ¥æ˜¯å¦æ›´æ–°äº†å°ç›˜ç›¸å…³é…ç½®
const timingKeys = ['drawInterval', 'closeBeforeDraw', 'warningTime'];
const hasTimingUpdate = Object.keys(updateDto).some(key => 
  timingKeys.includes(key)
);

if (hasTimingUpdate) {
  await this.countdownService.refreshSettings();
}
```

**ä½œç”¨**: æ›´æ–°é…ç½®åç«‹å³åˆ·æ–°å€’è®¡æ—¶æœåŠ¡

---

#### 4. **ç³»ç»Ÿè®¾ç½®æ¨¡å—** âœ…
**æ–‡ä»¶**: `score-system/backend/src/modules/system/system.module.ts`

**ä¿®æ”¹å†…å®¹**:
```typescript
@Module({
  imports: [LotteryModule], // å¯¼å…¥ LotteryModule
  controllers: [SystemController],
  providers: [SystemService],
  exports: [SystemService],
})
```

**ä½œç”¨**: æ”¯æŒä¾èµ–æ³¨å…¥ `LotteryCountdownService`

---

#### 5. **ç³»ç»Ÿè®¾ç½® DTO** âœ…
**æ–‡ä»¶**: `score-system/backend/src/modules/system/dto/update-system-settings.dto.ts`

**ä¿®æ”¹å†…å®¹**:
```typescript
@ApiProperty({ description: 'å¼€å¥–é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰', required: false, example: 210 })
@IsOptional()
@IsNumber()
@Min(60)
@Max(600)
drawInterval?: number;

@ApiProperty({ description: 'å°ç›˜æ—¶é—´ï¼ˆå¼€å¥–å‰å¤šå°‘ç§’å°ç›˜ï¼‰', required: false, example: 30 })
@IsOptional()
@IsNumber()
@Min(5)
@Max(120)
closeBeforeDraw?: number;

@ApiProperty({ description: 'å°ç›˜é¢„è­¦æ—¶é—´ï¼ˆç§’ï¼‰', required: false, example: 60 })
@IsOptional()
@IsNumber()
@Min(10)
@Max(180)
warningTime?: number;
```

**ä½œç”¨**: æ·»åŠ å­—æ®µéªŒè¯ï¼Œç¡®ä¿é…ç½®åˆç†

---

### å‰ç«¯æ–‡ä»¶ï¼ˆFrontend Adminï¼‰

#### 6. **ç³»ç»Ÿè®¾ç½®é¡µé¢** âœ…
**æ–‡ä»¶**: `score-system/frontend-admin/src/views/SystemSettings.vue`

**ä¿®æ”¹å†…å®¹**:

1. **æ·»åŠ è¡¨å•é¡¹**:
```vue
<el-divider content-position="left">å°ç›˜æ—¶é—´è®¾ç½®</el-divider>

<el-form-item label="å¼€å¥–é—´éš”æ—¶é—´" prop="drawInterval">
  <el-input-number v-model="form.drawInterval" :min="60" :max="600" />
  <span class="form-tip">ä¸¤æ¬¡å¼€å¥–çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰</span>
</el-form-item>

<el-form-item label="å°ç›˜æ—¶é—´" prop="closeBeforeDraw">
  <el-input-number v-model="form.closeBeforeDraw" :min="5" :max="120" />
  <span class="form-tip">å¼€å¥–å‰å¤šå°‘ç§’å°ç›˜</span>
</el-form-item>

<el-form-item label="å°ç›˜é¢„è­¦æ—¶é—´" prop="warningTime">
  <el-input-number v-model="form.warningTime" :min="10" :max="180" />
  <span class="form-tip">å°ç›˜å‰å¤šå°‘ç§’æ˜¾ç¤ºé¢„è­¦æç¤º</span>
</el-form-item>

<!-- é…ç½®è¯´æ˜ Alert -->
<el-alert title="é…ç½®è¯´æ˜" type="info">
  æ—¶é—´è½´ç¤ºä¾‹å’Œè®¡ç®—å…¬å¼
</el-alert>
```

2. **æ›´æ–°è¡¨å•æ•°æ®**:
```typescript
const form = reactive<SystemSettings>({
  // ... å…¶ä»–å­—æ®µ
  drawInterval: 210,
  closeBeforeDraw: 30,
  warningTime: 60,
})
```

3. **æ·»åŠ éªŒè¯è§„åˆ™**:
```typescript
const rules = {
  // ... å…¶ä»–è§„åˆ™
  drawInterval: [
    { required: true, message: 'è¯·è¾“å…¥å¼€å¥–é—´éš”æ—¶é—´', trigger: 'blur' },
    { type: 'number', min: 60, max: 600, message: 'å¼€å¥–é—´éš”æ—¶é—´å¿…é¡»åœ¨60-600ç§’ä¹‹é—´' },
  ],
  closeBeforeDraw: [
    { required: true, message: 'è¯·è¾“å…¥å°ç›˜æ—¶é—´', trigger: 'blur' },
    { type: 'number', min: 5, max: 120, message: 'å°ç›˜æ—¶é—´å¿…é¡»åœ¨5-120ç§’ä¹‹é—´' },
  ],
  warningTime: [
    { required: true, message: 'è¯·è¾“å…¥é¢„è­¦æ—¶é—´', trigger: 'blur' },
    { type: 'number', min: 10, max: 180, message: 'é¢„è­¦æ—¶é—´å¿…é¡»åœ¨10-180ç§’ä¹‹é—´' },
  ],
}
```

**ä½œç”¨**: ç®¡ç†ç•Œé¢æ”¯æŒå°ç›˜æ—¶é—´é…ç½®

---

#### 7. **TypeScript ç±»å‹å®šä¹‰** âœ…
**æ–‡ä»¶**: `score-system/frontend-admin/src/types/index.ts`

**ä¿®æ”¹å†…å®¹**:
```typescript
export interface SystemSettings {
  gameEnabled: boolean
  maintenanceMode: boolean
  systemNotice: string
  lotteryDataSource: string
  autoSettleEnabled: boolean
  drawInterval: number // å¼€å¥–é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰
  closeBeforeDraw: number // å°ç›˜æ—¶é—´ï¼ˆç§’ï¼‰
  warningTime: number // å°ç›˜é¢„è­¦æ—¶é—´ï¼ˆç§’ï¼‰
}
```

**ä½œç”¨**: ç±»å‹å®‰å…¨ï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯

---

## ğŸ”„ æ•°æ®æµç¨‹

### é…ç½®æ›´æ–°æµç¨‹

```
ç®¡ç†å‘˜åœ¨ç•Œé¢ä¿®æ”¹
    â†“
å‰ç«¯æäº¤ PUT /admin/system-settings
    â†“
åç«¯ SystemService.updateSystemSettings()
    â†“
ä¿å­˜åˆ°æ•°æ®åº“ system_settings è¡¨
    â†“
æ£€æµ‹åˆ°å°ç›˜é…ç½®ä¿®æ”¹
    â†“
è°ƒç”¨ LotteryCountdownService.refreshSettings()
    â†“
é‡æ–°åŠ è½½é…ç½®
    â†“
âœ… ç«‹å³ç”Ÿæ•ˆ
```

### é…ç½®è¯»å–æµç¨‹

```
LotteryCountdownService å¯åŠ¨
    â†“
loadSettings() ä»æ•°æ®åº“è¯»å–
    â†“
DRAW_INTERVAL = 210
CLOSE_BEFORE_DRAW = 30
WARNING_TIME = 60
    â†“
æ¯5åˆ†é’Ÿè‡ªåŠ¨é‡æ–°åŠ è½½ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
    â†“
getLotteryStatus() ä½¿ç”¨æœ€æ–°é…ç½®è®¡ç®—å€’è®¡æ—¶
```

---

## âœ… åŠŸèƒ½éªŒè¯æ¸…å•

### åç«¯éªŒè¯

- [x] æ•°æ®åº“æ·»åŠ äº†3ä¸ªæ–°é…ç½®é¡¹
- [x] å€’è®¡æ—¶æœåŠ¡èƒ½ä»æ•°æ®åº“è¯»å–é…ç½®
- [x] ä¿®æ”¹é…ç½®åèƒ½ç«‹å³åˆ·æ–°
- [x] å®šæ—¶ä»»åŠ¡æ¯5åˆ†é’Ÿè‡ªåŠ¨é‡æ–°åŠ è½½
- [x] API æ¥å£æ”¯æŒæ›´æ–°å°ç›˜é…ç½®
- [x] å­—æ®µéªŒè¯ï¼ˆèŒƒå›´é™åˆ¶ï¼‰

### å‰ç«¯éªŒè¯

- [x] ç³»ç»Ÿè®¾ç½®é¡µé¢æ˜¾ç¤º3ä¸ªæ–°é…ç½®é¡¹
- [x] ä½¿ç”¨æ•°å­—è¾“å…¥æ¡†ï¼Œæœ‰æœ€å°/æœ€å¤§å€¼é™åˆ¶
- [x] æ˜¾ç¤ºé…ç½®è¯´æ˜å’Œç¤ºä¾‹
- [x] ä¿å­˜åè°ƒç”¨æ­£ç¡®çš„ API
- [x] TypeScript ç±»å‹å®šä¹‰æ­£ç¡®

### é›†æˆæµ‹è¯•

- [ ] å¯åŠ¨åç«¯ï¼Œç¡®è®¤é…ç½®ä»æ•°æ®åº“åŠ è½½æˆåŠŸ
- [ ] åœ¨ç®¡ç†åå°ä¿®æ”¹å°ç›˜æ—¶é—´
- [ ] éªŒè¯å‰ç«¯å€’è®¡æ—¶æ˜¾ç¤ºæ˜¯å¦æŒ‰æ–°é…ç½®è®¡ç®—
- [ ] éªŒè¯å°ç›˜æœŸæ— æ³•ä¸‹æ³¨
- [ ] æŸ¥çœ‹åç«¯æ—¥å¿—ç¡®è®¤é…ç½®åˆ·æ–°

---

## ğŸ“Š é…ç½®ç¤ºä¾‹

### é»˜è®¤é…ç½®ï¼ˆæ ‡å‡†æ¸¸æˆï¼‰

```yaml
å¼€å¥–é—´éš”: 210ç§’ï¼ˆ3.5åˆ†é’Ÿï¼‰
å°ç›˜æ—¶é—´: 30ç§’
é¢„è­¦æ—¶é—´: 60ç§’
```

**æ—¶é—´è½´**:
```
0s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 150s â”€â”€â”€â”€â”€â”€â”€â”€ 180s â”€â”€â”€ 210s
   æ­£å¸¸ä¸‹æ³¨        é¢„è­¦æœŸ      å°ç›˜   å¼€å¥–
```

### å¿«é€Ÿæ¸¸æˆé…ç½®

```yaml
å¼€å¥–é—´éš”: 180ç§’ï¼ˆ3åˆ†é’Ÿï¼‰
å°ç›˜æ—¶é—´: 15ç§’
é¢„è­¦æ—¶é—´: 30ç§’
```

**æ—¶é—´è½´**:
```
0s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 135s â”€â”€â”€ 165s â”€ 180s
   æ­£å¸¸ä¸‹æ³¨         é¢„è­¦æœŸ   å°ç›˜ å¼€å¥–
```

### ä¿å®ˆé…ç½®

```yaml
å¼€å¥–é—´éš”: 300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
å°ç›˜æ—¶é—´: 60ç§’
é¢„è­¦æ—¶é—´: 90ç§’
```

**æ—¶é—´è½´**:
```
0s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 150s â”€â”€â”€â”€â”€â”€ 240s â”€â”€â”€â”€â”€â”€ 300s
   æ­£å¸¸ä¸‹æ³¨         é¢„è­¦æœŸ       å°ç›˜      å¼€å¥–
```

---

## ğŸš€ å¯åŠ¨å’Œæµ‹è¯•

### 1. åˆå§‹åŒ–æ•°æ®åº“é…ç½®

```bash
cd score-system/backend
npx ts-node prisma/seed.ts
```

### 2. å¯åŠ¨åç«¯

```bash
cd score-system/backend
pnpm start:dev
```

**æŸ¥çœ‹æ—¥å¿—ç¡®è®¤é…ç½®åŠ è½½**:
```
[LotteryCountdownService] é…ç½®åŠ è½½æˆåŠŸ: å¼€å¥–é—´éš”=210ç§’, å°ç›˜æ—¶é—´=30ç§’, é¢„è­¦æ—¶é—´=60ç§’
```

### 3. å¯åŠ¨å‰ç«¯ç®¡ç†åå°

```bash
cd score-system/frontend-admin
npm run dev
```

### 4. æµ‹è¯•é…ç½®ä¿®æ”¹

1. è®¿é—®ï¼š`http://localhost:5174`
2. ç™»å½•ï¼š`admin` / `admin123`
3. å¯¼èˆªåˆ°ï¼š**ç³»ç»Ÿç®¡ç† â†’ ç½‘ç«™è®¾ç½®**
4. æ»šåŠ¨åˆ°"**å°ç›˜æ—¶é—´è®¾ç½®**"åŒºåŸŸ
5. ä¿®æ”¹é…ç½®å€¼
6. ç‚¹å‡»"**ä¿å­˜è®¾ç½®**"
7. æŸ¥çœ‹åç«¯æ—¥å¿—ç¡®è®¤åˆ·æ–°ï¼š`âœ… å°ç›˜é…ç½®å·²åˆ·æ–°`

### 5. éªŒè¯ç”Ÿæ•ˆ

1. æ‰“å¼€ç”¨æˆ·ç«¯ H5 é¡µé¢
2. è§‚å¯Ÿå€’è®¡æ—¶å˜åŒ–
3. åœ¨å°ç›˜æœŸå°è¯•ä¸‹æ³¨ï¼ˆåº”è¯¥è¢«æ‹’ç»ï¼‰
4. æ£€æŸ¥å€’è®¡æ—¶æ–‡å­—æ˜¯å¦ç¬¦åˆæ–°é…ç½®

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–

1. **å‰ç«¯å®æ—¶é¢„è§ˆ**: åœ¨ä¿®æ”¹é…ç½®æ—¶æ˜¾ç¤ºæ—¶é—´è½´é¢„è§ˆ
2. **é…ç½®é¢„è®¾**: æä¾›"å¿«é€Ÿ/æ ‡å‡†/ä¿å®ˆ"ä¸‰ç§é¢„è®¾é…ç½®
3. **å†å²è®°å½•**: è®°å½•é…ç½®ä¿®æ”¹å†å²ï¼Œæ–¹ä¾¿å›æ»š

### é•¿æœŸä¼˜åŒ–

1. **A/B æµ‹è¯•**: æ”¯æŒä¸åŒæ—¶æ®µä½¿ç”¨ä¸åŒé…ç½®
2. **åŠ¨æ€è°ƒæ•´**: æ ¹æ®ç”¨æˆ·æ´»è·ƒåº¦è‡ªåŠ¨è°ƒæ•´å°ç›˜æ—¶é—´
3. **é…ç½®æ¨¡æ¿**: æ”¯æŒä¿å­˜å’ŒåŠ è½½é…ç½®æ¨¡æ¿

---

## ğŸ‰ æ€»ç»“

å°ç›˜æ—¶é—´é…ç½®åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼š

âœ… **åç«¯æ”¯æŒ**: æ•°æ®åº“é…ç½® + åŠ¨æ€åŠ è½½ + è‡ªåŠ¨åˆ·æ–°  
âœ… **å‰ç«¯ç•Œé¢**: ç›´è§‚çš„é…ç½®ç•Œé¢ + éªŒè¯è§„åˆ™ + è¯´æ˜æ–‡æ¡£  
âœ… **å³æ—¶ç”Ÿæ•ˆ**: ä¿®æ”¹åç«‹å³åˆ·æ–°ï¼Œæ— éœ€é‡å¯  
âœ… **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰  
âœ… **å®¹é”™æœºåˆ¶**: é…ç½®è¯»å–å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼

**ç®¡ç†å‘˜ç°åœ¨å¯ä»¥åœ¨åå°çµæ´»è°ƒæ•´å°ç›˜ç­–ç•¥äº†ï¼** ğŸš€



