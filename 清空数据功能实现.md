# 清空数据功能实现 🗑️

## 📋 功能需求

**需求**：后台管理系统网站设置需要能清空自定义时间的数据，不包括用户积分

**可以清空的数据**：
- ✅ 开奖历史（已结算）
- ✅ 下注记录（已结算）
- ✅ 积分变动记录

**不能清空的数据**：
- ❌ 用户账户
- ❌ 用户积分（余额）

---

## 🎯 功能实现

### 1. 后端API ✅

#### DTO扩展

**文件**：`score-system/backend/src/modules/system/dto/clear-data.dto.ts`

```typescript
export class ClearDataDto {
  startDate: string;           // 开始日期
  endDate: string;             // 结束日期
  clearBets?: boolean;         // 是否清空下注记录（默认true）
  clearPointRecords?: boolean; // 是否清空积分记录（默认true）
  clearLotteryHistory?: boolean; // 是否清空开奖历史（默认true）✅ 新增
}
```

---

#### Service实现

**文件**：`score-system/backend/src/modules/system/system.service.ts`

**清空逻辑**：

```typescript
async clearData(clearDataDto, adminId, adminUsername) {
  const { startDate, endDate, clearBets, clearPointRecords, clearLotteryHistory } = clearDataDto;
  
  // 1. 清空下注记录（只删除已结算的）
  if (clearBets !== false) {
    await tx.bet.deleteMany({
      where: {
        createdAt: { gte: start, lte: end },
        status: { in: ['win', 'loss', 'cancelled'] }  // 只删除已结算
      }
    });
  }

  // 2. 清空积分记录
  if (clearPointRecords === true) {
    await tx.pointRecord.deleteMany({
      where: {
        createdAt: { gte: start, lte: end }
      }
    });
  }

  // 3. 清空开奖历史（只删除已结算的）✅ 新增
  if (clearLotteryHistory === true) {
    await tx.lotteryResult.deleteMany({
      where: {
        drawTime: { gte: start, lte: end },
        isSettled: 1  // 只删除已结算
      }
    });
  }

  // 4. 记录管理员操作日志
  await tx.adminLog.create({ ... });
}
```

**安全机制**：
- ✅ 只删除已结算的记录（避免影响正在进行的下注）
- ✅ 不删除用户账户和积分余额
- ✅ 记录管理员操作日志
- ✅ 使用事务保证数据一致性

---

#### Controller路由

**文件**：`score-system/backend/src/modules/system/system.controller.ts`

```typescript
@Post('clear-data')
@Roles('superadmin')  // 仅超级管理员可以清空数据
@ApiOperation({ summary: '清空指定时间数据' })
async clearData(
  @Body() clearDataDto: ClearDataDto,
  @CurrentUser() admin: any,
) {
  return this.systemService.clearData(
    clearDataDto,
    admin.id,
    admin.username,
  );
}
```

---

### 2. 前端管理界面 ✅

#### 系统设置页面

**文件**：`score-system/frontend-admin/src/views/SystemSettings.vue`

**UI结构**：

```
┌────────────────────────────────────────┐
│ 🗑️ 清空数据 [危险操作]                  │
├────────────────────────────────────────┤
│ ⚠️ 重要提示                             │
│ • 不会删除：用户账户、用户积分           │
│ • 可以删除：开奖历史、下注记录、积分记录 │
├────────────────────────────────────────┤
│ 时间范围：                              │
│ [2024-11-01] 至 [2024-11-30]           │
├────────────────────────────────────────┤
│ 选择清空内容：                          │
│ ☑ 下注记录（已结算）                    │
│ ☑ 积分变动记录                          │
│ ☑ 开奖历史（已结算）                    │
├────────────────────────────────────────┤
│ [确认清空数据] [重置]                   │
└────────────────────────────────────────┘
```

---

#### 功能特性

##### 1. 时间范围选择

```vue
<el-date-picker
  v-model="clearDataForm.dateRange"
  type="daterange"
  range-separator="至"
  start-placeholder="开始日期"
  end-placeholder="结束日期"
  value-format="YYYY-MM-DD"
/>
```

**默认值**：最近30天

---

##### 2. 清空内容选择

```vue
<el-checkbox-group v-model="clearDataForm.clearOptions">
  <el-checkbox label="bets">下注记录（已结算）</el-checkbox>
  <el-checkbox label="pointRecords">积分变动记录</el-checkbox>
  <el-checkbox label="lotteryHistory">开奖历史（已结算）</el-checkbox>
</el-checkbox-group>
```

**默认值**：全部选中

---

##### 3. 二次确认

```typescript
await ElMessageBox.confirm(
  `确认清空 ${startDate} 至 ${endDate} 的数据吗？此操作不可恢复！`,
  '⚠️ 危险操作确认',
  {
    confirmButtonText: '确认清空',
    cancelButtonText: '取消',
    type: 'warning',
    confirmButtonClass: 'el-button--danger',
  }
)
```

**安全提示**：
- ⚠️ 标题提醒危险操作
- 📅 显示具体时间范围
- ❗ 强调不可恢复
- 🔴 确认按钮为红色（危险色）

---

##### 4. 结果反馈

```typescript
ElMessage.success({
  message: `数据清空成功！已删除：
    下注记录 ${deletedBets} 条
    积分记录 ${deletedPointRecords} 条
    开奖历史 ${deletedLotteryHistory} 条`,
  duration: 5000,
  showClose: true,
})
```

**详细反馈**：
- ✅ 显示每种数据删除的条数
- ⏰ 停留5秒（足够阅读）
- ❌ 可手动关闭

---

#### API接口

**文件**：`score-system/frontend-admin/src/api/settings.ts`

```typescript
export function clearData(data: {
  startDate: string
  endDate: string
  clearBets?: boolean
  clearPointRecords?: boolean
  clearLotteryHistory?: boolean
}) {
  return request.post<{
    message: string
    deletedBets: number
    deletedPointRecords: number
    deletedLotteryHistory: number
  }>('/admin/clear-data', data)
}
```

---

## 🔒 安全机制

### 1. 权限控制

```typescript
@Roles('superadmin')  // 仅超级管理员可以清空数据
```

**级别**：仅超级管理员  
**原因**：防止误操作导致数据丢失

---

### 2. 状态过滤

#### 下注记录

```typescript
status: { in: ['win', 'loss', 'cancelled'] }  // 只删除已结算的
```

**不删除**：`pending`（待结算）状态的下注

#### 开奖历史

```typescript
isSettled: 1  // 只删除已结算的
```

**不删除**：未结算的开奖记录

---

### 3. 数据保护

**永不删除**：
- ❌ User表（用户账户）
- ❌ User.points（用户积分余额）

**可以删除**：
- ✅ Bet（已结算的下注记录）
- ✅ PointRecord（积分变动记录）
- ✅ LotteryResult（已结算的开奖历史）

---

### 4. 操作日志

```typescript
await tx.adminLog.create({
  data: {
    adminId,
    adminUsername,
    action: 'clear_data',
    description: `清空数据: ${startDate} 至 ${endDate}`,
    requestData: clearDataDto,
  },
});
```

**记录内容**：
- 👤 操作管理员ID和用户名
- 📅 清空的时间范围
- 📋 清空的数据类型
- 🕐 操作时间

---

## 🧪 使用示例

### 示例1：清空最近30天所有数据

```
1. 打开"系统设置"页面
2. 滚动到"清空数据"section
3. 时间范围：[2024-11-01] 至 [2024-11-30]（默认）
4. 选择清空内容：全部勾选（默认）
5. 点击"确认清空数据"
6. 二次确认弹窗 → 点击"确认清空"
7. 显示成功消息：
   已删除：
   - 下注记录 150 条
   - 积分记录 300 条
   - 开奖历史 200 条
```

---

### 示例2：只清空开奖历史

```
1. 打开"系统设置"页面
2. 滚动到"清空数据"section
3. 时间范围：[2024-10-01] 至 [2024-10-31]
4. 选择清空内容：只勾选"开奖历史（已结算）"
5. 点击"确认清空数据"
6. 二次确认弹窗 → 点击"确认清空"
7. 显示成功消息：
   已删除：
   - 下注记录 0 条
   - 积分记录 0 条
   - 开奖历史 1440 条（一个月约1440期）
```

---

### 示例3：清空指定日期的下注和积分记录

```
1. 时间范围：[2024-11-15] 至 [2024-11-15]（单天）
2. 选择清空内容：
   - ☑ 下注记录（已结算）
   - ☑ 积分变动记录
   - ☐ 开奖历史（已结算）
3. 点击"确认清空数据"
4. 显示成功消息：
   已删除：
   - 下注记录 50 条
   - 积分记录 100 条
   - 开奖历史 0 条
```

---

## 📊 数据清理建议

### 定期清理

| 数据类型 | 保留时长 | 清理频率 |
|---------|---------|---------|
| 开奖历史 | 3-6个月 | 每月清理一次 |
| 下注记录 | 3个月 | 每月清理一次 |
| 积分记录 | 1个月 | 每周清理一次 |

**原因**：
- 🚀 提升系统性能
- 💾 节省数据库空间
- 🔍 提高查询速度

---

### 建议流程

```
1. 每月1号
   ├─ 清空3个月前的下注记录
   └─ 清空6个月前的开奖历史

2. 每周日
   └─ 清空1个月前的积分记录

3. 系统升级前
   └─ 备份重要数据后清理所有历史数据
```

---

## ⚠️ 注意事项

### 1. 不可恢复

**清空后无法恢复**，请在清空前确认：
- [ ] 不需要这些历史数据用于统计分析
- [ ] 不需要这些数据用于审计
- [ ] 已做好数据备份（如有需要）

---

### 2. 影响范围

**会影响**：
- 📊 历史统计数据
- 📈 报表中的历史记录
- 🔍 管理员查看历史订单

**不影响**：
- 💰 用户当前积分（余额）
- 👤 用户账户信息
- 🎮 当前正在进行的下注
- 🎲 当前期的开奖记录

---

### 3. 权限要求

**必须是超级管理员**

普通管理员无此功能，防止误操作。

---

## 🚀 部署和测试

### 1. 后端部署

```bash
# 重启后端服务
cd D:\download\yunce\yunce\score-system\backend
taskkill /F /IM node.exe
Start-Sleep -Seconds 2
pnpm start:dev
```

---

### 2. 前端部署

```bash
# 重新构建前端管理系统
cd D:\download\yunce\yunce\score-system\frontend-admin
npm run build

# 或者开发模式测试
npm run dev
```

---

### 3. 测试步骤

#### 准备测试数据

```sql
-- 查看当前数据量
SELECT COUNT(*) FROM bets;
SELECT COUNT(*) FROM point_records;
SELECT COUNT(*) FROM lottery_results;
```

#### 执行清空操作

1. 登录后台管理系统
2. 进入"系统设置"
3. 滚动到"清空数据"
4. 选择最近7天的数据
5. 全部勾选
6. 点击"确认清空数据"
7. 确认提示框

#### 验证结果

```sql
-- 查看清空后的数据量
SELECT COUNT(*) FROM bets WHERE created_at BETWEEN '2024-11-20' AND '2024-11-27';
SELECT COUNT(*) FROM point_records WHERE created_at BETWEEN '2024-11-20' AND '2024-11-27';
SELECT COUNT(*) FROM lottery_results WHERE draw_time BETWEEN '2024-11-20' AND '2024-11-27' AND is_settled = 1;

-- 应该为0或接近0
```

---

## 🎉 总结

### 功能完成

✅ **后端API**：支持清空开奖历史、下注记录、积分记录  
✅ **安全机制**：仅超级管理员、只删除已结算、记录操作日志  
✅ **前端界面**：时间范围选择、内容选择、二次确认  
✅ **详细反馈**：显示删除条数、5秒提示、可手动关闭

### 核心特性

🔒 **安全**：二次确认、权限控制、状态过滤  
📊 **灵活**：自定义时间、可选内容、批量清理  
💾 **保护**：不删除用户积分、不删除进行中的记录  
📝 **可追溯**：记录管理员操作日志

**现在管理员可以安全地清理历史数据，优化系统性能了！** 🎊



