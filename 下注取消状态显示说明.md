# 下注取消状态显示说明 🚫

## 修改概述

为下注记录添加 `cancelled`（取消）状态的显示支持，在管理后台和 H5 前端都能正确显示"取消"状态。

## 修改详情

### 1. 管理后台修改

#### 1.1 格式化函数（format.ts）

**文件：** `frontend-admin/src/utils/format.ts`

添加 `cancelled` 状态的映射：

```typescript
export const formatBetStatus = (status: string): string => {
  const statusMap: Record<string, string> = {
    pending: '待结算',
    win: '赢',
    loss: '输',
    cancelled: '取消',  // ✅ 新增
  }
  return statusMap[status] || status
}
```

#### 1.2 状态标签颜色（BetRecords.vue）

**文件：** `frontend-admin/src/views/BetRecords.vue`

为 `cancelled` 状态添加警告色标签：

```typescript
const getStatusType = (status: string) => {
  const typeMap: Record<string, any> = {
    pending: 'info',      // 蓝色 - 待结算
    win: 'success',       // 绿色 - 赢
    loss: 'danger',       // 红色 - 输
    cancelled: 'warning', // 橙色 - 取消 ✅ 新增
  }
  return typeMap[status] || 'info'
}
```

### 2. H5 前端修改

#### 2.1 模板显示逻辑（BetHistory.vue）

**文件：** `frontend-h5/src/views/BetHistory.vue`

在结果列添加取消状态的显示：

```vue
<!-- 结果 -->
<div class="data-col result-col">
  <div v-if="item.status === 'pending'" class="result-pending">
    未结算
  </div>
  <div v-else-if="item.status === 'cancelled'" class="result-cancelled">
    取消  <!-- ✅ 新增 -->
  </div>
  <div v-else :class="['result-amount', getResultClass(item.resultAmount)]">
    {{ formatResultAmount(item.resultAmount) }}
  </div>
</div>

<!-- 剩余积分 -->
<div class="data-col balance-col">
  <div v-if="item.status === 'pending'" class="balance-pending">
    -
  </div>
  <div v-else-if="item.status === 'cancelled'" class="balance-cancelled">
    -  <!-- ✅ 新增 -->
  </div>
  <div v-else class="balance-amount">
    {{ formatMoney(item.pointsAfter) }}
  </div>
</div>
```

#### 2.2 样式定义

添加取消状态的样式：

```scss
.result-col {
  .result-pending {
    font-size: 12px;
    color: #999;
  }

  .result-cancelled {  // ✅ 新增
    font-size: 12px;
    color: #ff976a;    // 橙色
    font-weight: 500;
  }
}

.balance-col {
  .balance-pending {
    font-size: 12px;
    color: #999;
  }

  .balance-cancelled {  // ✅ 新增
    font-size: 12px;
    color: #999;
  }
}
```

## 状态说明

### 下注状态枚举

| 状态值 | 中文显示 | 标签颜色（管理后台） | 说明 |
|--------|---------|-------------------|------|
| `pending` | 待结算 | 蓝色（info） | 下注已提交，等待开奖 |
| `win` | 赢 | 绿色（success） | 中奖 |
| `loss` | 输 | 红色（danger） | 未中奖 |
| `cancelled` | 取消 | 橙色（warning） | 订单已取消 |

### 取消状态的使用场景

`cancelled` 状态可能在以下情况出现：

1. **系统回本机制触发**
   - 如果某期开奖结果会导致系统亏损过大
   - 系统自动取消该期所有下注
   - 退还用户本金

2. **异常期号处理**
   - 开奖数据异常
   - 期号数据有误
   - 管理员手动取消

3. **特殊情况**
   - 技术故障导致的订单异常
   - 需要撤销的订单

## 显示效果

### 管理后台

```
┌──────────────────────────────────────────────────────────────┐
│ 用户  │ 期号  │ 下注类型 │ 金额   │ 状态     │ 结算金额  │ ...│
├───────┼───────┼──────────┼────────┼──────────┼───────────┼────┤
│ 张三  │ 001   │ 大       │ ¥100   │ [取消]   │ -         │    │
│       │       │          │        │ (橙色)   │           │    │
└──────────────────────────────────────────────────────────────┘
```

### H5 前端

```
┌─────────────────────────────────────────────────────────┐
│ 期号  │ 开奖号码 │ 下注  │ 结果     │ 剩余              │
├───────┼──────────┼───────┼──────────┼──────────────────┤
│ ...001│ 3 5 8    │ 大    │ 取消     │ -                 │
│       │          │       │ (橙色)   │                   │
└─────────────────────────────────────────────────────────┘
```

## 与其他状态的区别

### 1. 待结算（pending）
- **显示**: "未结算" / "待结算"
- **颜色**: 灰色 `#999`
- **结算金额**: 不显示（显示 `-`）
- **剩余积分**: 不显示（显示 `-`）

### 2. 取消（cancelled）
- **显示**: "取消"
- **颜色**: 橙色 `#ff976a`（管理后台标签为橙色 warning）
- **结算金额**: 不显示（显示 `-`）
- **剩余积分**: 不显示（显示 `-`）

### 3. 赢/输（win/loss）
- **显示**: "赢" / "输" 或具体金额
- **颜色**: 绿色/红色
- **结算金额**: 显示具体金额
- **剩余积分**: 显示结算后的积分

## 数据流程

```
1. 用户下注
   ↓
2. 订单创建（status = 'pending'）
   ↓
3a. 正常开奖 → 结算（status = 'win' 或 'loss'）
   或
3b. 触发取消条件 → 取消订单（status = 'cancelled'）
   ↓
4. 前端显示对应状态
```

## 测试验证

### 管理后台测试
1. 访问 `http://localhost:5174/bet-records`
2. 查找状态为 `cancelled` 的记录
3. 验证：
   - ✅ 状态列显示橙色"取消"标签
   - ✅ 结算金额列为空或显示 `-`
   - ✅ 其他信息正常显示

### H5 前端测试
1. 访问投注历史页面
2. 查找状态为 `cancelled` 的记录
3. 验证：
   - ✅ 结果列显示橙色"取消"文字
   - ✅ 剩余积分显示 `-`
   - ✅ 样式正确应用

## 后端支持

**注意：** 这个修改只是前端显示层的更新。后端需要：

1. **确保返回正确的状态值**
   ```typescript
   {
     status: 'cancelled',  // 确保是这个字符串
     // ...其他字段
   }
   ```

2. **取消订单时的数据处理**
   - 设置 `status = 'cancelled'`
   - 不设置 `resultAmount`（或设置为 null）
   - 不设置 `pointsAfter`（或保持原值）
   - 记录取消原因（可选）

## 完成状态

- ✅ 管理后台格式化函数添加 `cancelled` 映射
- ✅ 管理后台状态标签颜色添加 `cancelled` 样式
- ✅ H5 前端模板添加 `cancelled` 状态显示逻辑
- ✅ H5 前端样式添加 `cancelled` 状态样式
- ✅ 所有代码通过 Linter 检查

## 扩展建议

如果需要更详细的取消信息显示：

1. **添加取消原因字段**
   ```typescript
   {
     status: 'cancelled',
     cancelReason: '系统回本',  // 取消原因
     cancelTime: '2025-11-27 19:30:00',  // 取消时间
   }
   ```

2. **在界面上显示取消原因**
   ```vue
   <div v-else-if="item.status === 'cancelled'" class="result-cancelled">
     取消
     <span class="cancel-reason">{{ item.cancelReason }}</span>
   </div>
   ```

3. **添加 Tooltip 提示**
   ```vue
   <el-tooltip content="订单已被系统取消，本金已退还">
     <el-tag type="warning">取消</el-tag>
   </el-tooltip>
   ```

---

**更新时间：** 2025-11-27
**影响页面：**
- 管理后台 → 下注记录
- H5 前端 → 投注历史




