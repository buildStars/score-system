# 重启后端服务指南

## 修改已完成 ✅

已修改以下文件：
1. `backend/src/modules/lottery/utils/lottery-rules.util.ts` - 计算逻辑
2. `backend/src/modules/lottery/lottery.service.ts` - 结算逻辑

## 需要重启后端服务

修改了后端代码，**必须重启后端服务**才能生效！

### 方法1：使用 npm 脚本

```bash
cd score-system/backend

# 停止当前服务（如果正在运行）
# 按 Ctrl+C 停止

# 重新启动
npm run start:dev
```

### 方法2：使用 PM2（如果已配置）

```bash
cd score-system/backend

# 重启服务
pm2 restart score-backend

# 或者先停止再启动
pm2 stop score-backend
pm2 start score-backend
```

### 方法3：重新构建并启动

```bash
cd score-system/backend

# 重新构建
npm run build

# 启动生产服务
npm run start:prod
```

---

## 验证修改是否生效

### 1. 清空旧的下注记录（可选）

如果想从头开始测试，可以清空旧的下注记录：

```sql
-- 清空下注记录
TRUNCATE TABLE bet;

-- 清空积分记录
TRUNCATE TABLE point_record;

-- 重置用户积分
UPDATE user SET points = 100000 WHERE id = 3;
```

### 2. 进行新的下注测试

1. 打开H5前端
2. 进行几次下注（倍数和组合）
3. 等待开奖
4. 查看投注历史中的"结果"列

### 3. 期待结果

**倍数下注 - 回本：**
- 下注1000，手续费30
- 结果显示：+970 ✅（而不是+2000）

**倍数下注 - 不回本：**
- 下注1000，手续费30
- 结果显示：-830 ✅（而不是+200）

**组合赢（没中奖）：**
- 下注1000，手续费50
- 结果显示：+950 ✅（而不是+2000）

**组合中奖且回本：**
- 下注1000，手续费50
- 结果显示：-50 ✅（而不是+1000）

**组合中奖且不回本：**
- 下注1000，手续费50
- 结果显示：-5050 ✅（而不是-4000）

---

## 注意事项

### 历史数据

- ⚠️ **旧的下注记录显示可能不正确**，因为它们使用的是旧逻辑计算的
- ✅ **新的下注记录将显示正确**的净盈亏

### 如需修正历史数据

如果需要修正旧的下注记录，需要重新计算 `resultAmount`：

```sql
-- 这是一个示例，实际需要根据具体情况编写
-- 请谨慎操作，建议先备份数据！

UPDATE bet 
SET resultAmount = (
  CASE 
    WHEN betType = 'multiple' AND status = 'win' THEN amount - fee
    WHEN betType = 'multiple' AND status = 'loss' THEN (amount * 0.2) - amount - fee
    WHEN betType = 'combo' AND status = 'win' THEN amount - fee
    -- ... 其他情况
  END
)
WHERE status IN ('win', 'loss');
```

**注意：** 不建议修改历史数据，除非有特殊需求。直接测试新的下注即可。

---

## 常见问题

### Q: 重启后前端还是显示旧数据？

A: 清除浏览器缓存，刷新页面。

### Q: 修改后积分变动不正确？

A: 检查：
1. 后端服务是否已重启
2. API 请求是否发送到正确的端口
3. 查看后端日志是否有错误

### Q: 测试时积分不够了？

A: 使用管理员后台给用户加分，或者直接修改数据库：

```sql
UPDATE user SET points = 100000 WHERE id = 3;
```

---

## 完成后

✅ 重启后端服务
✅ 进行几次测试下注
✅ 验证"结果"列显示正确的净盈亏
✅ 确认积分变动正确

现在前端投注历史中显示的将是真实的盈亏，而不是返还金额！🎉




