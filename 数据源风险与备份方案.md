# æ•°æ®æºé£é™©ä¸å¤‡ä»½æ–¹æ¡ˆ ğŸ›¡ï¸

## âš ï¸ å½“å‰é£é™©è¯„ä¼°

### æ•°æ®æºç°çŠ¶
**ä¸»æ•°æ®æº**: USA28 API  
**URL**: `https://api.365kaik.com/api/v1/trend/getHistoryList`  
**çŠ¶æ€**: âœ… å½“å‰å¯ç”¨  
**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰é£é™©

### å­˜åœ¨çš„é£é™©

#### 1. å•ç‚¹æ•…éšœé£é™© ğŸ”´ é«˜å±
- **é—®é¢˜**: åªæœ‰1ä¸ªæ•°æ®æº
- **å½±å“**: å¦‚æœAPIå¤±æ•ˆï¼Œæ•´ä¸ªç³»ç»Ÿå°†æ— æ³•è·å–å¼€å¥–æ•°æ®
- **æ¦‚ç‡**: ä¸­ç­‰ï¼ˆç¬¬ä¸‰æ–¹APIä¸å—æ§åˆ¶ï¼‰
- **åæœ**: ç³»ç»Ÿæ— æ³•ä¸‹æ³¨å’Œç»“ç®—

#### 2. ç¬¬ä¸‰æ–¹APIä¸å¯æ§ ğŸŸ¡ ä¸­å±
- **é—®é¢˜**: APIç”±ç¬¬ä¸‰æ–¹ç»´æŠ¤
- **å¯èƒ½å˜åŒ–**:
  - æ”¹å˜URLåœ°å€
  - å¢åŠ è®¤è¯è¦æ±‚ï¼ˆAPI Keyç­‰ï¼‰
  - é™æµæˆ–æ”¶è´¹
  - è¢«é˜²ç«å¢™å±è”½
  - æœåŠ¡å…³é—­
- **æ¦‚ç‡**: è¾ƒé«˜ï¼ˆæ ¹æ®æŠ¥å‘Šï¼Œ3ä¸ªæ•°æ®æºä¸­å·²æœ‰2ä¸ªå¤±æ•ˆï¼‰
- **åæœ**: éœ€è¦ç´§æ€¥ä¿®æ”¹ä»£ç 

#### 3. SSLè¯ä¹¦é—®é¢˜ ğŸŸ¡ ä¸­å±
- **é—®é¢˜**: å½“å‰ä»£ç å¿½ç•¥SSLè¯ä¹¦éªŒè¯
```typescript
const httpsAgent = new https.Agent({
  rejectUnauthorized: false, // ä¸å®‰å…¨
});
```
- **å½±å“**: å­˜åœ¨å®‰å…¨éšæ‚£
- **åæœ**: å¯èƒ½è¢«ä¸­é—´äººæ”»å‡»

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå»ºç«‹å¤‡ç”¨æ•°æ®æºï¼ˆæ¨èï¼‰â­

#### å®æ–½æ­¥éª¤

**Step 1: å¯»æ‰¾å¤‡ç”¨API**

å¯é€‰çš„28å½©ç¥¨æ•°æ®æºï¼š
1. **PC28å®˜æ–¹API** ï¼ˆå¦‚æœæœ‰ï¼‰
2. **å…¶ä»–å½©ç¥¨å¹³å°API**
   - åŒ—äº¬28
   - å¹¸è¿28
   - åŠ æ‹¿å¤§28ï¼ˆBCLCä¿®å¤åï¼‰
3. **è‡ªå»ºçˆ¬è™«**
   - çˆ¬å–å…¬å¼€ç½‘ç«™æ•°æ®
   - é£é™©ï¼šåçˆ¬æœºåˆ¶

**Step 2: ä»£ç å®ç°å¤šæ•°æ®æº**

```typescript
// lottery.service.ts
export class LotteryService {
  private dataSources = [
    {
      name: 'USA28',
      priority: 1,
      url: 'https://api.365kaik.com/api/v1/trend/getHistoryList',
      parser: this.parseUSA28Data,
      enabled: true,
    },
    {
      name: 'PC28',  // å¤‡ç”¨æº1
      priority: 2,
      url: 'https://api.pc28.com/xxx',
      parser: this.parsePC28Data,
      enabled: true,
    },
    {
      name: 'LocalCache',  // å¤‡ç”¨æº2ï¼šæœ¬åœ°ç¼“å­˜
      priority: 3,
      parser: this.parseLocalCache,
      enabled: true,
    },
  ];

  async syncLotteryData() {
    // æŒ‰ä¼˜å…ˆçº§å°è¯•æ¯ä¸ªæ•°æ®æº
    for (const source of this.dataSources.filter(s => s.enabled)) {
      try {
        console.log(`å°è¯•æ•°æ®æº: ${source.name}`);
        const data = await this.fetchFromSource(source);
        if (data) {
          console.log(`âœ… æˆåŠŸä» ${source.name} è·å–æ•°æ®`);
          return data;
        }
      } catch (error) {
        console.error(`âŒ æ•°æ®æº ${source.name} å¤±è´¥:`, error.message);
        // è®°å½•å¤±è´¥ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªæ•°æ®æº
        await this.logDataSourceFailure(source.name, error);
        continue;
      }
    }
    
    throw new Error('æ‰€æœ‰æ•°æ®æºå‡å¤±è´¥');
  }
}
```

**Step 3: é…ç½®ç®¡ç†**

åœ¨æ•°æ®åº“ä¸­é…ç½®æ•°æ®æºï¼š
```sql
CREATE TABLE lottery_data_sources (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50) NOT NULL,
  url VARCHAR(255) NOT NULL,
  priority INT DEFAULT 1,
  enabled BOOLEAN DEFAULT TRUE,
  last_success DATETIME,
  last_failure DATETIME,
  failure_count INT DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- æ’å…¥æ•°æ®æºé…ç½®
INSERT INTO lottery_data_sources (name, url, priority) VALUES
('USA28', 'https://api.365kaik.com/api/v1/trend/getHistoryList', 1),
('PC28', 'https://backup.api.com/lottery', 2),
('LocalCache', 'file:///data/lottery/cache', 3);
```

---

### æ–¹æ¡ˆ2ï¼šè‡ªå»ºæ•°æ®ä¸­è½¬æœåŠ¡å™¨ â­â­

#### æ¶æ„è®¾è®¡

```
å¤–éƒ¨API â†’ ä¸­è½¬æœåŠ¡å™¨ â†’ ä½ çš„ç³»ç»Ÿ
           (ç¼“å­˜+å¤‡ä»½)
```

#### ä¼˜åŠ¿
- âœ… æ§åˆ¶æ•°æ®æµ
- âœ… ç¼“å­˜å†å²æ•°æ®
- âœ… å¹³æ»‘åˆ‡æ¢æ•°æ®æº
- âœ… ç›‘æ§å’Œå‘Šè­¦
- âœ… æ•°æ®å¤‡ä»½

#### å®æ–½æ–¹æ¡ˆ

**1. æ­å»ºä¸­è½¬æœåŠ¡**
```typescript
// data-relay-service/src/app.ts
import express from 'express';
import axios from 'axios';
import Redis from 'ioredis';

const app = express();
const redis = new Redis();

// æ•°æ®æºé…ç½®
const sources = [
  { name: 'USA28', url: 'https://api.365kaik.com/...' },
  { name: 'Backup', url: 'https://backup.api.com/...' },
];

app.get('/api/lottery/latest', async (req, res) => {
  // 1. å…ˆä»ç¼“å­˜è¯»å–
  const cached = await redis.get('lottery:latest');
  if (cached) {
    return res.json(JSON.parse(cached));
  }

  // 2. å°è¯•ä»æ•°æ®æºè·å–
  for (const source of sources) {
    try {
      const data = await axios.get(source.url);
      // ç¼“å­˜30ç§’
      await redis.setex('lottery:latest', 30, JSON.stringify(data.data));
      return res.json(data.data);
    } catch (error) {
      console.error(`Source ${source.name} failed`);
      continue;
    }
  }

  // 3. æ‰€æœ‰æºéƒ½å¤±è´¥ï¼Œè¿”å›æœ€åä¸€æ¬¡æˆåŠŸçš„æ•°æ®
  const lastKnownGood = await redis.get('lottery:last_known_good');
  if (lastKnownGood) {
    return res.json(JSON.parse(lastKnownGood));
  }

  res.status(503).json({ error: 'All data sources unavailable' });
});

app.listen(3001);
```

**2. ä¿®æ”¹ä¸»ç³»ç»Ÿ**
```typescript
// æ”¹ä¸ºè°ƒç”¨è‡ªå·±çš„ä¸­è½¬æœåŠ¡
const response = await axios.get('http://your-relay-server.com/api/lottery/latest');
```

---

### æ–¹æ¡ˆ3ï¼šæœ¬åœ°æ•°æ®åº“ç¼“å­˜+æ‰‹åŠ¨å½•å…¥ï¼ˆæœ€åæ‰‹æ®µï¼‰

#### åŠŸèƒ½è®¾è®¡

```typescript
// lottery-manual.service.ts
export class LotteryManualService {
  /**
   * æ‰‹åŠ¨å½•å…¥å¼€å¥–æ•°æ®ï¼ˆå½“APIå…¨éƒ¨å¤±æ•ˆæ—¶ï¼‰
   */
  async manualInputLottery(data: {
    issue: string;
    number1: number;
    number2: number;
    number3: number;
    drawTime: string;
  }) {
    // 1. éªŒè¯ç®¡ç†å‘˜æƒé™
    // 2. éªŒè¯æ•°æ®æ ¼å¼
    // 3. ä¿å­˜åˆ°æ•°æ®åº“
    // 4. è§¦å‘ç»“ç®—æµç¨‹
    
    return await this.prisma.lotteryResult.create({
      data: {
        issue: data.issue,
        number1: data.number1,
        number2: data.number2,
        number3: data.number3,
        resultSum: data.number1 + data.number2 + data.number3,
        drawTime: new Date(data.drawTime),
        // ... å…¶ä»–å­—æ®µ
      },
    });
  }
}
```

#### ç®¡ç†åå°ç•Œé¢
```vue
<!-- ManualLotteryInput.vue -->
<template>
  <el-card title="æ‰‹åŠ¨å½•å…¥å¼€å¥–æ•°æ®ï¼ˆç´§æ€¥ï¼‰">
    <el-form :model="form">
      <el-form-item label="æœŸå·">
        <el-input v-model="form.issue" placeholder="3364710" />
      </el-form-item>
      <el-form-item label="å¼€å¥–å·ç ">
        <el-input-number v-model="form.number1" :min="0" :max="9" />
        <el-input-number v-model="form.number2" :min="0" :max="9" />
        <el-input-number v-model="form.number3" :min="0" :max="9" />
      </el-form-item>
      <el-form-item label="å¼€å¥–æ—¶é—´">
        <el-date-picker v-model="form.drawTime" type="datetime" />
      </el-form-item>
      <el-form-item>
        <el-button type="danger" @click="submitManual">
          ç´§æ€¥å½•å…¥
        </el-button>
      </el-form-item>
    </el-form>
  </el-card>
</template>
```

---

### æ–¹æ¡ˆ4ï¼šç›‘æ§å’Œè‡ªåŠ¨å‘Šè­¦ â­

#### å®æ–½æ–¹æ¡ˆ

**1. å¥åº·æ£€æŸ¥æ¥å£**
```typescript
// lottery.controller.ts
@Get('health')
async healthCheck() {
  const result = {
    timestamp: new Date(),
    status: 'healthy',
    dataSources: [],
    lastSuccessfulSync: null,
    warnings: [],
  };

  // æ£€æŸ¥æ¯ä¸ªæ•°æ®æº
  for (const source of this.dataSources) {
    try {
      const test = await this.testDataSource(source);
      result.dataSources.push({
        name: source.name,
        status: 'ok',
        responseTime: test.responseTime,
      });
    } catch (error) {
      result.status = 'degraded';
      result.dataSources.push({
        name: source.name,
        status: 'failed',
        error: error.message,
      });
    }
  }

  // æ£€æŸ¥æœ€åä¸€æ¬¡æˆåŠŸåŒæ­¥æ—¶é—´
  const lastSync = await this.getLastSyncTime();
  result.lastSuccessfulSync = lastSync;
  
  if (Date.now() - lastSync.getTime() > 5 * 60 * 1000) {
    result.status = 'critical';
    result.warnings.push('è¶…è¿‡5åˆ†é’ŸæœªåŒæ­¥æ•°æ®');
  }

  return result;
}
```

**2. è‡ªåŠ¨å‘Šè­¦**
```typescript
// alert.service.ts
@Injectable()
export class AlertService {
  @Cron('*/5 * * * *')  // æ¯5åˆ†é’Ÿæ£€æŸ¥
  async checkDataSourceHealth() {
    const health = await this.lotteryService.healthCheck();
    
    if (health.status === 'critical') {
      // å‘é€å‘Šè­¦
      await this.sendAlert({
        level: 'critical',
        message: 'å¼€å¥–æ•°æ®æºå…¨éƒ¨å¤±æ•ˆ',
        details: health,
      });
    }
  }

  private async sendAlert(alert) {
    // æ–¹å¼1: é‚®ä»¶
    // await this.emailService.send(alert);
    
    // æ–¹å¼2: çŸ­ä¿¡
    // await this.smsService.send(alert);
    
    // æ–¹å¼3: é’‰é’‰/å¾®ä¿¡é€šçŸ¥
    // await this.dingTalkService.send(alert);
    
    // æ–¹å¼4: è®°å½•åˆ°æ•°æ®åº“
    await this.prisma.alert.create({ data: alert });
  }
}
```

---

## ğŸ“Š é£é™©çŸ©é˜µ

| é£é™© | æ¦‚ç‡ | å½±å“ | ç­‰çº§ | è§£å†³æ–¹æ¡ˆ |
|------|------|------|------|----------|
| USA28 APIå¤±æ•ˆ | ä¸­ | é«˜ | ğŸ”´ é«˜ | æ–¹æ¡ˆ1ï¼šå¤‡ç”¨æ•°æ®æº |
| ç½‘ç»œä¸ç¨³å®š | ä½ | ä¸­ | ğŸŸ¡ ä¸­ | æ–¹æ¡ˆ2ï¼šä¸­è½¬æœåŠ¡+ç¼“å­˜ |
| éœ€è¦æ‰‹åŠ¨å¹²é¢„ | ä½ | ä¸­ | ğŸŸ¡ ä¸­ | æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨å½•å…¥åŠŸèƒ½ |
| æ— æ³•åŠæ—¶å‘ç°é—®é¢˜ | ä¸­ | é«˜ | ğŸ”´ é«˜ | æ–¹æ¡ˆ4ï¼šç›‘æ§å‘Šè­¦ |

---

## ğŸ¯ æ¨èå®æ–½ä¼˜å…ˆçº§

### ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³ï¼‰
- [x] âœ… å½“å‰å·²ä½¿ç”¨USA28æ•°æ®æº
- [ ] ğŸ”§ ä¿®å¤SSLè¯ä¹¦éªŒè¯é—®é¢˜
- [ ] ğŸ“Š å®æ–½æ–¹æ¡ˆ4ï¼šç›‘æ§å’Œå‘Šè­¦

### ç¬¬äºŒé˜¶æ®µï¼ˆ1å‘¨å†…ï¼‰
- [ ] ğŸ” å¯»æ‰¾1-2ä¸ªå¤‡ç”¨æ•°æ®æº
- [ ] ğŸ› ï¸ å®æ–½æ–¹æ¡ˆ1ï¼šå¤šæ•°æ®æºæ”¯æŒ

### ç¬¬ä¸‰é˜¶æ®µï¼ˆ1ä¸ªæœˆå†…ï¼‰
- [ ] ğŸ—ï¸ è€ƒè™‘æ–¹æ¡ˆ2ï¼šè‡ªå»ºä¸­è½¬æœåŠ¡
- [ ] ğŸ†˜ å®æ–½æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨å½•å…¥åŠŸèƒ½

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### å¼€å‘é˜¶æ®µ
1. âœ… ä½¿ç”¨å½“å‰USA28 APIï¼ˆå·²å®ç°ï¼‰
2. âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼ˆå·²å®ç°ï¼‰
3. âš ï¸ ä¿®å¤SSLè¯ä¹¦éªŒè¯
4. ğŸ“Š æ·»åŠ å¥åº·æ£€æŸ¥æ¥å£

### æµ‹è¯•é˜¶æ®µ
1. ğŸ§ª æ¨¡æ‹ŸAPIå¤±è´¥åœºæ™¯
2. ğŸ”„ æµ‹è¯•é™çº§é€»è¾‘
3. â±ï¸ å‹åŠ›æµ‹è¯•
4. ğŸ“ˆ ç›‘æ§å“åº”æ—¶é—´

### ç”Ÿäº§é˜¶æ®µ
1. ğŸ”” è®¾ç½®å‘Šè­¦ï¼ˆé‚®ä»¶/çŸ­ä¿¡ï¼‰
2. ğŸ“Š å®šæœŸæ£€æŸ¥å¥åº·çŠ¶æ€
3. ğŸ’¾ ä¿ç•™å†å²æ•°æ®å¤‡ä»½
4. ğŸ“– å‡†å¤‡åº”æ€¥é¢„æ¡ˆ

---

## ğŸš¨ åº”æ€¥é¢„æ¡ˆ

### å½“USA28 APIå¤±æ•ˆæ—¶

**ç«‹å³è¡ŒåŠ¨**ï¼ˆ0-5åˆ†é’Ÿï¼‰ï¼š
1. æ£€æŸ¥é”™è¯¯æ—¥å¿—
2. å°è¯•æ‰‹åŠ¨è¯·æ±‚API
3. æ£€æŸ¥ç½‘ç»œè¿æ¥

**çŸ­æœŸæªæ–½**ï¼ˆ5-30åˆ†é’Ÿï¼‰ï¼š
1. åˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®æºï¼ˆå¦‚æœå·²å‡†å¤‡ï¼‰
2. ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®
3. æš‚åœç”¨æˆ·ä¸‹æ³¨ï¼ˆé¿å…æ— æ³•ç»“ç®—ï¼‰

**ä¸­æœŸæªæ–½**ï¼ˆ30åˆ†é’Ÿ-2å°æ—¶ï¼‰ï¼š
1. è”ç³»APIæä¾›æ–¹
2. å¯»æ‰¾æ›¿ä»£æ•°æ®æº
3. æ‰‹åŠ¨å½•å…¥å…³é”®æ•°æ®

**é•¿æœŸæªæ–½**ï¼ˆ2å°æ—¶+ï¼‰ï¼š
1. æ›´æ¢æ•°æ®æº
2. ä¿®æ”¹ä»£ç å¹¶æµ‹è¯•
3. éƒ¨ç½²æ›´æ–°

---

## ğŸ“ è”ç³»æ–¹å¼

**ç´§æ€¥æƒ…å†µè”ç³»**ï¼š
- æŠ€æœ¯è´Ÿè´£äºº: [ç”µè¯]
- å¤‡ç”¨è”ç³»äºº: [ç”µè¯]
- APIæä¾›æ–¹: [è”ç³»æ–¹å¼]

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-27  
**ä¸‹æ¬¡å®¡æŸ¥**: å»ºè®®æ¯æœˆå®¡æŸ¥ä¸€æ¬¡



