# 当期下注倍数合并优化说明

## 问题描述

### 修改前的行为
在首页"当期下注展示"区域，用户多次进行倍数下注时，会按**不同金额分开显示**：

**示例场景：**
1. 第一次下注：每倍100，倍数10，总金额1000
2. 第二次下注：每倍100，倍数5，总金额500

**修改前显示：**
```
本期下注  第3364706期
┌─────────────────────────┐
│ 1000倍数  1000分  ❌    │
│ 500倍数   500分   ❌    │
└─────────────────────────┘
```

**问题：**
- 用户需要分别取消两个下注项
- 界面显示繁琐，不够简洁
- 不符合用户心智模型（用户认为都是"倍数下注"）

---

## 优化方案

### 修改后的行为
所有倍数下注（`betType = 'multiple'`）自动合并为**一个下注项**，不区分具体金额：

**同样的场景：**
1. 第一次下注：1000分
2. 第二次下注：500分

**修改后显示：**
```
本期下注  第3364706期
┌─────────────────────────┐
│ 倍数  1500分  ❌         │
└─────────────────────────┘
```

**优势：**
- ✅ 一键取消所有倍数下注
- ✅ 界面简洁清晰
- ✅ 符合用户心智模型

---

## 技术实现

### 1. 后端修改

#### 文件：`backend/src/modules/bet/bet.service.ts`

#### 修改1：`getCurrentIssueBets` 方法 - 分组逻辑

**修改前：**
```typescript
// 按 betType + betContent 分组
const key = `${bet.betType}-${bet.betContent}`;
```

**修改后：**
```typescript
// 对于倍数下注，统一使用 "multiple" 作为 key
// 对于组合下注，使用 "combo-内容" 作为 key
const key = bet.betType === 'multiple' 
  ? 'multiple' 
  : `${bet.betType}-${bet.betContent}`;

// betContent 也相应调整
groupedBets.set(key, {
  betType: bet.betType,
  betContent: bet.betType === 'multiple' ? 'multiple' : bet.betContent,
  totalAmount: 0,
  totalFee: 0,
  betIds: [],
});
```

**说明：**
- 倍数下注：所有记录合并到 `key = 'multiple'`
- 组合下注：按内容分组（如 `key = 'combo-大'`, `key = 'combo-小双'`）

#### 修改2：`cancelBet` 方法 - 查询逻辑

**修改前：**
```typescript
const bets = await this.prisma.bet.findMany({
  where: {
    userId,
    issue,
    betType,
    betContent,  // 严格匹配 betContent
    status: 'pending',
  },
});
```

**修改后：**
```typescript
const where: any = {
  userId,
  issue,
  betType,
  status: 'pending',
};

// 只有组合下注才需要过滤 betContent
if (betType !== 'multiple') {
  where.betContent = betContent;
}

const bets = await this.prisma.bet.findMany({ where });
```

**说明：**
- 倍数下注：查询所有 `betType = 'multiple'` 的记录，不限 `betContent`
- 组合下注：仍然需要匹配具体的 `betContent`（如"大"、"小双"等）

---

### 2. 前端修改

#### 文件：`frontend-h5/src/views/Home.vue`

#### 修改：`formatBetDisplay` 函数

**修改前：**
```typescript
const formatBetDisplay = (betType: string, betContent: string) => {
  if (betType === 'multiple') {
    return `${betContent}倍数`  // 显示：1000倍数、500倍数
  } else {
    return betContent
  }
}
```

**修改后：**
```typescript
const formatBetDisplay = (betType: string, betContent: string) => {
  if (betType === 'multiple') {
    // 如果是合并后的倍数下注，betContent 为 'multiple'，只显示"倍数"
    // 如果是单独的倍数下注，betContent 为具体数值，显示"xxx倍数"
    return betContent === 'multiple' ? '倍数' : `${betContent}倍数`
  } else {
    return betContent
  }
}
```

**说明：**
- 当 `betContent = 'multiple'`（合并标识）时，显示：**倍数**
- 当 `betContent` 为具体数值时，显示：**1000倍数**（兼容性，通常不会出现）
- 组合下注保持不变

---

## 数据流示例

### 场景：用户多次进行倍数下注

#### 1. 用户操作
```
用户A：
- 第一次：下注1000分（倍数下注）
- 第二次：下注500分（倍数下注）
- 第三次：下注300分（倍数下注）
```

#### 2. 数据库存储（bets 表）
```sql
| id | userId | issue   | betType  | betContent | amount | fee | status  |
|----|--------|---------|----------|------------|--------|-----|---------|
| 1  | 3      | 3364706 | multiple | 1000       | 1000   | 30  | pending |
| 2  | 3      | 3364706 | multiple | 500        | 500    | 15  | pending |
| 3  | 3      | 3364706 | multiple | 300        | 300    | 9   | pending |
```

#### 3. 后端API响应（`/api/user/current-issue-bets`）
```json
{
  "code": 200,
  "data": {
    "issue": "3364706",
    "bets": [
      {
        "betType": "multiple",
        "betContent": "multiple",
        "totalAmount": 1800,
        "totalFee": 54,
        "betIds": [1, 2, 3]
      }
    ],
    "canCancel": true
  }
}
```

#### 4. 前端显示
```
本期下注  第3364706期
┌─────────────────────────┐
│ 倍数  1800分  ❌         │
└─────────────────────────┘
```

#### 5. 用户点击取消
- 前端调用：`POST /api/user/cancel-bet`
  ```json
  {
    "issue": "3364706",
    "betType": "multiple",
    "betContent": "multiple"
  }
  ```
- 后端处理：
  - 查询所有 `betType = 'multiple'` 的记录（ID: 1, 2, 3）
  - 计算退款：1800 + 54 = 1854分
  - 更新状态为 `cancelled`
  - 退回积分

---

## 组合下注不受影响

### 场景：用户多次进行组合下注

#### 用户操作
```
用户A：
- 下注：大 500分
- 下注：小双 300分
- 下注：大 200分（与第一次相同玩法，会合并）
```

#### 前端显示
```
本期下注  第3364706期
┌─────────────────────────┐
│ 大    700分  ❌          │  ← 两次"大"合并
│ 小双  300分  ❌          │
└─────────────────────────┘
```

#### 取消逻辑
- 点击"大"右侧的❌：取消所有"大"的下注（700分）
- 点击"小双"右侧的❌：取消所有"小双"的下注（300分）

**结论：** 组合下注仍然按**具体内容**（大/小/单/双等）分组，行为不变。

---

## 测试场景

### 测试1：倍数下注合并显示
1. 登录系统
2. 进行倍数下注：1000分
3. 再次进行倍数下注：500分
4. 查看"当期下注"区域
5. ✅ 验证：只显示一个"倍数 1500分"

### 测试2：倍数下注一键取消
1. 完成测试1
2. 点击"倍数"右侧的❌
3. 确认取消
4. ✅ 验证：
   - 显示"取消成功！退回积分：1545"
   - 区域消失（无其他下注）
   - 积分正确增加

### 测试3：混合下注（倍数+组合）
1. 下注：倍数 1000分
2. 下注：大 500分
3. 下注：倍数 500分
4. 查看"当期下注"区域
5. ✅ 验证：显示两个下注项
   - "倍数 1500分"（合并）
   - "大 500分"

### 测试4：组合下注不受影响
1. 下注：大 500分
2. 下注：小双 300分
3. 下注：大 200分
4. 查看"当期下注"区域
5. ✅ 验证：显示两个下注项
   - "大 700分"（合并）
   - "小双 300分"

### 测试5：取消后重新下注
1. 下注：倍数 1000分
2. 取消
3. 重新下注：倍数 800分
4. 查看"当期下注"区域
5. ✅ 验证：显示"倍数 800分"

---

## API 接口说明

### 1. 获取当期下注
**接口：** `GET /api/user/current-issue-bets`

**响应示例（倍数下注合并）：**
```json
{
  "code": 200,
  "data": {
    "issue": "3364706",
    "bets": [
      {
        "betType": "multiple",
        "betContent": "multiple",  // ← 合并标识
        "totalAmount": 1500,
        "totalFee": 45,
        "betIds": [1, 2]
      }
    ],
    "canCancel": true
  }
}
```

### 2. 取消下注
**接口：** `POST /api/user/cancel-bet`

**请求示例（取消倍数下注）：**
```json
{
  "issue": "3364706",
  "betType": "multiple",
  "betContent": "multiple"  // ← 对倍数下注，这个值会被忽略
}
```

**请求示例（取消组合下注）：**
```json
{
  "issue": "3364706",
  "betType": "combo",
  "betContent": "大"  // ← 对组合下注，需要精确匹配
}
```

---

## 影响范围

### 受影响的功能
1. ✅ 首页"当期下注展示"区域
2. ✅ 取消下注功能

### 不受影响的功能
1. ✅ 下注提交（逻辑不变，仍然单独存储每笔下注）
2. ✅ 投注历史（显示历史记录，不受影响）
3. ✅ 积分账单（显示积分流水，不受影响）
4. ✅ 结算逻辑（后台定时任务，不受影响）

---

## 兼容性说明

### 向后兼容
- ✅ 旧的下注记录不受影响
- ✅ 如果 `betContent` 不是 'multiple'（旧数据或其他情况），前端会显示具体数值（如"1000倍数"）
- ✅ 组合下注逻辑完全不变

### 数据库无需修改
- ✅ 不需要修改表结构
- ✅ 不需要迁移数据
- ✅ 只是查询和展示逻辑的优化

---

## 总结

### 优化前后对比

| 维度 | 优化前 | 优化后 |
|------|--------|--------|
| **显示方式** | 按金额分开（1000倍数、500倍数） | 合并显示（倍数 1500分） |
| **取消操作** | 需要分别取消多个项 | 一键取消所有倍数下注 |
| **界面简洁度** | 较繁琐 | 简洁清晰 |
| **用户体验** | 较差 | 优秀 |
| **组合下注** | 按内容分组 | 不变（仍按内容分组） |

### 技术特点
- ✅ **后端优化**：按玩法类型智能分组
- ✅ **前端适配**：智能显示格式
- ✅ **完全兼容**：不影响其他功能
- ✅ **零数据迁移**：无需修改数据库

该优化显著提升了用户体验，使"当期下注展示"功能更加符合用户的心智模型！🎉



