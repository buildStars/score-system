# âœ… H5 ä»åç«¯åŠ è½½ä¸‹æ³¨è®¾ç½®

## ğŸ“ éœ€æ±‚

H5 é¦–é¡µæŠ•æ³¨æ—¶åº”è¯¥ä»ç®¡ç†åå°çš„"æ¨¡å¼è®¾ç½®"ï¼ˆ`bet_type_settings` è¡¨ï¼‰è·å–ï¼š
- **æœ€å°ä¸‹æ³¨é‡‘é¢** (`minBet`)
- **æœ€å¤§ä¸‹æ³¨é‡‘é¢** (`maxBet`)
- **æ‰‹ç»­è´¹ç‡** (`feeRate`)
- **æ˜¯å¦å¯ç”¨** (`isEnabled`)
- **æ˜¾ç¤ºåç§°** (`name`)

## âœ… å®ç°æ–¹æ¡ˆ

### 1. åç«¯ï¼šæ·»åŠ å…¬å¼€API

#### æ–‡ä»¶ï¼š`lottery.controller.ts`

```typescript
@Public()
@Get('bet-type-settings')
@ApiOperation({ summary: 'è·å–æ‰€æœ‰å¯ç”¨çš„ä¸‹æ³¨ç±»å‹é…ç½®ï¼ˆå…¬å¼€æ¥å£ï¼‰' })
@ApiResponse({ status: 200, description: 'è·å–æˆåŠŸ' })
async getBetTypeSettings() {
  return await this.prisma.betTypeSetting.findMany({
    where: { isEnabled: true },
    orderBy: { sortOrder: 'asc' },
    select: {
      betType: true,
      name: true,
      minBet: true,
      maxBet: true,
      feeRate: true,
      isEnabled: true,
      description: true,
    },
  });
}
```

**è¦ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `@Public()` è£…é¥°å™¨ï¼Œæ— éœ€è®¤è¯
- âœ… åªè¿”å› `isEnabled: true` çš„é…ç½®
- âœ… è·¯å¾„ï¼š`/api/lottery/bet-type-settings`ï¼ˆåœ¨ lottery æ¨¡å—ä¸‹ï¼Œä¸æ˜¯ adminï¼‰
- âœ… åªè¿”å›å‰ç«¯éœ€è¦çš„å­—æ®µï¼ˆä¸åŒ…æ‹¬ `odds`ï¼Œå› ä¸ºç³»ç»Ÿä¸ç”¨èµ”ç‡ï¼‰

#### æ–‡ä»¶ï¼š`roles.guard.ts`

```typescript
canActivate(context: ExecutionContext): boolean {
  // æ£€æŸ¥æ˜¯å¦ä¸ºå…¬å¼€è·¯ç”±
  const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
    context.getHandler(),
    context.getClass(),
  ]);
  
  if (isPublic) {
    return true;
  }
  
  // ... åŸæœ‰é€»è¾‘
}
```

**è¦ç‚¹**ï¼š
- âœ… ä¿®å¤ `RolesGuard`ï¼Œæ”¯æŒ `@Public()` è£…é¥°å™¨
- âœ… å…¬å¼€è·¯ç”±å³ä½¿åœ¨éœ€è¦æƒé™çš„ Controller ä¸­ä¹Ÿèƒ½æ­£å¸¸è®¿é—®

---

### 2. å‰ç«¯ï¼šAPI ç±»å‹å®šä¹‰

#### æ–‡ä»¶ï¼š`frontend-h5/src/api/system.ts`

```typescript
/**
 * ä¸‹æ³¨ç±»å‹è®¾ç½®ï¼ˆä» bet_type_settings è¡¨ï¼‰
 */
export interface BetTypeSetting {
  betType: string         // ä¸‹æ³¨ç±»å‹ï¼ˆbig, small, odd, even, combo, multipleç­‰ï¼‰
  name: string            // æ˜¾ç¤ºåç§°
  minBet: number          // æœ€å°ä¸‹æ³¨é‡‘é¢
  maxBet: number          // æœ€å¤§ä¸‹æ³¨é‡‘é¢
  feeRate: number         // æ‰‹ç»­è´¹ç‡ï¼ˆå°æ•°ï¼Œå¦‚0.03è¡¨ç¤º3%ï¼‰
  isEnabled: boolean      // æ˜¯å¦å¯ç”¨
  description: string     // æè¿°
}

/**
 * è·å–æ‰€æœ‰å¯ç”¨çš„ä¸‹æ³¨ç±»å‹è®¾ç½®ï¼ˆå…¬å¼€æ¥å£ï¼Œæ— éœ€è®¤è¯ï¼‰
 */
export function getBetTypeSettings(): Promise<ApiResponse<BetTypeSetting[]>> {
  return request.get('/lottery/bet-type-settings')
}
```

---

### 3. å‰ç«¯ï¼šHome.vue ä½¿ç”¨

#### æ•°æ®ç»“æ„

```typescript
// ä¸‹æ³¨ç±»å‹è®¾ç½®ï¼ˆä»åç«¯è·å–ï¼‰
const betTypeSettings = ref<BetTypeSetting[]>([])

// è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®ä¸‹æ³¨ç±»å‹è·å–è®¾ç½®
const getBetTypeSetting = (betType: string): BetTypeSetting | null => {
  return betTypeSettings.value.find(s => s.betType === betType) || null
}

// è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®ä¸‹æ³¨å†…å®¹è·å–å¯¹åº”çš„ betType
const getBetTypeFromContent = (content: string): string => {
  if (content === 'å€æ•°') return 'multiple'
  if (content === 'å¤§') return 'big'
  if (content === 'å°') return 'small'
  if (content === 'å•') return 'odd'
  if (content === 'åŒ') return 'even'
  if (['å¤§å•', 'å¤§åŒ', 'å°å•', 'å°åŒ'].includes(content)) return 'combo'
  return 'big' // é»˜è®¤
}
```

#### è®¡ç®—æ‰‹ç»­è´¹

```typescript
const calculateFee = (type: string) => {
  const amount = type === 'multiple' ? Number(multipleBet.amount) : Number(comboBet.amount)
  if (!amount || amount <= 0) return '0.00'

  // è·å–å¯¹åº”ç±»å‹çš„è®¾ç½®
  const setting = getBetTypeSetting(type)
  if (!setting) return '0.00'

  // feeRate æ˜¯å°æ•°ï¼ˆå¦‚ 0.03 è¡¨ç¤º 3%ï¼‰
  const fee = Math.floor(amount * Number(setting.feeRate))
  return formatMoney(fee)
}
```

**è¦ç‚¹**ï¼š
- âœ… `feeRate` æ˜¯å°æ•°ï¼ˆå¦‚ `0.03` è¡¨ç¤º 3%ï¼‰ï¼Œä¸æ˜¯ç™¾åˆ†æ¯”
- âœ… ç›´æ¥ä¹˜ä»¥é‡‘é¢å³å¯ï¼Œæ— éœ€é™¤ä»¥ 100

#### éªŒè¯é‡‘é¢èŒƒå›´

```typescript
// éªŒè¯é‡‘é¢èŒƒå›´ï¼ˆä½¿ç”¨åç«¯è®¾ç½®ï¼‰
const setting = getBetTypeSetting(type)
if (setting) {
  if (amount < Number(setting.minBet)) {
    showToast({
      message: `âš ï¸ ${setting.name} æœ€å°ä¸‹æ³¨é‡‘é¢ä¸º ${formatMoney(Number(setting.minBet))}`,
      type: 'fail',
      duration: 2000,
    })
    return
  }

  if (amount > Number(setting.maxBet)) {
    showToast({
      message: `âš ï¸ ${setting.name} æœ€å¤§ä¸‹æ³¨é‡‘é¢ä¸º ${formatMoney(Number(setting.maxBet))}`,
      type: 'fail',
      duration: 2000,
    })
    return
  }
}
```

**è¦ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `setting.name` æ˜¾ç¤ºå‹å¥½çš„ç±»å‹åç§°ï¼ˆå¦‚"å¤§"ã€"å°"ï¼‰
- âœ… ä½¿ç”¨ `minBet` å’Œ `maxBet` è¿›è¡ŒéªŒè¯
- âœ… `minBet` å’Œ `maxBet` æ˜¯ `Decimal` ç±»å‹ï¼Œéœ€è¦ `Number()` è½¬æ¢

#### é¡µé¢åŠ è½½æ—¶è·å–è®¾ç½®

```typescript
const loadBetTypeSettings = async () => {
  try {
    const res = await getBetTypeSettings()
    if (res.data) {
      betTypeSettings.value = res.data
      console.log('âœ… ä¸‹æ³¨ç±»å‹è®¾ç½®åŠ è½½æˆåŠŸ:', betTypeSettings.value)
    }
  } catch (error) {
    console.error('âŒ åŠ è½½ä¸‹æ³¨ç±»å‹è®¾ç½®å¤±è´¥:', error)
    // å‡ºé”™æ—¶ä½¿ç”¨ç©ºæ•°ç»„ï¼Œå‰ç«¯å°†æ— æ³•éªŒè¯
  }
}

onMounted(async () => {
  // å…ˆåŠ è½½ä¸‹æ³¨ç±»å‹è®¾ç½®
  await loadBetTypeSettings()
  // loadCurrentData() ä¼šè‡ªåŠ¨åŠ è½½ loadCurrentIssueBets()
  loadCurrentData()
})
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### `bet_type_settings` è¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `betType` | String | ä¸‹æ³¨ç±»å‹æ ‡è¯† | `big`, `small`, `odd`, `even`, `combo`, `multiple` |
| `name` | String | æ˜¾ç¤ºåç§° | "å¤§", "å°", "å•", "åŒ", "ç»„åˆ", "å€æ•°" |
| `odds` | Decimal | èµ”ç‡ï¼ˆæœ¬ç³»ç»Ÿä¸ä½¿ç”¨ï¼‰ | `1.95` |
| `minBet` | Decimal | æœ€å°ä¸‹æ³¨é‡‘é¢ | `1.00` |
| `maxBet` | Decimal | æœ€å¤§ä¸‹æ³¨é‡‘é¢ | `100000.00` |
| `feeRate` | Decimal | æ‰‹ç»­è´¹ç‡ï¼ˆå°æ•°ï¼‰ | `0.03`ï¼ˆè¡¨ç¤º3%ï¼‰ |
| `isEnabled` | Boolean | æ˜¯å¦å¯ç”¨ | `true` |
| `sortOrder` | Int | æ’åº | `1`, `2`, `3`... |
| `description` | String | æè¿° | "æ€»å’Œâ‰¥14" |

---

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### åç«¯

1. âœ… `backend/src/modules/lottery/lottery.controller.ts`
   - æ·»åŠ  `@Public() getBetTypeSettings()` æ¥å£
   - æ³¨å…¥ `PrismaService`

2. âœ… `backend/src/common/guards/roles.guard.ts`
   - æ·»åŠ  `@Public()` è£…é¥°å™¨æ”¯æŒ
   - å¯¼å…¥ `IS_PUBLIC_KEY`

### å‰ç«¯

1. âœ… `frontend-h5/src/api/system.ts`
   - å®šä¹‰ `BetTypeSetting` æ¥å£
   - æ·»åŠ  `getBetTypeSettings()` API è°ƒç”¨

2. âœ… `frontend-h5/src/api/index.ts`
   - å¯¼å‡º `getBetTypeSettings`

3. âœ… `frontend-h5/src/views/Home.vue`
   - å¯¼å…¥ `getBetTypeSettings` å’Œ `BetTypeSetting` ç±»å‹
   - æ·»åŠ  `betTypeSettings` çŠ¶æ€
   - æ·»åŠ  `getBetTypeSetting()` å’Œ `getBetTypeFromContent()` è¾…åŠ©å‡½æ•°
   - æ›´æ–° `calculateFee()` ä½¿ç”¨ `feeRate`
   - æ›´æ–°é‡‘é¢éªŒè¯ä½¿ç”¨ `minBet` å’Œ `maxBet`
   - æ·»åŠ  `loadBetTypeSettings()` å‡½æ•°
   - åœ¨ `onMounted` ä¸­è°ƒç”¨

---

## ğŸ¯ ä¼˜åŠ¿

### 1. ç»Ÿä¸€é…ç½®æº

- âœ… ç®¡ç†å‘˜åœ¨åå°ä¿®æ”¹è®¾ç½®ï¼ŒH5 ç«‹å³ç”Ÿæ•ˆ
- âœ… æ— éœ€å‰åç«¯åŒæ—¶ä¿®æ”¹
- âœ… é¿å…é…ç½®ä¸ä¸€è‡´

### 2. çµæ´»æ€§

- âœ… å¯ä»¥ä¸ºä¸åŒä¸‹æ³¨ç±»å‹è®¾ç½®ä¸åŒçš„æœ€å°/æœ€å¤§é‡‘é¢
- âœ… å¯ä»¥åŠ¨æ€å¯ç”¨/ç¦ç”¨æŸäº›ä¸‹æ³¨ç±»å‹
- âœ… å¯ä»¥è°ƒæ•´æ‰‹ç»­è´¹ç‡

### 3. ç”¨æˆ·ä½“éªŒ

- âœ… é”™è¯¯æç¤ºæ˜¾ç¤ºå…·ä½“çš„ç±»å‹åç§°ï¼ˆå¦‚"å¤§ æœ€å°ä¸‹æ³¨é‡‘é¢ä¸º 1"ï¼‰
- âœ… æ‰‹ç»­è´¹è®¡ç®—å‡†ç¡®
- âœ… å®æ—¶éªŒè¯ï¼Œé¿å…æ— æ•ˆè¯·æ±‚

### 4. å®‰å…¨æ€§

- âœ… å‰ç«¯éªŒè¯ + åç«¯éªŒè¯åŒé‡ä¿éšœ
- âœ… å…¬å¼€æ¥å£åªè¿”å›å¿…è¦å­—æ®µ
- âœ… åªè¿”å›å·²å¯ç”¨çš„é…ç½®

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç®¡ç†å‘˜è®¾ç½®

ç®¡ç†å‘˜åœ¨åå°è®¾ç½®ï¼š

```json
{
  "betType": "big",
  "name": "å¤§",
  "minBet": 10,
  "maxBet": 100000,
  "feeRate": 0.03,
  "isEnabled": true,
  "description": "æ€»å’Œâ‰¥14"
}
```

### H5 è‡ªåŠ¨åº”ç”¨

ç”¨æˆ·ä¸‹æ³¨"å¤§"æ—¶ï¼š
- âœ… æœ€å°é‡‘é¢ï¼š10
- âœ… æœ€å¤§é‡‘é¢ï¼š100000
- âœ… æ‰‹ç»­è´¹ï¼š`ä¸‹æ³¨é‡‘é¢ Ã— 0.03 = ä¸‹æ³¨é‡‘é¢ Ã— 3%`

å¦‚æœç®¡ç†å‘˜ä¿®æ”¹ä¸ºï¼š
```json
{
  "minBet": 100,
  "feeRate": 0.05
}
```

H5 åˆ·æ–°åè‡ªåŠ¨åº”ç”¨æ–°é…ç½®ï¼š
- âœ… æœ€å°é‡‘é¢ï¼š100
- âœ… æ‰‹ç»­è´¹ï¼š`ä¸‹æ³¨é‡‘é¢ Ã— 0.05 = ä¸‹æ³¨é‡‘é¢ Ã— 5%`

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. feeRate æ˜¯å°æ•°

```typescript
// âŒ é”™è¯¯
const fee = (amount / 100) * feeRate  // ä»¥ä¸º feeRate æ˜¯ 3 è¡¨ç¤º 3%

// âœ… æ­£ç¡®
const fee = amount * feeRate  // feeRate æœ¬èº«å°±æ˜¯ 0.03ï¼ˆ3%ï¼‰
```

### 2. minBet/maxBet éœ€è¦ç±»å‹è½¬æ¢

```typescript
// Prisma è¿”å›çš„æ˜¯ Decimal å¯¹è±¡
if (amount < Number(setting.minBet)) {  // âœ… éœ€è¦ Number() è½¬æ¢
  // ...
}
```

### 3. ç©ºæ•°ç»„å¤„ç†

å¦‚æœåç«¯è¯·æ±‚å¤±è´¥ï¼Œ`betTypeSettings` ä¸ºç©ºæ•°ç»„ï¼š
- `getBetTypeSetting()` è¿”å› `null`
- ä¸è¿›è¡ŒéªŒè¯ï¼ˆå…è®¸ä¸‹æ³¨ï¼Œç”±åç«¯æœ€ç»ˆéªŒè¯ï¼‰
- æ‰‹ç»­è´¹æ˜¾ç¤ºä¸º `0.00`

### 4. é»˜è®¤å€¼

`getBetTypeFromContent()` æœ‰é»˜è®¤è¿”å›å€¼ `'big'`ï¼Œç¡®ä¿å§‹ç»ˆæœ‰ç±»å‹ï¼š
```typescript
const getBetTypeFromContent = (content: string): string => {
  if (content === 'å€æ•°') return 'multiple'
  // ...
  return 'big' // é»˜è®¤
}
```

---

**å®ç°æ—¶é—´**ï¼š2025-11-29  
**å½±å“èŒƒå›´**ï¼šH5 ä¸‹æ³¨éªŒè¯é€»è¾‘  
**å‘ä¸‹å…¼å®¹**ï¼šâœ… æ˜¯ï¼ˆå¦‚æœåç«¯è¯·æ±‚å¤±è´¥ï¼Œå‰ç«¯ä»å¯å·¥ä½œï¼‰  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

