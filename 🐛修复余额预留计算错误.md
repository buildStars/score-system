# ğŸ› ä¿®å¤ä½™é¢é¢„ç•™è®¡ç®—é”™è¯¯ï¼ˆä¸¥é‡bugï¼‰

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆç”Ÿäº§ç¯å¢ƒä¸­ä½™é¢é¢„ç•™è®¡ç®—ä¸æ­£ç¡®ï¼š

### é—®é¢˜1ï¼šå€æ•°ä¸‹æ³¨é¢„ç•™åˆ†é”™è¯¯
- **é”™è¯¯è¡¨ç°**ï¼šä¸‹350å€æ•°ï¼Œç³»ç»Ÿè¦æ±‚350åˆ†
- **æ­£ç¡®åº”è¯¥**ï¼š350 Ã— 0.8 + æ‰‹ç»­è´¹ = 280 + 10 = **290åˆ†**

### é—®é¢˜2ï¼šç»„åˆä¸‹æ³¨é¢„ç•™åˆ†é”™è¯¯
- **é”™è¯¯è¡¨ç°**ï¼šä¸‹635å¤§åŒï¼Œç³»ç»Ÿè¦æ±‚350åˆ†
- **æ­£ç¡®åº”è¯¥**ï¼š635 Ã— 5 + æ‰‹ç»­è´¹ = 3175 + 31 = **3206åˆ†**

## æ ¹æœ¬åŸå› 

**æ–‡ä»¶**ï¼š`score-system/backend/src/modules/lottery/utils/lottery-rules.util.ts`

**é—®é¢˜ä»£ç **ï¼š
```typescript
export function calculateMinimumBalance(betType, amount, betContent, ...) {
  if (betType === 'multiple') {
    // âœ… å€æ•°é€»è¾‘æ­£ç¡®
    const fee = Math.floor((amount / 100) * 3);
    const minimumBalance = amount * 0.8 + fee;
    return { minimumBalance, breakdown: ... };
  }
  
  if (betType === 'combo') {  // âŒ é—®é¢˜åœ¨è¿™é‡Œï¼
    const isBigSmallOddEven = ['å¤§', 'å°', 'å•', 'åŒ'].includes(betContent || '');
    
    if (isBigSmallOddEven) {
      return { minimumBalance: amount, breakdown: `æœ¬é‡‘ ${amount}` };
    } else {
      // ç»„åˆé€»è¾‘
      const fee = Math.floor((amount / 100) * 5);
      const minimumBalance = amount * 5 + fee;
      return { minimumBalance, breakdown: ... };
    }
  }
  
  // âŒ é»˜è®¤è¿”å›æœ¬é‡‘ï¼ˆå¯¼è‡´ç»„åˆä¸‹æ³¨åªè¦æ±‚æœ¬é‡‘ï¼‰
  return {
    minimumBalance: amount,
    breakdown: `æœ¬é‡‘ ${amount}`,
  };
}
```

**é—®é¢˜åˆ†æ**ï¼š
1. **å‰ç«¯å‘é€**ï¼šç”¨æˆ·é€‰æ‹©"å¤§åŒ"æ—¶ï¼Œå‘é€ `betType='big_even', betContent='å¤§åŒ'`
2. **åç«¯åˆ¤æ–­**ï¼šå‡½æ•°åªæ£€æŸ¥ `if (betType === 'combo')`ï¼Œä½†å®é™…æ”¶åˆ°çš„æ˜¯ `'big_even'`
3. **é”™è¯¯ç»“æœ**ï¼šè·³è¿‡æ‰€æœ‰åˆ†æ”¯ï¼Œèµ°åˆ°é»˜è®¤çš„ `return { minimumBalance: amount }`
4. **åæœ**ï¼šç»„åˆä¸‹æ³¨åªè¦æ±‚æœ¬é‡‘ï¼Œåº”è¯¥è¦æ±‚ `æœ¬é‡‘ Ã— 5 + æ‰‹ç»­è´¹`

## ä¿®å¤æ–¹æ¡ˆ

**ä¿®æ”¹åçš„ä»£ç **ï¼š
```typescript
export function calculateMinimumBalance(betType, amount, betContent, ...) {
  if (betType === 'multiple') {
    // å€æ•°ä¸‹æ³¨ï¼šå€æ•° Ã— 0.8 + æ‰‹ç»­è´¹
    const fee = Math.floor((amount / (feeBase || 100)) * (feeRate || 3));
    const minimumBalance = amount * multipleLossRate + fee;
    return { minimumBalance, breakdown: ... };
  }
  
  // âœ… åˆ¤æ–­æ˜¯å¦ä¸ºå¤§å°å•åŒï¼ˆæŒ‰ betType åˆ¤æ–­ï¼‰
  const isBigSmallOddEven = betType === 'big' || betType === 'small' || 
                            betType === 'odd' || betType === 'even' ||
                            ['å¤§', 'å°', 'å•', 'åŒ'].includes(betContent || '');
  
  if (isBigSmallOddEven) {
    // å¤§å°å•åŒï¼šæœ€ä½ä½™é¢ = æœ¬é‡‘
    return {
      minimumBalance: amount,
      breakdown: `æœ¬é‡‘ ${amount}`,
    };
  }
  
  // âœ… åˆ¤æ–­æ˜¯å¦ä¸ºç»„åˆä¸‹æ³¨ï¼ˆæŒ‰ betType åˆ¤æ–­ï¼‰
  const isCombo = betType === 'big_odd' || betType === 'big_even' || 
                  betType === 'small_odd' || betType === 'small_even' ||
                  betType === 'combo' ||
                  ['å¤§å•', 'å¤§åŒ', 'å°å•', 'å°åŒ'].includes(betContent || '');
  
  if (isCombo) {
    // ç»„åˆï¼šæœ€ä½ä½™é¢ = æœ¬é‡‘ Ã— 5 + æ‰‹ç»­è´¹
    const fee = Math.floor((amount / (feeBase || 100)) * (feeRate || 5));
    const minimumBalance = amount * 5 + fee;
    return { minimumBalance, breakdown: ... };
  }
  
  // é»˜è®¤ï¼šè¿”å›æœ¬é‡‘
  return {
    minimumBalance: amount,
    breakdown: `æœ¬é‡‘ ${amount}`,
  };
}
```

## ä¿®å¤éªŒè¯

### æµ‹è¯•1ï¼šå€æ•°ä¸‹æ³¨ï¼ˆ350å€ï¼‰
- **è®¡ç®—ç»“æœ**ï¼š290
- **è¯¦ç»†**ï¼šå€æ•° 350 Ã— 0.8 + æ‰‹ç»­è´¹ 10 = 290
- **âœ… æ­£ç¡®**

### æµ‹è¯•2ï¼šå€æ•°ä¸‹æ³¨ï¼ˆ100å€ï¼‰
- **è®¡ç®—ç»“æœ**ï¼š83
- **è¯¦ç»†**ï¼šå€æ•° 100 Ã— 0.8 + æ‰‹ç»­è´¹ 3 = 83
- **âœ… æ­£ç¡®**

### æµ‹è¯•3ï¼šå¤§åŒç»„åˆï¼ˆ635åˆ†ï¼‰
- **è®¡ç®—ç»“æœ**ï¼š3206
- **è¯¦ç»†**ï¼šæœ¬é‡‘ 635 Ã— 5 + æ‰‹ç»­è´¹ 31 = 3206
- **âœ… æ­£ç¡®**ï¼ˆä¿®å¤å‰æ˜¯635ï¼‰

### æµ‹è¯•4ï¼šå°å•ç»„åˆï¼ˆ100åˆ†ï¼‰
- **è®¡ç®—ç»“æœ**ï¼š505
- **è¯¦ç»†**ï¼šæœ¬é‡‘ 100 Ã— 5 + æ‰‹ç»­è´¹ 5 = 505
- **âœ… æ­£ç¡®**

### æµ‹è¯•5ï¼šå¤§ï¼ˆå¤§å°å•åŒï¼Œ500åˆ†ï¼‰
- **è®¡ç®—ç»“æœ**ï¼š500
- **è¯¦ç»†**ï¼šæœ¬é‡‘ 500
- **âœ… æ­£ç¡®**

### æµ‹è¯•6ï¼šå•ï¼ˆå¤§å°å•åŒï¼Œ300åˆ†ï¼‰
- **è®¡ç®—ç»“æœ**ï¼š300
- **è¯¦ç»†**ï¼šæœ¬é‡‘ 300
- **âœ… æ­£ç¡®**

## å½±å“èŒƒå›´

**ä¸¥é‡ç¨‹åº¦**ï¼šğŸ”´ **é«˜å±bug**

**å½±å“**ï¼š
1. âŒ **ç»„åˆä¸‹æ³¨å¯ä»¥ç”¨æå°‘ç§¯åˆ†ä¸‹å¤§é¢æ³¨å•**ï¼ˆä¾‹å¦‚ï¼š635åˆ†å¯ä»¥ä¸‹635å¤§åŒï¼Œå®é™…åº”éœ€è¦3206åˆ†ï¼‰
2. âŒ **å¯èƒ½å¯¼è‡´ç”¨æˆ·èµ„é‡‘é£é™©**ï¼ˆç”¨æˆ·å®é™…ä½™é¢ä¸è¶³ä»¥æ”¯ä»˜å¯èƒ½çš„æŸå¤±ï¼‰
3. âŒ **ç³»ç»Ÿèµ„é‡‘å¹³è¡¡å¯èƒ½å‡ºç°é—®é¢˜**

**ä¿®å¤å‰çš„è¡Œä¸º**ï¼š
- å€æ•°ä¸‹æ³¨ï¼šâœ… æ­£ç¡®ï¼ˆå€æ•° Ã— 0.8 + æ‰‹ç»­è´¹ï¼‰
- å¤§å°å•åŒï¼šâœ… æ­£ç¡®ï¼ˆæœ¬é‡‘ï¼‰
- **ç»„åˆä¸‹æ³¨**ï¼šâŒ **é”™è¯¯**ï¼ˆåªè¦æ±‚æœ¬é‡‘ï¼Œåº”è¯¥æ˜¯æœ¬é‡‘ Ã— 5 + æ‰‹ç»­è´¹ï¼‰

**ä¿®å¤åçš„è¡Œä¸º**ï¼š
- å€æ•°ä¸‹æ³¨ï¼šâœ… æ­£ç¡®ï¼ˆå€æ•° Ã— 0.8 + æ‰‹ç»­è´¹ï¼‰
- å¤§å°å•åŒï¼šâœ… æ­£ç¡®ï¼ˆæœ¬é‡‘ï¼‰
- ç»„åˆä¸‹æ³¨ï¼šâœ… **å·²ä¿®å¤**ï¼ˆæœ¬é‡‘ Ã— 5 + æ‰‹ç»­è´¹ï¼‰

## éƒ¨ç½²æ­¥éª¤

### ç”Ÿäº§ç¯å¢ƒï¼ˆç´§æ€¥ä¿®å¤ï¼‰

```bash
cd /path/to/score-system

# 1. åœæ­¢æœåŠ¡
docker-compose down

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull

# 3. é‡æ–°æ„å»ºåç«¯
docker-compose build backend

# 4. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 5. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å¯åŠ¨æˆåŠŸ
docker-compose logs -f backend
```

### å¼€å‘ç¯å¢ƒ

```bash
cd score-system/backend

# é‡æ–°ç¼–è¯‘
npm run build

# æˆ–å¼€å‘æ¨¡å¼ï¼ˆä¼šè‡ªåŠ¨é‡å¯ï¼‰
npm run start:dev
```

## å»ºè®®

1. **ç«‹å³éƒ¨ç½²**ï¼šè¿™æ˜¯ä¸¥é‡çš„èµ„é‡‘å®‰å…¨bugï¼Œå»ºè®®ç«‹å³ä¿®å¤
2. **æ•°æ®å®¡è®¡**ï¼šæ£€æŸ¥å†å²æ•°æ®ï¼Œæ˜¯å¦æœ‰ç”¨æˆ·åˆ©ç”¨æ­¤bugä¸‹äº†å¤§é¢ç»„åˆæ³¨å•
3. **ä½™é¢ä¿®æ­£**ï¼šå¦‚æœå‘ç°å¼‚å¸¸ä¸‹æ³¨è®°å½•ï¼Œéœ€è¦äººå·¥å®¡æ ¸å¹¶ä¿®æ­£ç”¨æˆ·ä½™é¢

## ä¿®æ”¹æ–‡ä»¶

- `score-system/backend/src/modules/lottery/utils/lottery-rules.util.ts` - ä¿®å¤ `calculateMinimumBalance` å‡½æ•°

