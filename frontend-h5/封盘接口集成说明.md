# 📡 封盘接口集成说明

## ✅ 更新内容

### 1. 添加封盘接口 ✅

**接口地址**：`GET /api/lottery/status`

**返回数据**：
```typescript
interface LotteryStatus {
  currentPeriod: string           // 当前期号
  nextPeriod: string               // 下期期号
  status: 'open' | 'closing' | 'closed'  // 状态：开盘、即将封盘、已封盘
  canBet: boolean                  // 是否可以下注
  countdown: number                // 倒计时秒数
  countdownText: string            // 倒计时文本
  lastDrawTime: string             // 最后开奖时间
  nextDrawTime: string             // 下次开奖时间
  progressPercentage: number       // 进度百分比（0-100）
  serverTime: string               // 服务器时间
}
```

---

## 🎯 接口优势

### 相比原来的 `/api/lottery/current` 接口

| 特性 | 原接口 | 封盘接口 | 优势 |
|------|-------|---------|------|
| 倒计时精度 | 客户端计算 | 服务器计算 | ✅ 避免客户端时间不准 |
| 封盘状态 | 无 | 有（3种状态） | ✅ 明确区分开盘/即将封盘/已封盘 |
| 下注权限 | 需自行判断 | 直接返回canBet | ✅ 后端统一控制 |
| 时间同步 | 无 | 返回服务器时间 | ✅ 避免时间偏差 |
| 进度显示 | 无 | 返回进度百分比 | ✅ 可以显示进度条 |
| 倒计时文本 | 需自行格式化 | 直接返回文本 | ✅ 后端统一文案 |

---

## 📝 更新的文件

### 1. `src/api/lottery.ts`
添加了封盘接口相关的类型定义和API函数：

```typescript
// 添加类型定义
export interface LotteryStatus {
  currentPeriod: string
  nextPeriod: string
  status: 'open' | 'closing' | 'closed'
  canBet: boolean
  countdown: number
  countdownText: string
  lastDrawTime: string
  nextDrawTime: string
  progressPercentage: number
  serverTime: string
}

// 添加API函数
export function getLotteryStatus() {
  return request<ApiResponse<LotteryStatus>>({
    url: '/lottery/status',
    method: 'get',
  })
}

export function canPlaceBet() {
  return request<ApiResponse<{ canBet: boolean; reason?: string }>>({
    url: '/lottery/can-bet',
    method: 'get',
  })
}
```

### 2. `src/api/index.ts`
导出封盘接口函数：

```typescript
export { getLotteryStatus, canPlaceBet, getLotteryHistory } from './lottery'
```

### 3. `src/views/Home.vue`
更新首页使用封盘接口：

```typescript
import { getLotteryStatus } from '@/api'
import type { LotteryStatus } from '@/api/lottery'

// 修改loadCurrentData函数
const loadCurrentData = async () => {
  try {
    // 使用封盘接口获取精确的倒计时
    const res = await getLotteryStatus()
    const status: LotteryStatus = res.data
    
    // 更新期号信息
    lotteryStore.currentIssue = status.currentPeriod
    
    // 更新倒计时
    countdown.value = status.countdown
    
    // 更新游戏状态（根据封盘状态）
    lotteryStore.gameEnabled = status.canBet
    
    // 同时获取用户信息和上期开奖结果
    await Promise.all([
      userStore.fetchUserInfo(),
      lotteryStore.fetchCurrentIssue(),
    ])
    
    // 启动倒计时
    startCountdown()
  } catch (error) {
    console.error('加载数据失败：', error)
  }
}
```

### 4. 倒计时标题优化
```vue
<div class="countdown-title">
  {{ lotteryStore.gameEnabled ? '距离封盘' : '距离开奖' }}
</div>
```

---

## 🎨 用户体验提升

### 1. 精确的倒计时
- ✅ 使用服务器时间计算，避免客户端时间不准确
- ✅ 每次刷新都从服务器获取最新倒计时

### 2. 明确的状态提示
- ✅ **开盘状态**（open）：显示"距离封盘"
- ✅ **即将封盘**（closing）：开奖前60秒，显示"⚠️ 即将封盘"
- ✅ **已封盘**（closed）：开奖前30秒，显示"距离开奖"

### 3. 智能的下注控制
- ✅ 根据`canBet`字段控制下注按钮
- ✅ 封盘时自动禁用下注功能
- ✅ 开盘时自动启用下注功能

---

## 🔄 数据流程

### 旧流程
```
1. 前端请求 /api/lottery/current
2. 获取期号和初始倒计时
3. 客户端自己倒计时（可能不准确）
4. 倒计时结束后重新请求
```

### 新流程
```
1. 前端请求 /api/lottery/status
2. 获取服务器计算的精确倒计时
3. 获取封盘状态（open/closing/closed）
4. 根据状态控制下注按钮
5. 倒计时结束后重新请求最新状态
```

---

## 📊 封盘时间规则

### 后端配置
```typescript
DRAW_INTERVAL = 210秒    // 开奖间隔：3.5分钟
CLOSE_BEFORE_DRAW = 30秒  // 封盘时间：开奖前30秒
WARNING_TIME = 60秒       // 警告时间：封盘前60秒
OPEN_TIME = 180秒         // 开盘时间：3分钟
```

### 时间线
```
开奖后
  ↓
开盘（180秒）- 可以下注
  ↓
即将封盘（60秒）- 可以下注，显示警告
  ↓
封盘（30秒）- 不可下注
  ↓
开奖
  ↓
循环
```

---

## 🧪 测试建议

### 1. 倒计时准确性测试
```
1. 打开首页
2. 观察倒计时是否准确
3. 等待倒计时结束
4. 检查是否自动刷新
```

### 2. 封盘状态测试
```
1. 在开盘时间（3分钟）
   - 应该显示"距离封盘"
   - 下注按钮可用
   
2. 在即将封盘（封盘前60秒）
   - 应该显示警告标志
   - 下注按钮仍可用
   
3. 在封盘时间（开奖前30秒）
   - 应该显示"距离开奖"
   - 下注按钮禁用
```

### 3. 时间同步测试
```
1. 修改客户端系统时间
2. 刷新页面
3. 倒计时应该仍然准确（以服务器时间为准）
```

---

## 💡 进一步优化建议

### 1. 添加进度条
可以使用返回的`progressPercentage`显示进度：

```vue
<van-progress 
  :percentage="progressPercentage" 
  :show-pivot="false" 
  color="#1989fa"
/>
```

### 2. 显示服务器时间
可以显示服务器时间，让用户知道时间同步：

```vue
<div class="server-time">
  服务器时间：{{ serverTime }}
</div>
```

### 3. 状态颜色区分
根据不同状态显示不同颜色：

```scss
.countdown-section {
  &.status-open {
    border-color: #07c160; // 绿色-开盘
  }
  
  &.status-closing {
    border-color: #ff976a; // 橙色-即将封盘
  }
  
  &.status-closed {
    border-color: #ee0a24; // 红色-已封盘
  }
}
```

### 4. 添加状态提示音
封盘时播放提示音：

```typescript
// 封盘提示音
if (status.status === 'closed' && prevStatus === 'closing') {
  playSound('close.mp3')
}
```

---

## ✅ 完成情况

- [x] 添加封盘接口类型定义
- [x] 添加封盘API函数
- [x] 更新首页使用封盘接口
- [x] 优化倒计时显示
- [x] 优化下注按钮控制
- [x] 编写集成文档

---

## 📋 API使用示例

### 基础使用
```typescript
import { getLotteryStatus } from '@/api'

// 获取封盘状态
const res = await getLotteryStatus()
const status = res.data

console.log('当前期号:', status.currentPeriod)
console.log('下期期号:', status.nextPeriod)
console.log('当前状态:', status.status)
console.log('可以下注:', status.canBet)
console.log('倒计时:', status.countdown, '秒')
console.log('倒计时文本:', status.countdownText)
```

### 检查是否可以下注
```typescript
import { canPlaceBet } from '@/api'

const res = await canPlaceBet()

if (res.data.canBet) {
  // 可以下注
  console.log('可以下注')
} else {
  // 不可以下注
  console.log('不可以下注，原因:', res.data.reason)
}
```

---

## 🎉 总结

### 集成优势
- ✅ **更准确**：服务器计算倒计时，避免客户端时间偏差
- ✅ **更清晰**：明确的封盘状态（开盘/即将封盘/已封盘）
- ✅ **更智能**：自动控制下注权限，避免封盘后下注
- ✅ **更友好**：提供倒计时文本，统一文案提示

### 用户体验提升
- ✅ 倒计时精确到秒
- ✅ 封盘状态清晰显示
- ✅ 下注按钮智能控制
- ✅ 避免无效下注

---

**文档版本**：v1.0  
**更新日期**：2024年11月26日  
**状态**：✅ 集成完成

现在首页的倒计时使用了后端的封盘接口，更加准确和可靠！🎉




