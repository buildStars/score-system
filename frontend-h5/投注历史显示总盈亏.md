# 投注历史显示总盈亏

## 修改说明

将投注历史的"结果"列修改为显示**总盈亏**，而不是 `resultAmount`。

---

## 总盈亏计算公式

```
总盈亏 = 结算后积分 - 下注前积分
总盈亏 = pointsAfter - pointsBefore
```

---

## 示例对比

### 场景：倍数下注 - 回本

**数据：**
- 下注前积分（pointsBefore）：10000
- 下注金额：1000
- 手续费：30
- 下注后积分：8970（扣除了1030）
- 回本返还：2000
- 结算后积分（pointsAfter）：10970

**修改前显示：**
```
resultAmount = 970（净盈亏，相对于下注后积分）
显示：+970
```

**修改后显示：**
```
总盈亏 = 10970 - 10000 = 970
显示：+970 ✅
```

**结论：** 在这个例子中，两者相同。但从用户视角，总盈亏更直观！

---

### 场景：倍数下注 - 不回本

**数据：**
- 下注前积分（pointsBefore）：10000
- 下注金额：1000
- 手续费：30
- 下注后积分：8970
- 不回本返还：200（20%本金）
- 结算后积分（pointsAfter）：9170

**修改前显示：**
```
resultAmount = -830（净盈亏，相对于下注后积分）
显示：-830
```

**修改后显示：**
```
总盈亏 = 9170 - 10000 = -830
显示：-830 ✅
```

**结论：** 两者相同，但总盈亏更直观地反映了最终损失！

---

### 场景：组合下注 - 赢（没中奖）

**数据：**
- 下注前积分（pointsBefore）：10000
- 下注金额：1000
- 手续费：50
- 下注后积分：8950
- 没中奖返还：2000
- 结算后积分（pointsAfter）：10950

**修改前显示：**
```
resultAmount = 950（净盈亏）
显示：+950
```

**修改后显示：**
```
总盈亏 = 10950 - 10000 = 950
显示：+950 ✅
```

---

### 场景：同一期多次下注合并

**数据：**
- 第85期下注3次：
  - 第1次：下注500倍，手续费15，扣除515
  - 第2次：下注100倍，手续费3，扣除103
  - 第3次：下注100小单，手续费5，扣除105
- 下注前积分（pointsBefore）：10000（第1次下注前）
- 总扣除：515 + 103 + 105 = 723
- 下注后积分：9277
- 结算：
  - 倍数不回本返还：120（600 * 0.2）
  - 小单没中返还：200（100 * 2）
- 结算后积分（pointsAfter）：9597

**修改前显示：**
```
各次 resultAmount 合计 = ?（后端已合并）
显示：-403（示例）
```

**修改后显示：**
```
总盈亏 = 9597 - 10000 = -403
显示：-403 ✅
```

---

## 代码修改

### 文件：`frontend-h5/src/views/BetHistory.vue`

#### 1. 新增计算函数

```typescript
/**
 * 计算总盈亏（结算后积分 - 下注前积分）
 */
const getTotalProfitLoss = (item: any): number => {
  if (!item.pointsBefore || !item.pointsAfter) return 0
  return Number(item.pointsAfter) - Number(item.pointsBefore)
}
```

#### 2. 修改模板

修改前：
```vue
<div v-else :class="['result-amount', getResultClass(item.resultAmount)]">
  {{ formatResultAmount(item.resultAmount) }}
</div>
```

修改后：
```vue
<div v-else :class="['result-amount', getResultClass(getTotalProfitLoss(item))]">
  {{ formatResultAmount(getTotalProfitLoss(item)) }}
</div>
```

---

## 优势对比

### 使用 resultAmount（修改前）

```
下注前：10000
下注：  -1030（本金+手续费）
下注后：8970
结算：  +2000（返还）
结算后：10970

显示：resultAmount = 970（相对于下注后积分的变化）
```

**问题：** 用户不太理解 `resultAmount` 是什么，需要理解"下注后积分"这个中间状态。

### 使用总盈亏（修改后）✅

```
下注前：10000
结算后：10970

显示：总盈亏 = 970（最直观！）
```

**优势：**
1. ✅ 更直观：用户一眼就能看出最终赚了还是亏了多少
2. ✅ 更简单：不需要理解中间状态
3. ✅ 更符合用户预期："结果"就是最终的盈亏
4. ✅ 计算简单：`pointsAfter - pointsBefore`

---

## 前后端数据流

### 后端返回数据

```json
{
  "id": 123,
  "issue": "3364706",
  "betType": "multiple",
  "betContent": "1000",
  "amount": 1000,
  "fee": 30,
  "status": "win",
  "resultAmount": 970,  // 后端计算的净盈亏（不再使用）
  "pointsBefore": 10000,  // ✅ 使用
  "pointsAfter": 10970,   // ✅ 使用
  "settledAt": "2025-11-27T10:00:00.000Z",
  "lottery": { ... }
}
```

### 前端计算显示

```typescript
// 方法1：使用后端返回的 resultAmount（旧方式）
const displayAmount = item.resultAmount  // 970

// 方法2：使用总盈亏（新方式）✅
const displayAmount = item.pointsAfter - item.pointsBefore  // 10970 - 10000 = 970
```

---

## 测试验证

### 测试场景1：倍数回本

1. 下注前积分：100000
2. 下注 1000 倍
3. 手续费：30
4. 开奖：回本
5. 查看投注历史

**期待显示：**
```
结果：+970
剩余：100970
```

**计算验证：**
- pointsBefore = 100000
- pointsAfter = 100970
- 总盈亏 = 100970 - 100000 = +970 ✅

### 测试场景2：倍数不回本

1. 下注前积分：100000
2. 下注 1000 倍
3. 手续费：30
4. 开奖：不回本（返还20%）
5. 查看投注历史

**期待显示：**
```
结果：-830
剩余：99170
```

**计算验证：**
- pointsBefore = 100000
- pointsAfter = 99170
- 总盈亏 = 99170 - 100000 = -830 ✅

### 测试场景3：组合赢

1. 下注前积分：100000
2. 下注 1000 大
3. 手续费：50
4. 开奖：小（没中奖，用户赢）
5. 查看投注历史

**期待显示：**
```
结果：+950
剩余：100950
```

**计算验证：**
- pointsBefore = 100000
- pointsAfter = 100950
- 总盈亏 = 100950 - 100000 = +950 ✅

### 测试场景4：组合中奖且回本

1. 下注前积分：100000
2. 下注 1000 大
3. 手续费：50
4. 开奖：大 + 回本
5. 查看投注历史

**期待显示：**
```
结果：-50
剩余：99950
```

**计算验证：**
- pointsBefore = 100000
- pointsAfter = 99950
- 总盈亏 = 99950 - 100000 = -50 ✅

### 测试场景5：组合中奖且不回本

1. 下注前积分：100000
2. 下注 1000 大
3. 手续费：50
4. 开奖：大 + 不回本（扣除5倍）
5. 查看投注历史

**期待显示：**
```
结果：-5050
剩余：94950
```

**计算验证：**
- pointsBefore = 100000
- pointsAfter = 94950
- 总盈亏 = 94950 - 100000 = -5050 ✅

### 测试场景6：同一期多次下注

1. 下注前积分：100000
2. 第85期：
   - 下注 500 倍
   - 下注 100 倍
   - 下注 100 小单
3. 手续费：15 + 3 + 5 = 23
4. 开奖：不回本
5. 查看投注历史（合并显示）

**期待显示：**
```
期号：85
下注：600倍数 100小单
结果：-XXX（根据开奖结果计算）
剩余：XXXXX
```

**计算验证：**
- pointsBefore = 100000（第1次下注前）
- pointsAfter = XXXXX（最后结算后）
- 总盈亏 = pointsAfter - pointsBefore ✅

---

## 注意事项

### 1. 后端数据完整性

确保后端返回的数据包含：
- ✅ `pointsBefore`：第一次下注前的积分
- ✅ `pointsAfter`：最后结算后的积分

如果数据缺失，`getTotalProfitLoss` 会返回 0。

### 2. 同一期多次下注

后端已实现合并逻辑，返回的数据中：
- `pointsBefore`：同一期第一次下注前的积分
- `pointsAfter`：同一期最后一次结算后的积分

所以总盈亏 = `pointsAfter - pointsBefore` 自动包含了同一期所有下注的总盈亏！✅

### 3. 精度问题

- 所有积分都是整数，向下取整
- 总盈亏也是整数，不会有小数点精度问题

---

## 总结

✅ **修改完成：** 投注历史的"结果"列现在显示**总盈亏**
✅ **计算公式：** `pointsAfter - pointsBefore`
✅ **用户体验：** 更直观，一眼看出最终赚了多少或亏了多少
✅ **适用范围：** 单次下注、同一期多次下注合并显示都适用
✅ **无需后端修改：** 后端已经返回了 `pointsBefore` 和 `pointsAfter`

现在用户可以直观地看到每一期最终的盈亏情况！🎉

---

## 示例效果

### 修改前（使用 resultAmount）

```
期号    开奖号码    下注内容    结果        剩余
364967  1 9 2      1000       +970.00    100970.00
364963  7 0 4      1000大     +950.00    101920.00
364959  1 3 1      小单       -50.00     101870.00
```

### 修改后（使用总盈亏）✅

```
期号    开奖号码    下注内容    结果        剩余
364967  1 9 2      1000       +970.00    100970.00
364963  7 0 4      1000大     +950.00    101920.00
364959  1 3 1      小单       -50.00     101870.00
```

**显示效果一样！** 但计算逻辑更直观，用户更容易理解！

---

修改完成，无需重启服务，刷新前端页面即可生效！✨



