# 当期下注展示 & 可取消功能测试指南

## 测试前准备

### 1. 启动服务

```bash
# 启动后端服务
cd score-system/backend
npm run start:dev

# 启动前端H5服务
cd score-system/frontend-h5
npm run dev
```

### 2. 确认环境
- 后端运行在 http://localhost:3000
- 前端H5运行在 http://localhost:5173
- 确保有测试账号并已登录
- 确保账户有足够的积分进行测试

### 3. 测试工具
- Chrome DevTools（查看网络请求）
- 准备好计算器（验证退款金额）

## 测试场景

### 场景1：单次下注展示和取消

#### 测试步骤
1. **登录系统**
   - 打开H5首页 http://localhost:5173
   - 使用测试账号登录（如：testuser）
   - 记录当前积分（如：10000分）

2. **进行单次下注**
   - 选择"倍数下注"标签
   - 设置每倍金额：100分
   - 设置倍数：10倍
   - 总金额显示：1000分
   - 点击"确认下注"按钮
   - 确认对话框显示：
     ```
     下注内容：1000
     下注金额：1000
     手续费：30
     确认提交吗？
     ```
   - 点击"确认"

3. **验证下注展示**
   - ✅ 页面自动刷新
   - ✅ 倒计时section下方显示"本期下注"区域
   - ✅ 区域背景为渐变紫色
   - ✅ 显示期号（如："第3364706期"）
   - ✅ 显示下注项："1000倍数 1000分 X"
   - ✅ "X"图标为红色，可点击
   - ✅ 用户积分减少：10000 - 1030 = 8970分

4. **取消下注**
   - 点击"1000倍数"右侧的红色"X"图标
   - ✅ 弹出确认对话框：
     ```
     标题：确认取消
     内容：确定要取消 1000倍数 的下注吗？
           取消后将退回积分到您的账户。
     按钮：红色"确定取消"、灰色"我再想想"
     ```
   - 点击"确定取消"

5. **验证取消结果**
   - ✅ 显示成功提示："✅ 取消成功！退回积分：1030"
   - ✅ "本期下注"区域消失（无其他下注）
   - ✅ 用户积分恢复：8970 + 1030 = 10000分
   - ✅ 打开DevTools查看网络请求：
     - POST /api/user/cancel-bet
     - 响应：`{ code: 200, data: { refundAmount: 1030, newPoints: 10000 } }`

6. **验证取消确认对话框的"取消"按钮**
   - 再次下注"1000倍数"
   - 点击红色"X"图标
   - 在确认对话框中点击"我再想想"
   - ✅ 对话框关闭，下注项仍然存在
   - ✅ 积分不变

**预期结果：** 单次下注能正确展示和取消，积分计算正确，UI交互流畅。

---

### 场景2：多次加注合并展示

#### 测试步骤
1. **第一次下注**
   - 选择"倍数下注"
   - 设置：每倍100分，倍数5倍，总金额500分
   - 确认下注
   - ✅ "本期下注"区域显示："500倍数 500分 X"
   - ✅ 积分减少：10000 - 515 = 9485分

2. **第二次加注（同一玩法）**
   - 再次选择"倍数下注"
   - 设置：每倍100分，倍数3倍，总金额300分
   - 确认下注
   - ✅ "本期下注"区域自动更新为："800倍数 800分 X"
   - ✅ 积分减少：9485 - 309 = 9176分
   - ✅ 只显示一个卡片（合并显示）

3. **第三次加注（同一玩法）**
   - 再次下注200倍数
   - ✅ 区域更新为："1000倍数 1000分 X"
   - ✅ 积分减少：9176 - 206 = 8970分

4. **取消所有加注**
   - 点击"1000倍数"右侧的"X"图标
   - 确认取消
   - ✅ 提示："✅ 取消成功！退回积分：1030"
   - ✅ 区域消失
   - ✅ 积分恢复：8970 + 1030 = 10000分

5. **验证退款金额**
   - 计算：
     ```
     第一次：500 + 15 = 515
     第二次：300 + 9 = 309
     第三次：200 + 6 = 206
     总计：515 + 309 + 206 = 1030
     ```
   - ✅ 退款金额正确

**预期结果：** 多次加注能正确合并显示，取消时退回所有下注和手续费。

---

### 场景3：多玩法混合下注

#### 测试步骤
1. **下注第一个玩法（倍数）**
   - 选择"倍数下注"
   - 下注1000倍数
   - ✅ 显示："1000倍数 1000分 X"
   - ✅ 积分：10000 - 1030 = 8970分

2. **下注第二个玩法（组合-大）**
   - 切换到"组合下注"标签
   - 选择"大"
   - 输入金额500
   - 确认下注
   - ✅ 区域显示两个卡片：
     - "1000倍数 1000分 X"
     - "大 500分 X"
   - ✅ 积分：8970 - 525 = 8445分

3. **下注第三个玩法（组合-小双）**
   - 选择"小双"
   - 输入金额300
   - 确认下注
   - ✅ 区域显示三个卡片：
     - "1000倍数 1000分 X"
     - "大 500分 X"
     - "小双 300分 X"
   - ✅ 积分：8445 - 315 = 8130分

4. **取消中间的玩法（大）**
   - 点击"大"右侧的"X"图标
   - 确认取消
   - ✅ 提示："✅ 取消成功！退回积分：525"
   - ✅ "大"卡片消失
   - ✅ 仍显示两个卡片：
     - "1000倍数 1000分 X"
     - "小双 300分 X"
   - ✅ 积分：8130 + 525 = 8655分

5. **取消第一个玩法（倍数）**
   - 点击"1000倍数"右侧的"X"图标
   - 确认取消
   - ✅ 提示："✅ 取消成功！退回积分：1030"
   - ✅ "1000倍数"卡片消失
   - ✅ 仍显示一个卡片："小双 300分 X"
   - ✅ 积分：8655 + 1030 = 9685分

6. **取消最后的玩法（小双）**
   - 点击"小双"右侧的"X"图标
   - 确认取消
   - ✅ 提示："✅ 取消成功！退回积分：315"
   - ✅ 整个"本期下注"区域消失
   - ✅ 积分：9685 + 315 = 10000分

**预期结果：** 多玩法能独立管理，取消任意一个不影响其他玩法。

---

### 场景4：封盘后无法取消

#### 测试步骤
1. **进行下注**
   - 下注1000倍数
   - ✅ 显示："1000倍数 1000分 X"
   - ✅ "X"图标为红色，可点击

2. **等待封盘**
   - 观察倒计时区域
   - 等待"距离封盘"倒计时结束
   - ✅ 倒计时标题变为"距离开奖"
   - ✅ 状态提示变为"已封盘，等待开奖中..."

3. **验证无法取消**
   - 刷新页面确保状态同步
   - 查看"本期下注"区域
   - ✅ "X"图标消失
   - ✅ 显示灰色"已封盘"文字
   - ✅ 点击"已封盘"文字无任何反应
   - ✅ 下注项仍然显示但无法操作

4. **等待开奖**
   - 等待"距离开奖"倒计时结束
   - ✅ 页面自动刷新
   - ✅ "本期下注"区域消失
   - ✅ 切换到下一期
   - ✅ 投注历史中显示该期已结算的记录

**预期结果：** 封盘后无法取消下注，UI正确显示状态。

---

### 场景5：跨期下注测试

#### 测试步骤
1. **在第85期下注**
   - 记录当前期号：3364685
   - 下注1000倍数
   - ✅ 显示："本期下注 第3364685期"
   - ✅ 显示："1000倍数 1000分 X"

2. **等待至开奖**
   - 等待该期开奖完成
   - ✅ 页面自动切换到第3364686期
   - ✅ "本期下注"区域消失（上一期已结算）

3. **在新一期下注**
   - 当前期号：3364686
   - 下注500倍数
   - ✅ 显示："本期下注 第3364686期"
   - ✅ 显示："500倍数 500分 X"
   - ✅ 可以取消

4. **尝试取消新一期的下注**
   - 点击"X"取消
   - ✅ 成功取消，退回积分

**预期结果：** 每期的下注独立管理，不会混淆。

---

### 场景6：快速连续操作

#### 测试步骤
1. **快速下注和取消**
   - 下注1000倍数
   - 立即点击"X"取消
   - 再次下注500倍数
   - 立即点击"X"取消
   - ✅ 所有操作响应正常
   - ✅ 积分计算正确
   - ✅ 无UI异常

2. **连续加注多次**
   - 连续下注3次：100倍数、200倍数、300倍数
   - ✅ 每次下注后区域自动更新
   - ✅ 最终显示："600倍数 600分 X"
   - ✅ 取消后退回所有积分

**预期结果：** 快速操作不会导致UI错误或积分计算错误。

---

### 场景7：异常情况处理

#### 测试步骤
1. **网络异常测试**
   - 打开DevTools，切换到Network标签
   - 将网络设置为"Offline"
   - 尝试取消下注
   - ✅ 显示错误提示："网络连接失败，请检查网络"
   - ✅ 下注项仍然存在
   - ✅ 恢复网络后可以正常操作

2. **后端错误测试**
   - 停止后端服务
   - 刷新页面
   - ✅ 页面加载正常（使用缓存的用户信息）
   - ✅ "本期下注"区域为空或显示旧数据
   - ✅ 尝试下注时显示错误提示
   - ✅ 重启后端后恢复正常

3. **Token过期测试**
   - 清除localStorage中的token
   - 刷新页面
   - ✅ 自动跳转到登录页
   - ✅ 重新登录后恢复正常

**预期结果：** 异常情况有合理的错误处理和用户提示。

---

## API测试

### 1. 测试获取当期下注API

```bash
# 请求
curl -X GET http://localhost:3000/api/user/current-issue-bets \
  -H "Authorization: Bearer YOUR_TOKEN"

# 预期响应
{
  "code": 200,
  "message": "success",
  "data": {
    "issue": "3364706",
    "bets": [
      {
        "betType": "multiple",
        "betContent": "1000",
        "totalAmount": 1500,
        "totalFee": 45,
        "betIds": [1, 2, 3]
      }
    ],
    "canCancel": true
  }
}
```

### 2. 测试取消下注API

```bash
# 请求
curl -X POST http://localhost:3000/api/user/cancel-bet \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "issue": "3364706",
    "betType": "multiple",
    "betContent": "1000"
  }'

# 预期响应
{
  "code": 200,
  "message": "success",
  "data": {
    "message": "取消成功",
    "refundAmount": 1545,
    "newPoints": 10000
  }
}
```

### 3. 测试封盘后取消（预期失败）

```bash
# 在封盘后执行
curl -X POST http://localhost:3000/api/user/cancel-bet \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "issue": "3364706",
    "betType": "multiple",
    "betContent": "1000"
  }'

# 预期响应
{
  "code": 400,
  "message": "已封盘，无法取消下注"
}
```

---

## 测试检查清单

### 功能测试
- [ ] 单次下注能正确展示
- [ ] 多次加注能合并显示
- [ ] 多玩法能独立展示
- [ ] 取消功能正常工作
- [ ] 封盘后无法取消
- [ ] 退款金额计算正确
- [ ] 积分实时更新
- [ ] 跨期不会混淆

### UI测试
- [ ] 渐变紫色背景显示正确
- [ ] 期号显示正确
- [ ] 玩法名称格式正确
- [ ] 金额显示带"分"单位
- [ ] "X"图标红色醒目
- [ ] "已封盘"提示清晰
- [ ] 确认对话框样式美观
- [ ] 成功提示含退款金额
- [ ] 区域在无下注时隐藏

### 交互测试
- [ ] 点击"X"弹出确认框
- [ ] 确认对话框可以取消
- [ ] 取消成功后自动刷新
- [ ] 下注成功后自动刷新
- [ ] "X"图标有悬停效果
- [ ] "X"图标有点击动画
- [ ] 页面滚动顺畅

### 性能测试
- [ ] 加载速度快（<500ms）
- [ ] 刷新操作流畅
- [ ] 无明显卡顿
- [ ] 内存使用正常

### 错误处理
- [ ] 网络错误有提示
- [ ] 后端错误有提示
- [ ] Token过期自动跳转
- [ ] 取消操作可以撤销

### 兼容性测试
- [ ] Chrome浏览器正常
- [ ] Firefox浏览器正常
- [ ] Safari浏览器正常
- [ ] 移动端浏览器正常
- [ ] 不同屏幕尺寸适配

---

## 常见问题排查

### 问题1：区域不显示
**可能原因：**
- 当前没有下注
- API请求失败
- 数据格式错误

**排查步骤：**
1. 打开DevTools查看Network请求
2. 检查`/api/user/current-issue-bets`响应
3. 查看Console是否有错误
4. 确认`currentIssueBets.value`有数据

### 问题2：取消按钮不响应
**可能原因：**
- 已封盘
- 事件监听未绑定
- CSS层级覆盖

**排查步骤：**
1. 检查`canCancel`字段值
2. 查看元素的事件监听器
3. 检查CSS的`pointer-events`
4. 确认没有被其他元素遮挡

### 问题3：退款金额不对
**可能原因：**
- 手续费计算错误
- 合并逻辑错误
- 数据库记录错误

**排查步骤：**
1. 手动计算预期退款金额
2. 检查后端的`totalRefund`计算逻辑
3. 查询数据库的bet记录
4. 确认手续费率设置

### 问题4：积分更新延迟
**可能原因：**
- 未调用刷新函数
- Promise未等待
- Store未更新

**排查步骤：**
1. 检查是否调用`userStore.fetchUserInfo()`
2. 确认使用`await`等待异步操作
3. 查看Store的数据是否更新
4. 刷新页面确认数据库已更新

---

## 测试报告模板

### 测试环境
- 测试日期：2025-11-27
- 测试人员：[姓名]
- 前端版本：v1.0.0
- 后端版本：v1.0.0
- 浏览器：Chrome 120.0

### 测试结果

#### 场景1：单次下注展示和取消
- 状态：✅ 通过 / ❌ 失败
- 备注：[问题描述]

#### 场景2：多次加注合并展示
- 状态：✅ 通过 / ❌ 失败
- 备注：[问题描述]

#### 场景3：多玩法混合下注
- 状态：✅ 通过 / ❌ 失败
- 备注：[问题描述]

#### 场景4：封盘后无法取消
- 状态：✅ 通过 / ❌ 失败
- 备注：[问题描述]

#### 场景5：跨期下注测试
- 状态：✅ 通过 / ❌ 失败
- 备注：[问题描述]

#### 场景6：快速连续操作
- 状态：✅ 通过 / ❌ 失败
- 备注：[问题描述]

#### 场景7：异常情况处理
- 状态：✅ 通过 / ❌ 失败
- 备注：[问题描述]

### 发现的问题
1. [问题描述]
2. [问题描述]

### 总体评价
- 功能完整性：[评价]
- 用户体验：[评价]
- 性能表现：[评价]
- 稳定性：[评价]

### 建议
- [建议内容]

---

## 总结

本测试指南覆盖了当期下注展示 & 可取消功能的所有核心场景和边缘情况。通过系统性的测试，可以确保功能的：

✅ **正确性**：逻辑正确，计算准确
✅ **稳定性**：异常处理完善，不会崩溃
✅ **易用性**：交互流畅，提示清晰
✅ **安全性**：权限控制，防止误操作

请按照测试场景逐一验证，记录测试结果，发现问题及时反馈！🎯



